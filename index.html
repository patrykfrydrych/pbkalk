<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kalkulator Sprzedażowy - Materiały Budowlane</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM libraries (local copies with CDN fallback) -->
    <script src="/vendor/react.development.js" crossorigin></script>
    <script>window.React || document.write('<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin><\/script>');</script>
    <script src="/vendor/react-dom.development.js" crossorigin></script>
    <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin><\/script>');</script>
    
    <!-- Babel Standalone for compiling JSX in the browser -->
    <script src="/vendor/babel.min.js"></script>
    <script>window.Babel || document.write('<script src="https://unpkg.com/@babel/standalone/babel.min.js"><\/script>');</script>

    <!-- ExcelJS for Excel import/export -->
    <script src="/vendor/exceljs.min.js"></script>
    <script>window.ExcelJS || document.write('<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"><\/script>');</script>

    <!-- PocketBase sync (fetch-based, no SDK needed) -->
    <script src="/leier-chimney.bundle.js"></script>

    <!-- Build-time env injection (Vite) -> exposes window.POCKETBASE_URL -->
    <script type="module" src="/env.ts"></script>

<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <!-- The entire application logic is contained within this script tag -->
        <script id="leier-materials-data" type="application/json">[
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 6 cm CZARNA",
    "priceNet": 34.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.58",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 6 cm CZERWONA",
    "priceNet": 34.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.58",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 6 cm SZARA",
    "priceNet": 32.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.58",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 6 cm ŻÓŁTA",
    "priceNet": 36.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.58",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 8 cm CZARNA",
    "priceNet": 39.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 8 cm CZERWONA",
    "priceNet": 39.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 8 cm SZARA",
    "priceNet": 36.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Antic Stone (1 elem.) 8 cm ŻÓŁTA",
    "priceNet": 14.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Bloczek betonowy B15 38x25x14 cm",
    "priceNet": 3.59,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "54",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Bloczek betonowy B20 38x25x14 cm",
    "priceNet": 4.1,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "54",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Blok 24 50x24x24 cm beton",
    "priceNet": 10.6,
    "discountPercent": 20.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) _x000d__x000d_\n20x10x 6 cm CZARNA",
    "priceNet": 31.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.8",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) _x000d__x000d_\n20x10x 6 cm CZERWONA",
    "priceNet": 31.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.8",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) _x000d__x000d_\n20x10x 6 cm SZARA",
    "priceNet": 29.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.8",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) _x000d__x000d_\n20x10x 6 cm ŻÓŁTA",
    "priceNet": 35.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.8",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) 20x10x 8 cm CZARNA",
    "priceNet": 37.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) 20x10x 8 cm CZERWONA",
    "priceNet": 37.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) 20x10x 8 cm SZARA",
    "priceNet": 34.9,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Brick Floor (Piazza) 20x10x 8 cm ŻÓŁTA",
    "priceNet": 40.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "8.64",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Calisia (4 elem.) 6 cm",
    "priceNet": 0.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "10.7",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Działowy 12 50x12x22 cm beton",
    "priceNet": 3.7,
    "discountPercent": 20.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Gazon okrągły KOLOR",
    "priceNet": 37.8,
    "discountPercent": 30.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Gazon okrągły SZARY",
    "priceNet": 34.7,
    "discountPercent": 30.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Gazon prostokątny KOLOR",
    "priceNet": 42.5,
    "discountPercent": 30.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Gazon prostokątny SZARY",
    "priceNet": 37.8,
    "discountPercent": 30.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Hammer (Solido ) 8 cm CZARNA",
    "priceNet": 376.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "7.15",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Hammer (Solido) 8 cm CZERWONA",
    "priceNet": 37.6,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "7.15",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Hammer (Solido) 8 cm SZARA",
    "priceNet": 35.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "7.15",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Hammer (Solido) 8 cm ŻÓŁTA",
    "priceNet": 40.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "7.15",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Krawężnik drogowy ciężki_x000d__x000d__x000d_\n 20/30/100",
    "priceNet": 29.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "12",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Krawężnik drogowy_x000d__x000d__x000d_\n 15/30/100",
    "priceNet": 22.4,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "15",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Krawężnik najazdowy_x000d__x000d__x000d_\n 15/22/100",
    "priceNet": 19.7,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "12",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Leca Blok 12 50x12x24 cm  keramzyt",
    "priceNet": 8.0,
    "discountPercent": 23.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Leca Blok 24 50x24x24 cm keramzyt",
    "priceNet": 14.8,
    "discountPercent": 23.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Leca Blok Akustyczny 38x18x24 cm keramzyt",
    "priceNet": 10.0,
    "discountPercent": 23.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 120",
    "priceNet": 41.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 150",
    "priceNet": 55.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 180",
    "priceNet": 68.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 210",
    "priceNet": 75.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 240",
    "priceNet": 99.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 270",
    "priceNet": 126.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 360",
    "priceNet": 141.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże D 90",
    "priceNet": 32.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 180",
    "priceNet": 113.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 210",
    "priceNet": 132.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 240",
    "priceNet": 167.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 270",
    "priceNet": 189.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 300",
    "priceNet": 210.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 330",
    "priceNet": 260.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 360",
    "priceNet": 281.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże NKLL 90",
    "priceNet": 50.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 115",
    "priceNet": 17.58,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 145",
    "priceNet": 22.16,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 175",
    "priceNet": 26.76,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 205",
    "priceNet": 36.6,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 215",
    "priceNet": 38.4,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 245",
    "priceNet": 47.25,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 275",
    "priceNet": 53.04,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nadproże Strong 305",
    "priceNet": 58.82,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "NadprożeNKLL 120",
    "priceNet": 68.0,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "NadprożeNKLL 150",
    "priceNet": 93.5,
    "discountPercent": 40.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nobilis (3 elem.) 6 cm CZARNA",
    "priceNet": 35.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "11.3",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nobilis (3 elem.) 6 cm CZERWONA",
    "priceNet": 35.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "11.3",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nobilis (3 elem.) 6 cm SZARA",
    "priceNet": 33.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "11.3",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Nobilis (3 elem.) 6 cm ŻÓŁTA",
    "priceNet": 37.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "11.3",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Obrzeże 6/20/100 KOLOR",
    "priceNet": 9.65,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "42",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Obrzeże 6/20/100 SZARY",
    "priceNet": 8.2,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "42",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Obrzeże 8/25/100 KOLOR",
    "priceNet": 13.2,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "22",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Obrzeże 8/25/100 SZARY",
    "priceNet": 11.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "22",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Obrzeże 8/30/100 SZARY",
    "priceNet": 13.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "22",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Opornik 12/25/100",
    "priceNet": 17.1,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "18",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta ażurowa (STONE GRASS) 8 cm",
    "priceNet": 42.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "m2",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta ażurowa 60x40 (GREENFIELD) 10,5 cm KOLOR",
    "priceNet": 10.5,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "28",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta ażurowa 60x40 (GREENFIELD) 10,5 cm SZARA",
    "priceNet": 8.95,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "28",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta ażurowa 60x40 (GREENFIELD) 8 cm KOLOR",
    "priceNet": 8.6,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "44",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta ażurowa 60x40 (GREENFIELD) 8 cm SZARA",
    "priceNet": 7.1,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "44",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płyta Drogowa",
    "priceNet": 625.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka ANTRACYT 30x30x 6 cm",
    "priceNet": 5.8,
    "discountPercent": 38.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "96",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka ANTRACYT 40x40x 6 cm",
    "priceNet": 14.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka ANTRACYT 40x60x 4 cm",
    "priceNet": 19.8,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka ANTRACYT 50x50x 4 cm",
    "priceNet": 21.5,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka SZARA 30x30x 6 cm",
    "priceNet": 5.1,
    "discountPercent": 38.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "120",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka SZARA 40x40x 4 cm",
    "priceNet": 9.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka SZARA 40x60x 3 cm",
    "priceNet": 11.5,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka SZARA 40x60x 4 cm",
    "priceNet": 14.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa gładka SZARA 50x50x 4 cm",
    "priceNet": 16.5,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x40x 4 cm AMBER GRAVEL (żwirek)",
    "priceNet": 12.3,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x40x 4 cm ANTRACYT",
    "priceNet": 16.4,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x40x 4 cm GRANITE GRAY",
    "priceNet": 15.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x40x 4 cm GRANITE WHITE",
    "priceNet": 15.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x40x 4 cm PARIS",
    "priceNet": 15.9,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x60x 4 cm AMBER GRAVEL (żwirek)",
    "priceNet": 18.0,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x60x 4 cm ANTRACYT",
    "priceNet": 24.6,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x60x 4 cm GRANITE GRAY",
    "priceNet": 23.7,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x60x 4 cm GRANITE WHITE",
    "priceNet": 23.7,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Płytka chodnikowa płukana 40x60x 4 cm PARIS",
    "priceNet": 23.7,
    "discountPercent": 36.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "90",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Pustak szalunkowy 20 50x20x23 cm",
    "priceNet": 6.4,
    "discountPercent": 17.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "60",
    "unit": "szt",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Pustak szalunkowy 25 50x20x23 cm",
    "priceNet": 7.1,
    "discountPercent": 17.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Pustak szalunkowy 30 50x20x23 cm",
    "priceNet": 7.7,
    "discountPercent": 17.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Pustak szalunkowy 35 50x20x23 cm",
    "priceNet": 11.1,
    "discountPercent": 17.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  },
  {
    "symbol": "",
    "name": "Stojak rowerowy",
    "priceNet": 33.0,
    "discountPercent": 0.0,
    "transportPerUnit": 0.0,
    "unitsPerPallet": "",
    "unit": "szt.",
    "palletWeight": ""
  }
]</script>
    <script id="leier-strop-data" type="application/json">[
  {
    "name": "Kształtka szalunkowa \"L\"",
    "unit": "szt",
    "catalogNet": 14.5,
    "catalogGross": 17.835,
    "discount": 0.25,
    "defaultQuantity": 162.0
  },
  {
    "name": "Kształtka szalunkowa \"C\"",
    "unit": "szt.",
    "catalogNet": 13.5,
    "catalogGross": 16.605,
    "discount": 0.25,
    "defaultQuantity": 60.0
  },
  {
    "name": "Siatka P1",
    "unit": "szt",
    "catalogNet": 94.0,
    "catalogGross": 115.62,
    "discount": 0.2,
    "defaultQuantity": 7.0
  },
  {
    "name": "Siatka P2",
    "unit": "szt.",
    "catalogNet": 73.0,
    "catalogGross": 89.78999999999999,
    "discount": 0.2,
    "defaultQuantity": 8.0
  },
  {
    "name": "Płytka stropowa",
    "unit": "szt",
    "catalogNet": 5.8,
    "catalogGross": 7.1339999999999995,
    "discount": 0.25,
    "defaultQuantity": 16.0
  },
  {
    "name": "Pustak stropowy lekki H=19,5 cm",
    "unit": "szt.",
    "catalogNet": 8.85,
    "catalogGross": 10.885499999999999,
    "discount": 0.32,
    "defaultQuantity": 670.0
  },
  {
    "name": "Belka stropowa 1,80 m",
    "unit": "szt",
    "catalogNet": 47.0,
    "catalogGross": 57.81,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 2,10 m",
    "unit": "szt.",
    "catalogNet": 54.0,
    "catalogGross": 66.42,
    "discount": 0.45,
    "defaultQuantity": 7.0
  },
  {
    "name": "Belka stropowa 2,40 m",
    "unit": "szt",
    "catalogNet": 62.5,
    "catalogGross": 76.875,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 2,70 m",
    "unit": "szt.",
    "catalogNet": 85.0,
    "catalogGross": 104.55,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 3,00 m",
    "unit": "szt",
    "catalogNet": 94.5,
    "catalogGross": 116.235,
    "discount": 0.45,
    "defaultQuantity": 13.0
  },
  {
    "name": "Belka stropowa 3,30 m",
    "unit": "szt.",
    "catalogNet": 104.5,
    "catalogGross": 128.535,
    "discount": 0.45,
    "defaultQuantity": 14.0
  },
  {
    "name": "Belka stropowa 3,60 m",
    "unit": "szt",
    "catalogNet": 139.0,
    "catalogGross": 170.97,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 3,90 m",
    "unit": "szt.",
    "catalogNet": 151.5,
    "catalogGross": 186.345,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 4,20 m",
    "unit": "szt",
    "catalogNet": 161.5,
    "catalogGross": 198.645,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 4,50 m",
    "unit": "szt.",
    "catalogNet": 211.0,
    "catalogGross": 259.53,
    "discount": 0.45,
    "defaultQuantity": 8.0
  },
  {
    "name": "Belka stropowa 4,80 m",
    "unit": "szt",
    "catalogNet": 221.5,
    "catalogGross": 272.445,
    "discount": 0.45,
    "defaultQuantity": 14.0
  },
  {
    "name": "Belka stropowa 5,10 m",
    "unit": "szt.",
    "catalogNet": 236.0,
    "catalogGross": 290.28,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 5,40 m",
    "unit": "szt",
    "catalogNet": 302.5,
    "catalogGross": 372.075,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 5,70 m",
    "unit": "szt.",
    "catalogNet": 323.5,
    "catalogGross": 397.905,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 6,00 m",
    "unit": "szt",
    "catalogNet": 337.5,
    "catalogGross": 415.125,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 6,30 m",
    "unit": "szt.",
    "catalogNet": 389.0,
    "catalogGross": 478.46999999999997,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 6,60 m",
    "unit": "szt",
    "catalogNet": 448.5,
    "catalogGross": 551.655,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 6,90 m",
    "unit": "szt.",
    "catalogNet": 487.0,
    "catalogGross": 599.01,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 7,20 m",
    "unit": "szt",
    "catalogNet": 553.5,
    "catalogGross": 680.805,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 7,50 m",
    "unit": "szt.",
    "catalogNet": 630.0,
    "catalogGross": 774.9,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 7,80 m",
    "unit": "szt",
    "catalogNet": 707.5,
    "catalogGross": 870.225,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 8,10 m",
    "unit": "szt.",
    "catalogNet": 729.0,
    "catalogGross": 896.67,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 8,40 m",
    "unit": "szt",
    "catalogNet": 821.0,
    "catalogGross": 1009.83,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 8,70 m",
    "unit": "szt.",
    "catalogNet": 931.0,
    "catalogGross": 1145.1299999999999,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 9,00 m",
    "unit": "szt",
    "catalogNet": 977.5,
    "catalogGross": 1202.325,
    "discount": 0.45,
    "defaultQuantity": 0.0
  },
  {
    "name": "Belka stropowa 9,30 m",
    "unit": "szt.",
    "catalogNet": 1062.0,
    "catalogGross": 1306.26,
    "discount": 0.45,
    "defaultQuantity": 0.0
  }
]</script>
    <script id="leier-chimney-data" type="application/json">{
  "fi": {
    "izolowany": [
      14,
      16,
      18,
      20,
      22,
      25,
      30
    ],
    "smart": [
      18,
      20
    ],
    "basic": [
      14,
      16,
      18,
      20,
      22,
      25,
      30
    ],
    "turbo": [
      14,
      16,
      18,
      20,
      22,
      25,
      30
    ],
    "multi": [
      14,
      16,
      18,
      20
    ],
    "stal": [
      8,
      10,
      12,
      14
    ],
    "duostal": [
      18,
      20
    ],
    "duoCore": [
      18,
      20
    ],
    "duoVent": [
      8,
      10,
      12,
      14
    ]
  },
  "price": {
    "common": [],
    "izolowany": [
      [
        35,
        41,
        54,
        78
      ],
      [
        52,
        58,
        83
      ],
      [
        26.5,
        31,
        37,
        44.5,
        60.5,
        70,
        85
      ],
      [
        164,
        175,
        191,
        210,
        255,
        350,
        500
      ],
      [
        165,
        175,
        191,
        210,
        255,
        350,
        500
      ],
      [
        190,
        212,
        245,
        255,
        320,
        422,
        615
      ],
      [
        233,
        238,
        402,
        455,
        570
      ],
      70,
      [
        45,
        40,
        60,
        60,
        85,
        90,
        120
      ],
      [
        260,
        265,
        285,
        300,
        330,
        420,
        450
      ],
      300,
      100,
      75,
      [
        120,
        120,
        120,
        120,
        120,
        130,
        130
      ],
      [
        120,
        120,
        135,
        160
      ],
      [
        120,
        140,
        150
      ],
      [
        120,
        125,
        145,
        165
      ],
      [
        120,
        145,
        160
      ],
      [
        85,
        100,
        115,
        140
      ],
      [
        95,
        110,
        125
      ]
    ],
    "smart": [
      [
        22.5,
        35,
        26.5
      ],
      [
        31,
        46,
        34.5
      ],
      [
        53,
        40
      ],
      [
        31,
        37,
        44.5
      ],
      [
        175,
        191,
        210
      ],
      [
        175,
        191,
        210
      ],
      [
        212,
        245,
        255
      ],
      [
        233,
        238
      ],
      70,
      [
        50,
        50,
        50
      ],
      [
        170,
        170,
        170
      ],
      300,
      2,
      75,
      [
        120,
        120
      ],
      [
        120,
        120
      ],
      [
        140,
        150
      ]
    ],
    "smartplus": [
      [
        22.5,
        35,
        26.5
      ],
      [
        31,
        46,
        34.5
      ],
      [
        53,
        40
      ],
      [
        31,
        37,
        44.5
      ],
      [
        175,
        191,
        210
      ],
      [
        175,
        191,
        210
      ],
      [
        212,
        245,
        255
      ],
      [
        233,
        238
      ],
      70,
      [
        50,
        50,
        50
      ],
      [
        265,
        285,
        300
      ],
      300,
      100,
      75,
      [
        120,
        120
      ],
      [
        120,
        120
      ],
      [
        140,
        150
      ]
    ],
    "basic": [
      [
        35,
        41,
        54,
        78
      ],
      [
        52,
        58,
        83
      ],
      [
        26.5,
        31,
        37,
        44.5,
        60.5,
        70,
        85
      ],
      [
        164,
        175,
        191,
        210,
        255,
        350,
        500
      ],
      [
        165,
        175,
        191,
        210,
        255,
        350,
        500
      ],
      [
        190,
        212,
        245,
        255,
        320,
        422,
        615
      ],
      70,
      3,
      [
        260,
        170,
        170,
        170,
        330,
        420,
        450
      ],
      300,
      75,
      [
        120,
        120,
        120,
        120,
        120,
        130,
        130
      ],
      [
        120,
        120,
        135,
        160
      ],
      [
        120,
        140,
        150
      ],
      [
        120,
        125,
        145,
        165
      ],
      [
        120,
        145,
        160
      ],
      [
        85,
        100,
        115,
        140
      ],
      [
        95,
        110,
        125
      ]
    ],
    "turbo": [
      [
        35,
        41,
        54,
        78
      ],
      [
        52,
        58,
        83
      ],
      35,
      [
        26.5,
        31,
        37,
        44.5,
        60.5,
        70,
        85
      ],
      [
        164,
        175,
        191,
        210,
        255,
        350,
        500
      ],
      165,
      [
        233,
        238,
        402,
        455,
        570
      ],
      [
        260,
        265,
        285,
        300,
        330,
        420,
        450
      ],
      [
        35,
        38,
        40,
        42,
        43,
        44,
        49
      ],
      300,
      105,
      45,
      80,
      90,
      95,
      75,
      [
        120,
        120,
        120,
        120,
        120,
        130,
        130
      ],
      [
        120,
        120,
        135,
        160
      ],
      [
        120,
        140,
        150
      ],
      [
        120,
        125,
        145,
        165
      ],
      [
        120,
        145,
        160
      ],
      [
        85,
        100,
        115,
        140
      ],
      [
        95,
        110,
        125
      ]
    ],
    "multi": [
      [
        35,
        41
      ],
      [
        52,
        58
      ],
      [
        140,
        160,
        170,
        180
      ],
      [
        280,
        290,
        295,
        300
      ],
      [
        280,
        290,
        295,
        300
      ],
      [
        230,
        240,
        250,
        260
      ],
      [
        340,
        345,
        350,
        355
      ],
      [
        35,
        38,
        40,
        42
      ],
      350,
      105,
      50,
      30,
      35,
      45,
      80,
      90,
      95,
      [
        120,
        120,
        120,
        120
      ],
      [
        120,
        120
      ],
      [
        120,
        140
      ],
      [
        120,
        125
      ],
      [
        120,
        145
      ],
      [
        85,
        100
      ],
      [
        95,
        110
      ]
    ],
    "turbos": [
      35,
      52,
      [
        100,
        110,
        125,
        140
      ],
      [
        235,
        245,
        265,
        280
      ],
      [
        235,
        245,
        265,
        280
      ],
      [
        212,
        222,
        228,
        230
      ],
      [
        310,
        320,
        330,
        340
      ],
      [
        35,
        35,
        35,
        35
      ],
      350,
      50,
      30,
      35,
      45,
      80,
      90,
      95,
      120,
      120,
      120,
      120,
      120,
      85,
      95
    ],
    "stal": [
      88,
      105,
      78,
      180,
      300,
      37,
      120,
      105,
      105,
      130,
      [
        8.5,
        13.3,
        19,
        24.7,
        14.3,
        21.5,
        28.5
      ]
    ],
    "duostal": [
      [
        53,
        40
      ],
      [
        37,
        44.5
      ],
      [
        191,
        210
      ],
      [
        191,
        210
      ],
      [
        245,
        255
      ],
      238,
      70,
      [
        50,
        50
      ],
      [
        170,
        170
      ],
      300,
      2,
      75,
      120,
      88,
      105,
      78,
      180,
      300,
      37,
      120,
      105,
      105,
      130
    ],
    "duo": [
      60,
      [
        37,
        44.5
      ],
      [
        191,
        210
      ],
      [
        191,
        210
      ],
      [
        245,
        255
      ],
      238,
      70,
      [
        60,
        60
      ],
      [
        285,
        300
      ],
      300,
      100,
      75,
      [
        120,
        120
      ],
      [
        100,
        110,
        125,
        140
      ],
      [
        235,
        245,
        265,
        280
      ],
      [
        235,
        245,
        265,
        280
      ],
      [
        212,
        222,
        228,
        230
      ],
      [
        310,
        320,
        330,
        340
      ],
      [
        35,
        35,
        35,
        35
      ],
      350,
      50,
      30,
      35,
      45,
      80,
      90,
      95,
      120
    ],
    "ventilation": [
      8.5,
      13.3,
      14,
      14.3,
      19,
      21.5,
      24.7,
      28.5
    ]
  }
}</script>
    <script id="weber-products-data" type="application/json">[
  {
    "id": "weber-001",
    "name": "Bitumen 2K",
    "group": "P26",
    "unit": "l",
    "priceNet": 11.8,
    "priceRaw": "11.8"
  },
  {
    "id": "weber-002",
    "name": "keramzyt antypoślizgowy worek",
    "group": "P41",
    "unit": "m3",
    "priceNet": 904.0,
    "priceRaw": "904"
  },
  {
    "id": "weber-003",
    "name": "keramzyt budowlany L big bag",
    "group": "P42",
    "unit": "m3",
    "priceNet": 631.0,
    "priceRaw": "631"
  },
  {
    "id": "weber-004",
    "name": "keramzyt budowlany M big bag",
    "group": "P42",
    "unit": "m3",
    "priceNet": 700.0,
    "priceRaw": "700"
  },
  {
    "id": "weber-005",
    "name": "keramzyt budowlany S big bag",
    "group": "P42",
    "unit": "m3",
    "priceNet": 728.0,
    "priceRaw": "728"
  },
  {
    "id": "weber-006",
    "name": "keramzyt impregnowany",
    "group": "P42",
    "unit": "m3",
    "priceNet": 679.0,
    "priceRaw": "679"
  },
  {
    "id": "weber-007",
    "name": "keramzyt izolacyjny L",
    "group": "P42",
    "unit": "m3",
    "priceNet": 658.0,
    "priceRaw": "od 658,00"
  },
  {
    "id": "weber-008",
    "name": "keramzyt izolacyjny M",
    "group": "P42",
    "unit": "m3",
    "priceNet": 702.0,
    "priceRaw": "od 702,00"
  },
  {
    "id": "weber-009",
    "name": "keramzyt izolacyjny S",
    "group": "P42",
    "unit": "m3",
    "priceNet": 752.0,
    "priceRaw": "od 752,00"
  },
  {
    "id": "weber-010",
    "name": "keramzyt podsypkowy",
    "group": "P42",
    "unit": "m3",
    "priceNet": 833.0,
    "priceRaw": "od 833,00"
  },
  {
    "id": "weber-011",
    "name": "Mariflex PU30 grey",
    "group": "P56",
    "unit": "szt.",
    "priceNet": 45.0,
    "priceRaw": "od 45,00"
  },
  {
    "id": "weber-012",
    "name": "Mariseal 250",
    "group": "P56",
    "unit": "kg",
    "priceNet": 57.5,
    "priceRaw": "od 57,50"
  },
  {
    "id": "weber-013",
    "name": "Mariseal 400",
    "group": "P56",
    "unit": "kg",
    "priceNet": 177.45,
    "priceRaw": "od 177,45"
  },
  {
    "id": "weber-014",
    "name": "Mariseal 460",
    "group": "P56",
    "unit": "kg",
    "priceNet": 99.0,
    "priceRaw": "od 99,00"
  },
  {
    "id": "weber-015",
    "name": "Mariseal 600",
    "group": "P56",
    "unit": "l",
    "priceNet": 59.0,
    "priceRaw": "od 59,00"
  },
  {
    "id": "weber-016",
    "name": "Mariseal 710",
    "group": "P56",
    "unit": "kg",
    "priceNet": 79.0,
    "priceRaw": "od 79,00"
  },
  {
    "id": "weber-017",
    "name": "Mariseal Aqua Primer",
    "group": "P56",
    "unit": "kg",
    "priceNet": 113.5,
    "priceRaw": "od 113,50"
  },
  {
    "id": "weber-018",
    "name": "Mariseal Detail",
    "group": "P56",
    "unit": "kg",
    "priceNet": 99.22,
    "priceRaw": "od 99,22"
  },
  {
    "id": "weber-019",
    "name": "Mariseal Fabric",
    "group": "P67",
    "unit": "m.b.",
    "priceNet": 4.1,
    "priceRaw": "od 4,10"
  },
  {
    "id": "weber-020",
    "name": "Mariseal Katalysator",
    "group": "P56",
    "unit": "kg",
    "priceNet": 145.96,
    "priceRaw": "145.96"
  },
  {
    "id": "weber-021",
    "name": "Maritrans Finish",
    "group": "P56",
    "unit": "kg",
    "priceNet": 220.0,
    "priceRaw": "220"
  },
  {
    "id": "weber-022",
    "name": "Maritrans MD",
    "group": "P56",
    "unit": "kg",
    "priceNet": 189.0,
    "priceRaw": "od 189,00"
  },
  {
    "id": "weber-023",
    "name": "Maritrans Tile Primer",
    "group": "P56",
    "unit": "l",
    "priceNet": 109.0,
    "priceRaw": "od 109,00"
  },
  {
    "id": "weber-024",
    "name": "piasek kwarcowy",
    "group": "P22",
    "unit": "kg",
    "priceNet": 1.8,
    "priceRaw": "1.8"
  },
  {
    "id": "weber-025",
    "name": "przyrząd do wykonywania imitacji deski",
    "group": "n/d",
    "unit": "szt.",
    "priceNet": 35.0,
    "priceRaw": "35"
  },
  {
    "id": "weber-026",
    "name": "taśma odcinająca do tynków modelarskich",
    "group": "P11",
    "unit": "szt.",
    "priceNet": 22.0,
    "priceRaw": "22"
  },
  {
    "id": "weber-027",
    "name": "weber FZ371",
    "group": "P04",
    "unit": "kg",
    "priceNet": 27.0,
    "priceRaw": "od 27,00"
  },
  {
    "id": "weber-028",
    "name": "weber FZ391",
    "group": "P04",
    "unit": "kg",
    "priceNet": 30.0,
    "priceRaw": "od 30,00"
  },
  {
    "id": "weber-029",
    "name": "weber IP 18",
    "group": "P30",
    "unit": "kg",
    "priceNet": 0.86,
    "priceRaw": "0.86"
  },
  {
    "id": "weber-030",
    "name": "weber IP INTER",
    "group": "P30",
    "unit": "kg",
    "priceNet": 1.05,
    "priceRaw": "1.05"
  },
  {
    "id": "weber-031",
    "name": "weber IP PLUS",
    "group": "P30",
    "unit": "kg",
    "priceNet": 1.1,
    "priceRaw": "1.1000000000000001"
  },
  {
    "id": "weber-032",
    "name": "weber KS112",
    "group": "P08",
    "unit": "kg",
    "priceNet": 1.5,
    "priceRaw": "1.5"
  },
  {
    "id": "weber-033",
    "name": "weber KS122",
    "group": "P08",
    "unit": "kg",
    "priceNet": 1.85,
    "priceRaw": "1.85"
  },
  {
    "id": "weber-034",
    "name": "weber KS123",
    "group": "P08",
    "unit": "kg",
    "priceNet": 2.3,
    "priceRaw": "2.2999999999999998"
  },
  {
    "id": "weber-035",
    "name": "weber KS126",
    "group": "P08",
    "unit": "kg",
    "priceNet": 2.6,
    "priceRaw": "2.6"
  },
  {
    "id": "weber-036",
    "name": "weber KS143",
    "group": "P08",
    "unit": "kg",
    "priceNet": 3.5,
    "priceRaw": "3.5"
  },
  {
    "id": "weber-037",
    "name": "weber PC241",
    "group": "P07",
    "unit": "kg",
    "priceNet": 24.0,
    "priceRaw": "24"
  },
  {
    "id": "weber-038",
    "name": "weber PC243",
    "group": "P07",
    "unit": "kg",
    "priceNet": 32.0,
    "priceRaw": "32"
  },
  {
    "id": "weber-039",
    "name": "weber PG212",
    "group": "P03",
    "unit": "kg",
    "priceNet": 21.5,
    "priceRaw": "od 21,50"
  },
  {
    "id": "weber-040",
    "name": "weber PG221",
    "group": "P03",
    "unit": "kg",
    "priceNet": 17.75,
    "priceRaw": "od 17,75"
  },
  {
    "id": "weber-041",
    "name": "weber PG225",
    "group": "P03",
    "unit": "kg",
    "priceNet": 26.0,
    "priceRaw": "od 26,00"
  },
  {
    "id": "weber-042",
    "name": "weber PH912",
    "group": "P11",
    "unit": "m2",
    "priceNet": 5.85,
    "priceRaw": "5.85"
  },
  {
    "id": "weber-043",
    "name": "weber PH913",
    "group": "P11",
    "unit": "m2",
    "priceNet": 5.4,
    "priceRaw": "5.4"
  },
  {
    "id": "weber-044",
    "name": "weber PH930 (Kooltherm K5)",
    "group": "P10",
    "unit": "m2",
    "priceNet": 114.85,
    "priceRaw": "od 114,85"
  },
  {
    "id": "weber-045",
    "name": "weber profi grunt",
    "group": "P17",
    "unit": "l",
    "priceNet": 7.4,
    "priceRaw": "od 7,40"
  },
  {
    "id": "weber-046",
    "name": "weber TD325",
    "group": "P03",
    "unit": "kg",
    "priceNet": 11.7,
    "priceRaw": "11.7"
  },
  {
    "id": "weber-047",
    "name": "weber TM314",
    "group": "P02",
    "unit": "kg",
    "priceNet": 3.4,
    "priceRaw": "3.4"
  },
  {
    "id": "weber-048",
    "name": "weber TP541",
    "group": "P30",
    "unit": "kg",
    "priceNet": 0.99,
    "priceRaw": "0.99"
  },
  {
    "id": "weber-049",
    "name": "weber ZK552",
    "group": "P36",
    "unit": "kg",
    "priceNet": 1.23,
    "priceRaw": "od 1,23"
  },
  {
    "id": "weber-050",
    "name": "weber ZK557",
    "group": "P36",
    "unit": "kg",
    "priceNet": 2.22,
    "priceRaw": "2.2200000000000002"
  },
  {
    "id": "weber-051",
    "name": "weber ZM5",
    "group": "P34",
    "unit": "kg",
    "priceNet": 0.68,
    "priceRaw": "0.68"
  },
  {
    "id": "weber-052",
    "name": "weber ZM5 fix",
    "group": "P34",
    "unit": "kg",
    "priceNet": 0.85,
    "priceRaw": "0.85"
  },
  {
    "id": "weber-053",
    "name": "weber ZM5 uni",
    "group": "P34",
    "unit": "kg",
    "priceNet": 0.81,
    "priceRaw": "0.81"
  },
  {
    "id": "weber-054",
    "name": "weber ZM10",
    "group": "P34",
    "unit": "kg",
    "priceNet": 0.72,
    "priceRaw": "0.72"
  },
  {
    "id": "weber-055",
    "name": "weber ZM10 fix",
    "group": "P34",
    "unit": "kg",
    "priceNet": 0.94,
    "priceRaw": "0.94"
  },
  {
    "id": "weber-056",
    "name": "weber ZP412",
    "group": "P12",
    "unit": "kg",
    "priceNet": 1.8,
    "priceRaw": "1.8"
  },
  {
    "id": "weber-057",
    "name": "weber ZP413",
    "group": "P12",
    "unit": "kg",
    "priceNet": 2.23,
    "priceRaw": "2.23"
  },
  {
    "id": "weber-058",
    "name": "weber ZP414",
    "group": "P13",
    "unit": "kg",
    "priceNet": 3.45,
    "priceRaw": "3.45"
  },
  {
    "id": "weber-059",
    "name": "weber.floor 1000",
    "group": "P21",
    "unit": "kg",
    "priceNet": 1.13,
    "priceRaw": "1.1299999999999999"
  },
  {
    "id": "weber-060",
    "name": "weber.floor 4010",
    "group": "P18",
    "unit": "kg",
    "priceNet": 3.3,
    "priceRaw": "3.3"
  },
  {
    "id": "weber-061",
    "name": "weber.floor 4020",
    "group": "P18",
    "unit": "kg",
    "priceNet": 3.67,
    "priceRaw": "3.67"
  },
  {
    "id": "weber-062",
    "name": "weber.floor 4045",
    "group": "P18",
    "unit": "kg",
    "priceNet": 6.82,
    "priceRaw": "6.82"
  },
  {
    "id": "weber-063",
    "name": "weberfloor 4100 POZIOM",
    "group": "P19",
    "unit": "kg",
    "priceNet": 3.2,
    "priceRaw": "3.2"
  },
  {
    "id": "weber-064",
    "name": "weber.floor 4150",
    "group": "P19",
    "unit": "kg",
    "priceNet": 3.92,
    "priceRaw": "3.92"
  },
  {
    "id": "weber-065",
    "name": "weber.floor 4310",
    "group": "P19",
    "unit": "kg",
    "priceNet": 4.5,
    "priceRaw": "4.5"
  },
  {
    "id": "weber-066",
    "name": "weber.floor 4320",
    "group": "P19",
    "unit": "kg",
    "priceNet": 5.97,
    "priceRaw": "5.97"
  },
  {
    "id": "weber-067",
    "name": "weber.floor 4602 Industry Base Extra",
    "group": "P20",
    "unit": "kg",
    "priceNet": 6.78,
    "priceRaw": "6.78"
  },
  {
    "id": "weber-068",
    "name": "weber.floor 4610 Industry Top",
    "group": "P20",
    "unit": "kg",
    "priceNet": 9.22,
    "priceRaw": "9.2200000000000006"
  },
  {
    "id": "weber-069",
    "name": "weber.floor 4716",
    "group": "P22",
    "unit": "kg",
    "priceNet": 37.25,
    "priceRaw": "od 37,25"
  }
]</script>
    <script type="text/babel" data-type="module">
        const React = globalThis.React;
        const ReactDOM = globalThis.ReactDOM;

        if (!React || !ReactDOM) {
            const rootContainer = document.getElementById('root');
            if (rootContainer) {
                rootContainer.innerHTML = '<div class="flex min-h-screen items-center justify-center bg-white p-6 text-center text-slate-600">Nie udało się załadować bibliotek React. Sprawdź połączenie z internetem i odśwież stronę.</div>';
            }
            throw new Error('React or ReactDOM global was not found.');
        }

        const { useState, useEffect, useMemo, useCallback, Fragment, useRef } = React;

        //======================================================================
        // CONSTANTS
        //======================================================================
        const MANUFACTURERS = [
            { id: 'porotherm', name: 'POROTHERM (Wienerberger)', type: 'Pustaki ceramiczne', productCount: 28, status: 'active', icon: '🧱' },
            { id: 'solbet', name: 'SOLBET', type: 'Beton komórkowy', productCount: 120, status: 'active', icon: '🏗️' },
            { id: 'brukbet', name: 'BRUK-BET', type: 'Kostka brukowa i płyty', productCount: 2400, status: 'active', icon: '🟫' },
            { id: 'semmelrock', name: 'SEMMELROCK stein+design', type: 'Rozwiązania krajobrazowe', productCount: 295, status: 'active', icon: '🌿' },
            { id: 'polbruk', name: 'POLBRUK S.A.', type: 'Materiały budowlane', productCount: 300, status: 'active', icon: '🏭' },
            { id: 'weber', name: 'WEBER (Saint-Gobain)', type: 'Systemy ociepleń i chemia budowlana', productCount: 69, status: 'active', icon: '🟡' },
            { id: 'leier', name: 'LEIER', type: 'Systemy budowlane', productCount: 106, status: 'active', icon: '🏢' },
            { id: 'uvalue', name: 'Współczynnik U', type: 'Analiza izolacji', productCount: 0, status: 'active', icon: '❄️' },
            { id: 'silikaty', name: 'SILIKATY SZLACHTA', type: 'Bloczki silikatowe', productCount: 45, status: 'active', icon: '⬜' },
            { id: 'docieplenie', name: 'Docieplenie', type: 'Nowy kalkulator ociepleń', productCount: 0, status: 'active', icon: '🧊' },
            { id: 'knauf', name: 'KNAUF Insulation', type: 'Wełna mineralna', productCount: 115, status: 'active', icon: '🧵' },
            { id: 'rockwool', name: 'ROCKWOOL', type: 'Wełna skalna i fasady', productCount: 80, status: 'active', icon: '🪨' },
            { id: 'projects', name: 'Budowy / Inwestycje / Wykonawcy', type: 'CRM inwestycji', productCount: 0, status: 'active', icon: '🏗️' }
        ];

        const MANUFACTURER_ORDER_KEY = 'manufacturer_order';

        const INITIAL_LAST_UPDATE = '1970-01-01T00:00:00.000Z';

        const UVALUE_MATERIALS = [
            {
                id: 'pir-023',
                name: 'Płyta PIR',
                lambda: 0.023,
                color: '#7c3aed',
                description: 'Sztywna płyta poliizocyjanurowa o bardzo niskiej lambdzie'
            },
            {
                id: 'eps-031',
                name: 'Grafitowy EPS',
                lambda: 0.031,
                color: '#2563eb',
                description: 'Popularna izolacja styropianowa λ = 0,031 W/(m·K)'
            },
            {
                id: 'eps-036',
                name: 'EPS 80',
                lambda: 0.036,
                color: '#0ea5e9',
                description: 'Biały styropian fasadowy o standardowej lambdzie'
            },
            {
                id: 'mineral-039',
                name: 'Wełna mineralna',
                lambda: 0.039,
                color: '#f97316',
                description: 'Izolacja z wełny mineralnej λ ≈ 0,039 W/(m·K)'
            },
            {
                id: 'xps-045',
                name: 'Styrodur (XPS)',
                lambda: 0.045,
                color: '#0d9488',
                description: 'Płyta XPS do stref o podwyższonej wilgotności'
            }
        ];

        const UVALUE_THICKNESS_RANGE = { min: 5, max: 40, step: 1 };
        const UVALUE_THICKNESS_PRESETS = [5, 8, 10, 12, 15, 20, 25, 30, 35, 40];
        const UVALUE_TARGETS = [
            { id: 'wt2021', label: 'WT 2021 (U ≤ 0,20)', uLimit: 0.20 },
            { id: 'nf40', label: 'Dom pasywny (U ≤ 0,15)', uLimit: 0.15 }
        ];

        const DOCIEPLENIE_BASE_GROUPS = [
            { id: 'styroType', label: 'Rodzaj styropianu' },
            { id: 'kolki', label: 'Kołki' },
            { id: 'zaslepki', label: 'Zaślepki' },
            { id: 'siatka', label: 'Siatka' },
            { id: 'klejStyro', label: 'Klej do styropianu' },
            { id: 'klejSiatka', label: 'Klej do siatki' },
            { id: 'piana', label: 'Piana do uszczelniania' },
        ];

        const DOCIEPLENIE_STYRO_SHEET_WIDTH = 1;   // m
        const DOCIEPLENIE_STYRO_SHEET_HEIGHT = 0.5; // m
        const DOCIEPLENIE_STYRO_SHEET_AREA = DOCIEPLENIE_STYRO_SHEET_WIDTH * DOCIEPLENIE_STYRO_SHEET_HEIGHT; // 0.5 m2

        const DOCIEPLENIE_INITIAL_PRODUCTS = [
            { id: 'doc_styro_type_eps', name: 'EPS fasada biały λ 0,036', group: 'styroType', priceNet: 98, unit: 'm3', consumptionPerM2: '' },
            { id: 'doc_styro_type_grafit', name: 'EPS grafitowy λ 0,031', group: 'styroType', priceNet: 128, unit: 'm3', consumptionPerM2: '' },
            { id: 'doc_kolki', name: 'Kołki fasadowe 10x160', group: 'kolki', priceNet: 0.95, unit: 'szt', consumptionPerM2: 6 },
            { id: 'doc_zaslepki', name: 'Zaślepki styropianowe Ø60', group: 'zaslepki', priceNet: 0.35, unit: 'szt', consumptionPerM2: 6 },
            { id: 'doc_siatka', name: 'Siatka 145 g/m²', group: 'siatka', priceNet: 2.8, unit: 'm²', consumptionPerM2: 1.1, packageSize: 50, packageUnit: 'm²' },
            { id: 'doc_klej_styro', name: 'Klej do styropianu 25 kg', group: 'klejStyro', priceNet: 22, unit: 'kg', packageSize: 25, packageUnit: 'kg', consumptionPerM2: 3.5 },
            { id: 'doc_klej_siatka', name: 'Klej do siatki 25 kg', group: 'klejSiatka', priceNet: 24, unit: 'kg', packageSize: 25, packageUnit: 'kg', consumptionPerM2: 4.0 },
            { id: 'doc_piana', name: 'Piana do styropianu fasadowa', group: 'piana', priceNet: 24, unit: 'szt', consumptionPerM2: 0.12 },
        ];
        const UVALUE_DEFAULT_COLOR = '#1d4ed8';

        const INITIAL_POROTHERM_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                agreements: [
                    { id: "przyszlosc-1", name: "POROZUMIENIE PRZYSZŁOŚĆ", code: "0624-03 Grzesik przyszłość jagiellońska", validUntil: "2025-06-30", transportCosts: { leborkMalbork: 0, gnaszynMalbork: 0 }, settings: { basicDiscount: 22, margin: 10, cashDiscount: 3, defaultBasicDiscount: '' }, products: [ { id: "pustak-vent-1b-1", name: "PUSTAK WENTYLACYJNY TYP 1B", location: "Lębork", netPrice: 5.9, additionalDiscount: 12, unitsPerPallet: 150, palletsPerTruck: 24, category: "Pustaki wentylacyjne", specifications: "Typ 1B, single channel" }, { id: "pustak-vent-2b90-1", name: "Pustak wentylacyjny dwukanałowy 2B/90", location: "Lębork", netPrice: 9.45, additionalDiscount: 14, unitsPerPallet: 90, palletsPerTruck: 24, category: "Pustaki wentylacyjne", specifications: "Typ 2B/90, double channel" } ], lastUpdate: "2025-09-14" },
                    { id: "przyszlosc-2", name: "POROZUMIENIE PRZYSZŁOŚĆ", code: "0625-EZ Grzesik PBR Przyszłość Lipowiec", validUntil: "2025-07-31", transportCosts: { leborkMalbork: 1100, gnaszynMalbork: 0 }, settings: { basicDiscount: 22, margin: 10, cashDiscount: 3, defaultBasicDiscount: '' }, products: [ { id: "porotherm-25-pw-kl15", name: "POROTHERM 25 P+W KL.15", location: "Lębork", netPrice: 10.9, additionalDiscount: 26, unitsPerPallet: 72, palletsPerTruck: 19, category: "Pustaki budowlane", specifications: "25cm, klasa 15, P+W system" }, { id: "porotherm-25-pw-kl20", name: "POROTHERM 25 P+W KL.20", location: "Lębork", netPrice: 11.2, additionalDiscount: 26, unitsPerPallet: 72, palletsPerTruck: 19, category: "Pustaki budowlane", specifications: "25cm, klasa 20, P+W system" }, { id: "porotherm-188-pw-kl15", name: "POROTHERM 18.8 P+W KL.15", location: "Lębork", netPrice: 13.2, additionalDiscount: 26, unitsPerPallet: 72, palletsPerTruck: 18, category: "Pustaki budowlane", specifications: "18.8cm, klasa 15, P+W system" } ], lastUpdate: "2025-09-14" }
                ],
                defaultAgreementId: "przyszlosc-2",
                migrations: { percentScale: true }
            }
        };

        const INITIAL_SOLBET_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: { transportCost: 2800, discountPercent: 0, margin: 20 },
                products: [
                    {
                        id: "solbet-600-240",
                        name: "SOLBET OPTIMAL 600 - 240mm",
                        density: 600,
                        width: 240,
                        height: 240,
                        length: 590,
                        priceNet: 7.15,
                        category: "standard",
                        unitsPerPallet: 40,
                        palletsPerTruck: 18,
                        mortarType: "thin",
                        mortarConsumption: 2.5
                    },
                    {
                        id: "solbet-500-240",
                        name: "SOLBET OPTIMAL 500 - 240mm",
                        density: 500,
                        width: 240,
                        height: 240,
                        length: 590,
                        priceNet: 6.80,
                        category: "standard",
                        unitsPerPallet: 40,
                        palletsPerTruck: 20,
                        mortarType: "thin",
                        mortarConsumption: 2.5
                    }
                ]
            }
        };

        const INITIAL_SEMMELROCK_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    transportRate: 500,
                    margin: 30,
                    truckWeight: 26,
                    maxPalletsPerTruck: 22,
                    discounts: { 'G1': 0, 'G2': 5, 'G3': 10, 'G4': 15 },
                    defaultDiscounts: { 'G1': '', 'G2': '', 'G3': '', 'G4': '' }
                },
                products: [
                    {
                        symbol: '5538',
                        grupa: 'G2-b',
                        nazwa: 'Umbriano kwarcytowo-biały gr. 8 cm',
                        iloscNaPalecie: 9,
                        jednostka: 'm²',
                        waga: 1.61,
                        cenaNetto: 131.7,
                        maxPalletsPerTruck: 15
                    },
                    {
                        symbol: '5514',
                        grupa: 'G2-b',
                        nazwa: 'Umbriano grafitowo-biały gr. 8 cm',
                        iloscNaPalecie: 9,
                        jednostka: 'm²',
                        waga: 1.61,
                        cenaNetto: 131.7,
                        maxPalletsPerTruck: 15
                    },
                    {
                        symbol: '8223',
                        grupa: 'G2-c',
                        nazwa: 'Linero silva gr. 6 cm',
                        iloscNaPalecie: 11.25,
                        jednostka: 'm²',
                        waga: 1.46,
                        cenaNetto: 80.9,
                        maxPalletsPerTruck: 16
                    }
                ]
            }
        };

        const INITIAL_BRUKBET_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    transportRate: 500,
                    margin: 30,
                    factory: "brukbet-main",
                    factories: [
                        { id: "brukbet-main", nazwa: "BRUK-BET Zakład Główny", kosztTransportu: 500 },
                        { id: "brukbet-north", nazwa: "BRUK-BET Północ", kosztTransportu: 450 },
                        { id: "brukbet-south", nazwa: "BRUK-BET Południe", kosztTransportu: 550 }
                    ],
                    maxPalletsPerTruck: 22,
                    discounts: {
                        'PRESTIGE': 0,
                        'UNI-DECOR': 5,
                        'STANDARD': 10,
                        'WYROBY UZUPEŁNIAJĄCE': 15
                    },
                    defaultDiscounts: {
                        'PRESTIGE': '',
                        'UNI-DECOR': '',
                        'STANDARD': '',
                        'WYROBY UZUPEŁNIAJĄCE': ''
                    }
                },
                products: [
                    {
                        id: "bruk_1",
                        symbol: "1-MB-SC-RBI-RU0-TI",
                        grupa: "PRESTIGE",
                        nazwa: "Bloczek ogrodowy SCALA 60x19x15 cm – graniton biały (rustical)",
                        zp: "Kielce",
                        waga: 1.9,
                        maxPalletsPerTruck: 12,
                        iloscNaPalecie: 50,
                        jednostka: "szt.",
                        cenaNetto: 67.7
                    },
                    {
                        id: "bruk_2",
                        symbol: "2-KD-HOLLAND-BLE-U0",
                        grupa: "STANDARD",
                        nazwa: "Holland 21x7x10,5 cm – betonowy szary",
                        zp: "Tarnów",
                        waga: 1.8,
                        maxPalletsPerTruck: 14,
                        iloscNaPalecie: 198,
                        jednostka: "szt.",
                        cenaNetto: 1.35
                    }
                ]
            }
        };
        const INITIAL_POLBRUK_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: { transportRate: 500, margin: 30, truckWeight: 24, maxPalletsPerTruck: 22 },
                products: [
                    { symbol: 'PLB001', nazwa: 'Polbruk płukany gr. 4 cm: WESTA', ksztalt: 'Płukany', kolorystyka: '', jednostka: 'm²', iloscNaPalecie: 12, waga: 1.6, maxPalletsPerTruck: 14, cenaNetto: 65.40, rabat: 42.7 },
                    { symbol: 'PLB002', nazwa: 'Polbruk gładki gr. 4 cm: NAPOLI', ksztalt: '', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 12, waga: 1.6, maxPalletsPerTruck: 14, cenaNetto: 56.60, rabat: 40.8 },
                    { symbol: 'PLB003', nazwa: 'Polbruk gładki | monokolor | gr. 4.5 cm I płyta: LAMELL', ksztalt: '4.5x40x60', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 80, waga: 1.2, maxPalletsPerTruck: 18, cenaNetto: 19.90, rabat: 40.2 },
                    { symbol: 'PLB004', nazwa: 'Polbruk gładki | melanż | gr. 6 cm: IDEO, CARMINO, GRANITO', ksztalt: 'Gładka', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 10, waga: 1.5, maxPalletsPerTruck: 15, cenaNetto: 73.50, rabat: 44.2 },
                    { symbol: 'PLB005', nazwa: 'Polbruk płukany gr. 6 cm: AVANTI, COMPLEX, TRENTO', ksztalt: 'Płukany', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 10, waga: 1.5, maxPalletsPerTruck: 15, cenaNetto: 83.40, rabat: 43.7 },
                    { symbol: 'PLB006', nazwa: 'Polbruk postarzany gr. 6 cm: CARMINO, NAPOLI, METRIK', ksztalt: 'Postarzany', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 10, waga: 1.6, maxPalletsPerTruck: 14, cenaNetto: 99.00, rabat: 44.4 },
                    { symbol: 'PLB007', nazwa: 'Polbruk LUMIA 10x20, gr. 6 cm', ksztalt: 'Specjalny', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 200, waga: 1.1, maxPalletsPerTruck: 20, cenaNetto: 8.40, rabat: 16.7 },
                    { symbol: 'PLB008', nazwa: 'Polbruk gładki | melanż | gr. 8 cm | płyta: MAGNA 50x75', ksztalt: '8x50x75', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 30, waga: 1.8, maxPalletsPerTruck: 13, cenaNetto: 40.00, rabat: 38.8 },
                    { symbol: 'PLB009', nazwa: 'Polbruk płukany gr. 8 cm: AVANTI, URBANIKA, NAPOLI', ksztalt: 'Płukany', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 8, waga: 1.8, maxPalletsPerTruck: 13, cenaNetto: 99.00, rabat: 43.9 },
                    { symbol: 'PLB010', nazwa: 'Polbruk gładki | melanż | gr. 8 cm I płyta: BOSSO 60X60', ksztalt: '8x60x60', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 25, waga: 1.8, maxPalletsPerTruck: 13, cenaNetto: 49.00, rabat: 42.9 },
                    { symbol: 'PLB011', nazwa: 'Polbruk drobnopłukany | kolor | PŁYTA PLANO 8x80x80', ksztalt: 'Płukany', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 20, waga: 1.9, maxPalletsPerTruck: 12, cenaNetto: 98.00, rabat: 43.9 },
                    { symbol: 'PLB012', nazwa: 'Polbruk gładki | melanż | gr. 8 cm : DYNAMIK', ksztalt: '8x14x50', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 9, waga: 1.7, maxPalletsPerTruck: 13, cenaNetto: 89.00, rabat: 44.9 },
                    { symbol: 'PLB013', nazwa: 'Polbruk gładki gr. 4 cm: NOSTALITE, NAPOLI', ksztalt: '', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 14, waga: 1.2, maxPalletsPerTruck: 18, cenaNetto: 48.00, rabat: 42.3 },
                    { symbol: 'PLB014', nazwa: 'Obrzeże TREO | szary | 8x30x50 | drobnoutwardzony', ksztalt: '50x30x08', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 60, waga: 1.4, maxPalletsPerTruck: 16, cenaNetto: 21.55, rabat: 25.8 },
                    { symbol: 'PLB015', nazwa: 'Polbruk gr. 6 cm z fazą / bez fazy', ksztalt: 'Prostokąt, Tetka', kolorystyka: '', jednostka: 'm2', iloscNaPalecie: 10, waga: 1.5, maxPalletsPerTruck: 15, cenaNetto: 55.00, rabat: 47.3 },
                    { symbol: 'PLB016', nazwa: 'Płytka chodnikowa 30x30 gładka gr. 5 cm', ksztalt: '30X30X5', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 100, waga: 1.1, maxPalletsPerTruck: 20, cenaNetto: 5.40, rabat: 40.7 },
                    { symbol: 'PLB017', nazwa: 'Płyta MEBA gr. 12 cm', ksztalt: '40X60', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 40, waga: 1.6, maxPalletsPerTruck: 14, cenaNetto: 25.68, rabat: 46.9 },
                    { symbol: 'PLB018', nazwa: 'Krawężnik lekki 15', ksztalt: '15X30X100', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 30, waga: 1.8, maxPalletsPerTruck: 13, cenaNetto: 38.88, rabat: 48.6 },
                    { symbol: 'PLB019', nazwa: 'Obrzeże trawnikowe 6x20x100', ksztalt: '6x20x100', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 90, waga: 1.3, maxPalletsPerTruck: 17, cenaNetto: 14.30, rabat: 47.6 },
                    { symbol: 'PLB020', nazwa: 'Gazon ogrodowy MINI LUNA', ksztalt: 'Fi 35X20', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 50, waga: 1, maxPalletsPerTruck: 22, cenaNetto: 10.10, rabat: 27.7 },
                    { symbol: 'PLB021', nazwa: 'Ogrodzenie Polbruk NEO - Pustak', ksztalt: '60x20x10', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 45, waga: 1.7, maxPalletsPerTruck: 13, cenaNetto: 12.96, rabat: 32.5 },
                    { symbol: 'PLB022', nazwa: 'Stopień schodowy GRANDO 15x40x100 łamany', ksztalt: '15x40x100', kolorystyka: '', jednostka: 'szt', iloscNaPalecie: 10, waga: 2.0, maxPalletsPerTruck: 12, cenaNetto: 135.00, rabat: 40.0 },
                ]
            }
        };

        const INITIAL_SILIKATY_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    transportHds: '0',
                    transportBezHds: '0',
                    palletsPerTruck: '20',
                    margin: '20',
                    discountStandard: '0',
                    discountInwest: '0',
                    defaultDiscountNote: '',
                },
                modes: { transport: 'hds', discount: 'standard' },
                filters: { searchTerm: '' },
                products: [
                    {
                        id: 'silikat_n1',
                        name: 'Cegła N1 kl.20',
                        priceNet: 1.95,
                        unitsPerPallet: 288,
                        consumptionPerM2: 55,
                        className: '20',
                        weight: 3,
                        dimensions: '',
                    },
                    {
                        id: 'silikat_wentylacyjny_15',
                        name: 'Pustak wentylacyjny kl.15',
                        priceNet: 7.8,
                        unitsPerPallet: 64,
                        consumptionPerM2: '',
                        className: '15',
                        weight: 16,
                        dimensions: '',
                    },
                    {
                        id: 'silikat_n24_15',
                        name: 'Blok N24 kl.15',
                        priceNet: 6.95,
                        unitsPerPallet: 64,
                        consumptionPerM2: 17.5,
                        className: '15',
                        weight: 19,
                        dimensions: '',
                    },
                    {
                        id: 'silikat_n12_15',
                        name: 'Bloczek N12 kl.15',
                        priceNet: 3.49,
                        unitsPerPallet: 128,
                        consumptionPerM2: 17.5,
                        className: '15',
                        weight: 9.5,
                        dimensions: '',
                    },
                ],
            }
        };

        const INITIAL_DOCIEPLENIE_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                notes: '',
                styroThicknessCm: '15',
                surfaceArea: '100',
                settings: {
                    margin: '20',
                    transportCost: '0',
                },
                groups: DOCIEPLENIE_BASE_GROUPS,
                selections: DOCIEPLENIE_BASE_GROUPS.reduce((acc, group) => {
                    acc[group.id] = DOCIEPLENIE_INITIAL_PRODUCTS.find((p) => p.group === group.id)?.id || '';
                    return acc;
                }, {}),
                products: DOCIEPLENIE_INITIAL_PRODUCTS,
                filters: { productSearch: '' },
                quantityAdjustments: DOCIEPLENIE_BASE_GROUPS.reduce((acc, group) => {
                    acc[group.id] = '';
                    return acc;
                }, {}),
            }
        };

        const INITIAL_ROCKWOOL_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    defaultMargin: '18',
                    defaultWaste: '5',
                    vatRate: '23',
                    discounts: {
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                    },
                    defaultDiscounts: {
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                    }
                },
                filters: { planSearch: '', productSearch: '' },
                products: [
                    {"id":"rw-rockton-premium-50","name":"ROCKTON PREMIUM 50mm","lambda":0.033,"thicknessCm":5,"coveragePerPack":7.32,"pricePerPack":220.33,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-rockton-premium-100","name":"ROCKTON PREMIUM 100mm","lambda":0.033,"thicknessCm":10,"coveragePerPack":3.66,"pricePerPack":220.73,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-rockton-premium-150","name":"ROCKTON PREMIUM 150mm","lambda":0.033,"thicknessCm":15,"coveragePerPack":2.44,"pricePerPack":227.68,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-rockton-premium-200","name":"ROCKTON PREMIUM 200mm","lambda":0.033,"thicknessCm":20,"coveragePerPack":1.83,"pricePerPack":233.89,"note":"Płyta 1000x610mm (3 szt w op.)"},
                    {"id":"rw-rockton-super-50","name":"ROCKTON SUPER 50mm","lambda":0.036,"thicknessCm":5,"coveragePerPack":7.32,"pricePerPack":174,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-rockton-super-60","name":"ROCKTON SUPER 60mm","lambda":0.035,"thicknessCm":6,"coveragePerPack":6.1,"pricePerPack":185.01,"note":"Płyta 1000x610mm (10 szt w op.)"},
                    {"id":"rw-rockton-super-70","name":"ROCKTON SUPER 70mm","lambda":0.035,"thicknessCm":7,"coveragePerPack":4.88,"pricePerPack":156.6,"note":"Płyta 1000x610mm (8 szt w op.)"},
                    {"id":"rw-rockton-super-80","name":"ROCKTON SUPER 80mm","lambda":0.036,"thicknessCm":8,"coveragePerPack":3.66,"pricePerPack":161,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-rockton-super-100","name":"ROCKTON SUPER 100mm","lambda":0.035,"thicknessCm":10,"coveragePerPack":3.66,"pricePerPack":174.33,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-rockton-super-120","name":"ROCKTON SUPER 120mm","lambda":0.035,"thicknessCm":12,"coveragePerPack":3.05,"pricePerPack":189.28,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-rockton-super-140","name":"ROCKTON SUPER 140mm","lambda":0.035,"thicknessCm":14,"coveragePerPack":2.44,"pricePerPack":184.17,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-rockton-super-150","name":"ROCKTON SUPER 150mm","lambda":0.035,"thicknessCm":15,"coveragePerPack":2.44,"pricePerPack":179.8,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-rockton-super-160","name":"ROCKTON SUPER 160mm","lambda":0.035,"thicknessCm":16,"coveragePerPack":1.83,"pricePerPack":162.38,"note":"Płyta 1000x610mm (3 szt w op.)"},
                    {"id":"rw-rockton-super-180","name":"ROCKTON SUPER 180mm","lambda":0.035,"thicknessCm":18,"coveragePerPack":1.83,"pricePerPack":176.19,"note":"Płyta 1000x610mm (3 szt w op.)"},
                    {"id":"rw-rockton-super-200","name":"ROCKTON SUPER 200mm","lambda":0.035,"thicknessCm":20,"coveragePerPack":1.83,"pricePerPack":190.01,"note":"Płyta 1000x610mm (3 szt w op.)"},
                    {"id":"rw-toprock-premium-100","name":"TOPROCK PREMIUM 100mm","lambda":0.035,"thicknessCm":10,"coveragePerPack":5,"pricePerPack":197.65,"note":"Rolka 5000x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-premium-120","name":"TOPROCK PREMIUM 120mm","lambda":0.035,"thicknessCm":12,"coveragePerPack":4.5,"pricePerPack":246.38,"note":"Rolka 4500x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-premium-150","name":"TOPROCK PREMIUM 150mm","lambda":0.035,"thicknessCm":15,"coveragePerPack":3.5,"pricePerPack":208.08,"note":"Rolka 3500x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-premium-180","name":"TOPROCK PREMIUM 180mm","lambda":0.035,"thicknessCm":18,"coveragePerPack":2.5,"pricePerPack":192.82,"note":"Rolka 2500x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-premium-200","name":"TOPROCK PREMIUM 200mm","lambda":0.035,"thicknessCm":20,"coveragePerPack":2.5,"pricePerPack":199,"note":"Rolka 2500x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-super-100","name":"TOPROCK SUPER 100mm","lambda":0.037,"thicknessCm":10,"coveragePerPack":3.5,"pricePerPack":125.2,"note":"Rolka 3500x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-super-150","name":"TOPROCK SUPER 150mm","lambda":0.037,"thicknessCm":15,"coveragePerPack":2.4,"pricePerPack":129.24,"note":"Rolka 2400x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-super-180","name":"TOPROCK SUPER 180mm","lambda":0.037,"thicknessCm":18,"coveragePerPack":2,"pricePerPack":139.72,"note":"Rolka 2000x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-super-200","name":"TOPROCK SUPER 200mm","lambda":0.037,"thicknessCm":20,"coveragePerPack":1.8,"pricePerPack":129.74,"note":"Rolka 1800x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-plus-100","name":"TOPROCK PLUS 100mm","lambda":0.039,"thicknessCm":10,"coveragePerPack":4,"pricePerPack":118.36,"note":"Rolka 2x2000x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-plus-150","name":"TOPROCK PLUS 150mm","lambda":0.039,"thicknessCm":15,"coveragePerPack":3,"pricePerPack":132.78,"note":"Rolka 3000x1000mm (1 szt w op.)"},
                    {"id":"rw-toprock-plus-200","name":"TOPROCK PLUS 200mm","lambda":0.039,"thicknessCm":20,"coveragePerPack":2,"pricePerPack":117.86,"note":"Rolka 2000x1000mm (1 szt w op.)"},
                    {"id":"rw-superrock-premium-50","name":"SUPERROCK PREMIUM 50mm","lambda":0.034,"thicknessCm":5,"coveragePerPack":9.15,"pricePerPack":221.8,"note":"Płyta 1000x610mm (15 szt w op.)"},
                    {"id":"rw-superrock-premium-75","name":"SUPERROCK PREMIUM 75mm","lambda":0.034,"thicknessCm":7.5,"coveragePerPack":6.1,"pricePerPack":261.51,"note":"Płyta 1000x610mm (10 szt w op.)"},
                    {"id":"rw-superrock-premium-100","name":"SUPERROCK PREMIUM 100mm","lambda":0.034,"thicknessCm":10,"coveragePerPack":4.88,"pricePerPack":225.21,"note":"Płyta 1000x610mm (8 szt w op.)"},
                    {"id":"rw-superrock-premium-150","name":"SUPERROCK PREMIUM 150mm","lambda":0.034,"thicknessCm":15,"coveragePerPack":3.05,"pricePerPack":216.18,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-superrock-premium-180","name":"SUPERROCK PREMIUM 180mm","lambda":0.034,"thicknessCm":18,"coveragePerPack":2.44,"pricePerPack":223.82,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-superrock-premium-200","name":"SUPERROCK PREMIUM 200mm","lambda":0.034,"thicknessCm":20,"coveragePerPack":2.44,"pricePerPack":229.77,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-superrock-premium-50-565","name":"SUPERROCK PREMIUM 50mm","lambda":0.034,"thicknessCm":5,"coveragePerPack":8.47,"pricePerPack":205.31,"note":"Płyta 1000x565mm (15 szt w op.)"},
                    {"id":"rw-superrock-premium-100-565","name":"SUPERROCK PREMIUM 100mm","lambda":0.034,"thicknessCm":10,"coveragePerPack":4.52,"pricePerPack":208.6,"note":"Płyta 1000x565mm (8 szt w op.)"},
                    {"id":"rw-superrock-premium-150-565","name":"SUPERROCK PREMIUM 150mm","lambda":0.034,"thicknessCm":15,"coveragePerPack":2.82,"pricePerPack":199.88,"note":"Płyta 1000x565mm (5 szt w op.)"},
                    {"id":"rw-superrock-premium-200-565","name":"SUPERROCK PREMIUM 200mm","lambda":0.034,"thicknessCm":20,"coveragePerPack":2.26,"pricePerPack":212.82,"note":"Płyta 1000x565mm (4 szt w op.)"},
                    {"id":"rw-superrock-50","name":"SUPERROCK 50mm","lambda":0.036,"thicknessCm":5,"coveragePerPack":9.15,"pricePerPack":189.31,"note":"Płyta 1000x610mm (15 szt w op.)"},
                    {"id":"rw-superrock-60","name":"SUPERROCK 60mm","lambda":0.035,"thicknessCm":6,"coveragePerPack":7.32,"pricePerPack":190.03,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-superrock-75","name":"SUPERROCK 75mm","lambda":0.036,"thicknessCm":7.5,"coveragePerPack":6.1,"pricePerPack":216.85,"note":"Płyta 1000x610mm (10 szt w op.)"},
                    {"id":"rw-superrock-100","name":"SUPERROCK 100mm","lambda":0.035,"thicknessCm":10,"coveragePerPack":4.88,"pricePerPack":192.27,"note":"Płyta 1000x610mm (8 szt w op.)"},
                    {"id":"rw-superrock-120","name":"SUPERROCK 120mm","lambda":0.035,"thicknessCm":12,"coveragePerPack":4.27,"pricePerPack":235.66,"note":"Płyta 1000x610mm (7 szt w op.)"},
                    {"id":"rw-superrock-140","name":"SUPERROCK 140mm","lambda":0.035,"thicknessCm":14,"coveragePerPack":3.66,"pricePerPack":216.38,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-superrock-150","name":"SUPERROCK 150mm","lambda":0.035,"thicknessCm":15,"coveragePerPack":3.05,"pricePerPack":181.08,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-superrock-160","name":"SUPERROCK 160mm","lambda":0.035,"thicknessCm":16,"coveragePerPack":3.05,"pricePerPack":212.55,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-superrock-180","name":"SUPERROCK 180mm","lambda":0.035,"thicknessCm":18,"coveragePerPack":2.44,"pricePerPack":191.15,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-superrock-200","name":"SUPERROCK 200mm","lambda":0.035,"thicknessCm":20,"coveragePerPack":2.44,"pricePerPack":196.08,"note":"Płyta 1000x610mm (4 szt w op.)"},
                    {"id":"rw-superrock-60-580","name":"SUPERROCK 60mm","lambda":0.035,"thicknessCm":6,"coveragePerPack":6.96,"pricePerPack":180.68,"note":"Płyta 1000x580mm (12 szt w op.)"},
                    {"id":"rw-superrock-80-580","name":"SUPERROCK 80mm","lambda":0.036,"thicknessCm":8,"coveragePerPack":5.8,"pricePerPack":206.19,"note":"Płyta 1000x580mm (10 szt w op.)"},
                    {"id":"rw-superrock-100-580","name":"SUPERROCK 100mm","lambda":0.035,"thicknessCm":10,"coveragePerPack":4.64,"pricePerPack":182.82,"note":"Płyta 1000x580mm (8 szt w op.)"},
                    {"id":"rw-superrock-120-580","name":"SUPERROCK 120mm","lambda":0.035,"thicknessCm":12,"coveragePerPack":4.06,"pricePerPack":224.07,"note":"Płyta 1000x580mm (7 szt w op.)"},
                    {"id":"rw-superrock-140-580","name":"SUPERROCK 140mm","lambda":0.035,"thicknessCm":14,"coveragePerPack":3.48,"pricePerPack":205.74,"note":"Płyta 1000x580mm (6 szt w op.)"},
                    {"id":"rw-superrock-160-580","name":"SUPERROCK 160mm","lambda":0.035,"thicknessCm":16,"coveragePerPack":2.9,"pricePerPack":202.1,"note":"Płyta 1000x580mm (5 szt w op.)"},
                    {"id":"rw-superrock-180-580","name":"SUPERROCK 180mm","lambda":0.035,"thicknessCm":18,"coveragePerPack":2.32,"pricePerPack":181.75,"note":"Płyta 1000x580mm (4 szt w op.)"},
                    {"id":"rw-superrock-50-565","name":"SUPERROCK 50mm","lambda":0.036,"thicknessCm":5,"coveragePerPack":8.47,"pricePerPack":175.24,"note":"Płyta 1000x565mm (15 szt w op.)"},
                    {"id":"rw-superrock-75-565","name":"SUPERROCK 75mm","lambda":0.036,"thicknessCm":7.5,"coveragePerPack":5.65,"pricePerPack":200.86,"note":"Płyta 1000x565mm (10 szt w op.)"},
                    {"id":"rw-superrock-100-565","name":"SUPERROCK 100mm","lambda":0.035,"thicknessCm":10,"coveragePerPack":4.52,"pricePerPack":178.09,"note":"Płyta 1000x565mm (8 szt w op.)"},
                    {"id":"rw-superrock-150-565","name":"SUPERROCK 150mm","lambda":0.035,"thicknessCm":15,"coveragePerPack":2.82,"pricePerPack":167.42,"note":"Płyta 1000x565mm (5 szt w op.)"},
                    {"id":"rw-superrock-200-565","name":"SUPERROCK 200mm","lambda":0.035,"thicknessCm":20,"coveragePerPack":2.26,"pricePerPack":181.61,"note":"Płyta 1000x565mm (4 szt w op.)"},
                    {"id":"rw-rockmin-plus-50","name":"ROCKMIN PLUS 50mm","lambda":0.037,"thicknessCm":5,"coveragePerPack":10.98,"pricePerPack":160.2,"note":"Płyta 1000x610mm (18 szt w op.)"},
                    {"id":"rw-rockmin-plus-60","name":"ROCKMIN PLUS 60mm","lambda":0.037,"thicknessCm":6,"coveragePerPack":9.15,"pricePerPack":170.37,"note":"Płyta 1000x610mm (15 szt w op.)"},
                    {"id":"rw-rockmin-plus-75","name":"ROCKMIN PLUS 75mm","lambda":0.037,"thicknessCm":7.5,"coveragePerPack":7.32,"pricePerPack":177.44,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-rockmin-plus-80","name":"ROCKMIN PLUS 80mm","lambda":0.037,"thicknessCm":8,"coveragePerPack":7.32,"pricePerPack":190.91,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-rockmin-plus-100","name":"ROCKMIN PLUS 100mm","lambda":0.037,"thicknessCm":10,"coveragePerPack":6.1,"pricePerPack":178.61,"note":"Płyta 1000x610mm (10 szt w op.)"},
                    {"id":"rw-rockmin-plus-120","name":"ROCKMIN PLUS 120mm","lambda":0.037,"thicknessCm":12,"coveragePerPack":4.88,"pricePerPack":183.83,"note":"Płyta 1000x610mm (8 szt w op.)"},
                    {"id":"rw-rockmin-plus-140","name":"ROCKMIN PLUS 140mm","lambda":0.037,"thicknessCm":14,"coveragePerPack":4.27,"pricePerPack":187.03,"note":"Płyta 1000x610mm (7 szt w op.)"},
                    {"id":"rw-rockmin-plus-150","name":"ROCKMIN PLUS 150mm","lambda":0.037,"thicknessCm":15,"coveragePerPack":3.66,"pricePerPack":159.39,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-rockmin-plus-160","name":"ROCKMIN PLUS 160mm","lambda":0.037,"thicknessCm":16,"coveragePerPack":3.66,"pricePerPack":188.45,"note":"Płyta 1000x610mm (6 szt w op.)"},
                    {"id":"rw-rockmin-plus-180","name":"ROCKMIN PLUS 180mm","lambda":0.037,"thicknessCm":18,"coveragePerPack":3.05,"pricePerPack":169.98,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-rockmin-plus-200","name":"ROCKMIN PLUS 200mm","lambda":0.037,"thicknessCm":20,"coveragePerPack":3.05,"pricePerPack":180.62,"note":"Płyta 1000x610mm (5 szt w op.)"},
                    {"id":"rw-rockmin-plus-50-565","name":"ROCKMIN PLUS 50mm","lambda":0.037,"thicknessCm":5,"coveragePerPack":10.17,"pricePerPack":148.38,"note":"Płyta 1000x565mm (18 szt w op.)"},
                    {"id":"rw-rockmin-plus-100-565","name":"ROCKMIN PLUS 100mm","lambda":0.037,"thicknessCm":10,"coveragePerPack":5.65,"pricePerPack":165.43,"note":"Płyta 1000x565mm (10 szt w op.)"},
                    {"id":"rw-rockmin-50","name":"ROCKMIN 50mm","lambda":0.04,"thicknessCm":5,"coveragePerPack":10.98,"pricePerPack":124.73,"note":"Płyta 1000x610mm (18 szt w op.)"},
                    {"id":"rw-rockmin-75","name":"ROCKMIN 75mm","lambda":0.039,"thicknessCm":7.5,"coveragePerPack":7.32,"pricePerPack":111.78,"note":"Płyta 1000x610mm (12 szt w op.)"},
                    {"id":"rw-rockmin-100","name":"ROCKMIN 100mm","lambda":0.039,"thicknessCm":10,"coveragePerPack":6.1,"pricePerPack":137.56,"note":"Płyta 1000x610mm (10 szt w op.)"},
                    {"id":"rw-rockmin-150","name":"ROCKMIN 150mm","lambda":0.039,"thicknessCm":15,"coveragePerPack":3.66,"pricePerPack":122.46,"note":"Płyta 1000x610mm (6 szt w op.)"}
                ],
                plans: [
                    {
                        id: 'rw-plan-1',
                        name: 'Strefa startowa',
                        productId: 'rw-rockton-premium-50',
                        area: 120,
                        wastePercent: '5',
                        margin: '18',
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                        extraNote: 'Przykładowy scenariusz - edytuj lub usuń'
                    }
                ],
            }
        };

        const INITIAL_KNAUF_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    defaultMargin: '18',
                    defaultWaste: '5',
                    vatRate: '23',
                    discounts: {
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                    },
                    defaultDiscounts: {
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                    }
                },
                filters: { planSearch: '', productSearch: '' },
                products: [
                                    {
                                                        "id": "kn-akustikboard-100-600",
                                                        "name": "AKUSTIKBOARD 100mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 8.0,
                                                        "pricePerPack": 248.8,
                                                        "note": "600x1250mm; kod: 673184"
                                    },
                                    {
                                                        "id": "kn-akustikboard-150-600",
                                                        "name": "AKUSTIKBOARD 150mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 3.75,
                                                        "pricePerPack": 174.75,
                                                        "note": "600x1250.4mm; kod: 842073"
                                    },
                                    {
                                                        "id": "kn-akustikboard-50-600",
                                                        "name": "AKUSTIKBOARD 50mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 16.0,
                                                        "pricePerPack": 248.0,
                                                        "note": "600x1250mm; kod: 673175"
                                    },
                                    {
                                                        "id": "kn-akustikboard-75-6-1250.2",
                                                        "name": "AKUSTIKBOARD 75.6mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 7.56,
                                                        "coveragePerPack": 7.5,
                                                        "pricePerPack": 174.75,
                                                        "note": "1250.2x7.5mm; kod: 673181"
                                    },
                                    {
                                                        "id": "kn-clt-c1-100-0-200",
                                                        "name": "CLT C1 THERMAL 100mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 217.08,
                                                        "note": "200x1000mm; kod: 807400"
                                    },
                                    {
                                                        "id": "kn-clt-c1-120-0-200",
                                                        "name": "CLT C1 THERMAL 120mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 240.12,
                                                        "note": "200x1000mm; kod: 807401"
                                    },
                                    {
                                                        "id": "kn-clt-c1-140-0-200",
                                                        "name": "CLT C1 THERMAL 140mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 261.54,
                                                        "note": "200x1000mm; kod: 807402"
                                    },
                                    {
                                                        "id": "kn-clt-c1-150-0-200",
                                                        "name": "CLT C1 THERMAL 150mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 190.8,
                                                        "note": "200x1000mm; kod: 807403"
                                    },
                                    {
                                                        "id": "kn-clt-c1-160-0-200",
                                                        "name": "CLT C1 THERMAL 160mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 193.32,
                                                        "note": "200x1000mm; kod: 807404"
                                    },
                                    {
                                                        "id": "kn-clt-c1-180-0-200",
                                                        "name": "CLT C1 THERMAL 180mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 220.32,
                                                        "note": "200x1000mm; kod: 807405"
                                    },
                                    {
                                                        "id": "kn-clt-c1-200-0-200",
                                                        "name": "CLT C1 THERMAL 200mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 225.48,
                                                        "note": "200x1000mm; kod: 807406"
                                    },
                                    {
                                                        "id": "kn-clt-c1-220-0-200",
                                                        "name": "CLT C1 THERMAL 220mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 22.0,
                                                        "coveragePerPack": 0.6,
                                                        "pricePerPack": 127.92,
                                                        "note": "200x1000mm; kod: 807407"
                                    },
                                    {
                                                        "id": "kn-clt-c1-240-0-200",
                                                        "name": "CLT C1 THERMAL 240mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 24.0,
                                                        "coveragePerPack": 0.6,
                                                        "pricePerPack": 132.48,
                                                        "note": "200x1000mm; kod: 807408"
                                    },
                                    {
                                                        "id": "kn-clt-c1-50-0-200",
                                                        "name": "CLT C1 THERMAL 50mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 3.6,
                                                        "pricePerPack": 295.92,
                                                        "note": "200x1000mm; kod: 807409"
                                    },
                                    {
                                                        "id": "kn-clt-c1-60-0-200",
                                                        "name": "CLT C1 THERMAL 60mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 269.7,
                                                        "note": "200x1000mm; kod: 807410"
                                    },
                                    {
                                                        "id": "kn-clt-c1-80-0-200",
                                                        "name": "CLT C1 THERMAL 80mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 246.0,
                                                        "note": "200x1000mm; kod: 807411"
                                    },
                                    {
                                                        "id": "kn-ddp-x-100-0-1200",
                                                        "name": "DDP-X 100mm",
                                                        "lambda": 0.039,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 31.2,
                                                        "pricePerPack": 3734.64,
                                                        "note": "1200x2000mm; kod: 473633"
                                    },
                                    {
                                                        "id": "kn-ddp-x-120-0-1200",
                                                        "name": "DDP-X 120mm",
                                                        "lambda": 0.039,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 26.4,
                                                        "pricePerPack": 3796.32,
                                                        "note": "1200x2000mm; kod: 529430"
                                    },
                                    {
                                                        "id": "kn-ddp-x-60-0-1200",
                                                        "name": "DDP-X 60mm",
                                                        "lambda": 0.039,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 52.8,
                                                        "pricePerPack": 3796.32,
                                                        "note": "1200x2000mm; kod: 677316"
                                    },
                                    {
                                                        "id": "kn-ddp-x-80-0-1200",
                                                        "name": "DDP-X 80mm",
                                                        "lambda": 0.039,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 38.4,
                                                        "pricePerPack": 3724.8,
                                                        "note": "1200x2000mm; kod: 470206"
                                    },
                                    {
                                                        "id": "kn-ekoboard-100-600",
                                                        "name": "EKOBOARD 100mm",
                                                        "lambda": 0.039,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 8.0,
                                                        "pricePerPack": 212.8,
                                                        "note": "600x1250mm; kod: 501426"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-100-0-400",
                                                        "name": "FKD N THERMAL 400x1200 100mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 1.44,
                                                        "pricePerPack": 112.03,
                                                        "note": "400x1200mm; kod: 841056"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-120-0-400",
                                                        "name": "FKD N THERMAL 400x1200 120mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 1.44,
                                                        "pricePerPack": 135.07,
                                                        "note": "400x1200mm; kod: 841058"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-140-0-400",
                                                        "name": "FKD N THERMAL 400x1200 140mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 1.44,
                                                        "pricePerPack": 157.82,
                                                        "note": "400x1200mm; kod: 841059"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-150-0-400",
                                                        "name": "FKD N THERMAL 400x1200 150mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 1.44,
                                                        "pricePerPack": 168.48,
                                                        "note": "400x1200mm; kod: 841060"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-160-0-400",
                                                        "name": "FKD N THERMAL 400x1200 160mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 0.96,
                                                        "pricePerPack": 119.42,
                                                        "note": "400x1200mm; kod: 841062"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-180-0-400",
                                                        "name": "FKD N THERMAL 400x1200 180mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 0.96,
                                                        "pricePerPack": 133.25,
                                                        "note": "400x1200mm; kod: 841063"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-200-0-400",
                                                        "name": "FKD N THERMAL 400x1200 200mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 0.96,
                                                        "pricePerPack": 150.53,
                                                        "note": "400x1200mm; kod: 841064"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-220-0-400",
                                                        "name": "FKD N THERMAL 400x1200 220mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 22.0,
                                                        "coveragePerPack": 0.96,
                                                        "pricePerPack": 164.93,
                                                        "note": "400x1200mm; kod: 841065"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-240-0-400",
                                                        "name": "FKD N THERMAL 400x1200 240mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 24.0,
                                                        "coveragePerPack": 0.48,
                                                        "pricePerPack": 89.52,
                                                        "note": "400x1200mm; kod: 841066"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-245-0-400",
                                                        "name": "FKD N THERMAL 400x1200 245mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 24.5,
                                                        "coveragePerPack": 0.48,
                                                        "pricePerPack": 91.49,
                                                        "note": "400x1200mm; kod: 841068"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-50-0-400",
                                                        "name": "FKD N THERMAL 400x1200 50mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 2.88,
                                                        "pricePerPack": 113.18,
                                                        "note": "400x1200mm; kod: 841050"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-60-0-400",
                                                        "name": "FKD N THERMAL 400x1200 60mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 112.8,
                                                        "note": "400x1200mm; kod: 841052"
                                    },
                                    {
                                                        "id": "kn-fkd-n-thermal-80-0-400",
                                                        "name": "FKD N THERMAL 400x1200 80mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 1.92,
                                                        "pricePerPack": 120.38,
                                                        "note": "400x1200mm; kod: 841054"
                                    },
                                    {
                                                        "id": "kn-fkd-rs-20-0-600",
                                                        "name": "FKD RS 20mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 2.0,
                                                        "coveragePerPack": 7.2,
                                                        "pricePerPack": 144.0,
                                                        "note": "600x1000mm; kod: 654345"
                                    },
                                    {
                                                        "id": "kn-fkd-rs-40-0-600",
                                                        "name": "FKD RS 40mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 191.52,
                                                        "note": "600x1000mm; kod: 654335"
                                    },
                                    {
                                                        "id": "kn-fpl-035-100-0-600",
                                                        "name": "FPL 035 GVB 100mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 212.1,
                                                        "note": "600x1000mm; kod: 450768"
                                    },
                                    {
                                                        "id": "kn-fpl-035-120-0-600",
                                                        "name": "FPL 035 GVB 120mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 200.88,
                                                        "note": "600x1000mm; kod: 429166"
                                    },
                                    {
                                                        "id": "kn-fpl-035-140-0-600",
                                                        "name": "FPL 035 GVB 140mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 173.16,
                                                        "note": "600x1000mm; kod: 450803"
                                    },
                                    {
                                                        "id": "kn-fpl-035-150-0-600",
                                                        "name": "FPL 035 GVB 150mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 179.46,
                                                        "note": "600x1000mm; kod: 578332"
                                    },
                                    {
                                                        "id": "kn-fpl-035-160-0-600",
                                                        "name": "FPL 035 GVB 160mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 196.74,
                                                        "note": "600x1000mm; kod: 450808"
                                    },
                                    {
                                                        "id": "kn-fpl-035-180-0-600",
                                                        "name": "FPL 035 GVB 180mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 146.16,
                                                        "note": "600x1000mm; kod: 450810"
                                    },
                                    {
                                                        "id": "kn-fpl-035-200-0-600",
                                                        "name": "FPL 035 GVB 200mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 160.44,
                                                        "note": "600x1000mm; kod: 450815"
                                    },
                                    {
                                                        "id": "kn-fpl-035-60-0-600",
                                                        "name": "FPL 035 GVB 60mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 216.0,
                                                        "note": "600x1000mm; kod: 450819"
                                    },
                                    {
                                                        "id": "kn-fpl-035-80-0-600",
                                                        "name": "FPL 035 GVB 80mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 3.6,
                                                        "pricePerPack": 208.8,
                                                        "note": "600x1000mm; kod: 450820"
                                    },
                                    {
                                                        "id": "kn-mpe-100-0-600",
                                                        "name": "MPE 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 159.6,
                                                        "note": "600x1000mm; kod: 2409906"
                                    },
                                    {
                                                        "id": "kn-mpe-120-0-600",
                                                        "name": "MPE 120mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 155.76,
                                                        "note": "600x1000mm; kod: 307086"
                                    },
                                    {
                                                        "id": "kn-mpe-140-0-600",
                                                        "name": "MPE 140mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 136.08,
                                                        "note": "600x1000mm; kod: 2409907"
                                    },
                                    {
                                                        "id": "kn-mpe-150-0-600",
                                                        "name": "MPE 150mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 144.72,
                                                        "note": "600x1000mm; kod: 2409903"
                                    },
                                    {
                                                        "id": "kn-mpe-160-0-600",
                                                        "name": "MPE 160mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 156.06,
                                                        "note": "600x1000mm; kod: 307273"
                                    },
                                    {
                                                        "id": "kn-mpe-180-0-600",
                                                        "name": "MPE 180mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 173.7,
                                                        "note": "600x1000mm; kod: 2409904"
                                    },
                                    {
                                                        "id": "kn-mpe-200-0-600",
                                                        "name": "MPE 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 2.0,
                                                        "pricePerPack": 217.2,
                                                        "note": "600x1000mm; kod: 308466"
                                    },
                                    {
                                                        "id": "kn-mpe-220-0-600",
                                                        "name": "MPE 220mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 22.0,
                                                        "coveragePerPack": 2.0,
                                                        "pricePerPack": 235.6,
                                                        "note": "600x1000mm; kod: 474493"
                                    },
                                    {
                                                        "id": "kn-mpe-50-0-600",
                                                        "name": "MPE 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 162.6,
                                                        "note": "600x1000mm; kod: 307080"
                                    },
                                    {
                                                        "id": "kn-mpe-60-0-600",
                                                        "name": "MPE 60mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 156.0,
                                                        "note": "600x1000mm; kod: 307084"
                                    },
                                    {
                                                        "id": "kn-mpe-80-0-600",
                                                        "name": "MPE 80mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 3.6,
                                                        "pricePerPack": 156.24,
                                                        "note": "600x1000mm; kod: 307085"
                                    },
                                    {
                                                        "id": "kn-mpn-120-0-600",
                                                        "name": "MPN 120mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 3.6,
                                                        "pricePerPack": 196.92,
                                                        "note": "600x1000mm; kod: 306284"
                                    },
                                    {
                                                        "id": "kn-mpn-140-0-600",
                                                        "name": "MPN 140mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 192.0,
                                                        "note": "600x1000mm; kod: 306148"
                                    },
                                    {
                                                        "id": "kn-mpn-150-0-600",
                                                        "name": "MPN 150mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 163.92,
                                                        "note": "600x1000mm; kod: 306366"
                                    },
                                    {
                                                        "id": "kn-mpn-160-0-600",
                                                        "name": "MPN 160mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 174.24,
                                                        "note": "600x1000mm; kod: 459196"
                                    },
                                    {
                                                        "id": "kn-mpn-180-0-600",
                                                        "name": "MPN 180mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 194.88,
                                                        "note": "600x1000mm; kod: 2410328"
                                    },
                                    {
                                                        "id": "kn-mpn-200-0-600",
                                                        "name": "MPN 200mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 163.08,
                                                        "note": "600x1000mm; kod: 306967"
                                    },
                                    {
                                                        "id": "kn-mpn-50-0-600",
                                                        "name": "MPN 50mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 7.2,
                                                        "pricePerPack": 163.44,
                                                        "note": "600x1000mm; kod: 306265"
                                    },
                                    {
                                                        "id": "kn-mps-100-0-600",
                                                        "name": "MPS 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 178.5,
                                                        "note": "600x1000mm; kod: 2409902"
                                    },
                                    {
                                                        "id": "kn-mps-120-0-600",
                                                        "name": "MPS 120mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 2.4,
                                                        "pricePerPack": 171.12,
                                                        "note": "600x1000mm; kod: 308520"
                                    },
                                    {
                                                        "id": "kn-mps-140-0-600",
                                                        "name": "MPS 140mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 149.4,
                                                        "note": "600x1000mm; kod: 2411529"
                                    },
                                    {
                                                        "id": "kn-mps-150-0-600",
                                                        "name": "MPS 150mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 159.12,
                                                        "note": "600x1000mm; kod: 2411528"
                                    },
                                    {
                                                        "id": "kn-mps-160-0-600",
                                                        "name": "MPS 160mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 1.8,
                                                        "pricePerPack": 171.18,
                                                        "note": "600x1000mm; kod: 307447"
                                    },
                                    {
                                                        "id": "kn-mps-180-0-600",
                                                        "name": "MPS 180mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 128.04,
                                                        "note": "600x1000mm; kod: 308841"
                                    },
                                    {
                                                        "id": "kn-mps-200-0-600",
                                                        "name": "MPS 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 1.2,
                                                        "pricePerPack": 140.04,
                                                        "note": "600x1000mm; kod: 2411790"
                                    },
                                    {
                                                        "id": "kn-mps-50-0-600",
                                                        "name": "MPS 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 177.6,
                                                        "note": "600x1000mm; kod: 2409901"
                                    },
                                    {
                                                        "id": "kn-mps-60-0-600",
                                                        "name": "MPS 60mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 171.36,
                                                        "note": "600x1000mm; kod: 308754"
                                    },
                                    {
                                                        "id": "kn-mps-80-0-600",
                                                        "name": "MPS 80mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 3.6,
                                                        "pricePerPack": 171.72,
                                                        "note": "600x1000mm; kod: 2410921"
                                    },
                                    {
                                                        "id": "kn-naturboard-100-600",
                                                        "name": "NATURBOARD 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 8.0,
                                                        "pricePerPack": 356.0,
                                                        "note": "600x1250mm; kod: 842067"
                                    },
                                    {
                                                        "id": "kn-naturboard-150-6-1250.4",
                                                        "name": "NATURBOARD 150.6mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.06,
                                                        "coveragePerPack": 3.75,
                                                        "pricePerPack": 251.25,
                                                        "note": "1250.4x3.8mm; kod: 842695"
                                    },
                                    {
                                                        "id": "kn-naturboard-200-600",
                                                        "name": "NATURBOARD 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 4.0,
                                                        "pricePerPack": 357.6,
                                                        "note": "600x1250mm; kod: 842069"
                                    },
                                    {
                                                        "id": "kn-naturboard-50-600",
                                                        "name": "NATURBOARD 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 12.0,
                                                        "pricePerPack": 268.8,
                                                        "note": "600x1250mm; kod: 707097"
                                    },
                                    {
                                                        "id": "kn-naturboard-75-600",
                                                        "name": "NATURBOARD 75mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 7.5,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 214.2,
                                                        "note": "600x1250.2mm; kod: 842693"
                                    },
                                    {
                                                        "id": "kn-pte-20-0-600",
                                                        "name": "PTE 20mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 2.0,
                                                        "coveragePerPack": 9.6,
                                                        "pricePerPack": 214.08,
                                                        "note": "600x1000mm; kod: 795737"
                                    },
                                    {
                                                        "id": "kn-pte-30-0-600",
                                                        "name": "PTE 30mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 3.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 196.2,
                                                        "note": "600x1000mm; kod: 308741"
                                    },
                                    {
                                                        "id": "kn-pte-40-0-600",
                                                        "name": "PTE 40mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 208.32,
                                                        "note": "600x1000mm; kod: 545859"
                                    },
                                    {
                                                        "id": "kn-pte-50-0-600",
                                                        "name": "PTE 50mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 164.4,
                                                        "note": "600x1000mm; kod: 545862"
                                    },
                                    {
                                                        "id": "kn-pte-60-0-600",
                                                        "name": "PTE 60mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 192.0,
                                                        "note": "600x1000mm; kod: 545860"
                                    },
                                    {
                                                        "id": "kn-ptn-20-0-600",
                                                        "name": "PTN 20mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 2.0,
                                                        "coveragePerPack": 9.6,
                                                        "pricePerPack": 171.84,
                                                        "note": "600x1000mm; kod: 795738"
                                    },
                                    {
                                                        "id": "kn-ptn-25-0-600",
                                                        "name": "PTN 25mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 2.5,
                                                        "coveragePerPack": 8.4,
                                                        "pricePerPack": 187.32,
                                                        "note": "600x1000mm; kod: 2433017"
                                    },
                                    {
                                                        "id": "kn-ptn-30-0-600",
                                                        "name": "PTN 30mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 3.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 157.8,
                                                        "note": "600x1000mm; kod: 2433006"
                                    },
                                    {
                                                        "id": "kn-ptn-40-0-600",
                                                        "name": "PTN 40mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 167.52,
                                                        "note": "600x1000mm; kod: 545857"
                                    },
                                    {
                                                        "id": "kn-ptn-50-0-600",
                                                        "name": "PTN 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 131.1,
                                                        "note": "600x1000mm; kod: 545858"
                                    },
                                    {
                                                        "id": "kn-pts-20-0-600",
                                                        "name": "PTS 20mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 2.0,
                                                        "coveragePerPack": 9.6,
                                                        "pricePerPack": 226.56,
                                                        "note": "600x1000mm; kod: 795739"
                                    },
                                    {
                                                        "id": "kn-pts-30-0-600",
                                                        "name": "PTS 30mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 3.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 169.92,
                                                        "note": "600x1000mm; kod: 2433005"
                                    },
                                    {
                                                        "id": "kn-pts-40-0-600",
                                                        "name": "PTS 40mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 4.8,
                                                        "pricePerPack": 228.48,
                                                        "note": "600x1000mm; kod: 545873"
                                    },
                                    {
                                                        "id": "kn-pts-50-0-600",
                                                        "name": "PTS 50mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 176.4,
                                                        "note": "600x1000mm; kod: 545870"
                                    },
                                    {
                                                        "id": "kn-pts-60-0-600",
                                                        "name": "PTS 60mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 212.1,
                                                        "note": "600x1000mm; kod: 545864"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-100-0-1200",
                                                        "name": "SMARTROOF BASE 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 31.2,
                                                        "pricePerPack": 2421.12,
                                                        "note": "1200x2000mm; kod: 521061"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-120-0-1200",
                                                        "name": "SMARTROOF BASE 120mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 26.4,
                                                        "pricePerPack": 2463.12,
                                                        "note": "1200x2000mm; kod: 521065"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-140-0-1200",
                                                        "name": "SMARTROOF BASE 140mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 21.6,
                                                        "pricePerPack": 2352.24,
                                                        "note": "1200x2000mm; kod: 521066"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-150-0-1200",
                                                        "name": "SMARTROOF BASE 150mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 19.2,
                                                        "pricePerPack": 2246.4,
                                                        "note": "1200x2000mm; kod: 524419"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-160-0-1200",
                                                        "name": "SMARTROOF BASE 160mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 19.2,
                                                        "pricePerPack": 2382.72,
                                                        "note": "1200x2000mm; kod: 521068"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-180-0-1200",
                                                        "name": "SMARTROOF BASE 180mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 16.8,
                                                        "pricePerPack": 2346.96,
                                                        "note": "1200x2000mm; kod: 534645"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-200-0-1200",
                                                        "name": "SMARTROOF BASE 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 14.4,
                                                        "pricePerPack": 2234.88,
                                                        "note": "1200x2000mm; kod: 521069"
                                    },
                                    {
                                                        "id": "kn-smartroof-base-80-0-1200",
                                                        "name": "SMARTROOF BASE 80mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 38.4,
                                                        "pricePerPack": 2584.32,
                                                        "note": "1200x2000mm; kod: 534637"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-100-0-1200",
                                                        "name": "SMARTROOF PRO 100mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 31.2,
                                                        "pricePerPack": 2801.76,
                                                        "note": "1200x2000mm; kod: 801436"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-120-0-1200",
                                                        "name": "SMARTROOF PRO 120mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 26.4,
                                                        "pricePerPack": 2827.44,
                                                        "note": "1200x2000mm"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-140-0-1200",
                                                        "name": "SMARTROOF PRO 140mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 21.6,
                                                        "pricePerPack": 2676.24,
                                                        "note": "1200x2000mm; kod: 843390"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-160-0-1200",
                                                        "name": "SMARTROOF PRO 160mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 19.2,
                                                        "pricePerPack": 2741.76,
                                                        "note": "1200x2000mm; kod: 832449"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-200-0-1200",
                                                        "name": "SMARTROOF PRO 200mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 14.4,
                                                        "pricePerPack": 2556.0,
                                                        "note": "1200x2000mm; kod: 855570"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-50-0-1200",
                                                        "name": "SMARTROOF PRO 50mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 62.4,
                                                        "pricePerPack": 2820.48,
                                                        "note": "1200x2000mm"
                                    },
                                    {
                                                        "id": "kn-smartroof-pro-60-0-1200",
                                                        "name": "SMARTROOF PRO 60mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 52.8,
                                                        "pricePerPack": 2830.08,
                                                        "note": "1200x2000mm"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-100-0-1200",
                                                        "name": "SMARTROOF THERMAL 100mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 31.2,
                                                        "pricePerPack": 3341.52,
                                                        "note": "1200x2000mm; kod: 505403"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-120-0-1200",
                                                        "name": "SMARTROOF THERMAL 120mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 26.4,
                                                        "pricePerPack": 3360.72,
                                                        "note": "1200x2000mm; kod: 506709"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-140-0-1200",
                                                        "name": "SMARTROOF THERMAL 140mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 21.6,
                                                        "pricePerPack": 3214.08,
                                                        "note": "1200x2000mm; kod: 506769"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-150-0-1200",
                                                        "name": "SMARTROOF THERMAL 150mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 19.2,
                                                        "pricePerPack": 2876.16,
                                                        "note": "1200x2000mm; kod: 506771"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-160-0-1200",
                                                        "name": "SMARTROOF THERMAL 160mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 19.2,
                                                        "pricePerPack": 3264.0,
                                                        "note": "1200x2000mm; kod: 506774"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-180-0-1200",
                                                        "name": "SMARTROOF THERMAL 180mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 16.8,
                                                        "pricePerPack": 3213.84,
                                                        "note": "1200x2000mm; kod: 506777"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-200-0-1200",
                                                        "name": "SMARTROOF THERMAL 200mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 14.4,
                                                        "pricePerPack": 3062.88,
                                                        "note": "1200x2000mm; kod: 506778"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-40-0-1200",
                                                        "name": "SMARTROOF THERMAL 40mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 76.8,
                                                        "pricePerPack": 3379.2,
                                                        "note": "1200x2000mm; kod: 523571"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-50-0-1200",
                                                        "name": "SMARTROOF THERMAL 50mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 62.4,
                                                        "pricePerPack": 3812.64,
                                                        "note": "1200x2000mm; kod: 523572"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-60-0-1200",
                                                        "name": "SMARTROOF THERMAL 60mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 52.8,
                                                        "pricePerPack": 3717.12,
                                                        "note": "1200x2000mm; kod: 523573"
                                    },
                                    {
                                                        "id": "kn-smartroof-thermal-80-0-1200",
                                                        "name": "SMARTROOF THERMAL 80mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 38.4,
                                                        "pricePerPack": 3275.52,
                                                        "note": "1200x2000mm; kod: 506790"
                                    },
                                    {
                                                        "id": "kn-smartroof-top-40-0-1200",
                                                        "name": "SMARTROOF TOP 40mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 4.0,
                                                        "coveragePerPack": 76.8,
                                                        "pricePerPack": 3356.16,
                                                        "note": "1200x2000mm; kod: 610488"
                                    },
                                    {
                                                        "id": "kn-smartroof-top-50-0-1200",
                                                        "name": "SMARTROOF TOP 50mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 62.4,
                                                        "pricePerPack": 3400.8,
                                                        "note": "1200x2000mm; kod: 534837"
                                    },
                                    {
                                                        "id": "kn-smartroof-top-60-0-1200",
                                                        "name": "SMARTROOF TOP 60mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 52.8,
                                                        "pricePerPack": 3769.92,
                                                        "note": "1200x2000mm; kod: 521080"
                                    },
                                    {
                                                        "id": "kn-smartroof-top-80-0-1200",
                                                        "name": "SMARTROOF TOP 80mm",
                                                        "lambda": 0.038,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 38.4,
                                                        "pricePerPack": 3048.96,
                                                        "note": "1200x2000mm; kod: 521083"
                                    },
                                    {
                                                        "id": "kn-tp-435-b-100-600",
                                                        "name": "TP 435 B 100mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 373.2,
                                                        "note": "600x1250mm; kod: 704511"
                                    },
                                    {
                                                        "id": "kn-tp-435-b-120-600",
                                                        "name": "TP 435 B 120mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 223.8,
                                                        "note": "600x1250.4mm; kod: 704512"
                                    },
                                    {
                                                        "id": "kn-tp-435-b-160-600",
                                                        "name": "TP 435 B 160mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 4.0,
                                                        "pricePerPack": 383.6,
                                                        "note": "600x1250mm; kod: 704514"
                                    },
                                    {
                                                        "id": "kn-tp-435-b-180-600",
                                                        "name": "TP 435 B 180mm",
                                                        "lambda": 0.034,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 2.25,
                                                        "pricePerPack": 236.47,
                                                        "note": "600x1250.5mm; kod: 704515"
                                    },
                                    {
                                                        "id": "kn-unifit-032-100-1200",
                                                        "name": "UNIFIT 032 100mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 4.2,
                                                        "pricePerPack": 279.3,
                                                        "note": "1200x3500mm; kod: 623134"
                                    },
                                    {
                                                        "id": "kn-unifit-032-120-1200",
                                                        "name": "UNIFIT 032 120mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 3.48,
                                                        "pricePerPack": 278.05,
                                                        "note": "1200x2900mm; kod: 623139"
                                    },
                                    {
                                                        "id": "kn-unifit-032-140-1200",
                                                        "name": "UNIFIT 032 140mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 280.2,
                                                        "note": "1200x2500mm; kod: 623141"
                                    },
                                    {
                                                        "id": "kn-unifit-032-150-1200",
                                                        "name": "UNIFIT 032 150mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 2.76,
                                                        "pricePerPack": 275.45,
                                                        "note": "1200x2300mm; kod: 623353"
                                    },
                                    {
                                                        "id": "kn-unifit-032-160-1200",
                                                        "name": "UNIFIT 032 160mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 2.64,
                                                        "pricePerPack": 281.42,
                                                        "note": "1200x2200mm; kod: 623144"
                                    },
                                    {
                                                        "id": "kn-unifit-032-180-1200",
                                                        "name": "UNIFIT 032 180mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 2.64,
                                                        "pricePerPack": 316.01,
                                                        "note": "1200x2000mm; kod: 623147"
                                    },
                                    {
                                                        "id": "kn-unifit-032-200-1200",
                                                        "name": "UNIFIT 032 200mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 2.64,
                                                        "pricePerPack": 352.18,
                                                        "note": "1200x2000mm; kod: 704559"
                                    },
                                    {
                                                        "id": "kn-unifit-032-60-1200",
                                                        "name": "UNIFIT 032 60mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 7.08,
                                                        "pricePerPack": 283.91,
                                                        "note": "1200x590mm; kod: 623124"
                                    },
                                    {
                                                        "id": "kn-unifit-032-80-1200",
                                                        "name": "UNIFIT 032 80mm",
                                                        "lambda": 0.032,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 5.28,
                                                        "pricePerPack": 281.42,
                                                        "note": "1200x440mm; kod: 623131"
                                    },
                                    {
                                                        "id": "kn-unifit-033-100-1200",
                                                        "name": "UNIFIT 033 100mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 5.28,
                                                        "pricePerPack": 303.07,
                                                        "note": "1200x440mm; kod: 591882"
                                    },
                                    {
                                                        "id": "kn-unifit-033-120-1200",
                                                        "name": "UNIFIT 033 120mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 4.44,
                                                        "pricePerPack": 305.92,
                                                        "note": "1200x3700mm; kod: 591888"
                                    },
                                    {
                                                        "id": "kn-unifit-033-140-1200",
                                                        "name": "UNIFIT 033 140mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 3.72,
                                                        "pricePerPack": 298.34,
                                                        "note": "1200x3100mm; kod: 591903"
                                    },
                                    {
                                                        "id": "kn-unifit-033-150-1200",
                                                        "name": "UNIFIT 033 150mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 3.48,
                                                        "pricePerPack": 299.63,
                                                        "note": "1200x2900mm; kod: 591921"
                                    },
                                    {
                                                        "id": "kn-unifit-033-160-1200",
                                                        "name": "UNIFIT 033 160mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 3.36,
                                                        "pricePerPack": 308.45,
                                                        "note": "1200x2800mm; kod: 591923"
                                    },
                                    {
                                                        "id": "kn-unifit-033-180-1200",
                                                        "name": "UNIFIT 033 180mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 3.0,
                                                        "pricePerPack": 309.3,
                                                        "note": "1200x2500mm; kod: 591926"
                                    },
                                    {
                                                        "id": "kn-unifit-033-200-1200",
                                                        "name": "UNIFIT 033 200mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 2.64,
                                                        "pricePerPack": 303.07,
                                                        "note": "1200x2200mm; kod: 591929"
                                    },
                                    {
                                                        "id": "kn-unifit-033-50-1200",
                                                        "name": "UNIFIT 033 50mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 10.44,
                                                        "pricePerPack": 299.63,
                                                        "note": "1200x870mm; kod: 591871"
                                    },
                                    {
                                                        "id": "kn-unifit-033-80-1200",
                                                        "name": "UNIFIT 033 80mm",
                                                        "lambda": 0.033,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 6.6,
                                                        "pricePerPack": 301.62,
                                                        "note": "1200x550mm; kod: 591878"
                                    },
                                    {
                                                        "id": "kn-unifit-035-100-1200",
                                                        "name": "UNIFIT 035 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 267.0,
                                                        "note": "1200x500mm; kod: 730128"
                                    },
                                    {
                                                        "id": "kn-unifit-035-100-1200",
                                                        "name": "UNIFIT 035 100mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 7.32,
                                                        "pricePerPack": 262.79,
                                                        "note": "1200x610mm; kod: 730132"
                                    },
                                    {
                                                        "id": "kn-unifit-035-120-1200",
                                                        "name": "UNIFIT 035 120mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 5.16,
                                                        "pricePerPack": 277.09,
                                                        "note": "1200x430mm; kod: 730150"
                                    },
                                    {
                                                        "id": "kn-unifit-035-120-1200",
                                                        "name": "UNIFIT 035 120mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 6.0,
                                                        "pricePerPack": 260.4,
                                                        "note": "1200x500mm; kod: 730154"
                                    },
                                    {
                                                        "id": "kn-unifit-035-140-1200",
                                                        "name": "UNIFIT 035 140mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 4.44,
                                                        "pricePerPack": 277.06,
                                                        "note": "1200x3700mm; kod: 730164"
                                    },
                                    {
                                                        "id": "kn-unifit-035-140-1200",
                                                        "name": "UNIFIT 035 140mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 5.28,
                                                        "pricePerPack": 266.11,
                                                        "note": "1200x440mm; kod: 730166"
                                    },
                                    {
                                                        "id": "kn-unifit-035-150-1200",
                                                        "name": "UNIFIT 035 150mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 4.08,
                                                        "pricePerPack": 273.36,
                                                        "note": "1200x3400mm; kod: 803741"
                                    },
                                    {
                                                        "id": "kn-unifit-035-150-1200",
                                                        "name": "UNIFIT 035 150mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 4.92,
                                                        "pricePerPack": 267.16,
                                                        "note": "1200x410mm; kod: 730180"
                                    },
                                    {
                                                        "id": "kn-unifit-035-160-1200",
                                                        "name": "UNIFIT 035 160mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 3.84,
                                                        "pricePerPack": 273.41,
                                                        "note": "1200x3200mm; kod: 730190"
                                    },
                                    {
                                                        "id": "kn-unifit-035-160-1200",
                                                        "name": "UNIFIT 035 160mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 4.56,
                                                        "pricePerPack": 263.57,
                                                        "note": "1200x3800mm; kod: 730192"
                                    },
                                    {
                                                        "id": "kn-unifit-035-180-1200",
                                                        "name": "UNIFIT 035 180mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 3.48,
                                                        "pricePerPack": 279.1,
                                                        "note": "1200x2900mm; kod: 730204"
                                    },
                                    {
                                                        "id": "kn-unifit-035-180-1200",
                                                        "name": "UNIFIT 035 180mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 4.08,
                                                        "pricePerPack": 263.98,
                                                        "note": "1200x3400mm; kod: 730208"
                                    },
                                    {
                                                        "id": "kn-unifit-035-200-1200",
                                                        "name": "UNIFIT 035 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 3.12,
                                                        "pricePerPack": 278.93,
                                                        "note": "1200x2600mm; kod: 730218"
                                    },
                                    {
                                                        "id": "kn-unifit-035-200-1200",
                                                        "name": "UNIFIT 035 200mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 3.72,
                                                        "pricePerPack": 268.58,
                                                        "note": "1200x3100mm; kod: 730222"
                                    },
                                    {
                                                        "id": "kn-unifit-035-220-1200",
                                                        "name": "UNIFIT 035 220mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 22.0,
                                                        "coveragePerPack": 3.72,
                                                        "pricePerPack": 366.05,
                                                        "note": "1200x3100mm; kod: 730236"
                                    },
                                    {
                                                        "id": "kn-unifit-035-240-1200",
                                                        "name": "UNIFIT 035 240mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 24.0,
                                                        "coveragePerPack": 3.48,
                                                        "pricePerPack": 372.71,
                                                        "note": "1200x2900mm; kod: 730240"
                                    },
                                    {
                                                        "id": "kn-unifit-035-50-1200",
                                                        "name": "UNIFIT 035 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 12.12,
                                                        "pricePerPack": 271.49,
                                                        "note": "1200x1010mm; kod: 730064"
                                    },
                                    {
                                                        "id": "kn-unifit-035-50-1200",
                                                        "name": "UNIFIT 035 50mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 12.48,
                                                        "pricePerPack": 227.14,
                                                        "note": "1200x1040mm; kod: 730068"
                                    },
                                    {
                                                        "id": "kn-unifit-035-60-1200",
                                                        "name": "UNIFIT 035 60mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 9.6,
                                                        "pricePerPack": 255.36,
                                                        "note": "1200x800mm; kod: 730092"
                                    },
                                    {
                                                        "id": "kn-unifit-035-60-1200",
                                                        "name": "UNIFIT 035 60mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 12.12,
                                                        "pricePerPack": 261.79,
                                                        "note": "1200x1010mm; kod: 730096"
                                    },
                                    {
                                                        "id": "kn-unifit-035-80-1200",
                                                        "name": "UNIFIT 035 80mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 7.2,
                                                        "pricePerPack": 257.04,
                                                        "note": "1200x600mm; kod: 730112"
                                    },
                                    {
                                                        "id": "kn-unifit-035-80-1200",
                                                        "name": "UNIFIT 035 80mm",
                                                        "lambda": 0.035,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 9.12,
                                                        "pricePerPack": 264.48,
                                                        "note": "1200x760mm; kod: 730116"
                                    },
                                    {
                                                        "id": "kn-unifit-037-100-1200",
                                                        "name": "UNIFIT 037 100mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 9.24,
                                                        "pricePerPack": 286.44,
                                                        "note": "1200x770mm; kod: 730140"
                                    },
                                    {
                                                        "id": "kn-unifit-037-100-1200",
                                                        "name": "UNIFIT 037 100mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 10.0,
                                                        "coveragePerPack": 9.84,
                                                        "pricePerPack": 285.36,
                                                        "note": "1200x820mm; kod: 730144"
                                    },
                                    {
                                                        "id": "kn-unifit-037-120-1200",
                                                        "name": "UNIFIT 037 120mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 7.68,
                                                        "pricePerPack": 285.7,
                                                        "note": "1200x640mm; kod: 730158"
                                    },
                                    {
                                                        "id": "kn-unifit-037-120-1200",
                                                        "name": "UNIFIT 037 120mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 12.0,
                                                        "coveragePerPack": 8.16,
                                                        "pricePerPack": 284.78,
                                                        "note": "1200x680mm; kod: 730162"
                                    },
                                    {
                                                        "id": "kn-unifit-037-140-1200",
                                                        "name": "UNIFIT 037 140mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 6.6,
                                                        "pricePerPack": 286.44,
                                                        "note": "1200x550mm; kod: 730170"
                                    },
                                    {
                                                        "id": "kn-unifit-037-140-1200",
                                                        "name": "UNIFIT 037 140mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 14.0,
                                                        "coveragePerPack": 7.08,
                                                        "pricePerPack": 285.32,
                                                        "note": "1200x590mm; kod: 730172"
                                    },
                                    {
                                                        "id": "kn-unifit-037-150-1200",
                                                        "name": "UNIFIT 037 150mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 6.12,
                                                        "pricePerPack": 284.58,
                                                        "note": "1200x510mm; kod: 730182"
                                    },
                                    {
                                                        "id": "kn-unifit-037-150-1200",
                                                        "name": "UNIFIT 037 150mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 15.0,
                                                        "coveragePerPack": 6.6,
                                                        "pricePerPack": 286.44,
                                                        "note": "1200x550mm; kod: 730186"
                                    },
                                    {
                                                        "id": "kn-unifit-037-160-1200",
                                                        "name": "UNIFIT 037 160mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 5.76,
                                                        "pricePerPack": 284.54,
                                                        "note": "1200x480mm; kod: 730196"
                                    },
                                    {
                                                        "id": "kn-unifit-037-160-1200",
                                                        "name": "UNIFIT 037 160mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 16.0,
                                                        "coveragePerPack": 6.12,
                                                        "pricePerPack": 282.74,
                                                        "note": "1200x510mm; kod: 730200"
                                    },
                                    {
                                                        "id": "kn-unifit-037-180-1200",
                                                        "name": "UNIFIT 037 180mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 5.04,
                                                        "pricePerPack": 280.73,
                                                        "note": "1200x420mm; kod: 730210"
                                    },
                                    {
                                                        "id": "kn-unifit-037-180-1200",
                                                        "name": "UNIFIT 037 180mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 18.0,
                                                        "coveragePerPack": 5.52,
                                                        "pricePerPack": 287.59,
                                                        "note": "1200x460mm; kod: 730214"
                                    },
                                    {
                                                        "id": "kn-unifit-037-200-1200",
                                                        "name": "UNIFIT 037 200mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 4.56,
                                                        "pricePerPack": 282.26,
                                                        "note": "1200x3800mm; kod: 730228"
                                    },
                                    {
                                                        "id": "kn-unifit-037-200-1200",
                                                        "name": "UNIFIT 037 200mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 20.0,
                                                        "coveragePerPack": 4.92,
                                                        "pricePerPack": 284.38,
                                                        "note": "1200x410mm; kod: 730232"
                                    },
                                    {
                                                        "id": "kn-unifit-037-240-1200",
                                                        "name": "UNIFIT 037 240mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 24.0,
                                                        "coveragePerPack": 4.08,
                                                        "pricePerPack": 281.93,
                                                        "note": "1200x3400mm; kod: 730244"
                                    },
                                    {
                                                        "id": "kn-unifit-037-50-1200",
                                                        "name": "UNIFIT 037 50mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 18.48,
                                                        "pricePerPack": 282.74,
                                                        "note": "1200x2mm; kod: 730074"
                                    },
                                    {
                                                        "id": "kn-unifit-037-50-1200",
                                                        "name": "UNIFIT 037 50mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 19.68,
                                                        "pricePerPack": 285.36,
                                                        "note": "1200x2mm; kod: 730082"
                                    },
                                    {
                                                        "id": "kn-unifit-037-50-1200",
                                                        "name": "UNIFIT 037 50mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 5.0,
                                                        "coveragePerPack": 21.84,
                                                        "pricePerPack": 292.66,
                                                        "note": "1200x2mm; kod: 732341"
                                    },
                                    {
                                                        "id": "kn-unifit-037-60-1200",
                                                        "name": "UNIFIT 037 60mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 15.6,
                                                        "pricePerPack": 291.72,
                                                        "note": "1200x2mm; kod: 730098"
                                    },
                                    {
                                                        "id": "kn-unifit-037-60-1200",
                                                        "name": "UNIFIT 037 60mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 6.0,
                                                        "coveragePerPack": 16.32,
                                                        "pricePerPack": 282.34,
                                                        "note": "1200x2mm; kod: 730102"
                                    },
                                    {
                                                        "id": "kn-unifit-037-80-1200",
                                                        "name": "UNIFIT 037 80mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 11.52,
                                                        "pricePerPack": 284.54,
                                                        "note": "1200x960mm; kod: 730118"
                                    },
                                    {
                                                        "id": "kn-unifit-037-80-1200",
                                                        "name": "UNIFIT 037 80mm",
                                                        "lambda": 0.037,
                                                        "thicknessCm": 8.0,
                                                        "coveragePerPack": 12.24,
                                                        "pricePerPack": 280.3,
                                                        "note": "1200x1020mm; kod: 730122"
                                    },
                                    {
                                                        "id": "kn-wy-15-0-40",
                                                        "name": "WY pas brzegowy 15mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 1.5,
                                                        "coveragePerPack": 0.4,
                                                        "pricePerPack": 8.2,
                                                        "note": "40x1000mm; kod: 305485"
                                    },
                                    {
                                                        "id": "kn-wy-15-0-80",
                                                        "name": "WY pas brzegowy 15mm",
                                                        "lambda": 0.036,
                                                        "thicknessCm": 1.5,
                                                        "coveragePerPack": 0.8,
                                                        "pricePerPack": 8.7,
                                                        "note": "80x1000mm; kod: 305992"
                                    }
                ],
                plans: [
                    {
                        id: 'kn-plan-1',
                        name: 'Strefa startowa',
                        productId: 'kn-fkd-n-thermal-50-0-400',
                        area: 120,
                        wastePercent: '5',
                        margin: '18',
                        discount1: '',
                        discount2: '',
                        discount3: '',
                        discount4: '',
                        extraNote: 'Przykładowy scenariusz - edytuj lub usuń'
                    }
                ],
            }
        };

        const INITIAL_PROJECTS_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                projects: [],
                contractors: [],
                investors: [],
                filters: { search: '' },
            }
        };

        const LEIER_MATERIALS_PRODUCTS = JSON.parse(document.getElementById('leier-materials-data').textContent);
        const WEBER_INITIAL_PRODUCTS = JSON.parse(document.getElementById('weber-products-data').textContent);
        const LEIER_STROP_PRODUCTS = JSON.parse(document.getElementById('leier-strop-data').textContent);
        const LEIER_CHIMNEY_DATA = JSON.parse(document.getElementById('leier-chimney-data').textContent);
        const LEIER_CHIMNEY_HTML = (typeof window !== 'undefined' && window.LEIER_CHIMNEY_HTML) ? window.LEIER_CHIMNEY_HTML : '';

        const INITIAL_WEBER_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                settings: {
                    purchaseDiscount: '0',
                    margin: '20',
                    palletPrice: '0',
                    defaultPurchaseDiscountNote: '',
                },
                filters: { searchTerm: '' },
                products: WEBER_INITIAL_PRODUCTS.map(product => ({
                    ...product,
                    packageSize: 1,
                    packageUnit: product.unit || '',
                    priceOverride: '',
                })),
            }
        };

        const INITIAL_LEIER_DATA = {
            lastUpdate: INITIAL_LAST_UPDATE,
            content: {
                priceListVersion: '',
                priceListDate: '',
                materials: {
                    settings: { transportRate: '0', margin: '25' },
                    products: LEIER_MATERIALS_PRODUCTS,
                    searchTerm: ""
                },
                chimney: {
                    activeType: 'izolowany',
                    config: {
                        height: 6.5,
                        diameter: 18,
                        shellType: 'standard',
                        finish: 'plaster',
                        ending: 'formwork',
                        connectionAngle: '90',
                        smartBlockVariant: 'standard'
                    },
                    ventHeights: [0, 0, 0, 0, 0, 0, 0, 0],
                    discounts: { chimney: '0', vent: '0' },
                    client: { name: '', street: '', city: '', phone: '', notes: '' },
                    adjustments: {},
                    ventAdjustments: {}
                },
                slab: {
                    settings: {
                        transportCost: '0',
                        margin: '10',
                        groupDiscounts: { R1: '25', R2: '36', R3: '32', R4: '45' }
                    },
                    products: LEIER_STROP_PRODUCTS,
                    quantities: {}
                }
            }
        };

        //======================================================================
        // ICONS
        //======================================================================
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" /></svg>;
        const UploadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v8.614l-1.47-1.47a.75.75 0 00-1.06 1.06l2.75 2.75a.75.75 0 001.06 0l2.75-2.75a.75.75 0 10-1.06-1.06l-1.47 1.47V4.75z" /><path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" /></svg>;
        const AddIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>;
        const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>;
        const SettingsIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8.26 4.72c-.69.25-1.34.63-1.92 1.1L4.63 4.11c-1.1-1.1-2.89-.34-2.89 1.34L1.74 7c-.25.69-.63 1.34-1.1 1.92L-.28 8.51c-1.56.38-1.56 2.6 0 2.98l1.55.25c.25.69.63 1.34 1.1 1.92l-1.71 1.71c-1.1 1.1-.34 2.89 1.34 2.89L7 18.26c.69-.25 1.34-.63 1.92-1.1l.25 1.55c.38 1.56 2.6 1.56 2.98 0l.25-1.55c.69-.25 1.34-.63 1.92-1.1l1.71 1.71c1.1 1.1 2.89.34 2.89-1.34L18.26 13c.25-.69.63-1.34 1.1-1.92l1.55-.25c1.56-.38-1.56-2.6 0-2.98l-1.55-.25c-.25-.69-.63-1.34-1.1-1.92l1.71-1.71c-1.1-1.1.34-2.89-1.34-2.89L13 1.74c-.69.25-1.34.63-1.92 1.1l-.25-1.55zM10 13a3 3 0 100-6 3 3 0 000 6z" clipRule="evenodd" /></svg>;

        const SyncCloudIcon = ({ status }) => {
            const icons = {
                synced: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l2 2 4-4" /></svg>,
                pending: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>,
                syncing: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.18-3.185m-3.181 9.348a8.25 8.25 0 00-11.664 0l-3.18 3.185" /></svg>,
                offline: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /><path strokeLinecap="round" strokeLinejoin="round" d="M3 3l18 18" /></svg>
            };
            return icons[status] || icons.offline;
        };

        //======================================================================
        // SERVICES
        //======================================================================

        // --- POCKETBASE SETUP ---
        // 1. Utwórz kolekcję `calculator_data` w PocketBase.
        // 2. Dodaj pola:
        //    - key (text, required, unique)
        //    - data (json, required)
        //    - last_update (date, required)
        // 3. Reguły dostępu (na start): list/view/create/update = true
        // 4. Ustaw VITE_POCKETBASE_URL w .env.local
        //    (np. https://api.gorilla-glue.org)
        const POCKETBASE_URL = (window.POCKETBASE_URL || 'YOUR_POCKETBASE_URL')
            .replace(/\/+$/, '');
        const pocketbaseEnabled = Boolean(
            POCKETBASE_URL && POCKETBASE_URL !== 'YOUR_POCKETBASE_URL'
        );

        const buildPocketbaseUrl = (path, params = {}) => {
            const url = new URL(`${POCKETBASE_URL}${path}`);
            Object.entries(params).forEach(([paramKey, value]) => {
                if (value != null) {
                    url.searchParams.set(paramKey, value);
                }
            });
            return url.toString();
        };

        const pocketbaseRequest = async (url, options = {}) => {
            try {
                const response = await fetch(url, options);
                const payload = await response.json().catch(() => null);
                if (!response.ok) {
                    return {
                        data: null,
                        error: payload || {
                            message: response.statusText,
                            status: response.status
                        }
                    };
                }
                return { data: payload, error: null };
            } catch (error) {
                return {
                    data: null,
                    error: { message: error?.message || 'Network error' }
                };
            }
        };

        const pocketbaseService = {
            async getData(key) {
                if (!pocketbaseEnabled) {
                    return {
                        data: null,
                        error: { message: 'PocketBase not configured' }
                    };
                }
                const url = buildPocketbaseUrl(
                    '/api/collections/calculator_data/records',
                    {
                    perPage: '1',
                    filter: `key="${key}"`
                    }
                );
                const { data, error } = await pocketbaseRequest(url);
                if (error) return { data: null, error };
                const record = data && Array.isArray(data.items)
                    ? data.items[0]
                    : null;
                return { data: record || null, error: null };
            },
            async upsertData(key, data) {
                if (!pocketbaseEnabled) {
                    return {
                        data: null,
                        error: { message: 'PocketBase not configured' }
                    };
                }

                const payload = {
                    key,
                    data: data.content,
                    last_update: data.lastUpdate
                };

                const { data: existing, error: lookupError } = await this.getData(key);
                if (lookupError) return { data: null, error: lookupError };

                if (existing && existing.id) {
                    const url = buildPocketbaseUrl(
                        `/api/collections/calculator_data/records/${existing.id}`
                    );
                    return await pocketbaseRequest(url, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const url = buildPocketbaseUrl('/api/collections/calculator_data/records');
                return await pocketbaseRequest(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            }
        };

        const calculatePorothermProduct = (product, agreement) => {
            const vatRate = 1.23;
            const netPrice = Number(product.netPrice) || 0;
            const basicDiscount = percentToDecimal(agreement.settings.basicDiscount);
            const productAdditionalDiscount = percentToDecimal(product.additionalDiscount);
            const cashDiscount = percentToDecimal(agreement.settings.cashDiscount);
            const margin = percentToDecimal(agreement.settings.margin);

            const basicDiscountAmount = netPrice * basicDiscount;
            const additionalDiscountAmount = netPrice * productAdditionalDiscount;
            const priceAfterDiscounts = netPrice - basicDiscountAmount - additionalDiscountAmount;
            const netPurchasePrice = priceAfterDiscounts * (1 - cashDiscount);
            
            const transportCostPerTruck = product.location === "Lębork" 
                ? Number(agreement.transportCosts.leborkMalbork) || 0
                : Number(agreement.transportCosts.gnaszynMalbork) || 0;
            
            const unitsPerPallet = Number(product.unitsPerPallet) || 0;
            const palletsPerTruck = Number(product.palletsPerTruck) || 0;
            const totalUnitsPerTruck = unitsPerPallet * palletsPerTruck;
            const transportPerUnit = totalUnitsPerTruck > 0 ? transportCostPerTruck / totalUnitsPerTruck : 0;

            const localPrice = netPurchasePrice + transportPerUnit;
            const customerNetPrice = localPrice * (1 + margin);
            const customerGrossPrice = customerNetPrice * vatRate;
            // Zużycie szt/m2: jeśli podane w produkcie, użyj do wyliczenia ceny m2 brutto.
            // Jeśli brak wpisu, pozostaw cenę m2 brutto pustą (null).
            const consumptionPerM2 = (product.consumptionPerM2 != null && product.consumptionPerM2 !== '')
                ? Number(product.consumptionPerM2)
                : null;
            const unitsPerSquareMeter = (consumptionPerM2 != null && isFinite(consumptionPerM2) && consumptionPerM2 > 0)
                ? consumptionPerM2
                : null;
            const grossPricePerSquareMeter = unitsPerSquareMeter != null
                ? unitsPerSquareMeter * customerGrossPrice
                : null;

            return {
                ...product,
                netPurchasePrice,
                transportPerUnit,
                localPrice,
                customerNetPrice,
                customerGrossPrice,
                unitsPerSquareMeter,
                grossPricePerSquareMeter,
            };
        };
        
        const calculateSolbetProduct = (product, settings = {}) => {
            const vatRate = 1.23;
            const priceNet = Number(product.priceNet) || 0;
            const discountPercent = Number(settings.discountPercent) || 0;
            const margin = Number(settings.margin) || 0;
            const transportCost = Number(settings.transportCost) || 0;

            const discountAmount = priceNet * (discountPercent / 100);
            const netPurchasePrice = priceNet - discountAmount;

            const unitsPerPallet = Number(product.unitsPerPallet) || 0;
            const palletsPerTruck = Number(product.palletsPerTruck) || 0;
            const totalUnitsPerTruck = unitsPerPallet * palletsPerTruck;
            const transportPerUnit = totalUnitsPerTruck > 0 ? transportCost / totalUnitsPerTruck : 0;
            
            const localPrice = netPurchasePrice + transportPerUnit;
            const customerNetPrice = localPrice * (1 + margin / 100);
            const customerGrossPrice = customerNetPrice * vatRate;

            const lengthMm = Number(product.length) || 0;
            const heightMm = Number(product.height) || 0;
            const unitAreaSqM = lengthMm > 0 && heightMm > 0
                ? (lengthMm / 1000) * (heightMm / 1000)
                : 0;
            const unitsPerSquareMeter = unitAreaSqM > 0 ? 1 / unitAreaSqM : 0;
            const grossPricePerSquareMeter = unitsPerSquareMeter * customerGrossPrice;

            return {
                ...product,
                netPurchasePrice,
                transportPerUnit,
                localPrice,
                customerNetPrice,
                customerGrossPrice,
                unitsPerSquareMeter,
                grossPricePerSquareMeter,
            };
        };

        const calculateBrukbetProduct = (product, settings) => {
            const vatRate = 1.23;
            const cenaNetto = Number(product.cenaNetto) || 0;
            const discountPercent = Number(settings.discounts[product.grupa]) || 0;
            const marginPercent = Number(settings.margin) || 0;

            const selectedFactory = Array.isArray(settings.factories)
                ? settings.factories.find(f => f.id === settings.factory)
                : null;
            const transportRateFromSettings = parseLooseNumber(settings.transportRate);
            const transportRateFromFactory = selectedFactory ? parseLooseNumber(selectedFactory.kosztTransportu) : Number.NaN;
            const transportCost = Number.isFinite(transportRateFromSettings)
                ? transportRateFromSettings
                : (Number.isFinite(transportRateFromFactory) ? transportRateFromFactory : 0);

            const cenaPoRabacie = cenaNetto * (1 - discountPercent / 100);

            const unitsPerPalletRaw = parseLooseNumber(product.iloscNaPalecie);
            const unitsPerPallet = Number.isFinite(unitsPerPalletRaw) && unitsPerPalletRaw > 0 ? unitsPerPalletRaw : 1;

            const palletsPerTruckRaw = parseLooseNumber(product.maxPalletsPerTruck);
            const fallbackPalletsRaw = parseLooseNumber(settings.maxPalletsPerTruck);
            const palletsPerTruckCandidate = Number.isFinite(palletsPerTruckRaw) && palletsPerTruckRaw > 0
                ? palletsPerTruckRaw
                : (Number.isFinite(fallbackPalletsRaw) && fallbackPalletsRaw > 0 ? fallbackPalletsRaw : 1);
            const totalUnitsPerTruck = unitsPerPallet * palletsPerTruckCandidate;
            const transportPerUnit = totalUnitsPerTruck > 0 ? transportCost / totalUnitsPerTruck : 0;
            
            const localPrice = cenaPoRabacie + transportPerUnit;
            const cenaSprzedazyNetto = localPrice * (1 + marginPercent / 100);
            const cenaSprzedazyBrutto = cenaSprzedazyNetto * vatRate;

            return { 
                ...product, 
                cenaPoRabacie, 
                cenaSprzedazyNetto, 
                cenaSprzedazyBrutto,
                transportPerUnit,
                rabat: discountPercent,
            };
        };

        const calculateSemmelrockProduct = (product, settings) => {
            const vatRate = 1.23;
            const cenaNetto = Number(product.cenaNetto) || 0;

            const productGroupKey = Object.keys(settings.discounts).find(key => product.grupa.startsWith(key));
            const discountPercent = productGroupKey ? (Number(settings.discounts[productGroupKey]) || 0) : 0;

            const marginPercent = Number(settings.margin) || 0;
            const transportRate = Number(settings.transportRate) || 0;
            const truckWeight = Number(settings.truckWeight) || 0;
            const palletWeight = Number(product.waga) || 0;
            
            const maxPalletsPerTruck = Number(product.maxPalletsPerTruck) || Number(settings.maxPalletsPerTruck) || 0;

            const cenaPoRabacie = cenaNetto * (1 - discountPercent / 100);

            let calculatedPalletsPerTruck = maxPalletsPerTruck;
            if (palletWeight > 0 && truckWeight > 0) {
                const palletsByWeight = Math.floor(truckWeight / palletWeight);
                calculatedPalletsPerTruck = Math.min(maxPalletsPerTruck, palletsByWeight);
            }
            
            const unitsPerPallet = Number(product.iloscNaPalecie) || 0;
            const totalUnitsPerTruck = unitsPerPallet * calculatedPalletsPerTruck;
            const transportPerUnit = totalUnitsPerTruck > 0 ? transportRate / totalUnitsPerTruck : 0;
            
            const localPrice = cenaPoRabacie + transportPerUnit;
            const cenaSprzedazyNetto = localPrice * (1 + marginPercent / 100);
            const cenaSprzedazyBrutto = cenaSprzedazyNetto * vatRate;

            return { 
                ...product, 
                rabat: discountPercent,
                cenaPoRabacie,
                transportPerUnit,
                cenaSprzedazyNetto,
                cenaSprzedazyBrutto,
            };
        };

        const calculatePolbrukProduct = (product, settings) => {
            const vatRate = 1.23;
            const cenaNetto = Number(product.cenaNetto) || 0;
            const discountPercent = Number(product.rabat) || 0;
            const marginPercent = Number(settings.margin) || 0;
            const transportRate = Number(settings.transportRate) || 0;
            const truckWeight = Number(settings.truckWeight) || 0;
            const maxPalletsPerTruckSetting = Number(product.maxPalletsPerTruck) || Number(settings.maxPalletsPerTruck) || 0;
            const palletWeight = Number(product.waga) || 0;

            const cenaPoRabacie = cenaNetto * (1 - discountPercent / 100);

            let palletsPerTruck = maxPalletsPerTruckSetting;
            if (palletWeight > 0 && truckWeight > 0 && palletWeight > 0) {
                const palletsByWeight = Math.floor(truckWeight / palletWeight);
                palletsPerTruck = Math.min(maxPalletsPerTruckSetting, palletsByWeight);
            }

            const unitsPerPallet = Number(product.iloscNaPalecie) || 0;
            const totalUnitsPerTruck = unitsPerPallet * palletsPerTruck;
            const transportPerUnit = totalUnitsPerTruck > 0 ? transportRate / totalUnitsPerTruck : 0;

            const localPrice = cenaPoRabacie + transportPerUnit;
            const cenaSprzedazyNetto = localPrice * (1 + marginPercent / 100);
            const cenaSprzedazyBrutto = cenaSprzedazyNetto * vatRate;

            return {
                ...product,
                rabat: discountPercent,
                cenaPoRabacie,
                transportPerUnit,
                cenaSprzedazyNetto,
                cenaSprzedazyBrutto,
            };
        };

        const calculateSilikatyProduct = (product, settings, modes) => {
            const vatRate = 1.23;
            const priceNet = Number(product.priceNet) || 0;
            const marginDecimal = percentToDecimal(settings.margin);
            const discountSource = modes?.discount === 'inwestycyjny'
                ? settings.discountInwest
                : settings.discountStandard;
            const discountDecimal = percentToDecimal(discountSource);

            const transportCostRaw = modes?.transport === 'bez_hds'
                ? settings.transportBezHds
                : settings.transportHds;
            const transportCost = parseLooseNumber(transportCostRaw);

            const unitsPerPallet = Number(product.unitsPerPallet) || 0;
            const palletsPerTruck = Number(settings.palletsPerTruck) || 0;
            const totalUnitsPerTruck = unitsPerPallet * palletsPerTruck;
            const transportPerUnit = totalUnitsPerTruck > 0 && Number.isFinite(transportCost)
                ? roundToPrecision(transportCost / totalUnitsPerTruck, 6)
                : 0;

            const netPurchasePrice = roundToPrecision(priceNet * (1 - discountDecimal), 6);
            const localPrice = roundToPrecision(netPurchasePrice + transportPerUnit, 6);
            const customerNetPrice = roundToPrecision(localPrice * (1 + marginDecimal), 6);
            const customerGrossPrice = roundToPrecision(customerNetPrice * vatRate, 6);

            const consumptionNumber = product.consumptionPerM2 === '' || product.consumptionPerM2 == null
                ? Number.NaN
                : Number(product.consumptionPerM2);
            const grossPricePerSquareMeter = Number.isFinite(consumptionNumber) && consumptionNumber > 0
                ? roundToPrecision(consumptionNumber * customerGrossPrice, 6)
                : null;

            return {
                ...product,
                discountApplied: ensurePercentScale(discountSource || 0),
                netPurchasePrice,
                transportPerUnit,
                localPrice,
                customerNetPrice,
                customerGrossPrice,
                grossPricePerSquareMeter,
            };
        };

        const calculateWeberProduct = (product, settings) => {
            const vatRate = 1.23;
            const basePriceCandidates = [
                parseLooseNumber(product.priceOverride),
                parseLooseNumber(product.priceNet),
                parseLooseNumber(product.priceRaw),
            ];
            const basePrice = basePriceCandidates.find((value) => Number.isFinite(value) && value >= 0) ?? 0;

            const discountDecimal = percentToDecimal(settings.purchaseDiscount);
            const marginDecimal = percentToDecimal(settings.margin);

            const purchasePrice = roundToPrecision(basePrice * (1 - discountDecimal), 6);
            const customerUnitPriceNet = roundToPrecision(purchasePrice * (1 + marginDecimal), 6);
            const customerUnitPriceGross = roundToPrecision(customerUnitPriceNet * vatRate, 6);

            const resolvedPackageSizeRaw = parseLooseNumber(product.packageSize);
            const resolvedPackageSize = Number.isFinite(resolvedPackageSizeRaw) && resolvedPackageSizeRaw > 0
                ? resolvedPackageSizeRaw
                : 1;

            const customerPackagePriceNet = roundToPrecision(customerUnitPriceNet * resolvedPackageSize, 6);
            const customerPackagePriceGross = roundToPrecision(customerUnitPriceGross * resolvedPackageSize, 6);

            return {
                ...product,
                resolvedBasePrice: basePrice,
                resolvedPurchasePrice: purchasePrice,
                resolvedCustomerUnitPriceNet: customerUnitPriceNet,
                resolvedCustomerUnitPriceGross: customerUnitPriceGross,
                resolvedCustomerPackagePriceNet: customerPackagePriceNet,
                resolvedCustomerPackagePriceGross: customerPackagePriceGross,
                resolvedPackageSize,
                resolvedDiscountPercent: ensurePercentScale(settings.purchaseDiscount),
                resolvedMarginPercent: ensurePercentScale(settings.margin),
            };
        };

        const DOCIEPLENIE_VAT_RATE = 1.23;

        const calculateDocieplenieLine = (product, surfaceArea, settings, { styroThicknessCm }) => {
            if (!product) {
                return {
                    unitsNeeded: 0,
                    netPurchaseUnit: 0,
                    saleNetUnit: 0,
                    lineNet: 0,
                    lineGross: 0,
                    consumptionPerM2Used: 0,
                };
            }

            const priceNet = parseLooseNumber(product.priceNet);
            const marginDecimal = percentToDecimal(settings.margin);
            const consumption = parseLooseNumber(product.consumptionPerM2);
            const safeArea = Number.isFinite(surfaceArea) && surfaceArea > 0 ? surfaceArea : 0;
            const styroThicknessMeters = parseLooseNumber(styroThicknessCm) / 100;
            const safeThickness = Number.isFinite(styroThicknessMeters) && styroThicknessMeters > 0 ? styroThicknessMeters : 0;

            let pricePerUnitNet = Number.isFinite(priceNet) && priceNet >= 0 ? priceNet : 0;
            let consumptionPerM2Used = Number.isFinite(consumption) && consumption > 0 ? consumption : 0;
            const packageSize = parseLooseNumber(product.packageSize);
            let hasPackage = Number.isFinite(packageSize) && packageSize > 0;

            if (product.group === 'styroType') {
                // Cena podawana za m3, zużycie to grubość w metrach na 1 m2 (m3/m2).
                pricePerUnitNet = Number.isFinite(priceNet) && priceNet >= 0 ? priceNet : 0;
                consumptionPerM2Used = safeThickness; // m3 na 1 m2
                hasPackage = false; // paczkowanie nie dotyczy styro (cena za m3)
            }

            if (hasPackage && consumptionPerM2Used > 0) {
                const packageCoverageM2 = packageSize / consumptionPerM2Used;
                consumptionPerM2Used = packageCoverageM2 > 0 ? 1 / packageCoverageM2 : consumptionPerM2Used;
                // pricePerUnitNet pozostaje ceną za całe opakowanie
            }

            const unitsNeeded = consumptionPerM2Used > 0 ? consumptionPerM2Used * safeArea : 0;

            const netPurchaseUnit = pricePerUnitNet; // ceny wejściowe są zakupowe, bez rabatu
            const saleNetUnit = netPurchaseUnit * (1 + marginDecimal);
            const saleGrossUnit = saleNetUnit * DOCIEPLENIE_VAT_RATE;
            const lineNet = saleNetUnit * unitsNeeded;
            const lineGross = saleGrossUnit * unitsNeeded;

            return {
                unitsNeeded,
                netPurchaseUnit,
                saleNetUnit,
                saleGrossUnit,
                lineNet,
                lineGross,
                consumptionPerM2Used,
            };
        };


        const formatCurrency = (value) => `${Number(value).toFixed(2)} zł`;

        const roundToPrecision = (value, precision = 8) => {
            if (!Number.isFinite(value)) {
                return value;
            }
            const factor = 10 ** precision;
            return Math.round(value * factor) / factor;
        };

        const clampValue = (value, min, max) => Math.min(Math.max(value, min), max);

        const ensurePercentScale = (value) => {
            if (value === '' || value == null) {
                return 0;
            }

            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return 0;
            }

            const scaled = Math.abs(numeric) <= 1 ? numeric * 100 : numeric;
            return roundToPrecision(scaled, 6);
        };

        const percentToDecimal = (value) => {
            if (value === '' || value == null) {
                return 0;
            }

            const numeric = Number(value);
            if (!Number.isFinite(numeric)) {
                return 0;
            }

            return Math.abs(numeric) > 1 ? numeric / 100 : numeric;
        };

        const formatPercentage = (value, fractionDigits = 1) => `${ensurePercentScale(value).toFixed(fractionDigits)}%`;

        const formatNumberForInput = (value, precision = 8) => {
            if (value === '' || value === null || value === undefined) {
                return '';
            }
            if (typeof value === 'string') {
                return value;
            }
            const rounded = roundToPrecision(value, precision);
            let formatted = rounded.toLocaleString('en-US', {
                useGrouping: false,
                maximumFractionDigits: precision,
            });
            if (formatted.includes('.')) {
                formatted = formatted.replace(/\.0+$/, '.0').replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
            }
            return formatted;
        };

        const parseLooseNumber = (value) => {
            if (value === '' || value === null || value === undefined) {
                return Number.NaN;
            }

            if (typeof value === 'number') {
                return Number.isFinite(value) ? value : Number.NaN;
            }

            const normalized = String(value).replace(',', '.').trim();
            if (normalized === '') {
                return Number.NaN;
            }

            const parsed = Number(normalized);
            return Number.isFinite(parsed) ? parsed : Number.NaN;
        };

        const extractNumberFromText = (value) => {
            if (value === '' || value === null || value === undefined) {
                return Number.NaN;
            }
            const normalized = String(value).replace(',', '.');
            const match = normalized.match(/-?\d+(?:\.\d+)?/);
            return match ? Number(match[0]) : Number.NaN;
        };

        const parseNumericInput = (rawValue, { min = -Infinity, max = Infinity } = {}) => {
            if (typeof rawValue !== 'string') {
                if (rawValue === '') return '';
                if (typeof rawValue === 'number') {
                    const clamped = Math.min(max, Math.max(min, rawValue));
                    return roundToPrecision(clamped);
                }
                return null;
            }

            const normalized = rawValue.replace(',', '.').trim();
            if (normalized === '') return '';

            if (!/^-?\d*\.?\d*$/.test(normalized)) {
                return null;
            }

            if (normalized === '-') {
                return min < 0 ? '-' : '';
            }

            if (normalized === '-.') {
                return min < 0 ? '-0.' : '';
            }

            if (normalized === '.') {
                return min <= 0 ? '0.' : String(roundToPrecision(min));
            }

            if (normalized.endsWith('.')) {
                const numericPart = normalized.slice(0, -1);
                const parsedNumeric = numericPart === '' || numericPart === '-' ? 0 : Number(numericPart);

                if (!Number.isFinite(parsedNumeric)) {
                    return null;
                }

                const clamped = Math.min(max, Math.max(min, parsedNumeric));
                if (clamped !== parsedNumeric) {
                    return roundToPrecision(clamped);
                }

                return normalized;
            }

            const numeric = Number(normalized);
            if (!Number.isFinite(numeric)) {
                return null;
            }

            const clamped = Math.min(max, Math.max(min, numeric));
            if (clamped !== numeric) {
                return roundToPrecision(clamped);
            }

            return normalized;
        };

        const parsePercentageInput = (rawValue) => parseNumericInput(rawValue, { min: 0, max: 100 });

        const normalizePercentInputValue = (rawValue) => {
            if (rawValue === '' || rawValue == null) {
                return '';
            }

            let stringValue = typeof rawValue === 'string' ? rawValue : String(rawValue);
            stringValue = stringValue.replace(',', '.').trim();

            if (stringValue === '') {
                return '';
            }

            if (!/^\d*\.?\d*$/.test(stringValue)) {
                return null;
            }

            if (stringValue === '.') {
                return '0.';
            }

            if (stringValue.startsWith('.')) {
                stringValue = `0${stringValue}`;
            }

            const numeric = Number(stringValue);
            if (!Number.isFinite(numeric)) {
                return null;
            }

            if (numeric < 0) {
                return '0';
            }

            if (numeric > 100) {
                return '100';
            }

            if (stringValue.endsWith('.')) {
                return stringValue;
            }

            return stringValue
                .replace(/\.0+$/, '')
                .replace(/(\.\d*?)0+$/, '$1');
        };

        const resolvePercentInputValue = (value) => {
            if (value === '' || value == null) {
                return '';
            }
            if (typeof value === 'string') {
                return value;
            }
            return formatNumberForInput(value);
        };

        const ensureExcelLibrary = () => {
            if (!window.ExcelJS) {
                throw new Error('Biblioteka ExcelJS nie została załadowana.');
            }
            return window.ExcelJS;
        };

        const normalizeCellValue = (value) => {
            if (value == null) return null;
            if (typeof value === 'object') {
                if (Array.isArray(value.richText)) {
                    return value.richText.map(part => part.text).join('');
                }
                if (Object.prototype.hasOwnProperty.call(value, 'text')) {
                    return value.text;
                }
                if (Object.prototype.hasOwnProperty.call(value, 'result')) {
                    return value.result;
                }
                if (Object.prototype.hasOwnProperty.call(value, 'value')) {
                    return value.value;
                }
            }
            return value;
        };

        const readExcelRows = async (file) => {
            const ExcelJS = ensureExcelLibrary();
            const buffer = await file.arrayBuffer();
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);
            const worksheet = workbook.worksheets[0];
            if (!worksheet) {
                throw new Error('Plik nie zawiera żadnego arkusza.');
            }

            const columnCount = worksheet.actualColumnCount || 0;
            const rows = [];
            worksheet.eachRow({ includeEmpty: true }, (row) => {
                const values = [];
                for (let col = 1; col <= columnCount; col += 1) {
                    values.push(normalizeCellValue(row.getCell(col).value));
                }
                rows.push(values);
            });

            return rows;
        };

        const normalizeHeaderKey = (header) => {
            if (header == null) {
                return '';
            }
            const base = String(header)
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();
            return base
                .replace(/\s+/g, '')
                .replace(/[\[\]()]/g, '')
                .replace(/\./g, '')
                .replace(/,/g, '')
                .replace(/²/g, '2');
        };

        const findNormalizedHeaderIndex = (headers, variants) => {
            const normalizedHeaders = headers.map(normalizeHeaderKey);
            for (const variant of variants) {
                const normalizedVariant = normalizeHeaderKey(variant);
                const index = normalizedHeaders.indexOf(normalizedVariant);
                if (index !== -1) {
                    return index;
                }
            }
            return -1;
        };

        const exportToExcel = async (data, sheetName, fileName) => {
            const ExcelJS = ensureExcelLibrary();
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet(sheetName);

            if (data.length > 0) {
                const headers = Object.keys(data[0]);
                const columnWidths = headers.map((header) => {
                    const maxLen = data.reduce((max, row) => {
                        const cellValue = row[header];
                        const cellLength = cellValue == null ? 0 : String(cellValue).length;
                        return Math.max(max, cellLength);
                    }, header.length);
                    return Math.min(40, Math.max(10, maxLen + 2));
                });

                worksheet.columns = headers.map((header, index) => ({
                    header,
                    key: header,
                    width: columnWidths[index] || header.length + 2,
                }));

                data.forEach((row) => worksheet.addRow(row));
            } else {
                worksheet.addRow([]);
            }

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        const safeExcelExport = async (data, sheetName, fileName, label) => {
            try {
                await exportToExcel(data, sheetName, fileName);
            } catch (error) {
                console.error(`Błąd eksportu danych ${label}:`, error);
                alert(`Nie udało się wyeksportować danych ${label}. Sprawdź konsolę przeglądarki.`);
            }
        };

        const exportPorothermToExcel = async (products, agreement) => {
            const excelData = products.map(product => ({
                'Nazwa produktu': product.name,
                'Lokalizacja': product.location,
                'Cennik net': product.netPrice,
                'Rabat dod.': formatPercentage(product.additionalDiscount, 1),
                'Zakup netto': product.netPurchasePrice.toFixed(2),
                'Transp/szt.': product.transportPerUnit.toFixed(2),
                'Loco Malbork': product.localPrice.toFixed(2),
                'Cena netto KL': product.customerNetPrice.toFixed(2),
                'Cena brutto KL': product.customerGrossPrice.toFixed(2),
                'Zużycie szt/m2': (product.consumptionPerM2 == null || product.consumptionPerM2 === '') ? '' : Number(product.consumptionPerM2).toFixed(2),
                'Cena m2 brutto': product.grossPricePerSquareMeter == null ? '' : product.grossPricePerSquareMeter.toFixed(2),
                'szt./paleta': product.unitsPerPallet,
                'palety/auto': product.palletsPerTruck,
                'Kategoria': product.category || '',
                'Specyfikacja': product.specifications || ''
            }));
            const fileName = `POROTHERM_${agreement.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'POROTHERM', fileName, 'POROTHERM');
        };

        const exportSolbetToExcel = async (products, settings = {}) => {
            const excelData = products.map(p => {
                const calculated = calculateSolbetProduct(p, settings);
                return {
                    'ID': p.id,
                    'Nazwa produktu': p.name,
                    'Gęstość': p.density,
                    'Szerokość': p.width,
                    'Wysokość': p.height,
                    'Długość': p.length,
                    'Cena netto': p.priceNet,
                    'Cena brutto KL': calculated.customerGrossPrice.toFixed(2),
                    'Cena m2 brutto': calculated.grossPricePerSquareMeter.toFixed(2),
                    'Kategoria': p.category,
                    'Sztuk na palecie': p.unitsPerPallet,
                    'Palet na auto': p.palletsPerTruck,
                };
            });
            const fileName = `SOLBET_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'SOLBET', fileName, 'SOLBET');
        };

        const exportBrukbetToExcel = async (products) => {
            const excelData = products.map(p => ({
                'Symbol': p.symbol,
                'Nazwa': p.nazwa,
                'ZP': p.zp,
                'Grupa': p.grupa,
                'Cena netto': p.cenaNetto,
                'Rabat (%)': p.rabat,
                'Cena po rabacie': p.cenaPoRabacie.toFixed(2),
                'Koszt transportu/szt.': p.transportPerUnit.toFixed(2),
                'Cena sprzedaży netto': p.cenaSprzedazyNetto.toFixed(2),
                'Cena sprzedaży brutto': p.cenaSprzedazyBrutto.toFixed(2),
                'Ilość na palecie': p.iloscNaPalecie,
                'Jednostka': p.jednostka,
                'Waga palety (t)': p.waga,
                'Maks. palet na auto': p.maxPalletsPerTruck,
            }));
            const fileName = `BRUKBET_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'BRUK-BET', fileName, 'BRUK-BET');
        };

        const exportSemmelrockToExcel = async (products) => {
            const excelData = products.map(p => ({
                'Symbol': p.symbol,
                'Grupa': p.grupa,
                'Nazwa': p.nazwa,
                'Jednostka': p.jednostka,
                'Ilość na palecie': p.iloscNaPalecie,
                'Maks. palet/auto': p.maxPalletsPerTruck,
                'Waga palety (t)': p.waga,
                'Cena netto': p.cenaNetto,
                'Rabat (%)': p.rabat,
                'Cena po rabacie': p.cenaPoRabacie.toFixed(2),
                'Koszt transportu/szt.': p.transportPerUnit.toFixed(2),
                'Cena sprzedaży netto': p.cenaSprzedazyNetto.toFixed(2),
                'Cena sprzedaży brutto': p.cenaSprzedazyBrutto.toFixed(2),
            }));
            const fileName = `SEMMELROCK_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'SEMMELROCK', fileName, 'SEMMELROCK');
        };

        const exportPolbrukToExcel = async (products) => {
            const excelData = products.map(p => ({
                'Symbol': p.symbol,
                'Nazwa': p.nazwa,
                'Kształt': p.ksztalt,
                'Kolorystyka': p.kolorystyka || '',
                'Cena detaliczna': p.cenaNetto,
                'Rabat (%)': p.rabat,
                'Cena po rabacie': p.cenaPoRabacie.toFixed(2),
                'Koszt transportu/szt.': p.transportPerUnit.toFixed(2),
                'Cena sprzedaży netto': p.cenaSprzedazyNetto.toFixed(2),
                'Cena sprzedaży brutto': p.cenaSprzedazyBrutto.toFixed(2),
                'Ilość na palecie': p.iloscNaPalecie,
                'Jednostka': p.jednostka,
                'Waga palety (t)': p.waga,
                'Maks. palet na auto': p.maxPalletsPerTruck,
            }));
            const fileName = `POLBRUK_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'POLBRUK', fileName, 'POLBRUK');
        };

        const exportSilikatyToExcel = async (products, settings, modes) => {
            const excelData = products.map(p => {
                const calculated = calculateSilikatyProduct(p, settings, modes);
                return {
                    'Nazwa': p.name,
                    'Cena katalogowa netto': p.priceNet,
                    'Rabat zastosowany (%)': calculated.discountApplied,
                    'Zakup netto': calculated.netPurchasePrice.toFixed(2),
                    'Transport/szt.': calculated.transportPerUnit.toFixed(2),
                    'Cena loco': calculated.localPrice.toFixed(2),
                    'Cena klient netto': calculated.customerNetPrice.toFixed(2),
                    'Cena klient brutto': calculated.customerGrossPrice.toFixed(2),
                    'Zużycie (szt/m2)': (p.consumptionPerM2 == null || p.consumptionPerM2 === '') ? '' : Number(p.consumptionPerM2).toFixed(2),
                    'Cena m2 brutto': calculated.grossPricePerSquareMeter == null ? '' : calculated.grossPricePerSquareMeter.toFixed(2),
                    'Sztuk na palecie': p.unitsPerPallet,
                    'Klasa': p.className || '',
                    'Waga (kg)': p.weight || '',
                    'Wymiary': p.dimensions || '',
                };
            });
            const fileName = `SILIKATY_SZLACHTA_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'SILIKATY', fileName, 'SILIKATY SZLACHTA');
        };

        const exportWeberToExcel = async (products, settings) => {
            const excelData = products.map(product => {
                const packageSizeNumber = parseLooseNumber(product.packageSize);
                const packageUnit = product.packageUnit || product.unit || '';
                const packageDisplay = Number.isFinite(packageSizeNumber) && packageSizeNumber > 0
                    ? `${formatNumberForInput(packageSizeNumber)} ${packageUnit}`.trim()
                    : (packageUnit || '');
                const priceOverrideNumeric = parseLooseNumber(product.priceOverride);
                const priceNetSource = parseLooseNumber(product.priceNet);

                return {
                    'Kod produktu': product.id,
                    'Asortyment': product.name,
                    'Opakowanie': packageDisplay,
                    'Jednostka bazowa': product.unit || '',
                    'Cena katalogowa netto': Number(product.resolvedBasePrice.toFixed(2)),
                    'Cena katalogowa (opis)': product.priceRaw || '',
                    'Cena zakupu netto': Number(product.resolvedPurchasePrice.toFixed(2)),
                    'Cena klient netto': Number(product.resolvedCustomerUnitPriceNet.toFixed(2)),
                    'Cena klient brutto': Number(product.resolvedCustomerUnitPriceGross.toFixed(2)),
                    'Cena klient (opak.) netto': Number(product.resolvedCustomerPackagePriceNet.toFixed(2)),
                    'Cena klient (opak.) brutto': Number(product.resolvedCustomerPackagePriceGross.toFixed(2)),
                    'Cena nadpisana netto': Number.isFinite(priceOverrideNumeric) && priceOverrideNumeric >= 0 ? Number(priceOverrideNumeric.toFixed(2)) : '',
                    'Wielkość opakowania': Number.isFinite(packageSizeNumber) && packageSizeNumber > 0 ? Number(packageSizeNumber.toFixed(6)) : '',
                    'Jednostka opakowania': packageUnit,
                    'Grupa (źródło)': product.group || '',
                    'Cena netto (źródło)': Number.isFinite(priceNetSource) ? Number(priceNetSource.toFixed(2)) : '',
                    'Parametr rabatu [%]': ensurePercentScale(settings.purchaseDiscount),
                    'Parametr marży [%]': ensurePercentScale(settings.margin),
                };
            });
            const fileName = `WEBER_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'WEBER', fileName, 'WEBER');
        };

        const exportDocieplenieToExcel = async (products, groupLabelMap = {}) => {
            const fallbackMap = DOCIEPLENIE_BASE_GROUPS.reduce((acc, group) => {
                acc[group.id] = group.label;
                return acc;
            }, {});
            const excelData = products.map((product) => ({
                'Nazwa': product.name,
                'Grupa': groupLabelMap[product.group] || fallbackMap[product.group] || product.group,
                'Cena netto (zakup)': Number(product.priceNet || 0),
                'Zużycie / m²': product.consumptionPerM2 == null || product.consumptionPerM2 === ''
                    ? ''
                    : Number(product.consumptionPerM2),
                'Jednostka': product.unit || '',
                'ID': product.id,
            }));
            const fileName = `DOCIEPLENIE_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'DOCIEPLENIE', fileName, 'DOCIEPLENIE');
        };

        const exportKnaufToExcel = async (products, meta = {}) => {
            const excelData = products.map((product) => ({
                'ID': product.id,
                'Produkt': product.name,
                'Lambda': product.lambda,
                'Grubość (cm)': product.thicknessCm,
                'm² w paczce': product.coveragePerPack,
                'Cena paczki netto': product.pricePerPack,
                'Notatka': product.note || '',
            }));
            const versionSuffix = meta.priceListVersion ? `_${meta.priceListVersion.replace(/\\s+/g, '_')}` : '';
            const dateSuffix = meta.priceListDate ? `_${meta.priceListDate}` : '';
            const fileName = `KNAUF${versionSuffix}${dateSuffix}_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'KNAUF', fileName, 'KNAUF');
        };

        const exportRockwoolToExcel = async (products, meta = {}) => {
            const excelData = products.map((product) => ({
                'ID': product.id,
                'Produkt': product.name,
                'Lambda': product.lambda,
                'Grubość (cm)': product.thicknessCm,
                'm² w paczce': product.coveragePerPack,
                'Cena paczki netto': product.pricePerPack,
                'Notatka': product.note || '',
            }));
            const versionSuffix = meta.priceListVersion ? `_${meta.priceListVersion.replace(/\s+/g, '_')}` : '';
            const dateSuffix = meta.priceListDate ? `_${meta.priceListDate}` : '';
            const fileName = `ROCKWOOL${versionSuffix}${dateSuffix}_${new Date().toISOString().split('T')[0]}.xlsx`;
            await safeExcelExport(excelData, 'ROCKWOOL', fileName, 'ROCKWOOL');
        };



        //======================================================================
        // HOOKS
        //======================================================================
        function usePersistentState(key, initialValue) {
            const [data, setData] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    if (!item) {
                        return initialValue;
                    }

                    const parsed = JSON.parse(item);
                    if (!parsed || typeof parsed !== 'object' || !parsed.content) {
                        window.localStorage.removeItem(key);
                        return initialValue;
                    }

                    return {
                        lastUpdate: parsed.lastUpdate || initialValue.lastUpdate,
                        content: parsed.content,
                    };
                } catch (error) {
                    console.warn(`Error reading localStorage key “${key}”:`, error);
                    return initialValue;
                }
            });

            const [syncStatus, setSyncStatus] = useState('offline');
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const syncTimerRef = useRef(null);
            const syncPollRef = useRef(null);

            const syncData = useCallback(async () => {
                if (!isOnline || !pocketbaseEnabled) {
                    setSyncStatus('offline');
                    return;
                }

                setSyncStatus('syncing');

                const localData = JSON.parse(window.localStorage.getItem(key))
                    || initialValue;
                const { data: remoteData, error } = await pocketbaseService.getData(key);

                if (error) {
                    console.error('PocketBase fetch error:', error);
                    setSyncStatus('pending');
                    return;
                }

                const localTimestamp = Date.parse(localData.lastUpdate);
                const safeLocal = Number.isFinite(localTimestamp) ? localTimestamp : 0;
                const remoteTimestamp = remoteData?.last_update
                    ? Date.parse(remoteData.last_update)
                    : 0;
                const safeRemote = Number.isFinite(remoteTimestamp) ? remoteTimestamp : 0;

                if (!remoteData || safeLocal > safeRemote) {
                    // Local is newer or remote doesn't exist, so push
                    const { error: upsertError } = await pocketbaseService.upsertData(
                        key,
                        localData
                    );
                    if (upsertError) {
                        console.error('PocketBase upsert error:', upsertError);
                        setSyncStatus('pending');
                    } else {
                        setSyncStatus('synced');
                    }
                } else if (safeRemote > safeLocal) {
                    // Remote is newer, so pull
                    const newData = {
                        lastUpdate: remoteData.last_update,
                        content: remoteData.data
                    };
                    window.localStorage.setItem(key, JSON.stringify(newData));
                    setData(newData);
                    setSyncStatus('synced');
                } else {
                    // Already in sync
                    setSyncStatus('synced');
                }
            }, [key, isOnline, initialValue]);
            
            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                if (syncPollRef.current) {
                    clearInterval(syncPollRef.current);
                    syncPollRef.current = null;
                }

                if (isOnline && pocketbaseEnabled) {
                    // Initial sync on becoming online or on component mount
                    syncData();

                    // Poll to catch updates from other clients
                    syncPollRef.current = setInterval(() => {
                        syncData();
                    }, 60000);
                } else {
                    setSyncStatus('offline');
                }

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                    if (syncPollRef.current) {
                        clearInterval(syncPollRef.current);
                        syncPollRef.current = null;
                    }
                };
            }, [isOnline, key, initialValue, syncData]);

            useEffect(() => {
                return () => {
                    if (syncTimerRef.current) {
                        clearTimeout(syncTimerRef.current);
                    }
                    if (syncPollRef.current) {
                        clearInterval(syncPollRef.current);
                        syncPollRef.current = null;
                    }
                };
            }, []);

            const setPersistentData = (newValue) => {
                // Keep timestamps monotonic so sync can detect newer payloads
                const previousTimestamp = data?.lastUpdate ? Date.parse(data.lastUpdate) : 0;
                const safePrevious = Number.isFinite(previousTimestamp) ? previousTimestamp : 0;
                const candidate = Date.now();
                const nextTimestamp = Math.max(candidate, safePrevious + 1);
                const updatedData = {
                    ...newValue,
                    lastUpdate: new Date(nextTimestamp).toISOString()
                };
                
                try {
                    window.localStorage.setItem(key, JSON.stringify(updatedData));
                    setData(updatedData);
                    if (isOnline && pocketbaseEnabled) {
                        setSyncStatus('pending');
                        if (syncTimerRef.current) {
                            clearTimeout(syncTimerRef.current);
                        }
                        // Debounce writes so rapid edits collapse into a single sync call
                        syncTimerRef.current = setTimeout(() => {
                            syncTimerRef.current = null;
                            syncData();
                        }, 1500);
                    } else {
                        if (syncTimerRef.current) {
                            clearTimeout(syncTimerRef.current);
                            syncTimerRef.current = null;
                        }
                        setSyncStatus('offline');
                    }
                } catch (error) {
                    console.warn(`Error setting localStorage key “${key}”:`, error);
                }
            };

            return [data, setPersistentData, syncStatus, syncData];
        }

        //======================================================================
        // REUSABLE UI COMPONENTS
        //======================================================================
        const Card = ({ children, className = '' }) => <div className={`bg-white border border-slate-200 rounded-lg shadow-sm ${className}`}>{children}</div>;
        const CardHeader = ({ children, className = '' }) => <div className={`p-4 sm:p-6 border-b border-slate-200 ${className}`}>{children}</div>;
        const CardContent = ({ children, className = '' }) => <div className={`p-4 sm:p-6 ${className}`}>{children}</div>;
        const CardTitle = ({ children }) => <h3 className="text-lg font-semibold text-slate-800">{children}</h3>;
        const CardDescription = ({ children }) => <p className="text-sm text-slate-500 mt-1">{children}</p>;
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return ReactDOM.createPortal(
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h3 className="text-lg font-semibold">{title}</h3>
                            <button onClick={onClose} className="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                        </div>
                        <div className="p-6 overflow-y-auto">
                            {children}
                        </div>
                    </div>
                </div>,
                document.body
            );
        };

        const FormGroup = ({ label, children, error, variant }) => {
            const isDefaultDiscount = label === 'Rabat podst. domyślny' || variant === 'default-discount';
            const labelClassName = isDefaultDiscount
                ? 'block text-sm font-medium mb-1 text-red-600'
                : 'block text-sm font-medium text-slate-600 mb-1';

            return (
                <div className="mb-4">
                    <label className={labelClassName}>{label}</label>
                    {children}
                    {error && <p className="text-xs text-red-600 mt-1">{error}</p>}
                </div>
            );
        };

        const Input = ({ error, onKeyDown, inputMode, type = 'text', value, ...props }) => {
            const handleKeyDown = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    event.currentTarget.blur();
                }
                if (onKeyDown) {
                    onKeyDown(event);
                }
            };

            const resolvedInputMode = inputMode || (type === 'number' ? 'decimal' : undefined);
            const resolvedValue = type === 'number' ? formatNumberForInput(value) : (value ?? '');

            return (
                <input
                    type={type}
                    value={resolvedValue}
                    inputMode={resolvedInputMode}
                    onKeyDown={handleKeyDown}
                    className={`w-full p-2 border rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500 ${error ? 'border-red-500' : 'border-slate-300'}`}
                    {...props}
                />
            );
        };
        const Select = ({ className = '', ...props }) => <select {...props} className={`w-full p-2 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500 ${className}`} />;

        const StatsCard = ({ value, label }) => (
            <Card>
                <CardContent className="text-center">
                    <div className="text-2xl font-bold text-blue-600">{value}</div>
                    <div className="text-sm text-slate-500 mt-1">{label}</div>
                </CardContent>
            </Card>
        );

        const PriceListDateField = ({ value, onChange, className = '' }) => (
            <div className={`border-2 border-amber-500 rounded-md px-3 py-2 bg-amber-50 shadow-sm max-w-xs w-full ${className}`}>
                <label className="block text-[11px] font-extrabold uppercase text-amber-800 mb-1 tracking-wide">
                    Data obowiązywania cennika
                </label>
                <input
                    type="date"
                    value={value || ''}
                    onChange={onChange}
                    className="w-full border border-amber-500 rounded-md px-2 py-1 text-sm font-bold text-amber-900 bg-white placeholder:text-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-300"
                />
            </div>
        );
        
        const SyncStatusIndicator = ({ status, onSync }) => {
            const statusConfig = {
                synced: {
                    color: 'bg-green-600 text-white',
                    text: 'Dane zsynchronizowane'
                },
                pending: {
                    color: 'bg-yellow-500 text-black',
                    text: 'Oczekuje na synchronizację. Kliknij, aby przyspieszyć.'
                },
                syncing: {
                    color: 'bg-blue-600 text-white',
                    text: 'Synchronizowanie...'
                },
                offline: {
                    color: 'bg-slate-600 text-white',
                    text: 'Jesteś offline. Zmiany zostaną zapisane lokalnie.'
                }
            };
            const currentConfig = statusConfig[status] || statusConfig.offline;

            return (
                 <div className="fixed bottom-6 right-6 z-40 group">
                    <button
                        onClick={onSync}
                        disabled={status === 'syncing' || status === 'offline'}
                        className={`flex items-center justify-center h-14 w-14 rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:scale-110 ${currentConfig.color} disabled:cursor-not-allowed disabled:opacity-70`}
                        aria-label={currentConfig.text}
                    >
                        <SyncCloudIcon status={status} />
                    </button>
                    <div className="absolute bottom-1/2 right-full mr-4 transform translate-y-1/2 px-3 py-1.5 bg-slate-800 text-white text-sm rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                        {currentConfig.text}
                    </div>
                </div>
            );
        };


        //======================================================================
        // FORMS
        const LeierMaterialForm = ({ product, onSave, onCancel }) => {
            const [formData, setFormData] = useState(() => ({
                symbol: product?.symbol ?? '',
                name: product?.name ?? '',
                priceNet: product?.priceNet ?? '',
                discountPercent: product?.discountPercent ?? '',
                transportPerUnit: product?.transportPerUnit ?? '',
                unitsPerPallet: product?.unitsPerPallet ?? '',
                unit: product?.unit ?? '',
                palletWeight: product?.palletWeight ?? ''
            }));

            const handleTextChange = (event) => {
                const { name, value } = event.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleNumericChange = (event, options = {}) => {
                const { name, value } = event.target;
                if (options.percent) {
                    const normalized = normalizePercentInputValue(value);
                    if (normalized === null) {
                        return;
                    }
                    setFormData(prev => ({ ...prev, [name]: normalized }));
                    return;
                }

                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setFormData(prev => ({ ...prev, [name]: parsed }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();
                if (!formData.name.trim()) {
                    alert('Nazwa produktu jest wymagana.');
                    return;
                }

                onSave({
                    symbol: formData.symbol,
                    name: formData.name,
                    priceNet: formData.priceNet,
                    discountPercent: formData.discountPercent === '' ? 0 : Number(formData.discountPercent),
                    transportPerUnit: formData.transportPerUnit === '' ? 0 : Number(formData.transportPerUnit),
                    unitsPerPallet: formData.unitsPerPallet,
                    unit: formData.unit,
                    palletWeight: formData.palletWeight
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Symbol">
                            <Input name="symbol" value={formData.symbol} onChange={handleTextChange} />
                        </FormGroup>
                        <FormGroup label="Nazwa" >
                            <Input name="name" value={formData.name} onChange={handleTextChange} required />
                        </FormGroup>
                        <FormGroup label="Cena netto">
                            <Input name="priceNet" type="number" step="0.01" min="0" value={formData.priceNet} onChange={handleNumericChange} required />
                        </FormGroup>
                        <FormGroup label="Rabat (%)">
                            <Input name="discountPercent" type="number" step="0.01" min="0" max="100" value={formData.discountPercent} onChange={(event) => handleNumericChange(event, { percent: true })} />
                        </FormGroup>
                        <FormGroup label="Koszt transportu/szt. (zł)">
                            <Input name="transportPerUnit" type="number" step="0.01" min="0" value={formData.transportPerUnit} onChange={handleNumericChange} />
                        </FormGroup>
                        <FormGroup label="Ilość na palecie">
                            <Input name="unitsPerPallet" value={formData.unitsPerPallet} onChange={handleTextChange} />
                        </FormGroup>
                        <FormGroup label="Jednostka">
                            <Input name="unit" value={formData.unit} onChange={handleTextChange} />
                        </FormGroup>
                        <FormGroup label="Waga palety (t)">
                            <Input name="palletWeight" value={formData.palletWeight} onChange={handleTextChange} />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };

        const LeierSlabProductForm = ({ product, onSave, onCancel }) => {
            const vatRate = 1.23;
            const [formData, setFormData] = useState(() => ({
                name: product?.name ?? '',
                unit: product?.unit ?? '',
                catalogNet: product?.catalogNet ?? '',
                discountPercent: product?.discount != null ? ensurePercentScale(product.discount) : '',
                defaultQuantity: product?.defaultQuantity ?? ''
            }));

            const handleTextChange = (event) => {
                const { name, value } = event.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleNumericChange = (event, options = {}) => {
                const { name, value } = event.target;
                if (options.percent) {
                    const normalized = normalizePercentInputValue(value);
                    if (normalized === null) {
                        return;
                    }
                    setFormData(prev => ({ ...prev, [name]: normalized }));
                    return;
                }

                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setFormData(prev => ({ ...prev, [name]: parsed }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();
                if (!formData.name.trim()) {
                    alert('Nazwa produktu jest wymagana.');
                    return;
                }

                const catalogNet = Number(formData.catalogNet || 0);
                const discountPercent = Number(formData.discountPercent || 0);
                const defaultQuantity = formData.defaultQuantity === '' ? '' : Number(formData.defaultQuantity);

                onSave({
                    name: formData.name,
                    unit: formData.unit,
                    catalogNet,
                    catalogGross: catalogNet * vatRate,
                    discount: discountPercent / 100,
                    defaultQuantity
                });
            };

            const catalogGrossPreview = formatCurrency((Number(formData.catalogNet || 0) * vatRate));

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa">
                            <Input name="name" value={formData.name} onChange={handleTextChange} required />
                        </FormGroup>
                        <FormGroup label="Jednostka">
                            <Input name="unit" value={formData.unit} onChange={handleTextChange} required />
                        </FormGroup>
                        <FormGroup label="Cena katalogowa netto">
                            <Input name="catalogNet" type="number" step="0.01" min="0" value={formData.catalogNet} onChange={handleNumericChange} required />
                        </FormGroup>
                        <FormGroup label="Rabat (%)">
                            <Input name="discountPercent" type="number" step="0.01" min="0" max="100" value={formData.discountPercent} onChange={(event) => handleNumericChange(event, { percent: true })} />
                        </FormGroup>
                        <FormGroup label="Domyślna ilość">
                            <Input name="defaultQuantity" type="number" step="0.01" min="0" value={formData.defaultQuantity} onChange={handleNumericChange} />
                        </FormGroup>
                        <FormGroup label="Cena katalogowa brutto">
                            <Input value={catalogGrossPreview} readOnly />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };

        //======================================================================
        const PorothermAgreementForm = ({ agreement, onSave, onCancel }) => {
            const [formData, setFormData] = useState(agreement || { name: '', code: '' });
            const [error, setError] = useState('');

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                if (name === 'name' && value.trim()) {
                    setError('');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.name.trim()) {
                    setError('Nazwa porozumienia jest wymagana.');
                    return;
                }
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit}>
                    <FormGroup label="Nazwa Porozumienia" error={error}>
                        <Input name="name" value={formData.name} onChange={handleChange} error={!!error} />
                    </FormGroup>
                    <FormGroup label="Kod Porozumienia (opcjonalnie)">
                        <Input name="code" value={formData.code} onChange={handleChange} />
                    </FormGroup>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };
        
        const PorothermProductForm = ({ product, onSave, onCancel }) => {
            const [formData, setFormData] = useState(() => {
                const base = product ? { ...product } : {
                    name: '',
                    location: 'Lębork',
                    netPrice: '',
                    additionalDiscount: '',
                    unitsPerPallet: '',
                    palletsPerTruck: '',
                    consumptionPerM2: '',
                    category: '',
                    specifications: '',
                    width: '',
                    height: '',
                    length: '',
                };

                const normalizedAdditionalDiscount = base.additionalDiscount === '' || base.additionalDiscount == null
                    ? ''
                    : ensurePercentScale(base.additionalDiscount);

                return {
                    ...base,
                    width: base.width ?? '',
                    height: base.height ?? '',
                    length: base.length ?? '',
                    consumptionPerM2: base.consumptionPerM2 ?? '',
                    additionalDiscount: normalizedAdditionalDiscount,
                };
            });
            const [errors, setErrors] = useState({});

            const validate = (data) => {
                const newErrors = {};
                const discount = data.additionalDiscount;
                if (discount !== '' && (discount < 0 || discount > 100)) {
                    newErrors.additionalDiscount = 'Rabat musi być w zakresie 0-100%.';
                }
                return newErrors;
            };

            const handleNumericChange = (e, isPercentage = false, numericOptions = {}) => {
                const { name, value } = e.target;
                const parsedValue = isPercentage
                    ? parsePercentageInput(value)
                    : parseNumericInput(value, numericOptions);
                if (parsedValue === null) {
                    return;
                }

                const finalValue = isPercentage
                    ? (parsedValue === '' ? '' : roundToPrecision(parsedValue, 6))
                    : parsedValue;

                const newFormData = { ...formData, [name]: finalValue };
                setFormData(newFormData);
                setErrors(validate(newFormData));
            };
            
             const handleTextChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const validationErrors = validate(formData);
                if (Object.keys(validationErrors).length > 0) {
                    setErrors(validationErrors);
                    return;
                }
                onSave(formData);
            };

            const isFormValid = Object.keys(validate(formData)).length === 0;

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa produktu"><Input name="name" value={formData.name} onChange={handleTextChange} required /></FormGroup>
                        <FormGroup label="Lokalizacja"><Select name="location" value={formData.location} onChange={handleTextChange}><option>Lębork</option><option>Gnaszyn</option></Select></FormGroup>
                        <FormGroup label="Szerokość (mm)"><Input name="width" type="number" step="1" min="0" value={formData.width} onChange={(e) => handleNumericChange(e, false, { min: 0 })} /></FormGroup>
                        <FormGroup label="Wysokość (mm)"><Input name="height" type="number" step="1" min="0" value={formData.height} onChange={(e) => handleNumericChange(e, false, { min: 0 })} /></FormGroup>
                        <FormGroup label="Długość (mm)"><Input name="length" type="number" step="1" min="0" value={formData.length} onChange={(e) => handleNumericChange(e, false, { min: 0 })} /></FormGroup>
                        <FormGroup label="Cena netto"><Input name="netPrice" type="number" step="0.01" value={formData.netPrice} onChange={(e) => handleNumericChange(e)} required /></FormGroup>
                        <FormGroup label="Rabat dodatkowy (%)" error={errors.additionalDiscount}>
                            <Input
                                name="additionalDiscount"
                                type="number"
                                step="0.01"
                                min="0"
                                max="100"
                                value={formData.additionalDiscount}
                                onChange={(e) => handleNumericChange(e, true)}
                                error={!!errors.additionalDiscount}
                                required
                            />
                        </FormGroup>
                        <FormGroup label="Zużycie szt/m2 (opcjonalnie)">
                            <Input
                                name="consumptionPerM2"
                                type="number"
                                step="0.01"
                                min="0"
                                value={formData.consumptionPerM2}
                                onChange={(e) => handleNumericChange(e, false, { min: 0 })}
                            />
                        </FormGroup>
                        <FormGroup label="Sztuk na palecie"><Input name="unitsPerPallet" type="number" value={formData.unitsPerPallet} onChange={(e) => handleNumericChange(e)} required /></FormGroup>
                        <FormGroup label="Palet na auto"><Input name="palletsPerTruck" type="number" value={formData.palletsPerTruck} onChange={(e) => handleNumericChange(e)} required /></FormGroup>
                        <FormGroup label="Kategoria"><Input name="category" value={formData.category} onChange={handleTextChange} /></FormGroup>
                        <FormGroup label="Specyfikacja"><Input name="specifications" value={formData.specifications} onChange={handleTextChange} /></FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" disabled={!isFormValid} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300">Zapisz</button>
                    </div>
                </form>
            );
        };

        const SilikatyProductForm = ({ product, onSave, onCancel }) => {
            const [formData, setFormData] = useState(() => ({
                id: product?.id || '',
                name: product?.name || '',
                priceNet: product?.priceNet ?? '',
                unitsPerPallet: product?.unitsPerPallet ?? '',
                consumptionPerM2: product?.consumptionPerM2 ?? '',
                className: product?.className || '',
                weight: product?.weight ?? '',
                dimensions: product?.dimensions || '',
            }));
            const [errors, setErrors] = useState({});

            const validate = (data) => {
                const newErrors = {};
                if (!data.name.trim()) {
                    newErrors.name = 'Nazwa jest wymagana.';
                }
                const priceNumeric = parseLooseNumber(data.priceNet);
                if (!Number.isFinite(priceNumeric) || priceNumeric <= 0) {
                    newErrors.priceNet = 'Cena musi być dodatnią liczbą.';
                }
                const unitsNumeric = parseLooseNumber(data.unitsPerPallet);
                if (!Number.isFinite(unitsNumeric) || unitsNumeric <= 0) {
                    newErrors.unitsPerPallet = 'Wpisz dodatnią liczbę sztuk na palecie.';
                }
                const consumptionNumeric = parseLooseNumber(data.consumptionPerM2);
                if (data.consumptionPerM2 !== '' && (!Number.isFinite(consumptionNumeric) || consumptionNumeric < 0)) {
                    newErrors.consumptionPerM2 = 'Zużycie musi być dodatnie lub puste.';
                }
                return newErrors;
            };

            const handleChange = (e, isNumeric = false) => {
                const { name, value } = e.target;
                let finalValue = value;
                if (isNumeric) {
                    const parsed = parseNumericInput(value, { min: 0 });
                    if (parsed === null) {
                        return;
                    }
                    finalValue = parsed;
                }

                setFormData(prev => ({ ...prev, [name]: finalValue }));
                if (Object.keys(errors).length > 0) {
                    setErrors(validate({ ...formData, [name]: finalValue }));
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const validationErrors = validate(formData);
                if (Object.keys(validationErrors).length > 0) {
                    setErrors(validationErrors);
                    return;
                }

                onSave({
                    ...formData,
                    priceNet: parseLooseNumber(formData.priceNet),
                    unitsPerPallet: parseLooseNumber(formData.unitsPerPallet),
                    consumptionPerM2: formData.consumptionPerM2 === '' ? '' : roundToPrecision(parseLooseNumber(formData.consumptionPerM2), 6),
                    weight: formData.weight === '' ? '' : roundToPrecision(parseLooseNumber(formData.weight), 6),
                });
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa" error={errors.name}>
                            <Input name="name" value={formData.name} onChange={handleChange} placeholder="np. Bloczek N24" />
                        </FormGroup>
                        <FormGroup label="Cena katalogowa netto" error={errors.priceNet}>
                            <Input name="priceNet" value={formData.priceNet} onChange={(e) => handleChange(e, true)} />
                        </FormGroup>
                        <FormGroup label="Sztuk na palecie" error={errors.unitsPerPallet}>
                            <Input name="unitsPerPallet" value={formData.unitsPerPallet} onChange={(e) => handleChange(e, true)} />
                        </FormGroup>
                        <FormGroup label="Zużycie szt/m2" error={errors.consumptionPerM2}>
                            <Input name="consumptionPerM2" value={formData.consumptionPerM2} onChange={(e) => handleChange(e, true)} placeholder="opcjonalnie" />
                        </FormGroup>
                        <FormGroup label="Klasa">
                            <Input name="className" value={formData.className} onChange={handleChange} placeholder="np. 15" />
                        </FormGroup>
                        <FormGroup label="Waga (kg)">
                            <Input name="weight" value={formData.weight} onChange={(e) => handleChange(e, true)} placeholder="opcjonalnie" />
                        </FormGroup>
                        <FormGroup label="Wymiary">
                            <Input name="dimensions" value={formData.dimensions} onChange={handleChange} placeholder="np. 24x24x59" />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };

        const DocieplenieProductForm = ({ product, onSave, onCancel, groups = [] }) => {
            const [formData, setFormData] = useState(() => ({
                id: product?.id || '',
                name: product?.name || '',
                group: product?.group || (groups && groups[0]?.id) || '',
                priceNet: product?.priceNet ?? '',
                unit: product?.unit || 'szt',
                packageSize: product?.packageSize ?? '',
                packageUnit: product?.packageUnit || '',
                consumptionPerM2: product?.consumptionPerM2 ?? '',
            }));
            const [errors, setErrors] = useState({});

            const validate = (data) => {
                const nextErrors = {};
                if (!data.name.trim()) {
                    nextErrors.name = 'Podaj nazwę.';
                }
                if (!data.group) {
                    nextErrors.group = 'Wybierz grupę dla list rozwijanych.';
                }
                const priceValue = parseLooseNumber(data.priceNet);
                if (!Number.isFinite(priceValue) || priceValue <= 0) {
                    nextErrors.priceNet = 'Cena musi być dodatnia.';
                }
                const pkgSize = parseLooseNumber(data.packageSize);
                if (data.packageSize !== '' && (!Number.isFinite(pkgSize) || pkgSize <= 0)) {
                    nextErrors.packageSize = 'Opakowanie musi być dodatnie lub puste.';
                }
                const consumptionValue = parseLooseNumber(data.consumptionPerM2);
                if (data.consumptionPerM2 !== '' && (!Number.isFinite(consumptionValue) || consumptionValue < 0)) {
                    nextErrors.consumptionPerM2 = 'Zużycie nie może być ujemne.';
                }
                return nextErrors;
            };

            const handleChange = (event, isNumeric = false, numericOptions = { min: 0 }) => {
                const { name, value } = event.target;
                let finalValue = value;
                if (isNumeric) {
                    const parsed = parseNumericInput(value, numericOptions);
                    if (parsed === null) {
                        return;
                    }
                    finalValue = parsed;
                }

                setFormData(prev => ({ ...prev, [name]: finalValue }));
                if (Object.keys(errors).length > 0) {
                    setErrors(validate({ ...formData, [name]: finalValue }));
                }
            };

            const handleSubmit = (event) => {
                event.preventDefault();
                const validationErrors = validate(formData);
                if (Object.keys(validationErrors).length > 0) {
                    setErrors(validationErrors);
                    return;
                }

                onSave({
                    ...formData,
                    priceNet: roundToPrecision(parseLooseNumber(formData.priceNet), 6),
                    packageSize: formData.packageSize === '' ? '' : roundToPrecision(parseLooseNumber(formData.packageSize), 6),
                    packageUnit: formData.packageUnit || '',
                    consumptionPerM2: formData.consumptionPerM2 === ''
                        ? ''
                        : roundToPrecision(parseLooseNumber(formData.consumptionPerM2), 6),
                });
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa" error={errors.name}>
                            <Input
                                name="name"
                                value={formData.name}
                                onChange={handleChange}
                                placeholder="np. Klej do styropianu 25 kg"
                                error={!!errors.name}
                            />
                        </FormGroup>
                        <FormGroup label="Grupa" error={errors.group}>
                            <Select
                                name="group"
                                value={formData.group}
                                onChange={handleChange}
                                className="w-full"
                            >
                                {groups.map((group) => (
                                    <option key={group.id} value={group.id}>{group.label}</option>
                                ))}
                            </Select>
                        </FormGroup>
                        <FormGroup label="Cena netto" error={errors.priceNet}>
                            <Input
                                name="priceNet"
                                type="number"
                                step="0.01"
                                value={formData.priceNet}
                                onChange={(e) => handleChange(e, true)}
                                error={!!errors.priceNet}
                            />
                        </FormGroup>
                        <FormGroup label="Zużycie / m²" error={errors.consumptionPerM2}>
                            <Input
                                name="consumptionPerM2"
                                type="number"
                                step="0.01"
                                min="0"
                                value={formData.consumptionPerM2}
                                onChange={(e) => handleChange(e, true, { min: 0 })}
                                placeholder="np. 1.1"
                                error={!!errors.consumptionPerM2}
                            />
                        </FormGroup>
                        <FormGroup label="Wielkość opakowania" error={errors.packageSize}>
                            <div className="flex gap-2">
                                <Input
                                    name="packageSize"
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={formData.packageSize}
                                    onChange={(e) => handleChange(e, true, { min: 0 })}
                                    placeholder="np. 25"
                                    className="w-full"
                                    error={!!errors.packageSize}
                                />
                                <Input
                                    name="packageUnit"
                                    value={formData.packageUnit}
                                    onChange={handleChange}
                                    placeholder="np. kg / m² / szt"
                                    className="w-28"
                                />
                            </div>
                        </FormGroup>
                        <FormGroup label="Jednostka">
                            <Input
                                name="unit"
                                value={formData.unit}
                                onChange={handleChange}
                                placeholder="np. m² / szt / worek"
                            />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };

        const DocieplenieProjectForm = ({ project, onSave, onCancel, contractors = [], investors = [] }) => {
            const [formState, setFormState] = useState(() => ({
                id: project?.id || '',
                name: project?.name || '',
                investor: project?.investor || '',
                contractor: project?.contractor || '',
                owner: project?.owner || '',
                contact: project?.contact || '',
                status: project?.status || 'planowane',
                stage: project?.stage || '',
                startDate: project?.startDate || '',
                endDate: project?.endDate || '',
                notes: project?.notes || '',
            }));
            const [errors, setErrors] = useState({});

            const handleChange = (event, isNumeric = false) => {
                const { name, value } = event.target;
                const nextValue = isNumeric ? parseNumericInput(value, { min: 0 }) : value;
                if (isNumeric && nextValue === null) {
                    return;
                }
                setFormState((prev) => ({ ...prev, [name]: isNumeric ? nextValue : value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();
                const nextErrors = {};
                if (!formState.name.trim()) {
                    nextErrors.name = 'Nazwa inwestycji jest wymagana.';
                }
                if (!formState.contractor.trim() && !formState.investor.trim()) {
                    nextErrors.contractor = 'Podaj inwestora lub wykonawcę.';
                }
                if (Object.keys(nextErrors).length) {
                    setErrors(nextErrors);
                    return;
                }
                onSave(formState);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa inwestycji" error={errors.name}>
                            <Input name="name" value={formState.name} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Status">
                            <Select name="status" value={formState.status} onChange={handleChange} className="w-full">
                                {['planowane', 'oferta', 'w realizacji', 'zakończone', 'wstrzymane'].map((status) => (
                                    <option key={status} value={status}>{status}</option>
                                ))}
                            </Select>
                        </FormGroup>
                        <FormGroup label="Inwestor">
                            <Input name="investor" value={formState.investor} onChange={handleChange} list="investorOptions" />
                            <datalist id="investorOptions">
                                {investors.map((i) => <option key={i.id} value={i.name} />)}
                            </datalist>
                        </FormGroup>
                        <FormGroup label="Wykonawca" error={errors.contractor}>
                            <Input name="contractor" value={formState.contractor} onChange={handleChange} list="contractorOptions" />
                            <datalist id="contractorOptions">
                                {contractors.map((c) => <option key={c.id} value={c.name} />)}
                            </datalist>
                        </FormGroup>
                        <FormGroup label="Kontakt">
                            <Input name="contact" value={formState.contact} onChange={handleChange} placeholder="tel / email" />
                        </FormGroup>
                        <FormGroup label="Etap / zakres">
                            <Input name="stage" value={formState.stage} onChange={handleChange} placeholder="np. ocieplenie elewacji" />
                        </FormGroup>
                        <FormGroup label="Opiekun / handlowiec">
                            <Input name="owner" value={formState.owner} onChange={handleChange} placeholder="np. Jan Kowalski" />
                        </FormGroup>
                        <FormGroup label="Data startu">
                            <Input name="startDate" type="date" value={formState.startDate} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Data zakończenia">
                            <Input name="endDate" type="date" value={formState.endDate} onChange={handleChange} />
                        </FormGroup>
                    </div>
                    <FormGroup label="Notatki">
                        <textarea
                            name="notes"
                            value={formState.notes}
                            onChange={handleChange}
                            className="w-full min-h-[100px] p-3 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500"
                        />
                    </FormGroup>
                    <div className="flex justify-end gap-2">
                        <button type="button" onClick={onCancel} className="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };

        const SolbetProductForm = ({ product, onSave, onCancel }) => {
            const initialData = product || {
                name: '', density: 600, width: '', height: '', length: '', priceNet: '', category: 'standard', unitsPerPallet: '', palletsPerTruck: ''
            };
            const [formData, setFormData] = useState(initialData);
            const [errors, setErrors] = useState({});

            const validate = (data) => {
                const newErrors = {};
                if (!data.name.trim()) newErrors.name = "Nazwa produktu jest wymagana.";
                if (data.priceNet === '' || isNaN(data.priceNet) || data.priceNet <= 0) newErrors.priceNet = "Cena musi być liczbą dodatnią.";
                if (data.unitsPerPallet === '' || isNaN(data.unitsPerPallet) || data.unitsPerPallet <= 0) newErrors.unitsPerPallet = "Wartość musi być liczbą dodatnią.";
                if (data.palletsPerTruck === '' || isNaN(data.palletsPerTruck) || data.palletsPerTruck <= 0) newErrors.palletsPerTruck = "Wartość musi być liczbą dodatnią.";
                return newErrors;
            };

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let finalValue = value;
                if (type === 'number') {
                    const parsedValue = parseNumericInput(value);
                    if (parsedValue === null) {
                        return;
                    }
                    finalValue = parsedValue;
                }
                const newFormData = { ...formData, [name]: finalValue };
                setFormData(newFormData);
                 if(Object.keys(errors).length > 0) {
                     setErrors(validate(newFormData));
                }
            };
            
            const handleBlur = () => {
                setErrors(validate(formData));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const validationErrors = validate(formData);
                if (Object.keys(validationErrors).length > 0) {
                    setErrors(validationErrors);
                    return;
                }
                onSave(formData);
            };
            
            const isFormValid = Object.keys(validate(formData)).length === 0;

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa produktu" error={errors.name}><Input name="name" value={formData.name} onChange={handleChange} onBlur={handleBlur} error={!!errors.name} /></FormGroup>
                        <FormGroup label="Cena netto" error={errors.priceNet}><Input name="priceNet" type="number" step="0.01" value={formData.priceNet} onChange={handleChange} onBlur={handleBlur} error={!!errors.priceNet} /></FormGroup>
                        <FormGroup label="Gęstość"><Select name="density" value={formData.density} onChange={handleChange}><option value={500}>500</option><option value={600}>600</option></Select></FormGroup>
                        <FormGroup label="Kategoria"><Input name="category" value={formData.category} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Szerokość (mm)"><Input name="width" type="number" value={formData.width} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Wysokość (mm)"><Input name="height" type="number" value={formData.height} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Długość (mm)"><Input name="length" type="number" value={formData.length} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Sztuk na palecie" error={errors.unitsPerPallet}><Input name="unitsPerPallet" type="number" step="1" min="0" value={formData.unitsPerPallet} onChange={handleChange} onBlur={handleBlur} error={!!errors.unitsPerPallet} /></FormGroup>
                        <FormGroup label="Palet na auto" error={errors.palletsPerTruck}><Input name="palletsPerTruck" type="number" step="1" min="0" value={formData.palletsPerTruck} onChange={handleChange} onBlur={handleBlur} error={!!errors.palletsPerTruck} /></FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" disabled={!isFormValid} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed">Zapisz</button>
                    </div>
                </form>
            );
        };
        
        const SemmelrockProductForm = ({ product, onSave, onCancel }) => {
            const initialData = product || {
                symbol: '', grupa: '', nazwa: '', iloscNaPalecie: '', jednostka: 'm²', waga: '', cenaNetto: '', maxPalletsPerTruck: ''
            };
            const [formData, setFormData] = useState(initialData);

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let finalValue = value;
                if (type === 'number') {
                    const parsedValue = parseNumericInput(value);
                    if (parsedValue === null) {
                        return;
                    }
                    finalValue = parsedValue;
                }
                setFormData(prev => ({ ...prev, [name]: finalValue }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // Basic validation could be added here
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <FormGroup label="Symbol"><Input name="symbol" value={formData.symbol} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Nazwa"><Input name="nazwa" value={formData.nazwa} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Grupa"><Input name="grupa" value={formData.grupa} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Cena Netto"><Input name="cenaNetto" type="number" step="0.01" value={formData.cenaNetto} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Ilość na palecie"><Input name="iloscNaPalecie" type="number" value={formData.iloscNaPalecie} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Jednostka"><Input name="jednostka" value={formData.jednostka} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Waga palety (t)"><Input name="waga" type="number" step="0.01" value={formData.waga} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Maks. palet/auto"><Input name="maxPalletsPerTruck" type="number" value={formData.maxPalletsPerTruck} onChange={handleChange} /></FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };
        
        const BrukbetProductForm = ({ product, onSave, onCancel, groups }) => {
            const initialData = product || {
                symbol: '', grupa: 'STANDARD', nazwa: '', zp: '', waga: '', maxPalletsPerTruck: '', iloscNaPalecie: '', jednostka: 'szt.', cenaNetto: ''
            };
            const [formData, setFormData] = useState(initialData);
            
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let finalValue = value;
                if (type === 'number') {
                    const parsedValue = name === 'rabat' ? parsePercentageInput(value) : parseNumericInput(value);
                    if (parsedValue === null) {
                        return;
                    }
                    finalValue = parsedValue;
                }
                setFormData(prev => ({ ...prev, [name]: finalValue }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                // Basic validation could be added here
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <FormGroup label="Symbol"><Input name="symbol" value={formData.symbol} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Nazwa"><Input name="nazwa" value={formData.nazwa} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Grupa"><Select name="grupa" value={formData.grupa} onChange={handleChange}>{groups.map(g => <option key={g} value={g}>{g}</option>)}</Select></FormGroup>
                        <FormGroup label="Zakład Produkcyjny (ZP)"><Input name="zp" value={formData.zp} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Cena Netto"><Input name="cenaNetto" type="number" step="0.01" value={formData.cenaNetto} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Ilość na palecie"><Input name="iloscNaPalecie" type="number" value={formData.iloscNaPalecie} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Jednostka"><Input name="jednostka" value={formData.jednostka} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Waga palety (t)"><Input name="waga" type="number" step="0.01" value={formData.waga} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Maks. palet na auto"><Input name="maxPalletsPerTruck" type="number" value={formData.maxPalletsPerTruck} onChange={handleChange} /></FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };
        
        const PolbrukProductForm = ({ product, onSave, onCancel }) => {
            const initialData = product
                ? { ...product, kolorystyka: product.kolorystyka ?? '' }
                : {
                    symbol: '',
                    nazwa: '',
                    ksztalt: '',
                    kolorystyka: '',
                    cenaNetto: '',
                    iloscNaPalecie: '',
                    jednostka: 'szt',
                    waga: '',
                    maxPalletsPerTruck: '',
                    rabat: 0
                };
            const [formData, setFormData] = useState(initialData);

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let finalValue = value;
                if (type === 'number') {
                    const parsedValue = name === 'rabat' ? parsePercentageInput(value) : parseNumericInput(value);
                    if (parsedValue === null) {
                        return;
                    }
                    finalValue = parsedValue;
                }
                setFormData(prev => ({ ...prev, [name]: finalValue }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <form onSubmit={handleSubmit}>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <FormGroup label="Symbol"><Input name="symbol" value={formData.symbol} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Nazwa"><Input name="nazwa" value={formData.nazwa} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Kształt"><Input name="ksztalt" value={formData.ksztalt} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Kolorystyka"><Input name="kolorystyka" value={formData.kolorystyka} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Cena Detaliczna"><Input name="cenaNetto" type="number" step="0.01" value={formData.cenaNetto} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Rabat (%)"><Input name="rabat" type="number" step="0.01" min="0" max="100" value={formData.rabat} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Ilość na palecie"><Input name="iloscNaPalecie" type="number" value={formData.iloscNaPalecie} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Jednostka"><Input name="jednostka" value={formData.jednostka} onChange={handleChange} /></FormGroup>
                        <FormGroup label="Waga palety (t)"><Input name="waga" type="number" step="0.01" value={formData.waga} onChange={handleChange} required /></FormGroup>
                        <FormGroup label="Maks. palet na auto"><Input name="maxPalletsPerTruck" type="number" value={formData.maxPalletsPerTruck} onChange={handleChange} /></FormGroup>
                    </div>
                    <div className="flex justify-end gap-3 mt-6">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                    </div>
                </form>
            );
        };
        
        const BrukbetFactoryManagerModal = ({ isOpen, onClose, factories, onSave }) => {
            const [localFactories, setLocalFactories] = useState(factories);
            const [formState, setFormState] = useState({ id: null, nazwa: '', kosztTransportu: '' });
            const isEditing = formState.id !== null;

            useEffect(() => {
                if (isOpen) {
                    setLocalFactories(factories);
                }
            }, [isOpen, factories]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                if (name === 'kosztTransportu') {
                    const parsedValue = parseNumericInput(value, { min: 0 });
                    if (parsedValue === null) {
                        return;
                    }
                    setFormState(prev => ({ ...prev, [name]: parsedValue }));
                } else {
                    setFormState(prev => ({ ...prev, [name]: value }));
                }
            };

            const handleSelectForEdit = (factory) => {
                setFormState({ id: factory.id, nazwa: factory.nazwa, kosztTransportu: factory.kosztTransportu });
            };

            const handleCancelEdit = () => {
                setFormState({ id: null, nazwa: '', kosztTransportu: '' });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formState.nazwa.trim() || formState.kosztTransportu === '' || isNaN(formState.kosztTransportu)) {
                    alert("Proszę wypełnić wszystkie pola poprawnymi danymi.");
                    return;
                }

                if (isEditing) {
                    setLocalFactories(prev => prev.map(f => f.id === formState.id ? { ...f, ...formState } : f));
                } else {
                    setLocalFactories(prev => [...prev, { ...formState, id: `factory_${Date.now()}` }]);
                }
                handleCancelEdit(); // Reset form
            };

            const handleDelete = (factoryId) => {
                if(localFactories.length <= 1) {
                    alert("Nie można usunąć ostatniego zakładu produkcyjnego.");
                    return;
                }
                if (confirm('Czy na pewno chcesz usunąć ten zakład?')) {
                    setLocalFactories(prev => prev.filter(f => f.id !== factoryId));
                }
            };

            const handleSaveAndClose = () => {
                onSave(localFactories);
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Zarządzaj Zakładami Produkcyjnymi">
                    <div className="space-y-6">
                        <div>
                            <h4 className="text-md font-semibold mb-2 text-slate-700">Lista Zakładów</h4>
                            <div className="border rounded-md divide-y max-h-60 overflow-y-auto">
                                {localFactories.length > 0 ? localFactories.map(factory => (
                                    <div key={factory.id} className="p-3 flex justify-between items-center hover:bg-slate-50">
                                        <div>
                                            <p className="font-medium text-slate-800">{factory.nazwa}</p>
                                            <p className="text-sm text-slate-500">Koszt transportu: {formatCurrency(factory.kosztTransportu)}</p>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleSelectForEdit(factory)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-md" title="Edytuj"><EditIcon /></button>
                                            <button onClick={() => handleDelete(factory.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-md" title="Usuń"><DeleteIcon /></button>
                                        </div>
                                    </div>
                                )) : <p className="p-4 text-center text-slate-500">Brak zdefiniowanych zakładów.</p>}
                            </div>
                        </div>
                        
                        <div className="border-t pt-4">
                            <h4 className="text-md font-semibold mb-2 text-slate-700">{isEditing ? 'Edytuj Zakład' : 'Dodaj Nowy Zakład'}</h4>
                            <form onSubmit={handleSubmit} className="p-4 border rounded-md bg-slate-50">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                    <div className="md:col-span-2 grid grid-cols-2 gap-4">
                                        <FormGroup label="Nazwa Zakładu"><Input name="nazwa" value={formState.nazwa} onChange={handleChange} required /></FormGroup>
                                        <FormGroup label="Koszt Transportu (zł)"><Input name="kosztTransportu" type="number" step="1" value={formState.kosztTransportu} onChange={handleChange} required /></FormGroup>
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        {isEditing && (
                                            <button type="button" onClick={handleCancelEdit} className="px-3 py-2 bg-slate-200 text-slate-700 rounded-md hover:bg-slate-300 text-sm w-full">Anuluj</button>
                                        )}
                                        <button type="submit" className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm w-full">{isEditing ? 'Zapisz' : 'Dodaj'}</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                     <div className="flex justify-end gap-3 mt-8 border-t pt-4">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="button" onClick={handleSaveAndClose} className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Zapisz i Zamknij</button>
                    </div>
                </Modal>
            );
        };


        //======================================================================
        // CALCULATOR COMPONENTS
        //======================================================================
        const PlaceholderCalculator = ({ manufacturerName, onSwitch }) => (
            <div className="flex items-center justify-center h-full">
                <div className="text-center p-8">
                    <div className="text-6xl mb-4">🚧</div>
                    <h1 className="text-3xl font-bold text-slate-800 mb-2">{manufacturerName}</h1>
                    <p className="text-slate-500 mb-6">Kalkulator w przygotowaniu</p>
                    <Card className="max-w-md mx-auto">
                        <CardContent>
                            <p className="text-sm text-slate-600 mb-4">Ten kalkulator jest obecnie rozwijany. Funkcjonalność zostanie dodana w przyszłych aktualizacjach.</p>
                            <button onClick={onSwitch} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Przejdź do POROTHERM</button>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );

        const PorothermCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('porotherm_data', INITIAL_POROTHERM_DATA);
            const [selectedAgreementId, setSelectedAgreementId] = useState(data.content.selectedAgreementId || data.content.defaultAgreementId);
            const [errors, setErrors] = useState({ settings: {} });

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ type: null, data: null });
            
            const fileInputRef = useRef(null);

             useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);
            
            const dataContent = useMemo(() => data.content, [data]);

            useEffect(() => {
                const agreements = dataContent.agreements || [];
                const needsDefaults = agreements.some(agreement => agreement.settings && agreement.settings.defaultBasicDiscount === undefined);
                if (!needsDefaults) {
                    return;
                }

                const updatedAgreements = agreements.map(agreement => {
                    if (agreement.settings && agreement.settings.defaultBasicDiscount === undefined) {
                        return {
                            ...agreement,
                            settings: {
                                ...agreement.settings,
                                defaultBasicDiscount: '',
                            },
                        };
                    }
                    return agreement;
                });

                setData({ content: { ...dataContent, agreements: updatedAgreements } });
            }, [dataContent, setData]);

            useEffect(() => {
                // If the selected agreement no longer exists (e.g., was deleted), select the first one.
                if (selectedAgreementId && !dataContent.agreements.some(a => a.id === selectedAgreementId)) {
                    const nextId = dataContent.agreements[0]?.id || null;
                    setSelectedAgreementId(nextId);
                }
            }, [dataContent.agreements, selectedAgreementId]);
            

            const openModal = (type, data = null) => {
                setModalContent({ type, data });
                setIsModalOpen(true);
            };
            const closeModal = () => setIsModalOpen(false);

            const selectedAgreement = useMemo(() => dataContent.agreements.find(a => a.id === selectedAgreementId) || dataContent.agreements[0], [dataContent.agreements, selectedAgreementId]);
            const calculatedProducts = useMemo(() => selectedAgreement ? selectedAgreement.products.map(product => calculatePorothermProduct(product, selectedAgreement)) : [], [selectedAgreement]);
            const percentMigrationApplied = dataContent.migrations?.percentScale;

            useEffect(() => {
                if (percentMigrationApplied) {
                    return;
                }

                const needsMigration = dataContent.agreements.some(agreement => {
                    const { basicDiscount, margin, cashDiscount } = agreement.settings;
                    const needsSettingsMigration = [basicDiscount, margin, cashDiscount].some(value => {
                        const numeric = Number(value);
                        return Number.isFinite(numeric) && numeric !== 0 && Math.abs(numeric) < 1;
                    });

                    const needsProductMigration = agreement.products.some(product => {
                        const numeric = Number(product.additionalDiscount);
                        return Number.isFinite(numeric) && numeric !== 0 && Math.abs(numeric) < 1;
                    });

                    return needsSettingsMigration || needsProductMigration;
                });

                const nextContentBase = {
                    ...dataContent,
                    migrations: { ...dataContent.migrations, percentScale: true }
                };

                if (!needsMigration) {
                    setData({ content: nextContentBase });
                    return;
                }

                const migratePercentValue = (value) => {
                    if (value === '' || value == null) {
                        return '';
                    }
                    return roundToPrecision(ensurePercentScale(value), 6);
                };

                setData({
                    content: {
                        ...nextContentBase,
                        agreements: dataContent.agreements.map(agreement => ({
                            ...agreement,
                            settings: {
                                ...agreement.settings,
                                basicDiscount: migratePercentValue(agreement.settings.basicDiscount),
                                margin: migratePercentValue(agreement.settings.margin),
                                cashDiscount: migratePercentValue(agreement.settings.cashDiscount)
                            },
                            products: agreement.products.map(product => ({
                                ...product,
                                additionalDiscount: product.additionalDiscount === '' || product.additionalDiscount == null
                                    ? product.additionalDiscount
                                    : migratePercentValue(product.additionalDiscount)
                            }))
                        }))
                    }
                });
            }, [percentMigrationApplied, dataContent, setData]);

            const handleAgreementChange = (e) => {
                const newId = e.target.value;
                setSelectedAgreementId(newId);
                setData({ 
                    content: { ...dataContent, selectedAgreementId: newId }
                });
            };
            
            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListVersion: value,
                    }
                });
            };
            
            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };
            
            const validateSetting = (name, value) => {
                if (value === '') {
                    return '';
                }

                const numeric = Number(value);
                if (!Number.isFinite(numeric) || numeric < 0 || numeric > 100) {
                    return 'Wartość musi być w zakresie 0-100%';
                }

                return '';
            };

            const handleAgreementDetailsChange = (type, key, value, isPercentage = false) => {
                if (isPercentage) {
                    const normalized = normalizePercentInputValue(value);
                    if (normalized === null) {
                        return;
                    }

                    const error = validateSetting(key, normalized);
                    setErrors(prev => ({ ...prev, settings: { ...prev.settings, [key]: error } }));

                    setData({
                        content: {
                            ...dataContent,
                            agreements: dataContent.agreements.map(a =>
                                a.id === selectedAgreementId
                                    ? { ...a, [type]: { ...a[type], [key]: normalized } }
                                    : a
                            )
                        }
                    });
                    return;
                }

                const parsedValue = parseNumericInput(value);
                if (parsedValue === null) {
                    return;
                }

                setData({
                    content: {
                        ...dataContent,
                        agreements: dataContent.agreements.map(a =>
                            a.id === selectedAgreementId
                                ? { ...a, [type]: { ...a[type], [key]: parsedValue } }
                                : a
                        )
                    }
                });
            };

            const handleAgreementInfoChange = (key, value) => {
                if (!selectedAgreementId) {
                    return;
                }

                setData({
                    content: {
                        ...dataContent,
                        agreements: dataContent.agreements.map(agreement =>
                            agreement.id === selectedAgreementId
                                ? {
                                    ...agreement,
                                    settings: {
                                        ...agreement.settings,
                                        [key]: value,
                                    },
                                }
                                : agreement
                        )
                    }
                });
            };

            const handleQuantityAdjustmentChange = (groupId, value) => {
                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        quantityAdjustments: {
                            ...dataContent.quantityAdjustments,
                            [groupId]: parsed,
                        },
                    }
                });
            };

            const handleSaveProduct = (productData) => {
                 const newAgreements = dataContent.agreements.map(a => {
                    if (a.id === selectedAgreementId) {
                        const newProducts = productData.id 
                            ? a.products.map(p => p.id === productData.id ? productData : p)
                            : [...a.products, { ...productData, id: `prod_${Date.now()}` }];
                        return { ...a, products: newProducts };
                    }
                    return a;
                });
                setData({ content: { ...dataContent, agreements: newAgreements } });
                closeModal();
            };
            
            const handleSaveAgreement = (agreementData) => {
                if (agreementData.id) { // Editing existing
                     setData({
                        content: {
                            ...dataContent,
                            agreements: dataContent.agreements.map(a => a.id === agreementData.id ? {...a, ...agreementData} : a)
                        }
                    });
                } else { // Adding new
                    const newAgreement = {
                        id: `agr_${Date.now()}`,
                        name: agreementData.name,
                        code: agreementData.code,
                        validUntil: new Date().toISOString().split('T')[0],
                        transportCosts: { leborkMalbork: 0, gnaszynMalbork: 0 },
                        settings: { basicDiscount: 22, margin: 10, cashDiscount: 3, defaultBasicDiscount: '' },
                        products: [],
                        lastUpdate: new Date().toISOString().split('T')[0]
                    };
                    const newAgreements = [...dataContent.agreements, newAgreement];
                    setData({ content: { ...dataContent, agreements: newAgreements } });
                    setSelectedAgreementId(newAgreement.id);
                }
                closeModal();
            };

            const handleDeleteProduct = (productId) => {
                if (confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                     const newAgreements = dataContent.agreements.map(a => {
                        if (a.id === selectedAgreementId) {
                            return { ...a, products: a.products.filter(p => p.id !== productId) };
                        }
                        return a;
                    });
                    setData({ content: { ...dataContent, agreements: newAgreements } });
                }
            };
            
            const handleDeleteAgreement = () => {
                if (dataContent.agreements.length <= 1) {
                    alert('Nie można usunąć ostatniego porozumienia.');
                    return;
                }
                if (confirm(`Czy na pewno chcesz usunąć porozumienie "${selectedAgreement.name}"? Tej operacji nie można cofnąć.`)) {
                    const newAgreements = dataContent.agreements.filter(a => a.id !== selectedAgreementId);
                    const newSelectedId = newAgreements[0]?.id || null;
                    setData({ content: { ...dataContent, agreements: newAgreements, selectedAgreementId: newSelectedId } });
                }
            };
            
            const handleImportClick = () => {
                fileInputRef.current.click();
            };
            
            const handleFileImport = async (e) => {
                const input = e.target;
                const file = input.files[0];
                if (!file) return;

                try {
                    const rows = await readExcelRows(file);

                    if (rows.length < 2) {
                        alert("Plik jest pusty lub nie zawiera nagłówków.");
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const requiredHeaders = ['Nazwa produktu', 'Cennik net'];
                    if (!requiredHeaders.every((rh) => headers.includes(rh))) {
                        alert(`Brak wymaganych kolumn w pliku: ${requiredHeaders.join(', ')}`);
                        return;
                    }

                    const colIndices = {
                        name: headers.indexOf('Nazwa produktu'),
                        location: headers.indexOf('Lokalizacja'),
                        netPrice: headers.indexOf('Cennik net'),
                        additionalDiscount: headers.indexOf('Rabat dod.'),
                        unitsPerPallet: headers.indexOf('szt./paleta'),
                        palletsPerTruck: headers.indexOf('palety/auto'),
                        category: headers.indexOf('Kategoria'),
                        specifications: headers.indexOf('Specyfikacja'),
                        consumptionPerM2: findNormalizedHeaderIndex(headers, [
                            'Zużycie szt/m2',
                            'Zużycie szt/m²',
                            'Zuzycie szt/m2',
                            'Zuzycie szt/m²',
                            'Zużycie [szt/m2]',
                        ]),
                    };

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) continue;

                        const name = colIndices.name >= 0 ? row[colIndices.name] : null;
                        if (!name || String(name).trim() === '') continue;

                        const discountRaw = colIndices.additionalDiscount >= 0 ? row[colIndices.additionalDiscount] : null;
                        const discountValue = discountRaw == null ? 0 : parseFloat(String(discountRaw).toString().replace('%', '').replace(',', '.'));

                        const consumptionRaw = colIndices.consumptionPerM2 >= 0 ? row[colIndices.consumptionPerM2] : null;
                        const consumptionValue = parseLooseNumber(consumptionRaw);
                        const consumptionPerM2 = Number.isFinite(consumptionValue) && consumptionValue > 0
                            ? roundToPrecision(consumptionValue, 6)
                            : '';

                        const product = {
                            id: `imported_${Date.now()}_${i}`,
                            name: String(name),
                            location: colIndices.location >= 0 && row[colIndices.location] != null ? String(row[colIndices.location]) : 'Lębork',
                            netPrice: colIndices.netPrice >= 0 ? parseFloat(String(row[colIndices.netPrice]).replace(',', '.')) || 0 : 0,
                            additionalDiscount: Number.isFinite(discountValue) ? ensurePercentScale(discountValue) : 0,
                            unitsPerPallet: colIndices.unitsPerPallet >= 0 ? parseInt(row[colIndices.unitsPerPallet], 10) || 0 : 0,
                            palletsPerTruck: colIndices.palletsPerTruck >= 0 ? parseInt(row[colIndices.palletsPerTruck], 10) || 0 : 0,
                            category: colIndices.category >= 0 && row[colIndices.category] != null ? String(row[colIndices.category]) : '',
                            specifications: colIndices.specifications >= 0 && row[colIndices.specifications] != null ? String(row[colIndices.specifications]) : '',
                            consumptionPerM2,
                        };
                        newProducts.push(product);
                    }

                    if (newProducts.length === 0) {
                        alert("Nie znaleziono żadnych prawidłowych produktów do zaimportowania.");
                        return;
                    }

                    const newAgreements = dataContent.agreements.map(a => a.id === selectedAgreementId ? { ...a, products: newProducts } : a);
                    setData({ content: { ...dataContent, agreements: newAgreements } });

                    alert(`Import zakończony sukcesem! Zaimportowano ${newProducts.length} produktów.`);
                } catch (error) {
                    console.error("Błąd podczas importu pliku POROTHERM:", error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };

            const stats = useMemo(() => ({
                totalProducts: calculatedProducts.length,
                leborkProducts: calculatedProducts.filter(p => p.location === 'Lębork').length,
                gnaszynProducts: calculatedProducts.filter(p => p.location === 'Gnaszyn').length,
                avgUnitsPerTruck: Math.round(calculatedProducts.reduce((sum, p) => sum + (p.unitsPerPallet * p.palletsPerTruck), 0) / (calculatedProducts.length || 1)),
            }), [calculatedProducts]);
            
            if (!selectedAgreement) {
                return <div>Brak dostępnych porozumień. Dodaj nowe, aby rozpocząć. <button onClick={() => openModal('agreement')} className="text-blue-600">Dodaj</button></div>
            }

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">POROTHERM (Wienerberger)</h1>
                            <p className="text-slate-500">Kalkulator pustaków ceramicznych</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="border-2 border-red-600 rounded-md px-3 py-2 bg-red-50 max-w-xs w-full">
                                <label className="block text-xs font-bold uppercase text-red-700 mb-1">
                                    Wersja cennika
                                </label>
                                <input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={handlePriceListVersionChange}
                                    className="w-full border border-red-600 rounded-md px-2 py-1 text-sm font-semibold text-red-700 placeholder:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-300"
                                    placeholder="np. cennik 10/2025"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx, .xls"
                                />
                                <button
                                    onClick={handleImportClick}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button
                                    onClick={() => exportPorothermToExcel(calculatedProducts, selectedAgreement)}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader><CardTitle>Zarządzanie Porozumieniami</CardTitle></CardHeader>
                        <CardContent>
                            <div className="flex flex-col sm:flex-row gap-3 items-center">
                                <select value={selectedAgreementId || ''} onChange={handleAgreementChange} className="w-full p-2 border border-slate-300 rounded-md">
                                    {dataContent.agreements.map(agreement => <option key={agreement.id} value={agreement.id}>{agreement.name} - {agreement.code}</option>)}
                                </select>
                                <div className="flex gap-2 flex-shrink-0">
                                    <button onClick={() => openModal('agreement')} className="p-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200" title="Dodaj nowe porozumienie"><AddIcon /></button>
                                    <button onClick={() => openModal('agreement', selectedAgreement)} className="p-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200" title="Edytuj nazwę porozumienia"><EditIcon/></button>
                                    <button onClick={handleDeleteAgreement} className="p-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200" title="Usuń porozumienie"><DeleteIcon/></button>
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <Card>
                        <CardHeader><CardTitle>Ustawienia Cenowe</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div className="space-y-2">
                                <FormGroup label="Rabat podst. (%)" error={errors.settings?.basicDiscount}>
                                    <Input type="number" step="0.01" min="0" max="100" error={!!errors.settings?.basicDiscount} value={resolvePercentInputValue(selectedAgreement.settings.basicDiscount)} onChange={(e) => handleAgreementDetailsChange('settings', 'basicDiscount', e.target.value, true)} />
                                </FormGroup>
                                <FormGroup label="Rabat podst. domyślny" variant="default-discount">
                                    <Input
                                        type="text"
                                        value={selectedAgreement.settings.defaultBasicDiscount ?? ''}
                                        onChange={(e) => handleAgreementInfoChange('defaultBasicDiscount', e.target.value)}
                                        error
                                    />
                                </FormGroup>
                            </div>
                            <FormGroup label="Marża (%)">
                                <Input type="number" step="0.01" min="0" max="100" value={resolvePercentInputValue(selectedAgreement.settings.margin)} onChange={(e) => handleAgreementDetailsChange('settings', 'margin', e.target.value, true)} />
                            </FormGroup>
                            <FormGroup label="Skonto (%)" error={errors.settings?.cashDiscount}>
                                <Input type="number" step="0.01" min="0" max="100" error={!!errors.settings?.cashDiscount} value={resolvePercentInputValue(selectedAgreement.settings.cashDiscount)} onChange={(e) => handleAgreementDetailsChange('settings', 'cashDiscount', e.target.value, true)} />
                            </FormGroup>
                        </CardContent>
                    </Card>
                        <Card>
                            <CardHeader><CardTitle>Koszty Transportu</CardTitle></CardHeader>
                            <CardContent className="grid grid-cols-2 gap-4">
                                <FormGroup label="Lębork → Malbork (zł)">
                                     <Input type="number" step="50" value={selectedAgreement.transportCosts.leborkMalbork} onChange={(e) => handleAgreementDetailsChange('transportCosts', 'leborkMalbork', e.target.value)} />
                                </FormGroup>
                                <FormGroup label="Gnaszyn → Malbork (zł)">
                                     <Input type="number" step="50" value={selectedAgreement.transportCosts.gnaszynMalbork} onChange={(e) => handleAgreementDetailsChange('transportCosts', 'gnaszynMalbork', e.target.value)} />
                                </FormGroup>
                            </CardContent>
                        </Card>
                    </div>
                    <Card>
                        <CardHeader className="flex justify-between items-center">
                            <CardTitle>Produkty ({calculatedProducts.length})</CardTitle>
                            <button
                                onClick={() => openModal('product')}
                                className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors"
                            >
                                <AddIcon /> Dodaj produkt
                            </button>
                        </CardHeader>
                        <CardContent>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                        <tr>
                                            {['Nazwa', 'Lokalizacja', 'Cennik', 'Rabat dod.', 'Zakup', 'Transp.', 'Loco', 'Netto KL', 'Brutto KL', 'Zużycie szt/m2', 'Cena m2 brutto', 'szt/pal', 'pal/auto', 'Akcje'].map((h, i) => (
                                                <th key={h} scope="col" className={`px-4 py-3 ${i === 0 ? 'w-full' : ''}`}>{h}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {calculatedProducts.map((p) => (
                                            <tr key={p.id} className="bg-white border-b hover:bg-slate-50">
                                                <td className="px-4 py-2 font-medium text-slate-900 align-top">{p.name}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">
                                                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${p.location === 'Lębork' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>{p.location}</span>
                                                </td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(p.netPrice)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">{formatPercentage(p.additionalDiscount)}</td>
                                                <td className="px-4 py-2 bg-slate-50 font-semibold text-slate-600 whitespace-nowrap align-top">{formatCurrency(p.netPurchasePrice)}</td>
                                                <td className="px-4 py-2 bg-slate-50 whitespace-nowrap align-top">{formatCurrency(p.transportPerUnit)}</td>
                                                <td className="px-4 py-2 bg-slate-50 font-semibold text-slate-600 whitespace-nowrap align-top">{formatCurrency(p.localPrice)}</td>
                                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top">{formatCurrency(p.customerNetPrice)}</td>
                                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.customerGrossPrice)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.consumptionPerM2 != null && p.consumptionPerM2 !== '' ? String(p.consumptionPerM2) : '-'}</td>
                                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{p.grossPricePerSquareMeter == null ? '-' : formatCurrency(p.grossPricePerSquareMeter)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">{String(p.unitsPerPallet)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">{String(p.palletsPerTruck)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top">
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => openModal('product', p)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                        <button onClick={() => handleDeleteProduct(p.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>
                    {/* Usunięto statystyki dolne dla POROTHERM */}
                    <Modal isOpen={isModalOpen} onClose={closeModal} title={
                        modalContent.type === 'product' ? (modalContent.data ? 'Edytuj Produkt' : 'Dodaj Produkt') :
                        modalContent.type === 'agreement' ? (modalContent.data ? 'Edytuj Porozumienie' : 'Dodaj Porozumienie') :
                        'Edytuj Wartość'
                    }>
                        {modalContent.type === 'product' && <PorothermProductForm product={modalContent.data} onSave={handleSaveProduct} onCancel={closeModal} />}
                        {modalContent.type === 'agreement' && <PorothermAgreementForm agreement={modalContent.data} onSave={handleSaveAgreement} onCancel={closeModal} />}
                    </Modal>
                </div>
            );
        };

        const SolbetCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('solbet_data', INITIAL_SOLBET_DATA);
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null);
            
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);
            
            const dataContent = useMemo(() => data.content, [data]);

            useEffect(() => {
                if (!dataContent.settings.defaultDiscounts) {
                    const defaultDiscounts = Object.keys(dataContent.settings.discounts || {}).reduce((acc, key) => {
                        acc[key] = '';
                        return acc;
                    }, {});
                    setData({ content: { ...dataContent, settings: { ...dataContent.settings, defaultDiscounts } } });
                }
            }, [dataContent, setData]);

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };

            const handleEditProduct = (productId) => {
                const productToEdit = dataContent.products.find((item) => item.id === productId);
                if (productToEdit) {
                    openProductModal(productToEdit);
                } else {
                    const computedFallback = sortedProducts.find((item) => item.id === productId);
                    openProductModal(computedFallback || null);
                }
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };
            
            const handleSettingsChange = (e) => {
                const { name, value } = e.target;
                const isPercentageField = name === 'discountPercent' || name === 'margin';
                const parsedValue = isPercentageField ? normalizePercentInputValue(value) : parseNumericInput(value);
                if (parsedValue === null) {
                    return;
                }

                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            [name]: parsedValue,
                        }
                    }
                });
            };

            const filteredProducts = useMemo(() => {
                const term = searchTerm.toLowerCase();
                if (!term) return dataContent.products;
                return dataContent.products.filter(p => p.name.toLowerCase().includes(term));
            }, [dataContent.products, searchTerm]);

            const calculatedProducts = useMemo(() => {
                return filteredProducts.map(p => calculateSolbetProduct(p, dataContent.settings));
            }, [filteredProducts, dataContent.settings]);
            
            const handleSaveProduct = (productData) => {
                const newProducts = productData.id
                    ? dataContent.products.map(p => p.id === productData.id ? productData : p)
                    : [...dataContent.products, { ...productData, id: `solbet_${Date.now()}` }];
                setData({ content: { ...dataContent, products: newProducts } });
                closeProductModal();
            };

            const handleDeleteProduct = (productId) => {
                if (confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                     setData({
                        content: {
                            ...dataContent,
                            products: dataContent.products.filter(p => p.id !== productId)
                        }
                    });
                }
            };
            
            const handleImportClick = () => {
                fileInputRef.current.click();
            };
            
            const handleFileImport = async (e) => {
                const input = e.target;
                const file = input.files[0];
                if (!file) return;

                try {
                    const rows = await readExcelRows(file);

                    if (rows.length < 2) {
                        alert("Plik jest pusty lub nie zawiera nagłówków.");
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const requiredHeaders = ['Nazwa produktu', 'Cena netto'];
                    if (!requiredHeaders.every((rh) => headers.includes(rh))) {
                        alert(`Brak wymaganych kolumn w pliku: ${requiredHeaders.join(', ')}`);
                        return;
                    }

                    const colIndices = {
                        id: headers.indexOf('ID'),
                        name: headers.indexOf('Nazwa produktu'),
                        density: headers.indexOf('Gęstość'),
                        width: headers.indexOf('Szerokość'),
                        height: headers.indexOf('Wysokość'),
                        length: headers.indexOf('Długość'),
                        priceNet: headers.indexOf('Cena netto'),
                        category: headers.indexOf('Kategoria'),
                        unitsPerPallet: headers.indexOf('Sztuk na palecie'),
                        palletsPerTruck: headers.indexOf('Palet na auto'),
                    };

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) continue;

                        const name = colIndices.name >= 0 ? row[colIndices.name] : null;
                        if (!name || String(name).trim() === '') continue;

                        const product = {
                            id: colIndices.id >= 0 && row[colIndices.id] != null ? String(row[colIndices.id]) : `solbet_imported_${Date.now()}_${i}`,
                            name: String(name),
                            density: colIndices.density >= 0 ? parseInt(row[colIndices.density], 10) || 600 : 600,
                            width: colIndices.width >= 0 ? parseInt(row[colIndices.width], 10) || 0 : 0,
                            height: colIndices.height >= 0 ? parseInt(row[colIndices.height], 10) || 0 : 0,
                            length: colIndices.length >= 0 ? parseInt(row[colIndices.length], 10) || 0 : 0,
                            priceNet: colIndices.priceNet >= 0 ? parseFloat(String(row[colIndices.priceNet]).replace(',', '.')) || 0 : 0,
                            category: colIndices.category >= 0 && row[colIndices.category] != null ? String(row[colIndices.category]) : 'standard',
                            unitsPerPallet: colIndices.unitsPerPallet >= 0 ? parseInt(row[colIndices.unitsPerPallet], 10) || 0 : 0,
                            palletsPerTruck: colIndices.palletsPerTruck >= 0 ? parseInt(row[colIndices.palletsPerTruck], 10) || 0 : 0,
                        };
                        newProducts.push(product);
                    }

                    if (newProducts.length === 0) {
                        alert("Nie znaleziono żadnych prawidłowych produktów do zaimportowania.");
                        return;
                    }

                    setData({ content: { ...dataContent, products: newProducts } });
                    alert(`Import zakończony sukcesem! Zaimportowano ${newProducts.length} produktów.`);
                } catch (error) {
                    console.error("Błąd podczas importu pliku SOLBET:", error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };


            const stats = { 
                totalProducts: dataContent.products.length, 
                density600: dataContent.products.filter(p => p.density === 600).length, 
                density500: dataContent.products.filter(p => p.density === 500).length 
            };
            
            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListVersion: value,
                    }
                });
            };
            
            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };
            
            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">SOLBET</h1>
                            <p className="text-slate-500">Kalkulator betonu komórkowego</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="border-2 border-red-600 rounded-md px-3 py-2 bg-red-50 max-w-xs w-full">
                                <label className="block text-xs font-bold uppercase text-red-700 mb-1">
                                    Wersja cennika
                                </label>
                                <input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={handlePriceListVersionChange}
                                    className="w-full border border-red-600 rounded-md px-2 py-1 text-sm font-semibold text-red-700 placeholder:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-300"
                                    placeholder="np. cennik 10/2025"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx, .xls"
                                />
                                <button
                                    onClick={handleImportClick}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button
                                    onClick={() => exportSolbetToExcel(dataContent.products, dataContent.settings)}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader>
                            <CardTitle>Ustawienia Dynamiczne</CardTitle>
                        </CardHeader>
                        <CardContent className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <FormGroup label="Koszt transportu (zł)">
                                <Input
                                    type="number"
                                    name="transportCost"
                                    value={dataContent.settings.transportCost}
                                    onChange={handleSettingsChange}
                                    step="0.01"
                                    min="0"
                                />
                            </FormGroup>
                            <FormGroup label="Rabat (%)">
                                <Input
                                    type="number"
                                    name="discountPercent"
                                    value={dataContent.settings.discountPercent}
                                    onChange={handleSettingsChange}
                                    step="0.01"
                                    min="0"
                                    max="100"
                                />
                            </FormGroup>
                            <FormGroup label="Marża (%)">
                                <Input
                                    type="number"
                                    name="margin"
                                    value={dataContent.settings.margin}
                                    onChange={handleSettingsChange}
                                    step="0.01"
                                    min="0"
                                    max="100"
                                />
                            </FormGroup>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <CardTitle>Produkty ({calculatedProducts.length} / {dataContent.products.length})</CardTitle>
                             <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj produktów..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                             </div>
                        </CardHeader>
                        <CardContent><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-500">
                            <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    {[
                                        { key: 'nazwa', label: 'Nazwa', className: 'w-full' },
                                        { key: 'gestosc', label: 'Gęstość', className: 'w-20' },
                                        { key: 'szer', label: 'Szerokość', className: 'w-24' },
                                        { key: 'wys', label: 'Wysokość', className: 'w-24' },
                                        { key: 'dl', label: 'Długość', className: 'w-24' },
                                        { key: 'cenaNetto', label: (<span>Cena<br/>netto</span>), className: 'w-24' },
                                        { key: 'zakupNetto', label: (<span>Zakup<br/>netto</span>), className: 'w-24' },
                                        { key: 'transport', label: 'Transport', className: 'w-24' },
                                        { key: 'nettoKl', label: (<span>Netto<br/>KL</span>), className: 'w-24' },
                                        { key: 'bruttoKl', label: (<span>Brutto<br/>KL</span>), className: 'w-24' },
                                        { key: 'cenaM2Brutto', label: (<span>Cena m2<br/>brutto</span>), className: 'w-28' },
                                        { key: 'sztPal', label: (<span>szt/<br/>pal</span>), className: 'w-20' },
                                        { key: 'palAuto', label: (<span>pal/<br/>auto</span>), className: 'w-20' },
                                        { key: 'akcje', label: 'Akcje', className: 'w-20' },
                                    ].map(({ key, label, className }, i) => (
                                        <th key={key} scope="col" className={`px-2 py-3 ${className || ''} ${key === 'nazwa' ? 'w-full' : ''}`}>{label}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>{calculatedProducts.map(p => (<tr key={p.id} className="bg-white border-b hover:bg-slate-50">
                                <td className="px-4 py-2 font-medium text-slate-900 align-top">{p.name}</td>
                                <td className="px-2 py-2 align-top">{p.density}</td>
                                <td className="px-2 py-2 align-top">{p.width}mm</td>
                                <td className="px-2 py-2 align-top">{p.height}mm</td>
                                <td className="px-2 py-2 align-top">{p.length}mm</td>
                                <td className="px-2 py-2 whitespace-nowrap align-top">{formatCurrency(p.priceNet)}</td>
                                <td className="px-2 py-2 bg-slate-50 font-semibold text-slate-600 whitespace-nowrap align-top">{formatCurrency(p.netPurchasePrice)}</td>
                                <td className="px-2 py-2 bg-slate-50 whitespace-nowrap align-top">{formatCurrency(p.transportPerUnit)}</td>
                                <td className="px-2 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top">{formatCurrency(p.customerNetPrice)}</td>
                                <td className="px-2 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.customerGrossPrice)}</td>
                                <td className="px-2 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.grossPricePerSquareMeter)}</td>
                                <td className="px-2 py-2 align-top">{p.unitsPerPallet}</td>
                                <td className="px-2 py-2 align-top">{p.palletsPerTruck}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top"><div className="flex items-center gap-2">
                                    <button onClick={() => openProductModal(p)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                    <button onClick={() => handleDeleteProduct(p.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                </div></td>
                            </tr>))}</tbody>
                        </table></div></CardContent>
                    </Card>
                    {/* Usunięto statystyki dolne dla SOLBET */}
                     <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj Produkt SOLBET' : 'Dodaj Produkt SOLBET'}>
                        <SolbetProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };

        const SemmelrockCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('semmelrock_data', INITIAL_SEMMELROCK_DATA);
            const [searchTerm, setSearchTerm] = useState('');
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);
            
            const dataContent = useMemo(() => data.content, [data]);

            useEffect(() => {
                const existingDefaults = dataContent.settings.defaultDiscounts;
                if (existingDefaults && Object.keys(existingDefaults).length) {
                    return;
                }
                const defaults = Object.keys(dataContent.settings.discounts || {}).reduce((acc, key) => {
                    acc[key] = '';
                    return acc;
                }, {});
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            defaultDiscounts: defaults
                        }
                    }
                });
            }, [dataContent, setData]);

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const handleSettingChange = (key, value) => {
                const isPercentageField = key === 'margin';
                const parsedValue = isPercentageField
                    ? normalizePercentInputValue(value)
                    : parseNumericInput(value, { min: 0 });
                
                if (parsedValue === null) {
                    return;
                }

                setData({ content: { ...dataContent, settings: { ...dataContent.settings, [key]: parsedValue } } });
            };

            const handleDiscountChange = (group, value) => {
                const parsedValue = normalizePercentInputValue(value);
                if (parsedValue === null) {
                    return;
                }

                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            discounts: { ...dataContent.settings.discounts, [group]: parsedValue }
                        }
                    }
                });
            };

            const handleDefaultDiscountChange = (group, value) => {
                const currentDefaults = dataContent.settings.defaultDiscounts || {};
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            defaultDiscounts: {
                                ...currentDefaults,
                                [group]: value,
                            },
                        },
                    },
                });
            };
            
            const calculatedProducts = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const filtered = !term
                    ? dataContent.products
                    : dataContent.products.filter(p => 
                        (p.nazwa && p.nazwa.toLowerCase().includes(term)) ||
                        (p.symbol && p.symbol.toLowerCase().includes(term)) ||
                        (p.grupa && p.grupa.toLowerCase().includes(term))
                      );
                return filtered.map(p => calculateSemmelrockProduct(p, dataContent.settings));
            }, [dataContent.products, dataContent.settings, searchTerm]);

            const stats = { 
                totalProducts: dataContent.products.length, 
                g2Products: dataContent.products.filter(p => p.grupa.startsWith('G2')).length 
            };
            
            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListVersion: value,
                    }
                });
            };
            
            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };
            
            const handleSaveProduct = (productData) => {
                const newProducts = productData.symbol && dataContent.products.some(p => p.symbol === productData.symbol)
                    ? dataContent.products.map(p => p.symbol === productData.symbol ? { ...p, ...productData } : p)
                    : [...dataContent.products, { ...productData, symbol: productData.symbol || `semm_${Date.now()}` }];
                setData({ content: { ...dataContent, products: newProducts } });
                closeProductModal();
            };
            
            const handleDeleteProduct = (productSymbol) => {
                if (confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                     setData({
                        content: {
                            ...dataContent,
                            products: dataContent.products.filter(p => p.symbol !== productSymbol)
                        }
                    });
                }
            };
            
            const handleImportClick = () => { fileInputRef.current.click(); };

            const handleFileImport = async (e) => {
                const input = e.target;
                const file = input.files[0];
                if (!file) return;

                try {
                    const rows = await readExcelRows(file);

                    if (rows.length < 2) {
                        alert("Plik jest pusty lub nie zawiera nagłówków.");
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const requiredHeaders = ['Symbol', 'Nazwa', 'Cena netto'];
                    if (!requiredHeaders.every((rh) => headers.includes(rh))) {
                        alert(`Brak wymaganych kolumn w pliku: ${requiredHeaders.join(', ')}`);
                        return;
                    }

                    const colIndices = {
                        symbol: headers.indexOf('Symbol'),
                        grupa: headers.indexOf('Grupa'),
                        nazwa: headers.indexOf('Nazwa'),
                        iloscNaPalecie: headers.indexOf('Ilość na palecie'),
                        jednostka: headers.indexOf('Jednostka'),
                        waga: headers.indexOf('Waga palety (t)'),
                        cenaNetto: headers.indexOf('Cena netto'),
                        maxPalletsPerTruck: headers.indexOf('Maks. palet/auto'),
                    };

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) continue;

                        const nazwa = colIndices.nazwa >= 0 ? row[colIndices.nazwa] : null;
                        if (!nazwa || String(nazwa).trim() === '') continue;

                        newProducts.push({
                            symbol: colIndices.symbol >= 0 && row[colIndices.symbol] != null ? String(row[colIndices.symbol]) : `semm_imported_${Date.now()}_${i}`,
                            grupa: colIndices.grupa >= 0 && row[colIndices.grupa] != null ? String(row[colIndices.grupa]) : '',
                            nazwa: String(nazwa),
                            iloscNaPalecie: colIndices.iloscNaPalecie >= 0 ? parseFloat(String(row[colIndices.iloscNaPalecie]).replace(',', '.')) || 0 : 0,
                            jednostka: colIndices.jednostka >= 0 && row[colIndices.jednostka] != null ? String(row[colIndices.jednostka]) : 'm²',
                            waga: colIndices.waga >= 0 ? parseFloat(String(row[colIndices.waga]).replace(',', '.')) || 0 : 0,
                            cenaNetto: colIndices.cenaNetto >= 0 ? parseFloat(String(row[colIndices.cenaNetto]).replace(',', '.')) || 0 : 0,
                            maxPalletsPerTruck: colIndices.maxPalletsPerTruck >= 0 ? parseInt(row[colIndices.maxPalletsPerTruck], 10) || 0 : 0,
                        });
                    }

                    if (newProducts.length > 0) {
                        setData({ content: { ...dataContent, products: newProducts } });
                        alert(`Import zakończony! Zaimportowano ${newProducts.length} produktów.`);
                    } else {
                        alert("Nie znaleziono prawidłowych produktów do zaimportowania.");
                    }
                } catch (error) {
                    console.error("Błąd podczas importu pliku SEMMELROCK:", error);
                    alert('Wystąpił błąd podczas importu.');
                } finally {
                    input.value = '';
                }
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">SEMMELROCK stein+design</h1>
                            <p className="text-slate-500">Rozwiązania krajobrazowe</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="border-2 border-red-600 rounded-md px-3 py-2 bg-red-50 max-w-xs w-full">
                                <label className="block text-xs font-bold uppercase text-red-700 mb-1">
                                    Wersja cennika
                                </label>
                                <input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={handlePriceListVersionChange}
                                    className="w-full border border-red-600 rounded-md px-2 py-1 text-sm font-semibold text-red-700 placeholder:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-300"
                                    placeholder="np. cennik 10/2025"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx, .xls"
                                />
                                <button
                                    onClick={handleImportClick}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button
                                    onClick={() => exportSemmelrockToExcel(calculatedProducts)}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader><CardTitle>Ustawienia</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <FormGroup label="Stawka transportu (zł)"><Input type="number" step="0.01" min="0" value={dataContent.settings.transportRate} onChange={e => handleSettingChange('transportRate', e.target.value)} /></FormGroup>
                            <FormGroup label="Marża (%)"><Input type="number" step="0.01" min="0" max="100" value={dataContent.settings.margin} onChange={e => handleSettingChange('margin', e.target.value)} /></FormGroup>
                            <FormGroup label="Masa auta (t)"><Input type="number" step="1" value={dataContent.settings.truckWeight} onChange={e => handleSettingChange('truckWeight', e.target.value)} /></FormGroup>
                            <FormGroup label="Max palet/auto"><Input type="number" step="1" value={dataContent.settings.maxPalletsPerTruck} onChange={e => handleSettingChange('maxPalletsPerTruck', e.target.value)} /></FormGroup>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader><CardTitle>Rabaty Grupowe</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            {Object.entries(dataContent.settings.discounts).map(([group, discount]) => {
                                const defaultDiscountValue = dataContent.settings.defaultDiscounts?.[group] ?? '';
                                return (
                                    <div key={group} className="space-y-2">
                                            <FormGroup label={`Grupa ${group} (%)`}>
                                                <Input type="number" step="1" value={discount} onChange={e => handleDiscountChange(group, e.target.value)} />
                                            </FormGroup>
                                            <FormGroup label={`Rabat domyślny ${group}`} variant="default-discount">
                                                <Input type="text" value={defaultDiscountValue} onChange={e => handleDefaultDiscountChange(group, e.target.value)} />
                                            </FormGroup>
                                    </div>
                                );
                            })}
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <CardTitle>Produkty ({calculatedProducts.length} / {dataContent.products.length})</CardTitle>
                             <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj produktów..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                             </div>
                        </CardHeader>
                        <CardContent><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-500">
                            <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    {['Symbol', 'Nazwa', 'Jedn.', 'Grupa', 'Cena Netto', 'Rabat', 'Po rabacie', 'Transp/szt.', 'Netto KL', 'Brutto KL', 'Ilość/pal', 'Maks palet/auto', 'Waga (t)', 'Akcje'].map((h, i) => <th key={h} scope="col" className={`px-4 py-3 ${ i === 1 ? 'w-full' : ''}`}>{h}</th>)}
                                </tr>
                            </thead>
                            <tbody>{calculatedProducts.map(p => (<tr key={p.symbol} className="bg-white border-b hover:bg-slate-50">
                                <td className="px-4 py-2 font-medium text-slate-900 whitespace-nowrap align-top">{p.symbol}</td>
                                <td className="px-4 py-2 align-top">{p.nazwa}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.jednostka}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top"><span className="px-2 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-800">{p.grupa}</span></td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(p.cenaNetto)}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.rabat}%</td>
                                <td className="px-4 py-2 bg-slate-50 font-semibold whitespace-nowrap align-top">{formatCurrency(p.cenaPoRabacie)}</td>
                                <td className="px-4 py-2 bg-slate-50 whitespace-nowrap align-top">{formatCurrency(p.transportPerUnit)}</td>
                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyNetto)}</td>
                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyBrutto)}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.iloscNaPalecie}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.maxPalletsPerTruck}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">{p.waga}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top"><div className="flex items-center gap-2">
                                    <button onClick={() => openProductModal(p)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                    <button onClick={() => handleDeleteProduct(p.symbol)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                </div></td>
                            </tr>))}</tbody>
                        </table></div></CardContent>
                    </Card>
                    {/* Usunięto statystyki dolne dla SEMMELROCK */}
                     <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj Produkt SEMMELROCK' : 'Dodaj Produkt SEMMELROCK'}>
                        <SemmelrockProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };
        
        const SilikatyCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('silikaty_data', INITIAL_SILIKATY_DATA);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const dataContent = useMemo(() => {
                const content = data?.content || {};
                return {
                    priceListDate: content.priceListDate || '',
                    priceListVersion: content.priceListVersion || '',
                    settings: { ...INITIAL_SILIKATY_DATA.content.settings, ...(content.settings || {}) },
                    modes: { ...INITIAL_SILIKATY_DATA.content.modes, ...(content.modes || {}) },
                    filters: { ...INITIAL_SILIKATY_DATA.content.filters, ...(content.filters || {}) },
                    products: Array.isArray(content.products) ? content.products : [],
                };
            }, [data]);

            const handleSettingsChange = (key, rawValue, options = {}) => {
                const { isPercent = false, allowText = false } = options;
                if (allowText) {
                    setData({
                        content: {
                            ...data.content,
                            settings: { ...dataContent.settings, [key]: rawValue },
                        }
                    });
                    return;
                }
                const parser = isPercent
                    ? normalizePercentInputValue
                    : (value) => parseNumericInput(value, { min: 0 });
                const parsed = parser(rawValue);
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...data.content,
                        settings: { ...dataContent.settings, [key]: parsed },
                    }
                });
            };

            const handleModeChange = (key, value) => {
                setData({
                    content: {
                        ...data.content,
                        modes: { ...dataContent.modes, [key]: value },
                    }
                });
            };

            const handleFiltersChange = (value) => {
                setData({
                    content: {
                        ...data.content,
                        filters: { ...dataContent.filters, searchTerm: value },
                    }
                });
            };

            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...data.content,
                        priceListDate: value,
                    }
                });
            };

            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...data.content,
                        priceListVersion: value,
                    }
                });
            };

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };

            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const handleSaveProduct = (productData) => {
                const sanitized = {
                    ...productData,
                    id: productData.id || `silikaty_${Date.now()}`,
                };
                const newProducts = productData.id
                    ? dataContent.products.map(p => p.id === productData.id ? sanitized : p)
                    : [...dataContent.products, sanitized];
                setData({ content: { ...data.content, products: newProducts } });
                closeProductModal();
            };

            const handleDeleteProduct = (productId) => {
                if (!confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                    return;
                }
                setData({
                    content: {
                        ...data.content,
                        products: dataContent.products.filter(p => p.id !== productId),
                    }
                });
            };

            const handleImportClick = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const handleFileImport = async (event) => {
                const input = event.target;
                const file = input?.files?.[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (rows.length < 2) {
                        alert('Plik jest pusty lub nie zawiera nagłówków.');
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const idxName = findNormalizedHeaderIndex(headers, ['nazwa', 'nazwa produktu']);
                    const idxPrice = findNormalizedHeaderIndex(headers, ['cena katalog', 'cena', 'cennik net']);
                    if (idxName === -1 || idxPrice === -1) {
                        alert('Brak wymaganych kolumn: Nazwa oraz Cena katalog.');
                        return;
                    }
                    const idxDimensions = findNormalizedHeaderIndex(headers, ['wymiary']);
                    const idxClass = findNormalizedHeaderIndex(headers, ['klasa']);
                    const idxWeight = findNormalizedHeaderIndex(headers, ['waga']);
                    const idxUnits = findNormalizedHeaderIndex(headers, [
                        'ilosc/paleta',
                        'ilosc na palecie',
                        'ilość/paleta',
                        'ilosc paleta',
                        'paleta',
                        'paletaszt',
                        'iloscpaleta',
                    ]);
                    const idxConsumption = findNormalizedHeaderIndex(headers, [
                        'zuzycie',
                        'zużycie',
                        'zuzycie na 1 m2',
                        'zużycie na 1 m2',
                        'zuzycie na m2',
                    ]);

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) continue;

                        const name = idxName >= 0 ? row[idxName] : null;
                        if (!name || String(name).trim() === '') continue;

                        const priceNet = parseLooseNumber(idxPrice >= 0 ? row[idxPrice] : null);
                        if (!Number.isFinite(priceNet) || priceNet <= 0) continue;

                        const units = idxUnits >= 0 ? extractNumberFromText(row[idxUnits]) : Number.NaN;
                        const consumptionRaw = idxConsumption >= 0 ? extractNumberFromText(row[idxConsumption]) : Number.NaN;
                        const weightRaw = idxWeight >= 0 ? extractNumberFromText(row[idxWeight]) : Number.NaN;

                        const product = {
                            id: `silikaty_${Date.now()}_${i}`,
                            name: String(name).trim(),
                            priceNet,
                            unitsPerPallet: Number.isFinite(units) && units > 0 ? units : '',
                            consumptionPerM2: Number.isFinite(consumptionRaw) && consumptionRaw > 0 ? roundToPrecision(consumptionRaw, 6) : '',
                            className: idxClass >= 0 && row[idxClass] != null ? String(row[idxClass]).replace('klasa', '').trim() : '',
                            weight: Number.isFinite(weightRaw) && weightRaw > 0 ? roundToPrecision(weightRaw, 6) : '',
                            dimensions: idxDimensions >= 0 && row[idxDimensions] != null ? String(row[idxDimensions]) : '',
                        };
                        newProducts.push(product);
                    }

                    if (newProducts.length === 0) {
                        alert('Nie znaleziono żadnych prawidłowych produktów do zaimportowania.');
                        return;
                    }

                    setData({ content: { ...data.content, products: newProducts } });
                    alert(`Import zakończony sukcesem! Zaimportowano ${newProducts.length} produktów.`);
                } catch (error) {
                    console.error('Błąd podczas importu pliku SILIKATY:', error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };

            const filteredProducts = useMemo(() => {
                const term = dataContent.filters.searchTerm.trim().toLowerCase();
                if (!term) {
                    return dataContent.products;
                }
                return dataContent.products.filter((product) =>
                    [product.name, product.className, product.dimensions]
                        .filter(Boolean)
                        .some((value) => String(value).toLowerCase().includes(term))
                );
            }, [dataContent.products, dataContent.filters.searchTerm]);

            const calculatedProducts = useMemo(
                () => filteredProducts.map((p) => calculateSilikatyProduct(p, dataContent.settings, dataContent.modes)),
                [filteredProducts, dataContent.settings, dataContent.modes]
            );

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">SILIKATY SZLACHTA</h1>
                            <p className="text-slate-500">Kalkulator bloczków silikatowych</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="border-2 border-red-600 rounded-md px-3 py-2 bg-red-50 max-w-xs w-full">
                                <label className="block text-xs font-bold uppercase text-red-700 mb-1">
                                    Wersja cennika
                                </label>
                                <input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={handlePriceListVersionChange}
                                    className="w-full border border-red-600 rounded-md px-2 py-1 text-sm font-semibold text-red-700 placeholder:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-300"
                                    placeholder="np. cennik 10/2025"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx, .xls"
                                />
                                <button
                                    onClick={handleImportClick}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button
                                    onClick={() => exportSilikatyToExcel(
                                        calculatedProducts,
                                        dataContent.settings,
                                        dataContent.modes
                                    )}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader><CardTitle>Transport</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <FormGroup label="TRANSPORT HDS (zł)">
                                <Input
                                    type="number"
                                    step="1"
                                    min="0"
                                    value={dataContent.settings.transportHds}
                                    onChange={(e) => handleSettingsChange('transportHds', e.target.value)}
                                />
                            </FormGroup>
                            <FormGroup label="TRANSPORT BEZ HDS (zł)">
                                <Input
                                    type="number"
                                    step="1"
                                    min="0"
                                    value={dataContent.settings.transportBezHds}
                                    onChange={(e) => handleSettingsChange('transportBezHds', e.target.value)}
                                />
                            </FormGroup>
                            <FormGroup label="Palet na auto">
                                <Input
                                    type="number"
                                    step="1"
                                    min="0"
                                    value={dataContent.settings.palletsPerTruck}
                                    onChange={(e) => handleSettingsChange('palletsPerTruck', e.target.value)}
                                />
                            </FormGroup>
                            <FormGroup label="Tryb transportu">
                                <Select value={dataContent.modes.transport} onChange={(e) => handleModeChange('transport', e.target.value)}>
                                    <option value="hds">HDS</option>
                                    <option value="bez_hds">Bez HDS</option>
                                </Select>
                            </FormGroup>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader><CardTitle>Rabaty i marża</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <FormGroup label="STANDARD (%)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    value={resolvePercentInputValue(dataContent.settings.discountStandard)}
                                    onChange={(e) => handleSettingsChange('discountStandard', e.target.value, { isPercent: true })}
                                />
                            </FormGroup>
                            <FormGroup label="INWESTYCYJNY (%)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    value={resolvePercentInputValue(dataContent.settings.discountInwest)}
                                    onChange={(e) => handleSettingsChange('discountInwest', e.target.value, { isPercent: true })}
                                />
                            </FormGroup>
                            <FormGroup label="Marża (%)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    value={resolvePercentInputValue(dataContent.settings.margin)}
                                    onChange={(e) => handleSettingsChange('margin', e.target.value, { isPercent: true })}
                                />
                            </FormGroup>
                            <FormGroup label="Tryb rabatu">
                                <Select value={dataContent.modes.discount} onChange={(e) => handleModeChange('discount', e.target.value)}>
                                    <option value="standard">STANDARD</option>
                                    <option value="inwestycyjny">INWESTYCYJNY</option>
                                </Select>
                            </FormGroup>
                            <FormGroup label="Rabat domyślny" variant="default-discount">
                                <Input
                                    type="text"
                                    value={dataContent.settings.defaultDiscountNote}
                                    onChange={(e) => handleSettingsChange('defaultDiscountNote', e.target.value, { allowText: true })}
                                />
                            </FormGroup>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <CardTitle>Produkty ({calculatedProducts.length} / {dataContent.products.length})</CardTitle>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input
                                    type="text"
                                    placeholder="Szukaj produktów..."
                                    value={dataContent.filters.searchTerm}
                                    onChange={(e) => handleFiltersChange(e.target.value)}
                                    className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm"
                                />
                                <button
                                    onClick={() => openProductModal()}
                                    className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0"
                                >
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                        <tr>
                                            {[
                                                { key: 'name', label: 'Nazwa', className: 'w-full text-left' },
                                                { key: 'wymiary', label: 'Wymiary', className: 'text-center' },
                                                { key: 'cennik', label: 'Cennik', className: 'text-center' },
                                                { key: 'rabat', label: 'Rabat', className: 'text-center' },
                                                { key: 'zakup', label: 'Zakup', className: 'text-center' },
                                                { key: 'transport', label: 'Transp.', className: 'text-center' },
                                                { key: 'loco', label: 'Loco', className: 'text-center' },
                                                { key: 'netto', label: 'Netto KL', className: 'text-center' },
                                                { key: 'brutto', label: 'Brutto KL', className: 'text-center' },
                                                { key: 'zuzycie', label: 'Zużycie', className: 'text-center' },
                                                { key: 'cenaM2', label: 'Cena m2 brutto', className: 'text-center' },
                                                { key: 'paleta', label: 'szt/paleta', className: 'text-center' },
                                                { key: 'klasa', label: 'Klasa', className: 'text-center' },
                                                { key: 'waga', label: 'Waga (kg)', className: 'text-center' },
                                                { key: 'akcje', label: 'Akcje', className: 'text-center' },
                                            ].map(({ key, label, className }) => (
                                                <th key={key} scope="col" className={`px-4 py-3 ${className || ''}`}>{label}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {calculatedProducts.map((product) => (
                                            <tr key={product.id} className="bg-white border-b hover:bg-slate-50">
                                                <td className="px-4 py-2 font-medium text-slate-900 align-top text-left">{product.name}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.dimensions || '-'}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{formatCurrency(product.priceNet)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{formatPercentage(product.discountApplied)}</td>
                                                <td className="px-4 py-2 bg-slate-50 font-semibold text-slate-700 whitespace-nowrap align-top text-center">{formatCurrency(product.netPurchasePrice)}</td>
                                                <td className="px-4 py-2 bg-slate-50 whitespace-nowrap align-top text-center">{formatCurrency(product.transportPerUnit)}</td>
                                                <td className="px-4 py-2 bg-slate-50 whitespace-nowrap align-top text-center">{formatCurrency(product.localPrice)}</td>
                                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top text-center">{formatCurrency(product.customerNetPrice)}</td>
                                                <td className="px-4 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top text-center">{formatCurrency(product.customerGrossPrice)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.consumptionPerM2 === '' || product.consumptionPerM2 == null ? '-' : formatNumberForInput(product.consumptionPerM2, 3)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.grossPricePerSquareMeter == null ? '-' : formatCurrency(product.grossPricePerSquareMeter)}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.unitsPerPallet || '-'}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.className || '-'}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">{product.weight || '-'}</td>
                                                <td className="px-4 py-2 whitespace-nowrap align-top text-center">
                                                    <div className="flex items-center gap-2">
                                                        <button onClick={() => openProductModal(product)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                        <button onClick={() => handleDeleteProduct(product.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))} 
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>
                    <Modal
                        isOpen={isProductModalOpen}
                        onClose={closeProductModal}
                        title={editingProduct ? 'Edytuj produkt SILIKATY' : 'Dodaj produkt SILIKATY'}
                    >
                        <SilikatyProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };

        const DocieplenieCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('docieplenie_data', INITIAL_DOCIEPLENIE_DATA);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);
            const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
            const [editingGroup, setEditingGroup] = useState(null);
            const [groupFormLabel, setGroupFormLabel] = useState('');

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const dataContent = useMemo(() => {
                const content = data?.content || {};
                const groups = Array.isArray(content.groups) && content.groups.length ? content.groups : DOCIEPLENIE_BASE_GROUPS;
                const normalizeEntries = (source) => groups.reduce((acc, group) => {
                    acc[group.id] = source && Object.prototype.hasOwnProperty.call(source, group.id) ? source[group.id] : '';
                    return acc;
                }, {});
                return {
                    priceListVersion: content.priceListVersion || '',
                    priceListDate: content.priceListDate || '',
                    notes: content.notes || '',
                    styroThicknessCm: content.styroThicknessCm || '',
                    surfaceArea: content.surfaceArea || '',
                    settings: {
                        ...INITIAL_DOCIEPLENIE_DATA.content.settings,
                        ...(content.settings || {}),
                    },
                    groups,
                    selections: normalizeEntries(content.selections || {}),
                    quantityAdjustments: normalizeEntries(content.quantityAdjustments || {}),
                    products: Array.isArray(content.products) && content.products.length
                        ? content.products
                        : DOCIEPLENIE_INITIAL_PRODUCTS,
                    filters: {
                        ...INITIAL_DOCIEPLENIE_DATA.content.filters,
                        ...(content.filters || {}),
                    },
                };
            }, [data]);
            const docieplenieGroups = dataContent.groups && dataContent.groups.length ? dataContent.groups : DOCIEPLENIE_BASE_GROUPS;
            const groupLabelMap = useMemo(() => docieplenieGroups.reduce((acc, group) => {
                acc[group.id] = group.label;
                return acc;
            }, {}), [docieplenieGroups]);

            const handleSettingsChange = (key, value, { isPercent = false } = {}) => {
                const parsed = isPercent
                    ? normalizePercentInputValue(value)
                    : parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: { ...dataContent.settings, [key]: parsed },
                    }
                });
            };

            const handleSelectionChange = (groupId, productId) => {
                setData({
                    content: {
                        ...dataContent,
                        selections: { ...dataContent.selections, [groupId]: productId },
                    }
                });
            };

            const handleSurfaceChange = (value) => {
                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({ content: { ...dataContent, surfaceArea: parsed } });
            };

            const handleTextFieldChange = (key, value) => {
                setData({ content: { ...dataContent, [key]: value } });
            };

            const handleThicknessChange = (value) => {
                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({ content: { ...dataContent, styroThicknessCm: parsed } });
            };

            const normalizeEntriesForGroups = (groups, source) => groups.reduce((acc, group) => {
                acc[group.id] = source && Object.prototype.hasOwnProperty.call(source, group.id) ? source[group.id] : '';
                return acc;
            }, {});

            const handleSaveGroup = () => {
                const label = groupFormLabel.trim();
                if (!label) {
                    alert('Podaj nazwę grupy.');
                    return;
                }

                const existingIds = docieplenieGroups.map((g) => g.id);
                const toSlug = (text) => text.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '') || 'grupa';
                const generateUniqueId = (baseLabel) => {
                    const base = toSlug(baseLabel);
                    let candidate = base;
                    let counter = 1;
                    while (existingIds.includes(candidate)) {
                        candidate = `${base}_${counter}`;
                        counter += 1;
                    }
                    return candidate;
                };

                let newGroups = [...docieplenieGroups];
                if (editingGroup) {
                    newGroups = newGroups.map((group) => group.id === editingGroup.id ? { ...group, label } : group);
                } else {
                    const newGroup = { id: generateUniqueId(label), label };
                    newGroups = [...newGroups, newGroup];
                }

                const selections = normalizeEntriesForGroups(newGroups, dataContent.selections);
                const quantityAdjustments = normalizeEntriesForGroups(newGroups, dataContent.quantityAdjustments);

                setData({
                    content: {
                        ...dataContent,
                        groups: newGroups,
                        selections,
                        quantityAdjustments,
                    }
                });
                setIsGroupModalOpen(false);
                setEditingGroup(null);
                setGroupFormLabel('');
            };

            const openGroupModal = (group = null) => {
                setEditingGroup(group);
                setGroupFormLabel(group?.label || '');
                setIsGroupModalOpen(true);
            };

            const closeGroupModal = () => {
                setIsGroupModalOpen(false);
                setEditingGroup(null);
                setGroupFormLabel('');
            };


            const handleSaveProduct = (productData) => {
                const sanitized = {
                    ...productData,
                    id: productData.id || `docieplenie_${Date.now()}`,
                };
                const newProducts = productData.id
                    ? dataContent.products.map((p) => p.id === productData.id ? sanitized : p)
                    : [...dataContent.products, sanitized];
                setData({ content: { ...dataContent, products: newProducts } });
                setIsProductModalOpen(false);
                setEditingProduct(null);
            };

            const handleDeleteProduct = (productId) => {
                if (!confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                    return;
                }
                const newProducts = dataContent.products.filter((p) => p.id !== productId);
                const newSelections = { ...dataContent.selections };
                Object.entries(newSelections).forEach(([key, value]) => {
                    if (value === productId) {
                        newSelections[key] = '';
                    }
                });
                setData({
                    content: { ...dataContent, products: newProducts, selections: newSelections },
                });
            };

            const handleImportClick = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const resolveGroupIdFromText = (value) => {
                if (!value) return '';
                const normalized = normalizeHeaderKey(value);
                const found = docieplenieGroups.find((group) => {
                    const normalizedLabel = normalizeHeaderKey(group.label);
                    const normalizedId = normalizeHeaderKey(group.id);
                    return normalized === normalizedLabel || normalized === normalizedId;
                });
                return found ? found.id : '';
            };

            const handleFileImport = async (event) => {
                const input = event.target;
                const file = input?.files?.[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (rows.length < 2) {
                        alert('Plik jest pusty lub nie zawiera nagłówków.');
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const idxName = findNormalizedHeaderIndex(headers, ['nazwa', 'produkt', 'asortyment']);
                    const idxGroup = findNormalizedHeaderIndex(headers, ['grupa', 'segment']);
                    const idxPrice = findNormalizedHeaderIndex(headers, ['cena', 'cena netto']);
                    const idxConsumption = findNormalizedHeaderIndex(headers, ['zuzycie', 'zużycie', 'zuzycie / m2', 'zużycie / m2']);
                    const idxUnit = findNormalizedHeaderIndex(headers, ['jednostka', 'jm']);

                    if (idxName === -1 || idxGroup === -1 || idxPrice === -1) {
                        alert('Brak wymaganych kolumn: Nazwa, Grupa, Cena netto.');
                        return;
                    }

                    const imported = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every((cell) => cell === null || cell === '')) {
                            continue;
                        }
                        const name = row[idxName];
                        const groupRaw = row[idxGroup];
                        const priceRaw = row[idxPrice];
                        if (!name || !groupRaw || priceRaw == null) {
                            continue;
                        }

                        const groupId = resolveGroupIdFromText(groupRaw);
                        if (!groupId) {
                            continue;
                        }

                        const priceNet = parseLooseNumber(priceRaw);
                        if (!Number.isFinite(priceNet) || priceNet <= 0) {
                            continue;
                        }

                        const consumptionPerM2 = idxConsumption >= 0 ? parseLooseNumber(row[idxConsumption]) : '';
                        const unit = idxUnit >= 0 && row[idxUnit] != null ? String(row[idxUnit]).trim() : '';

                        imported.push({
                            id: `docieplenie_${Date.now()}_${i}`,
                            name: String(name).trim(),
                            group: groupId,
                            priceNet: priceNet,
                            consumptionPerM2: Number.isFinite(consumptionPerM2) && consumptionPerM2 >= 0 ? consumptionPerM2 : '',
                            unit,
                        });
                    }

                    if (!imported.length) {
                        alert('Nie znaleziono prawidłowych produktów do importu.');
                        return;
                    }

                    setData({ content: { ...dataContent, products: imported } });
                    alert(`Import zakończony sukcesem! Zaimportowano ${imported.length} pozycji.`);
                } catch (error) {
                    console.error('Błąd importu DOCIEPLENIE:', error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku.');
                } finally {
                    input.value = '';
                }
            };

            const productsByGroup = useMemo(() => {
                return docieplenieGroups.reduce((acc, group) => {
                    acc[group.id] = dataContent.products.filter((product) => product.group === group.id);
                    return acc;
                }, {});
            }, [dataContent.products, docieplenieGroups]);

            const selectedProducts = useMemo(() => (
                docieplenieGroups.reduce((acc, group) => {
                    acc[group.id] = dataContent.products.find((p) => p.id === dataContent.selections[group.id]) || null;
                    return acc;
                }, {})
            ), [dataContent.products, dataContent.selections, docieplenieGroups]);

            const surfaceAreaValue = parseLooseNumber(dataContent.surfaceArea);
            const safeSurface = Number.isFinite(surfaceAreaValue) && surfaceAreaValue > 0 ? surfaceAreaValue : 0;
            const transportNet = parseLooseNumber(dataContent.settings.transportCost);
            const safeTransportNet = Number.isFinite(transportNet) && transportNet >= 0 ? transportNet : 0;
            const transportGross = safeTransportNet * DOCIEPLENIE_VAT_RATE;

            const calculationRows = useMemo(() => (
                docieplenieGroups.map((group) => {
                    const product = selectedProducts[group.id];
                    const calculation = calculateDocieplenieLine(product, safeSurface, dataContent.settings, {
                        styroThicknessCm: dataContent.styroThicknessCm,
                    });
                    const manualUnits = parseLooseNumber(dataContent.quantityAdjustments[group.id]);
                    const unitsOverride = Number.isFinite(manualUnits) && manualUnits >= 0 ? manualUnits : null;
                    const unitsUsed = unitsOverride != null ? unitsOverride : calculation.unitsNeeded;
                    const lineNet = calculation.saleNetUnit * unitsUsed;
                    const lineGross = lineNet * DOCIEPLENIE_VAT_RATE;
                    return {
                        group,
                        product,
                        calculation: {
                            ...calculation,
                            unitsUsed,
                            lineNet,
                            lineGross,
                            unitsOverride,
                        }
                    };
                })
            ), [dataContent.settings, selectedProducts, safeSurface, dataContent.styroThicknessCm, dataContent.quantityAdjustments, docieplenieGroups]);

            const subtotalNet = calculationRows.reduce((sum, row) => sum + row.calculation.lineNet, 0);
            const subtotalGross = calculationRows.reduce((sum, row) => sum + row.calculation.lineGross, 0);
            const totalNet = subtotalNet + safeTransportNet;
            const totalGross = subtotalGross + transportGross;
            const perSquareNet = safeSurface > 0 ? totalNet / safeSurface : null;
            const perSquareGross = safeSurface > 0 ? totalGross / safeSurface : null;


            const filteredProductsByGroup = useMemo(() => {
                const term = (dataContent.filters.productSearch || '').toLowerCase();
                return docieplenieGroups.map((group) => {
                    const scoped = dataContent.products.filter((product) => product.group === group.id);
                    const filtered = !term
                        ? scoped
                        : scoped.filter((product) => (
                            [product.name, product.group, product.unit]
                                .filter(Boolean)
                                .some((value) => String(value).toLowerCase().includes(term))
                        ));
                    return { group, products: filtered };
                });
            }, [dataContent.filters.productSearch, dataContent.products, docieplenieGroups]);

            const openNewProduct = (groupId = null) => {
                setEditingProduct(groupId ? { group: groupId } : null);
                setIsProductModalOpen(true);
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">Docieplenie</h1>
                            <p className="text-slate-500">Kalkulator systemu ociepleń: styropian, kleje, akcesoria</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-2 sm:items-end w-full sm:w-auto">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={(event) => handleTextFieldChange('priceListDate', event.target.value)}
                                className="w-full sm:w-auto"
                            />
                            <FormGroup label="Wersja cennika">
                                <Input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={(event) => handleTextFieldChange('priceListVersion', event.target.value)}
                                    placeholder="np. 09/2024"
                                />
                            </FormGroup>
                            <div className="flex gap-2 flex-wrap justify-end">
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".xlsx, .xls"
                                    className="hidden"
                                    onChange={handleFileImport}
                                />
                                <button onClick={handleImportClick} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button onClick={() => exportDocieplenieToExcel(dataContent.products, groupLabelMap)} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                                <button onClick={() => { setEditingProduct(null); setIsProductModalOpen(true); }} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                    <AddIcon /> Dodaj produkt
                                </button>
                            </div>
                        </div>
                    </header>

                    <Card>
                        <CardHeader>
                            <CardTitle>Parametry kalkulatora</CardTitle>
                            <CardDescription>Powierzchnia, marża i koszt dostawy wpływają na wynik końcowy.</CardDescription>
                        </CardHeader>
                        <CardContent className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <FormGroup label="Powierzchnia ocieplenia (m²)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={dataContent.surfaceArea}
                                    onChange={(event) => handleSurfaceChange(event.target.value)}
                                    placeholder="np. 250"
                                />
                            </FormGroup>
                            <FormGroup label="Grubość styropianu (cm)">
                                <Input
                                    type="number"
                                    step="0.5"
                                    min="0"
                                    value={dataContent.styroThicknessCm}
                                    onChange={(event) => handleThicknessChange(event.target.value)}
                                    placeholder="np. 15"
                                />
                            </FormGroup>
                            <FormGroup label="Marża (%)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    max="100"
                                    value={dataContent.settings.margin}
                                    onChange={(event) => handleSettingsChange('margin', event.target.value, { isPercent: true })}
                                />
                            </FormGroup>
                            <FormGroup label="Koszt dostawy (zł)">
                                <Input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={dataContent.settings.transportCost}
                                    onChange={(event) => handleSettingsChange('transportCost', event.target.value)}
                                />
                            </FormGroup>
                            <FormGroup label="Notatki (nagłówek oferty)">
                                <textarea
                                    value={dataContent.notes || ''}
                                    onChange={(event) => handleTextFieldChange('notes', event.target.value)}
                                    placeholder="np. system ETICS, lambda 0,031"
                                    className="w-full min-h-[80px] p-3 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                />
                            </FormGroup>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Dobór materiałów</CardTitle>
                            <CardDescription>Wybierz produkty do poszczególnych warstw. Zużycie wpływa na ilość i koszt.</CardDescription>
                            {dataContent.styroThicknessCm && (
                                <p className="text-sm text-slate-600 mt-2">Grubość styropianu: <strong>{formatNumberForInput(dataContent.styroThicknessCm, 2)} cm</strong></p>
                            )}
                        </CardHeader>
                        <CardContent className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="text-xs uppercase text-slate-700 bg-slate-50">
                                    <tr>
                                        <th className="px-3 py-3 w-56">Grupa</th>
                                        <th className="px-3 py-3 w-[320px]">Produkt</th>
                                        <th className="px-3 py-3 text-center">Zużycie / m²</th>
                                        <th className="px-3 py-3 text-center">Ilość łącznie</th>
                                        <th className="px-3 py-3 text-center">Cena netto (sprzedaż)</th>
                                        <th className="px-3 py-3 text-center">Cena brutto (sprzedaż)</th>
                                        <th className="px-3 py-3 text-center">Wartość netto</th>
                                        <th className="px-3 py-3 text-center">Wartość brutto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {calculationRows.map(({ group, product, calculation }) => (
                                        <tr key={group.id} className="bg-white border-b hover:bg-slate-50">
                                            <td className="px-3 py-3 font-medium text-slate-800 align-top">{group.label}</td>
                                            <td className="px-3 py-3 align-top">
                                                <Select
                                                    value={dataContent.selections[group.id] || ''}
                                                    onChange={(event) => handleSelectionChange(group.id, event.target.value)}
                                                    className="w-full"
                                                >
                                                    <option value="">Wybierz produkt</option>
                                                    {productsByGroup[group.id].map((item) => (
                                                        <option key={item.id} value={item.id}>
                                                            {item.name}
                                                        </option>
                                                    ))}
                                                </Select>
                            {product && (
                                <p className="text-xs text-slate-500 mt-1">
                                    {product.group === 'styroType'
                                        ? <>Cena zakupu (m3): {formatCurrency(product.priceNet)} | Grubość: {formatNumberForInput(dataContent.styroThicknessCm || 0, 2)} cm</>
                                        : <>Cena zakupu: {formatCurrency(product.priceNet)}</>}
                                </p>
                            )}
                                            </td>
                                            <td className="px-3 py-3 text-center align-top">
                                                {calculation.consumptionPerM2Used > 0
                                                    ? formatNumberForInput(calculation.consumptionPerM2Used, 3)
                                                    : <span className="text-amber-600 text-xs">Brak zużycia</span>}
                                            </td>
                                            <td className="px-3 py-3 text-center align-top">
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    min="0"
                                                    value={dataContent.quantityAdjustments[group.id] ?? ''}
                                                    placeholder={calculation.unitsNeeded > 0 ? formatNumberForInput(calculation.unitsNeeded, 3) : ''}
                                                    onChange={(event) => handleQuantityAdjustmentChange(group.id, event.target.value)}
                                                    className="w-full px-2 py-1 border border-slate-300 rounded-md text-sm text-center"
                                                />
                                                <p className="text-[11px] text-slate-500 mt-1">Auto: {calculation.unitsNeeded > 0 ? formatNumberForInput(calculation.unitsNeeded, 3) : '-'}</p>
                                            </td>
                                            <td className="px-3 py-3 text-center align-top">
                                                {product
                                                    ? formatCurrency(calculation.saleNetUnit)
                                                    : '-'}
                                            </td>
                                            <td className="px-3 py-3 text-center align-top">
                                                {product
                                                    ? formatCurrency(calculation.saleGrossUnit)
                                                    : '-'}
                                            </td>
                                            <td className="px-3 py-3 text-center align-top font-semibold text-slate-800">
                                                {product
                                                    ? formatCurrency(calculation.lineNet)
                                                    : '-'}
                                            </td>
                                            <td className="px-3 py-3 text-center align-top font-semibold text-blue-700">
                                                {product
                                                    ? formatCurrency(calculation.lineGross)
                                                    : '-'}
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-slate-50 font-semibold">
                                        <td className="px-3 py-3" colSpan={5}>Transport (całość)</td>
                                        <td className="px-3 py-3 text-center">{formatCurrency(safeTransportNet)}</td>
                                        <td className="px-3 py-3 text-center">{formatCurrency(transportGross)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Podsumowanie kosztów</CardTitle>
                            <CardDescription>Kwoty sprzedażowe po rabacie i marży. Zawierają koszt dostawy.</CardDescription>
                        </CardHeader>
                        <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="p-4 border rounded-lg bg-slate-50">
                                <p className="text-sm font-semibold text-slate-800">Za całość docieplenia</p>
                                <p className="text-xs text-slate-500 mb-2">Powierzchnia: {safeSurface > 0 ? `${formatNumberForInput(safeSurface, 2)} m²` : '—'}</p>
                                <div className="flex justify-between text-lg font-bold text-slate-800">
                                    <span>Netto</span>
                                    <span>{formatCurrency(totalNet)}</span>
                                </div>
                                <div className="flex justify-between text-lg font-bold text-blue-800 mt-1">
                                    <span>Brutto</span>
                                    <span>{formatCurrency(totalGross)}</span>
                                </div>
                            </div>
                            <div className="p-4 border rounded-lg bg-slate-50">
                                <p className="text-sm font-semibold text-slate-800">Za 1 m²</p>
                                {safeSurface > 0 ? (
                                    <>
                                        <div className="flex justify-between text-lg font-bold text-slate-800">
                                            <span>Netto / m²</span>
                                            <span>{formatCurrency(perSquareNet)}</span>
                                        </div>
                                        <div className="flex justify-between text-lg font-bold text-blue-800 mt-1">
                                            <span>Brutto / m²</span>
                                            <span>{formatCurrency(perSquareGross)}</span>
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-sm text-slate-500">Podaj powierzchnię, aby wyświetlić stawki na m².</p>
                                )}
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>Asortyment (listy rozwijane)</CardTitle>
                                <CardDescription>Dodawaj, edytuj, importuj i eksportuj produkty.</CardDescription>
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input
                                    type="text"
                                    placeholder="Szukaj po nazwie, grupie..."
                                    value={dataContent.filters.productSearch}
                                    onChange={(event) => setData({ content: { ...dataContent, filters: { ...dataContent.filters, productSearch: event.target.value } } })}
                                    className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm"
                                />
                                <button onClick={() => openGroupModal()} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors flex-shrink-0">
                                    <SettingsIcon /> Grupy
                                </button>
                                <button onClick={() => openNewProduct()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {filteredProductsByGroup.map(({ group, products }) => (
                                    <div key={group.id} className="border rounded-lg bg-white shadow-sm">
                                        <div className="flex items-start justify-between gap-2 p-4 border-b">
                                            <div>
                                                <p className="text-sm font-semibold text-slate-800">{group.label}</p>
                                                <p className="text-xs text-slate-500">{products.length} produkt{products.length === 1 ? '' : 'y'}</p>
                                            </div>
                                            <button onClick={() => openNewProduct(group.id)} className="flex items-center gap-1 px-2 py-1 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                                <AddIcon /> Dodaj
                                            </button>
                                        </div>
                                        <div className="divide-y">
                                            {products.length === 0 && (
                                                <div className="p-4 text-sm text-slate-500">Brak produktów w tej grupie.</div>
                                            )}
                                            {products.map((product) => (
                                                <div key={product.id} className="p-4 flex flex-col gap-2">
                                                    <div className="flex justify-between items-start gap-2">
                                                        <div>
                                                            <p className="font-semibold text-slate-800">{product.name}</p>
                                                            <p className="text-xs text-slate-500">JM: {product.unit || '-'}</p>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => { setEditingProduct(product); setIsProductModalOpen(true); }} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                            <button onClick={() => handleDeleteProduct(product.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2 text-xs text-slate-600">
                                                        <div>
                                                            <p className="font-semibold text-slate-700">Cena netto (zakup)</p>
                                                            <p>{formatCurrency(product.priceNet)}</p>
                                                        </div>
                                                        <div>
                                                            <p className="font-semibold text-slate-700">Zużycie / m²</p>
                                                            <p>{product.consumptionPerM2 === '' || product.consumptionPerM2 == null ? '-' : formatNumberForInput(product.consumptionPerM2, 3)}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </CardContent>
                    </Card>

                    <Modal
                        isOpen={isProductModalOpen}
                        onClose={() => { setIsProductModalOpen(false); setEditingProduct(null); }}
                        title={editingProduct ? 'Edytuj produkt docieplenia' : 'Dodaj produkt docieplenia'}
                    >
                        <DocieplenieProductForm
                            product={editingProduct}
                            groups={docieplenieGroups}
                            onSave={handleSaveProduct}
                            onCancel={() => { setIsProductModalOpen(false); setEditingProduct(null); }}
                        />
                    </Modal>
                    <Modal
                        isOpen={isGroupModalOpen}
                        onClose={closeGroupModal}
                        title="Grupy asortymentowe"
                    >
                        <div className="space-y-4">
                            <div className="space-y-2 max-h-64 overflow-y-auto pr-1">
                                {docieplenieGroups.map((group) => (
                                    <div key={group.id} className="flex items-center justify-between gap-3 border border-slate-200 rounded-md px-3 py-2">
                                        <div>
                                            <p className="text-sm font-semibold text-slate-800">{group.label}</p>
                                            <p className="text-xs text-slate-500">ID: {group.id}</p>
                                        </div>
                                        <button onClick={() => openGroupModal(group)} className="px-2 py-1 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                            Edytuj
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t pt-4 space-y-3">
                                <FormGroup label="Nazwa grupy">
                                    <Input
                                        value={groupFormLabel}
                                        onChange={(event) => setGroupFormLabel(event.target.value)}
                                        placeholder="np. Tynk dekoracyjny"
                                    />
                                </FormGroup>
                                {editingGroup && (
                                    <p className="text-xs text-slate-500">ID grupy: {editingGroup.id} (niezmienialne)</p>
                                )}
                                <div className="flex justify-end gap-2">
                                    <button onClick={closeGroupModal} type="button" className="px-3 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                                    <button onClick={handleSaveGroup} type="button" className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz</button>
                                </div>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const KnaufProductForm = ({ product, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                name: '',
                lambda: '',
                thicknessCm: '',
                coveragePerPack: '',
                pricePerPack: '',
                note: '',
                ...(product || {})
            });

            useEffect(() => {
                setFormData({
                    name: '',
                    lambda: '',
                    thicknessCm: '',
                    coveragePerPack: '',
                    pricePerPack: '',
                    note: '',
                    ...(product || {})
                });
            }, [product]);

            const handleChange = (event) => {
                const { name, value } = event.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();

                const lambdaValue = parseLooseNumber(formData.lambda);
                const thicknessValue = parseLooseNumber(formData.thicknessCm);
                const coverageValue = parseLooseNumber(formData.coveragePerPack);
                const priceValue = parseLooseNumber(formData.pricePerPack);

                if (!formData.name.trim()) {
                    alert('Nazwa produktu jest wymagana.');
                    return;
                }
                if (!Number.isFinite(lambdaValue) || lambdaValue <= 0) {
                    alert('Podaj poprawną lambdę.');
                    return;
                }
                if (!Number.isFinite(thicknessValue) || thicknessValue <= 0) {
                    alert('Podaj grubość w cm.');
                    return;
                }
                if (!Number.isFinite(coverageValue) || coverageValue <= 0) {
                    alert('Podaj metraż w paczce.');
                    return;
                }
                if (!Number.isFinite(priceValue) || priceValue < 0) {
                    alert('Podaj cenę paczki netto.');
                    return;
                }

                const sanitized = {
                    id: product?.id || `kn_prod_${Date.now()}`,
                    name: formData.name.trim(),
                    lambda: roundToPrecision(lambdaValue, 4),
                    thicknessCm: roundToPrecision(thicknessValue, 3),
                    coveragePerPack: roundToPrecision(coverageValue, 3),
                    pricePerPack: roundToPrecision(priceValue, 2),
                    note: (formData.note || '').trim(),
                };

                onSave(sanitized);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa">
                            <Input name="name" value={formData.name} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Lambda">
                            <Input name="lambda" type="number" step="0.001" value={formData.lambda} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Grubość (cm)">
                            <Input name="thicknessCm" type="number" step="0.1" value={formData.thicknessCm} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Metraż w paczce (m²)">
                            <Input name="coveragePerPack" type="number" step="0.01" value={formData.coveragePerPack} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Cena paczki netto (zł)">
                            <Input name="pricePerPack" type="number" step="0.01" value={formData.pricePerPack} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Notatka">
                            <Input name="note" value={formData.note} onChange={handleChange} />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz produkt</button>
                    </div>
                </form>
            );
        };

        const KnaufPlanForm = ({ plan, products, defaults, onSave, onCancel }) => {
            const [formState, setFormState] = useState({
                name: '',
                productId: products[0]?.id || '',
                area: '',
                wastePercent: defaults.defaultWaste,
                margin: defaults.defaultMargin,
                discount1: defaults.discounts?.discount1 || defaults.defaultDiscounts?.discount1 || '',
                discount2: defaults.discounts?.discount2 || defaults.defaultDiscounts?.discount2 || '',
                discount3: defaults.discounts?.discount3 || defaults.defaultDiscounts?.discount3 || '',
                discount4: defaults.discounts?.discount4 || defaults.defaultDiscounts?.discount4 || '',
                extraNote: '',
                ...(plan || {})
            });

            useEffect(() => {
                setFormState({
                    name: '',
                    productId: products[0]?.id || '',
                    area: '',
                    wastePercent: defaults.defaultWaste,
                    margin: defaults.defaultMargin,
                    discount1: defaults.discounts?.discount1 || defaults.defaultDiscounts?.discount1 || '',
                    discount2: defaults.discounts?.discount2 || defaults.defaultDiscounts?.discount2 || '',
                    discount3: defaults.discounts?.discount3 || defaults.defaultDiscounts?.discount3 || '',
                    discount4: defaults.discounts?.discount4 || defaults.defaultDiscounts?.discount4 || '',
                    extraNote: '',
                    ...(plan || {})
                });
            }, [plan, products, defaults]);

            const handleChange = (event) => {
                const { name, value } = event.target;
                setFormState(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();

                const areaValue = parseLooseNumber(formState.area);
                const wasteValue = parseLooseNumber(formState.wastePercent);
                const marginValue = parseLooseNumber(formState.margin);
                const defaultWasteNumber = parseLooseNumber(defaults.defaultWaste);
                const defaultMarginNumber = parseLooseNumber(defaults.defaultMargin);

                if (!formState.name.trim()) {
                    alert('Nazwa strefy jest wymagana.');
                    return;
                }
                if (!formState.productId) {
                    alert('Wybierz produkt KNAUF.');
                    return;
                }
                if (!Number.isFinite(areaValue) || areaValue <= 0) {
                    alert('Podaj poprawną powierzchnię w m².');
                    return;
                }

                const sanitizedWaste = Number.isFinite(wasteValue)
                    ? wasteValue
                    : (Number.isFinite(defaultWasteNumber) ? defaultWasteNumber : 0);
                const sanitizedMargin = Number.isFinite(marginValue)
                    ? marginValue
                    : (Number.isFinite(defaultMarginNumber) ? defaultMarginNumber : 0);

                const pickDiscount = (value, primary, secondary) => {
                    if (Number.isFinite(value)) return value;
                    if (Number.isFinite(primary)) return primary;
                    if (Number.isFinite(secondary)) return secondary;
                    return 0;
                };
                const d1 = pickDiscount(
                    parseLooseNumber(formState.discount1),
                    parseLooseNumber(defaults.discounts?.discount1),
                    parseLooseNumber(defaults.defaultDiscounts?.discount1)
                );
                const d2 = pickDiscount(
                    parseLooseNumber(formState.discount2),
                    parseLooseNumber(defaults.discounts?.discount2),
                    parseLooseNumber(defaults.defaultDiscounts?.discount2)
                );
                const d3 = pickDiscount(
                    parseLooseNumber(formState.discount3),
                    parseLooseNumber(defaults.discounts?.discount3),
                    parseLooseNumber(defaults.defaultDiscounts?.discount3)
                );
                const d4 = pickDiscount(
                    parseLooseNumber(formState.discount4),
                    parseLooseNumber(defaults.discounts?.discount4),
                    parseLooseNumber(defaults.defaultDiscounts?.discount4)
                );

                const sanitized = {
                    id: plan?.id || `kn_plan_${Date.now()}`,
                    name: formState.name.trim(),
                    productId: formState.productId,
                    area: roundToPrecision(areaValue, 3),
                    wastePercent: roundToPrecision(sanitizedWaste, 3),
                    margin: roundToPrecision(sanitizedMargin, 3),
                    discount1: roundToPrecision(d1, 3),
                    discount2: roundToPrecision(d2, 3),
                    discount3: roundToPrecision(d3, 3),
                    discount4: roundToPrecision(d4, 3),
                    extraNote: (formState.extraNote || '').trim(),
                };

                onSave(sanitized);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa strefy">
                            <Input name="name" value={formState.name} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Produkt KNAUF">
                            <Select name="productId" value={formState.productId} onChange={handleChange} required>
                                <option value="">Wybierz...</option>
                                {products.map((product) => (
                                    <option key={product.id} value={product.id}>{product.name}</option>
                                ))}
                            </Select>
                        </FormGroup>
                        <FormGroup label="Powierzchnia (m²)">
                            <Input name="area" type="number" step="0.1" value={formState.area} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Odpady (%)">
                            <Input name="wastePercent" type="number" step="0.1" value={formState.wastePercent} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Marża (%)">
                            <Input name="margin" type="number" step="0.1" value={formState.margin} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 1 (%)">
                            <Input name="discount1" type="number" step="0.1" value={formState.discount1} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 2 (%)">
                            <Input name="discount2" type="number" step="0.1" value={formState.discount2} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 3 (%)">
                            <Input name="discount3" type="number" step="0.1" value={formState.discount3} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 4 (%)">
                            <Input name="discount4" type="number" step="0.1" value={formState.discount4} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Notatka">
                            <Input name="extraNote" value={formState.extraNote} onChange={handleChange} />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">{plan ? 'Zapisz zmiany' : 'Dodaj strefę'}</button>
                    </div>
                </form>
            );
        };

        const RockwoolProductForm = ({ product, onSave, onCancel }) => {
            const [formData, setFormData] = useState({
                name: '',
                lambda: '',
                thicknessCm: '',
                coveragePerPack: '',
                pricePerPack: '',
                note: '',
                ...(product || {})
            });

            useEffect(() => {
                setFormData({
                    name: '',
                    lambda: '',
                    thicknessCm: '',
                    coveragePerPack: '',
                    pricePerPack: '',
                    note: '',
                    ...(product || {})
                });
            }, [product]);

            const handleChange = (event) => {
                const { name, value } = event.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();

                const lambdaValue = parseLooseNumber(formData.lambda);
                const thicknessValue = parseLooseNumber(formData.thicknessCm);
                const coverageValue = parseLooseNumber(formData.coveragePerPack);
                const priceValue = parseLooseNumber(formData.pricePerPack);

                if (!formData.name.trim()) {
                    alert('Nazwa produktu jest wymagana.');
                    return;
                }
                if (!Number.isFinite(lambdaValue) || lambdaValue <= 0) {
                    alert('Podaj poprawną lambdę.');
                    return;
                }
                if (!Number.isFinite(thicknessValue) || thicknessValue <= 0) {
                    alert('Podaj grubość w cm.');
                    return;
                }
                if (!Number.isFinite(coverageValue) || coverageValue <= 0) {
                    alert('Podaj metraż w paczce.');
                    return;
                }
                if (!Number.isFinite(priceValue) || priceValue < 0) {
                    alert('Podaj cenę paczki netto.');
                    return;
                }

                const sanitized = {
                    id: product?.id || `rw_prod_${Date.now()}`,
                    name: formData.name.trim(),
                    lambda: roundToPrecision(lambdaValue, 4),
                    thicknessCm: roundToPrecision(thicknessValue, 3),
                    coveragePerPack: roundToPrecision(coverageValue, 3),
                    pricePerPack: roundToPrecision(priceValue, 2),
                    note: (formData.note || '').trim(),
                };

                onSave(sanitized);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa">
                            <Input name="name" value={formData.name} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Lambda">
                            <Input name="lambda" type="number" step="0.001" value={formData.lambda} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Grubość (cm)">
                            <Input name="thicknessCm" type="number" step="0.1" value={formData.thicknessCm} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Metraż w paczce (m²)">
                            <Input name="coveragePerPack" type="number" step="0.01" value={formData.coveragePerPack} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Cena paczki netto (zł)">
                            <Input name="pricePerPack" type="number" step="0.01" value={formData.pricePerPack} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Notatka">
                            <Input name="note" value={formData.note} onChange={handleChange} />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Zapisz produkt</button>
                    </div>
                </form>
            );
        };

        const RockwoolPlanForm = ({ plan, products, defaults, onSave, onCancel }) => {
            const [formState, setFormState] = useState({
                name: '',
                productId: products[0]?.id || '',
                area: '',
                wastePercent: defaults.defaultWaste,
                margin: defaults.defaultMargin,
                discount1: defaults.discounts?.discount1 || defaults.defaultDiscounts?.discount1 || '',
                discount2: defaults.discounts?.discount2 || defaults.defaultDiscounts?.discount2 || '',
                discount3: defaults.discounts?.discount3 || defaults.defaultDiscounts?.discount3 || '',
                discount4: defaults.discounts?.discount4 || defaults.defaultDiscounts?.discount4 || '',
                extraNote: '',
                ...(plan || {})
            });

            useEffect(() => {
                setFormState({
                    name: '',
                    productId: products[0]?.id || '',
                    area: '',
                    wastePercent: defaults.defaultWaste,
                    margin: defaults.defaultMargin,
                    discount1: defaults.discounts?.discount1 || defaults.defaultDiscounts?.discount1 || '',
                    discount2: defaults.discounts?.discount2 || defaults.defaultDiscounts?.discount2 || '',
                    discount3: defaults.discounts?.discount3 || defaults.defaultDiscounts?.discount3 || '',
                    discount4: defaults.discounts?.discount4 || defaults.defaultDiscounts?.discount4 || '',
                    extraNote: '',
                    ...(plan || {})
                });
            }, [plan, products, defaults]);

            const handleChange = (event) => {
                const { name, value } = event.target;
                setFormState(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();

                const areaValue = parseLooseNumber(formState.area);
                const wasteValue = parseLooseNumber(formState.wastePercent);
                const marginValue = parseLooseNumber(formState.margin);
                const defaultWasteNumber = parseLooseNumber(defaults.defaultWaste);
                const defaultMarginNumber = parseLooseNumber(defaults.defaultMargin);

                if (!formState.name.trim()) {
                    alert('Nazwa strefy jest wymagana.');
                    return;
                }
                if (!formState.productId) {
                    alert('Wybierz produkt ROCKWOOL.');
                    return;
                }
                if (!Number.isFinite(areaValue) || areaValue <= 0) {
                    alert('Podaj poprawną powierzchnię w m².');
                    return;
                }

                const sanitizedWaste = Number.isFinite(wasteValue)
                    ? wasteValue
                    : (Number.isFinite(defaultWasteNumber) ? defaultWasteNumber : 0);
                const sanitizedMargin = Number.isFinite(marginValue)
                    ? marginValue
                    : (Number.isFinite(defaultMarginNumber) ? defaultMarginNumber : 0);

                const pickDiscount = (value, primary, secondary) => {
                    if (Number.isFinite(value)) return value;
                    if (Number.isFinite(primary)) return primary;
                    if (Number.isFinite(secondary)) return secondary;
                    return 0;
                };
                const d1 = pickDiscount(
                    parseLooseNumber(formState.discount1),
                    parseLooseNumber(defaults.discounts?.discount1),
                    parseLooseNumber(defaults.defaultDiscounts?.discount1)
                );
                const d2 = pickDiscount(
                    parseLooseNumber(formState.discount2),
                    parseLooseNumber(defaults.discounts?.discount2),
                    parseLooseNumber(defaults.defaultDiscounts?.discount2)
                );
                const d3 = pickDiscount(
                    parseLooseNumber(formState.discount3),
                    parseLooseNumber(defaults.discounts?.discount3),
                    parseLooseNumber(defaults.defaultDiscounts?.discount3)
                );
                const d4 = pickDiscount(
                    parseLooseNumber(formState.discount4),
                    parseLooseNumber(defaults.discounts?.discount4),
                    parseLooseNumber(defaults.defaultDiscounts?.discount4)
                );

                const sanitized = {
                    id: plan?.id || `rw_plan_${Date.now()}`,
                    name: formState.name.trim(),
                    productId: formState.productId,
                    area: roundToPrecision(areaValue, 3),
                    wastePercent: roundToPrecision(sanitizedWaste, 3),
                    margin: roundToPrecision(sanitizedMargin, 3),
                    discount1: roundToPrecision(d1, 3),
                    discount2: roundToPrecision(d2, 3),
                    discount3: roundToPrecision(d3, 3),
                    discount4: roundToPrecision(d4, 3),
                    extraNote: (formState.extraNote || '').trim(),
                };

                onSave(sanitized);
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <FormGroup label="Nazwa strefy">
                            <Input name="name" value={formState.name} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Produkt ROCKWOOL">
                            <Select name="productId" value={formState.productId} onChange={handleChange} required>
                                <option value="">Wybierz...</option>
                                {products.map((product) => (
                                    <option key={product.id} value={product.id}>{product.name}</option>
                                ))}
                            </Select>
                        </FormGroup>
                        <FormGroup label="Powierzchnia (m²)">
                            <Input name="area" type="number" step="0.1" value={formState.area} onChange={handleChange} required />
                        </FormGroup>
                        <FormGroup label="Odpady (%)">
                            <Input name="wastePercent" type="number" step="0.1" value={formState.wastePercent} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Marża (%)">
                            <Input name="margin" type="number" step="0.1" value={formState.margin} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 1 (%)">
                            <Input name="discount1" type="number" step="0.1" value={formState.discount1} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 2 (%)">
                            <Input name="discount2" type="number" step="0.1" value={formState.discount2} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 3 (%)">
                            <Input name="discount3" type="number" step="0.1" value={formState.discount3} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Rabat 4 (%)">
                            <Input name="discount4" type="number" step="0.1" value={formState.discount4} onChange={handleChange} />
                        </FormGroup>
                        <FormGroup label="Notatka">
                            <Input name="extraNote" value={formState.extraNote} onChange={handleChange} />
                        </FormGroup>
                    </div>
                    <div className="flex justify-end gap-3">
                        <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-100 text-slate-700 rounded-md hover:bg-slate-200">Anuluj</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">{plan ? 'Zapisz zmiany' : 'Dodaj strefę'}</button>
                    </div>
                </form>
            );
        };


        const KnaufCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('knauf_data', INITIAL_KNAUF_DATA);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);
            const mergeKnaufProducts = useCallback((initialList, currentList) => {
                const map = new Map();
                (Array.isArray(currentList) ? currentList : []).forEach((item) => map.set(item.id, item));
                (Array.isArray(initialList) ? initialList : []).forEach((item) => {
                    if (!map.has(item.id)) {
                        map.set(item.id, item);
                    }
                });
                return Array.from(map.values());
            }, []);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const dataContent = useMemo(() => {
                const content = data?.content || {};
                return {
                    priceListVersion: content.priceListVersion || '',
                    priceListDate: content.priceListDate || '',
                    settings: {
                        ...INITIAL_KNAUF_DATA.content.settings,
                        ...(content.settings || {}),
                        discounts: {
                            ...(INITIAL_KNAUF_DATA.content.settings.discounts || {}),
                            ...(content.settings?.discounts || {}),
                        },
                        defaultDiscounts: {
                            ...(INITIAL_KNAUF_DATA.content.settings.defaultDiscounts || {}),
                            ...(content.settings?.defaultDiscounts || {}),
                        }
                    },
                    filters: {
                        ...INITIAL_KNAUF_DATA.content.filters,
                        ...(content.filters || {}),
                    },
                    products: mergeKnaufProducts(
                        INITIAL_KNAUF_DATA.content.products,
                        Array.isArray(content.products) ? content.products : INITIAL_KNAUF_DATA.content.products
                    ),
                    plans: Array.isArray(content.plans) ? content.plans : [],
                };
            }, [data, mergeKnaufProducts]);

            const handleSettingChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: { ...dataContent.settings, [key]: parsed },
                    }
                });
            };

            const handleDefaultDiscountChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0, max: 100 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            defaultDiscounts: {
                                ...dataContent.settings.defaultDiscounts,
                                [key]: parsed,
                            }
                        }
                    }
                });
            };

            const handleDiscountChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0, max: 100 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            discounts: {
                                ...(dataContent.settings.discounts || {}),
                                [key]: parsed,
                            }
                        }
                    }
                });
            };

            const handleMetaChange = (key, value) => {
                setData({
                    content: {
                        ...dataContent,
                        [key]: value,
                    }
                });
            };

            const handleFilterChange = (key, value) => {
                setData({
                    content: {
                        ...dataContent,
                        filters: { ...dataContent.filters, [key]: value },
                    }
                });
            };

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const calculatePlan = useCallback((plan) => {
                const product = dataContent.products.find((p) => p.id === plan.productId);
                const areaValue = parseLooseNumber(plan.area);
                const safeArea = Number.isFinite(areaValue) && areaValue > 0 ? areaValue : 0;

                const fallbackWaste = parseLooseNumber(dataContent.settings.defaultWaste);
                const wasteValueRaw = parseLooseNumber(plan.wastePercent);
                const wasteValue = Number.isFinite(wasteValueRaw)
                    ? wasteValueRaw
                    : (Number.isFinite(fallbackWaste) ? fallbackWaste : 0);

                const fallbackMargin = parseLooseNumber(dataContent.settings.defaultMargin);
                const marginValueRaw = parseLooseNumber(plan.margin);
                const marginValue = Number.isFinite(marginValueRaw)
                    ? marginValueRaw
                    : (Number.isFinite(fallbackMargin) ? fallbackMargin : 0);

                const vatRaw = parseLooseNumber(dataContent.settings.vatRate);
                const vatValue = Number.isFinite(vatRaw) ? vatRaw : 23;

                const coverageValue = product ? parseLooseNumber(product.coveragePerPack) : Number.NaN;
                const priceValue = product ? parseLooseNumber(product.pricePerPack) : Number.NaN;
                const thicknessValue = product ? parseLooseNumber(product.thicknessCm) : Number.NaN;
                const lambdaValue = product ? parseLooseNumber(product.lambda) : Number.NaN;

                const discounts = [
                    parseLooseNumber(plan.discount1),
                    parseLooseNumber(plan.discount2),
                    parseLooseNumber(plan.discount3),
                    parseLooseNumber(plan.discount4),
                ].map((value, index) => {
                    if (Number.isFinite(value)) return value;
                    const fallback = parseLooseNumber(dataContent.settings.defaultDiscounts?.[`discount${index + 1}`]);
                    return Number.isFinite(fallback) ? fallback : 0;
                });

                const discountFactor = discounts.reduce((acc, current) => acc * (1 - percentToDecimal(current)), 1);

                const requiredArea = safeArea * (1 + percentToDecimal(wasteValue));
                const packagesNeeded = Number.isFinite(coverageValue) && coverageValue > 0
                    ? requiredArea / coverageValue
                    : 0;
                const packagesCount = packagesNeeded > 0 ? Math.ceil(packagesNeeded) : 0;
                const basePricePerPack = Number.isFinite(priceValue) ? priceValue : 0;
                const discountedPricePerPack = basePricePerPack * discountFactor;
                const purchaseNet = discountedPricePerPack * packagesCount;
                const saleNet = purchaseNet * (1 + percentToDecimal(marginValue));
                const saleGross = saleNet * (1 + percentToDecimal(vatValue));
                const netPerM2 = safeArea > 0 ? saleNet / safeArea : 0;
                const grossPerM2 = safeArea > 0 ? saleGross / safeArea : 0;
                const volumeM3 = Number.isFinite(thicknessValue)
                    ? roundToPrecision((safeArea * thicknessValue) / 100, 4)
                    : '';

                return {
                    product,
                    area: safeArea,
                    requiredArea: roundToPrecision(requiredArea, 4),
                    packagesCount,
                    purchaseNet: roundToPrecision(purchaseNet, 2),
                    saleNet: roundToPrecision(saleNet, 2),
                    saleGross: roundToPrecision(saleGross, 2),
                    netPerM2: roundToPrecision(netPerM2, 2),
                    grossPerM2: roundToPrecision(grossPerM2, 2),
                    thickness: Number.isFinite(thicknessValue) ? roundToPrecision(thicknessValue, 3) : '',
                    lambda: Number.isFinite(lambdaValue) ? roundToPrecision(lambdaValue, 4) : '',
                    wastePercent: ensurePercentScale(wasteValue),
                    marginPercent: ensurePercentScale(marginValue),
                    vatPercent: ensurePercentScale(vatValue),
                    discountsPercent: discounts.map((d) => ensurePercentScale(d)),
                    discountFactor: roundToPrecision(discountFactor, 6),
                    volumeM3,
                };
            }, [dataContent]);

            const calculatedPlans = useMemo(() => dataContent.plans.map((plan) => ({
                ...plan,
                ...calculatePlan(plan),
            })), [dataContent.plans, calculatePlan]);

            const filteredPlans = useMemo(() => {
                const term = (dataContent.filters.planSearch || '').toLowerCase();
                if (!term) {
                    return calculatedPlans;
                }
                return calculatedPlans.filter((plan) => (
                    plan.name.toLowerCase().includes(term)
                    || (plan.extraNote || '').toLowerCase().includes(term)
                    || (plan.product?.name || '').toLowerCase().includes(term)
                ));
            }, [calculatedPlans, dataContent.filters.planSearch]);

            const filteredProducts = useMemo(() => {
                const term = (dataContent.filters.productSearch || '').toLowerCase();
                if (!term) {
                    return dataContent.products;
                }
                return dataContent.products.filter((product) => (
                    product.name.toLowerCase().includes(term)
                    || (product.note || '').toLowerCase().includes(term)
                ));
            }, [dataContent.products, dataContent.filters.productSearch]);

            const calculatedProducts = useMemo(() => {
                const discounts = [1, 2, 3, 4].map((idx) => {
                    const raw = parseLooseNumber(dataContent.settings.discounts?.[`discount${idx}`]);
                    if (Number.isFinite(raw)) {
                        return raw;
                    }
                    const fallback = parseLooseNumber(dataContent.settings.defaultDiscounts?.[`discount${idx}`]);
                    return Number.isFinite(fallback) ? fallback : 0;
                });
                const discountFactor = discounts.reduce(
                    (acc, current) => acc * (1 - percentToDecimal(current)),
                    1
                );
                const marginValue = parseLooseNumber(dataContent.settings.defaultMargin);
                const marginFactor = 1 + percentToDecimal(Number.isFinite(marginValue) ? marginValue : 0);
                const vatValue = parseLooseNumber(dataContent.settings.vatRate);
                const vatFactor = 1 + percentToDecimal(Number.isFinite(vatValue) ? vatValue : 23);

                return filteredProducts.map((product) => {
                    const basePrice = parseLooseNumber(product.pricePerPack);
                    const netAfterDiscountRaw = Number.isFinite(basePrice) ? basePrice * discountFactor : 0;
                    const netAfterDiscount = roundToPrecision(netAfterDiscountRaw, 2);
                    const saleGross = roundToPrecision(
                        (Number.isFinite(basePrice) ? basePrice * marginFactor : 0) * vatFactor,
                        2
                    );
                    const coverage = parseLooseNumber(product.coveragePerPack);
                    const grossPerPack = roundToPrecision(saleGross, 2);
                    const grossPerM2 = Number.isFinite(coverage) && coverage > 0
                        ? roundToPrecision(grossPerPack / coverage, 2)
                        : '';

                    return {
                        ...product,
                        netAfterDiscount,
                        grossPerPack,
                        grossPerM2,
                    };
                });
            }, [filteredProducts, dataContent.settings]);

            const handleSaveProduct = (productData) => {
                const exists = dataContent.products.some((product) => product.id === productData.id);
                const nextProducts = exists
                    ? dataContent.products.map((product) => product.id === productData.id ? productData : product)
                    : [...dataContent.products, productData];
                setData({
                    content: {
                        ...dataContent,
                        products: nextProducts,
                    }
                });
                closeProductModal();
            };

            const handleDeleteProduct = (productId) => {
                if (!confirm('Czy na pewno chcesz usunąć produkt KNAUF?')) {
                    return;
                }
                const nextProducts = dataContent.products.filter((product) => product.id !== productId);
                const nextPlans = dataContent.plans.map((plan) => plan.productId === productId
                    ? { ...plan, productId: '' }
                    : plan);
                setData({
                    content: {
                        ...dataContent,
                        products: nextProducts,
                        plans: nextPlans,
                    }
                });
            };

            const handleImportClick = () => {
                fileInputRef.current?.click();
            };

            const handleFileImport = async (event) => {
                const input = event.target;
                const file = input.files?.[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (rows.length < 2) {
                        alert('Plik jest pusty lub nie zawiera nagłówków.');
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const colIndices = {
                        id: findNormalizedHeaderIndex(headers, ['id', 'kod', 'symbol']),
                        name: findNormalizedHeaderIndex(headers, ['nazwa', 'produkt', 'nazwa produktu']),
                        lambda: findNormalizedHeaderIndex(headers, ['lambda', 'λ']),
                        thickness: findNormalizedHeaderIndex(headers, ['grubosc', 'grubość (cm)', 'grubosccm', 'thickness']),
                        coverage: findNormalizedHeaderIndex(headers, ['m2 w paczce', 'm² w paczce', 'powierzchnia w paczce', 'coverage']),
                        price: findNormalizedHeaderIndex(headers, ['cena paczki netto', 'cena netto', 'cena']),
                        note: findNormalizedHeaderIndex(headers, ['notatka', 'uwagi']),
                    };

                    const missingColumns = [];
                    if (colIndices.name < 0) missingColumns.push('Nazwa/Produkt');
                    if (colIndices.price < 0) missingColumns.push('Cena paczki netto');
                    if (missingColumns.length) {
                        alert(`Brak wymaganych kolumn w pliku: ${missingColumns.join(', ')}`);
                        return;
                    }

                    const importedProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every((cell) => cell === null || cell === '')) {
                            continue;
                        }

                        const name = colIndices.name >= 0 ? row[colIndices.name] : null;
                        if (!name || String(name).trim() === '') {
                            continue;
                        }

                        const lambdaValue = colIndices.lambda >= 0 ? parseLooseNumber(row[colIndices.lambda]) : null;
                        const thicknessValue = colIndices.thickness >= 0 ? parseLooseNumber(row[colIndices.thickness]) : null;
                        const coverageValue = colIndices.coverage >= 0 ? parseLooseNumber(row[colIndices.coverage]) : null;
                        const priceValue = colIndices.price >= 0 ? parseLooseNumber(row[colIndices.price]) : null;

                        importedProducts.push({
                            id: colIndices.id >= 0 && row[colIndices.id] != null && String(row[colIndices.id]).trim() !== ''
                                ? String(row[colIndices.id])
                                : `kn_imported_${Date.now()}_${i}`,
                            name: String(name),
                            lambda: Number.isFinite(lambdaValue) ? lambdaValue : '',
                            thicknessCm: Number.isFinite(thicknessValue) ? thicknessValue : '',
                            coveragePerPack: Number.isFinite(coverageValue) ? coverageValue : 0,
                            pricePerPack: Number.isFinite(priceValue) ? priceValue : 0,
                            note: colIndices.note >= 0 && row[colIndices.note] != null ? String(row[colIndices.note]) : '',
                        });
                    }

                    if (importedProducts.length === 0) {
                        alert('Nie znaleziono żadnych prawidłowych produktów do zaimportowania.');
                        return;
                    }

                    setData({
                        content: {
                            ...dataContent,
                            products: importedProducts,
                        }
                    });
                    alert(`Import zakończony sukcesem! Zaimportowano ${importedProducts.length} produktów.`);
                } catch (error) {
                    console.error('Błąd podczas importu pliku KNAUF:', error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };

            const handleExportClick = () => {
                exportKnaufToExcel(dataContent.products, {
                    priceListVersion: dataContent.priceListVersion,
                    priceListDate: dataContent.priceListDate,
                });
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">KNAUF</h1>
                            <p className="text-slate-500">Planer wełny skalnej z własnymi produktami i strefami roboczymi.</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end w-full sm:w-auto">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={(event) => handleMetaChange('priceListDate', event.target.value)}
                            />
                            <FormGroup label="Wersja cennika">
                                <Input
                                    type="text"
                                    value={dataContent.priceListVersion}
                                    onChange={(event) => handleMetaChange('priceListVersion', event.target.value)}
                                    placeholder="np. 01/2025"
                                />
                            </FormGroup>
                            <div className="flex flex-wrap gap-2 justify-end">
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".xlsx, .xls"
                                    className="hidden"
                                    onChange={handleFileImport}
                                />
                                <button onClick={handleImportClick} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors">
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button onClick={handleExportClick} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors">
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader>
                            <CardTitle>Parametry bazowe</CardTitle>
                            <CardDescription>Domyślne wartości dla nowych stref i raportów KNAUF.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="grid grid-cols-1 gap-4">
                                <FormGroup label="Marża">
                                    <Input
                                        type="number"
                                        step="0.1"
                                        value={dataContent.settings.defaultMargin}
                                        onChange={(event) => handleSettingChange('defaultMargin', event.target.value)}
                                    />
                                </FormGroup>
                                <div className="space-y-2">
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        {[1, 2, 3, 4].map((idx) => (
                                            <FormGroup key={`r-${idx}`} label={`Rabat ${idx} (%)`}>
                                                <Input
                                                    type="number"
                                                    step="0.1"
                                                    value={dataContent.settings.discounts?.[`discount${idx}`] || ''}
                                                    onChange={(event) => handleDiscountChange(`discount${idx}`, event.target.value)}
                                                />
                                            </FormGroup>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        {[1, 2, 3, 4].map((idx) => (
                                            <FormGroup key={`dr-${idx}`} label={`Domyślny Rabat ${idx} (%)`} variant="default-discount">
                                                <Input
                                                    type="number"
                                                    step="0.1"
                                                    value={dataContent.settings.defaultDiscounts[`discount${idx}`]}
                                                    onChange={(event) => handleDefaultDiscountChange(`discount${idx}`, event.target.value)}
                                                />
                                            </FormGroup>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>Katalog KNAUF</CardTitle>
                                <CardDescription>Twoje paczki, ceny i lambdy do wykorzystania w scenariuszach.</CardDescription>
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj w katalogu..." value={dataContent.filters.productSearch} onChange={(event) => handleFilterChange('productSearch', event.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                        <tr>
                                            {[
                                                { key: 'name', label: 'Produkt', className: 'w-full' },
                                                { key: 'lambda', label: 'Lambda', className: 'text-right' },
                                                { key: 'thickness', label: 'Grubość (cm)', className: 'text-right' },
                                                { key: 'coverage', label: 'm² w paczce', className: 'text-right' },
                                                { key: 'price', label: 'Zakup netto', className: 'text-right' },
                                                { key: 'netAfterDiscount', label: 'Netto po rabacie', className: 'text-right' },
                                                { key: 'grossPerM2', label: 'Brutto Klient m²', className: 'text-right' },
                                                { key: 'grossPerPack', label: 'Brutto klient opakowanie', className: 'text-right' },
                                                { key: 'note', label: 'Notatka', className: 'min-w-[140px]' },
                                                { key: 'actions', label: 'Akcje', className: 'text-right' },
                                            ].map(({ key, label, className }) => (
                                                <th key={key} scope="col" className={`px-3 py-3 ${className || ''}`}>{label}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {calculatedProducts.length === 0 && (
                                            <tr>
                                                <td colSpan="10" className="px-3 py-4 text-center text-slate-500">Brak produktów KNAUF w katalogu.</td>
                                            </tr>
                                        )}
                                        {calculatedProducts.map((product) => (
                                            <tr key={product.id} className="bg-white border-b hover:bg-slate-50">
                                                <td className="px-3 py-2 font-semibold text-slate-800 align-top">{product.name}</td>
                                                <td className="px-3 py-2 text-right align-top">{product.lambda}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatNumberForInput(product.thicknessCm, 2)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatNumberForInput(product.coveragePerPack, 2)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.pricePerPack)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.netAfterDiscount)}</td>
                                                <td className="px-3 py-2 text-right align-top">
                                                    {product.grossPerM2 === '' ? '—' : formatCurrency(product.grossPerM2)}
                                                </td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.grossPerPack)}</td>
                                                <td className="px-3 py-2 align-top text-slate-600">{product.note || '—'}</td>
                                                <td className="px-3 py-2 text-right align-top">
                                                    <div className="flex items-center justify-end gap-2">
                                                        <button onClick={() => openProductModal(product)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                        <button onClick={() => handleDeleteProduct(product.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>

                    <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj produkt KNAUF' : 'Dodaj produkt KNAUF'}>
                        <KnaufProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };

        

        const RockwoolCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('rockwool_data', INITIAL_ROCKWOOL_DATA);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const dataContent = useMemo(() => {
                const content = data?.content || {};
                return {
                    priceListVersion: content.priceListVersion || '',
                    priceListDate: content.priceListDate || '',
                    settings: {
                        ...INITIAL_ROCKWOOL_DATA.content.settings,
                        ...(content.settings || {}),
                        discounts: {
                            ...(INITIAL_ROCKWOOL_DATA.content.settings.discounts || {}),
                            ...(content.settings?.discounts || {}),
                        },
                        defaultDiscounts: {
                            ...(INITIAL_ROCKWOOL_DATA.content.settings.defaultDiscounts || {}),
                            ...(content.settings?.defaultDiscounts || {}),
                        }
                    },
                    filters: {
                        ...INITIAL_ROCKWOOL_DATA.content.filters,
                        ...(content.filters || {}),
                    },
                    products: Array.isArray(content.products) ? content.products : INITIAL_ROCKWOOL_DATA.content.products,
                    plans: Array.isArray(content.plans) ? content.plans : [],
                };
            }, [data]);

            const handleSettingChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: { ...dataContent.settings, [key]: parsed },
                    }
                });
            };

            const handleDefaultDiscountChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0, max: 100 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            defaultDiscounts: {
                                ...dataContent.settings.defaultDiscounts,
                                [key]: parsed,
                            }
                        }
                    }
                });
            };

            const handleDiscountChange = (key, rawValue) => {
                const parsed = parseNumericInput(rawValue, { min: 0, max: 100 });
                if (parsed === null) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            discounts: {
                                ...(dataContent.settings.discounts || {}),
                                [key]: parsed,
                            }
                        }
                    }
                });
            };

            const handleMetaChange = (key, value) => {
                setData({
                    content: {
                        ...dataContent,
                        [key]: value,
                    }
                });
            };

            const handleFilterChange = (key, value) => {
                setData({
                    content: {
                        ...dataContent,
                        filters: { ...dataContent.filters, [key]: value },
                    }
                });
            };

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const calculatePlan = useCallback((plan) => {
                const product = dataContent.products.find((p) => p.id === plan.productId);
                const areaValue = parseLooseNumber(plan.area);
                const safeArea = Number.isFinite(areaValue) && areaValue > 0 ? areaValue : 0;

                const fallbackWaste = parseLooseNumber(dataContent.settings.defaultWaste);
                const wasteValueRaw = parseLooseNumber(plan.wastePercent);
                const wasteValue = Number.isFinite(wasteValueRaw)
                    ? wasteValueRaw
                    : (Number.isFinite(fallbackWaste) ? fallbackWaste : 0);

                const fallbackMargin = parseLooseNumber(dataContent.settings.defaultMargin);
                const marginValueRaw = parseLooseNumber(plan.margin);
                const marginValue = Number.isFinite(marginValueRaw)
                    ? marginValueRaw
                    : (Number.isFinite(fallbackMargin) ? fallbackMargin : 0);

                const vatRaw = parseLooseNumber(dataContent.settings.vatRate);
                const vatValue = Number.isFinite(vatRaw) ? vatRaw : 23;

                const coverageValue = product ? parseLooseNumber(product.coveragePerPack) : Number.NaN;
                const priceValue = product ? parseLooseNumber(product.pricePerPack) : Number.NaN;
                const thicknessValue = product ? parseLooseNumber(product.thicknessCm) : Number.NaN;
                const lambdaValue = product ? parseLooseNumber(product.lambda) : Number.NaN;

                const discounts = [
                    parseLooseNumber(plan.discount1),
                    parseLooseNumber(plan.discount2),
                    parseLooseNumber(plan.discount3),
                    parseLooseNumber(plan.discount4),
                ].map((value, index) => {
                    if (Number.isFinite(value)) return value;
                    const fallback = parseLooseNumber(dataContent.settings.defaultDiscounts?.[`discount${index + 1}`]);
                    return Number.isFinite(fallback) ? fallback : 0;
                });

                const discountFactor = discounts.reduce((acc, current) => acc * (1 - percentToDecimal(current)), 1);

                const requiredArea = safeArea * (1 + percentToDecimal(wasteValue));
                const packagesNeeded = Number.isFinite(coverageValue) && coverageValue > 0
                    ? requiredArea / coverageValue
                    : 0;
                const packagesCount = packagesNeeded > 0 ? Math.ceil(packagesNeeded) : 0;
                const basePricePerPack = Number.isFinite(priceValue) ? priceValue : 0;
                const discountedPricePerPack = basePricePerPack * discountFactor;
                const purchaseNet = discountedPricePerPack * packagesCount;
                const saleNet = purchaseNet * (1 + percentToDecimal(marginValue));
                const saleGross = saleNet * (1 + percentToDecimal(vatValue));
                const netPerM2 = safeArea > 0 ? saleNet / safeArea : 0;
                const grossPerM2 = safeArea > 0 ? saleGross / safeArea : 0;
                const volumeM3 = Number.isFinite(thicknessValue)
                    ? roundToPrecision((safeArea * thicknessValue) / 100, 4)
                    : '';

                return {
                    product,
                    area: safeArea,
                    requiredArea: roundToPrecision(requiredArea, 4),
                    packagesCount,
                    purchaseNet: roundToPrecision(purchaseNet, 2),
                    saleNet: roundToPrecision(saleNet, 2),
                    saleGross: roundToPrecision(saleGross, 2),
                    netPerM2: roundToPrecision(netPerM2, 2),
                    grossPerM2: roundToPrecision(grossPerM2, 2),
                    thickness: Number.isFinite(thicknessValue) ? roundToPrecision(thicknessValue, 3) : '',
                    lambda: Number.isFinite(lambdaValue) ? roundToPrecision(lambdaValue, 4) : '',
                    wastePercent: ensurePercentScale(wasteValue),
                    marginPercent: ensurePercentScale(marginValue),
                    vatPercent: ensurePercentScale(vatValue),
                    discountsPercent: discounts.map((d) => ensurePercentScale(d)),
                    discountFactor: roundToPrecision(discountFactor, 6),
                    volumeM3,
                };
            }, [dataContent]);

            const calculatedPlans = useMemo(() => dataContent.plans.map((plan) => ({
                ...plan,
                ...calculatePlan(plan),
            })), [dataContent.plans, calculatePlan]);

            const filteredPlans = useMemo(() => {
                const term = (dataContent.filters.planSearch || '').toLowerCase();
                if (!term) {
                    return calculatedPlans;
                }
                return calculatedPlans.filter((plan) => (
                    plan.name.toLowerCase().includes(term)
                    || (plan.extraNote || '').toLowerCase().includes(term)
                    || (plan.product?.name || '').toLowerCase().includes(term)
                ));
            }, [calculatedPlans, dataContent.filters.planSearch]);

            const filteredProducts = useMemo(() => {
                const term = (dataContent.filters.productSearch || '').toLowerCase();
                if (!term) {
                    return dataContent.products;
                }
                return dataContent.products.filter((product) => (
                    product.name.toLowerCase().includes(term)
                    || (product.note || '').toLowerCase().includes(term)
                ));
            }, [dataContent.products, dataContent.filters.productSearch]);

            const calculatedProducts = useMemo(() => {
                const discounts = [1, 2, 3, 4].map((idx) => {
                    const raw = parseLooseNumber(dataContent.settings.discounts?.[`discount${idx}`]);
                    if (Number.isFinite(raw)) {
                        return raw;
                    }
                    const fallback = parseLooseNumber(dataContent.settings.defaultDiscounts?.[`discount${idx}`]);
                    return Number.isFinite(fallback) ? fallback : 0;
                });
                const discountFactor = discounts.reduce(
                    (acc, current) => acc * (1 - percentToDecimal(current)),
                    1
                );
                const marginValue = parseLooseNumber(dataContent.settings.defaultMargin);
                const marginFactor = 1 + percentToDecimal(Number.isFinite(marginValue) ? marginValue : 0);
                const vatValue = parseLooseNumber(dataContent.settings.vatRate);
                const vatFactor = 1 + percentToDecimal(Number.isFinite(vatValue) ? vatValue : 23);

                return filteredProducts.map((product) => {
                    const basePrice = parseLooseNumber(product.pricePerPack);
                    const netAfterDiscountRaw = Number.isFinite(basePrice) ? basePrice * discountFactor : 0;
                    const netAfterDiscount = roundToPrecision(netAfterDiscountRaw, 2);
                    const saleGross = roundToPrecision(
                        (Number.isFinite(basePrice) ? basePrice * marginFactor : 0) * vatFactor,
                        2
                    );
                    const coverage = parseLooseNumber(product.coveragePerPack);
                    const grossPerPack = roundToPrecision(saleGross, 2);
                    const grossPerM2 = Number.isFinite(coverage) && coverage > 0
                        ? roundToPrecision(grossPerPack / coverage, 2)
                        : '';

                    return {
                        ...product,
                        netAfterDiscount,
                        grossPerPack,
                        grossPerM2,
                    };
                });
            }, [filteredProducts, dataContent.settings]);

            const handleSaveProduct = (productData) => {
                const exists = dataContent.products.some((product) => product.id === productData.id);
                const nextProducts = exists
                    ? dataContent.products.map((product) => product.id === productData.id ? productData : product)
                    : [...dataContent.products, productData];
                setData({
                    content: {
                        ...dataContent,
                        products: nextProducts,
                    }
                });
                closeProductModal();
            };

            const handleDeleteProduct = (productId) => {
                if (!confirm('Czy na pewno chcesz usunąć produkt ROCKWOOL?')) {
                    return;
                }
                const nextProducts = dataContent.products.filter((product) => product.id !== productId);
                const nextPlans = dataContent.plans.map((plan) => plan.productId === productId
                    ? { ...plan, productId: '' }
                    : plan);
                setData({
                    content: {
                        ...dataContent,
                        products: nextProducts,
                        plans: nextPlans,
                    }
                });
            };

            const handleImportClick = () => {
                fileInputRef.current?.click();
            };

            const handleFileImport = async (event) => {
                const input = event.target;
                const file = input.files?.[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (rows.length < 2) {
                        alert('Plik jest pusty lub nie zawiera nagłówków.');
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const colIndices = {
                        id: findNormalizedHeaderIndex(headers, ['id', 'kod', 'symbol']),
                        name: findNormalizedHeaderIndex(headers, ['nazwa', 'produkt', 'nazwa produktu']),
                        lambda: findNormalizedHeaderIndex(headers, ['lambda', 'λ']),
                        thickness: findNormalizedHeaderIndex(headers, ['grubosc', 'grubość (cm)', 'grubosccm', 'thickness']),
                        coverage: findNormalizedHeaderIndex(headers, ['m2 w paczce', 'm² w paczce', 'powierzchnia w paczce', 'coverage']),
                        price: findNormalizedHeaderIndex(headers, ['cena paczki netto', 'cena netto', 'cena']),
                        note: findNormalizedHeaderIndex(headers, ['notatka', 'uwagi']),
                    };

                    const missingColumns = [];
                    if (colIndices.name < 0) missingColumns.push('Nazwa/Produkt');
                    if (colIndices.price < 0) missingColumns.push('Cena paczki netto');
                    if (missingColumns.length) {
                        alert(`Brak wymaganych kolumn w pliku: ${missingColumns.join(', ')}`);
                        return;
                    }

                    const importedProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every((cell) => cell === null || cell === '')) {
                            continue;
                        }

                        const name = colIndices.name >= 0 ? row[colIndices.name] : null;
                        if (!name || String(name).trim() === '') {
                            continue;
                        }

                        const lambdaValue = colIndices.lambda >= 0 ? parseLooseNumber(row[colIndices.lambda]) : null;
                        const thicknessValue = colIndices.thickness >= 0 ? parseLooseNumber(row[colIndices.thickness]) : null;
                        const coverageValue = colIndices.coverage >= 0 ? parseLooseNumber(row[colIndices.coverage]) : null;
                        const priceValue = colIndices.price >= 0 ? parseLooseNumber(row[colIndices.price]) : null;

                        importedProducts.push({
                            id: colIndices.id >= 0 && row[colIndices.id] != null && String(row[colIndices.id]).trim() !== ''
                                ? String(row[colIndices.id])
                                : `rw_imported_${Date.now()}_${i}`,
                            name: String(name),
                            lambda: Number.isFinite(lambdaValue) ? lambdaValue : '',
                            thicknessCm: Number.isFinite(thicknessValue) ? thicknessValue : '',
                            coveragePerPack: Number.isFinite(coverageValue) ? coverageValue : 0,
                            pricePerPack: Number.isFinite(priceValue) ? priceValue : 0,
                            note: colIndices.note >= 0 && row[colIndices.note] != null ? String(row[colIndices.note]) : '',
                        });
                    }

                    if (importedProducts.length === 0) {
                        alert('Nie znaleziono żadnych prawidłowych produktów do zaimportowania.');
                        return;
                    }

                    setData({
                        content: {
                            ...dataContent,
                            products: importedProducts,
                        }
                    });
                    alert(`Import zakończony sukcesem! Zaimportowano ${importedProducts.length} produktów.`);
                } catch (error) {
                    console.error('Błąd podczas importu pliku ROCKWOOL:', error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };

            const handleExportClick = () => {
                exportRockwoolToExcel(dataContent.products, {
                    priceListVersion: dataContent.priceListVersion,
                    priceListDate: dataContent.priceListDate,
                });
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">ROCKWOOL</h1>
                            <p className="text-slate-500">Planer wełny skalnej z własnymi produktami i strefami roboczymi.</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end w-full sm:w-auto">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={(event) => handleMetaChange('priceListDate', event.target.value)}
                            />
                            <FormGroup label="Wersja cennika">
                                <Input
                                    type="text"
                                    value={dataContent.priceListVersion}
                                    onChange={(event) => handleMetaChange('priceListVersion', event.target.value)}
                                    placeholder="np. 01/2025"
                                />
                            </FormGroup>
                            <div className="flex flex-wrap gap-2 justify-end">
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".xlsx, .xls"
                                    className="hidden"
                                    onChange={handleFileImport}
                                />
                                <button onClick={handleImportClick} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors">
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button onClick={handleExportClick} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-md text-sm font-medium hover:bg-slate-50 transition-colors">
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader>
                            <CardTitle>Parametry bazowe</CardTitle>
                            <CardDescription>Domyślne wartości dla nowych stref i raportów ROCKWOOL.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="grid grid-cols-1 gap-4">
                                <FormGroup label="Marża">
                                    <Input
                                        type="number"
                                        step="0.1"
                                        value={dataContent.settings.defaultMargin}
                                        onChange={(event) => handleSettingChange('defaultMargin', event.target.value)}
                                    />
                                </FormGroup>
                                <div className="space-y-2">
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        {[1, 2, 3, 4].map((idx) => (
                                            <FormGroup key={`r-${idx}`} label={`Rabat ${idx} (%)`}>
                                                <Input
                                                    type="number"
                                                    step="0.1"
                                                    value={dataContent.settings.discounts?.[`discount${idx}`] || ''}
                                                    onChange={(event) => handleDiscountChange(`discount${idx}`, event.target.value)}
                                                />
                                            </FormGroup>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                        {[1, 2, 3, 4].map((idx) => (
                                            <FormGroup key={`dr-${idx}`} label={`Domyślny Rabat ${idx} (%)`} variant="default-discount">
                                                <Input
                                                    type="number"
                                                    step="0.1"
                                                    value={dataContent.settings.defaultDiscounts[`discount${idx}`]}
                                                    onChange={(event) => handleDefaultDiscountChange(`discount${idx}`, event.target.value)}
                                                />
                                            </FormGroup>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>Katalog ROCKWOOL</CardTitle>
                                <CardDescription>Twoje paczki, ceny i lambdy do wykorzystania w scenariuszach.</CardDescription>
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj w katalogu..." value={dataContent.filters.productSearch} onChange={(event) => handleFilterChange('productSearch', event.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                        <tr>
                                            {[
                                                { key: 'name', label: 'Produkt', className: 'w-full' },
                                                { key: 'lambda', label: 'Lambda', className: 'text-right' },
                                                { key: 'thickness', label: 'Grubość (cm)', className: 'text-right' },
                                                { key: 'coverage', label: 'm² w paczce', className: 'text-right' },
                                                { key: 'price', label: 'Zakup netto', className: 'text-right' },
                                                { key: 'netAfterDiscount', label: 'Netto po rabacie', className: 'text-right' },
                                                { key: 'grossPerM2', label: 'Brutto Klient m²', className: 'text-right' },
                                                { key: 'grossPerPack', label: 'Brutto klient opakowanie', className: 'text-right' },
                                                { key: 'note', label: 'Notatka', className: 'min-w-[140px]' },
                                                { key: 'actions', label: 'Akcje', className: 'text-right' },
                                            ].map(({ key, label, className }) => (
                                                <th key={key} scope="col" className={`px-3 py-3 ${className || ''}`}>{label}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {calculatedProducts.length === 0 && (
                                            <tr>
                                                <td colSpan="10" className="px-3 py-4 text-center text-slate-500">Brak produktów ROCKWOOL w katalogu.</td>
                                            </tr>
                                        )}
                                        {calculatedProducts.map((product) => (
                                            <tr key={product.id} className="bg-white border-b hover:bg-slate-50">
                                                <td className="px-3 py-2 font-semibold text-slate-800 align-top">{product.name}</td>
                                                <td className="px-3 py-2 text-right align-top">{product.lambda}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatNumberForInput(product.thicknessCm, 2)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatNumberForInput(product.coveragePerPack, 2)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.pricePerPack)}</td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.netAfterDiscount)}</td>
                                                <td className="px-3 py-2 text-right align-top">
                                                    {product.grossPerM2 === '' ? '—' : formatCurrency(product.grossPerM2)}
                                                </td>
                                                <td className="px-3 py-2 text-right align-top">{formatCurrency(product.grossPerPack)}</td>
                                                <td className="px-3 py-2 align-top text-slate-600">{product.note || '—'}</td>
                                                <td className="px-3 py-2 text-right align-top">
                                                    <div className="flex items-center justify-end gap-2">
                                                        <button onClick={() => openProductModal(product)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                        <button onClick={() => handleDeleteProduct(product.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>

                    <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj produkt ROCKWOOL' : 'Dodaj produkt ROCKWOOL'}>
                        <RockwoolProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };

        const ProjectsCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('projects_data', INITIAL_PROJECTS_DATA);
            const [isProjectModalOpen, setIsProjectModalOpen] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [isContractorModalOpen, setIsContractorModalOpen] = useState(false);
            const [isInvestorModalOpen, setIsInvestorModalOpen] = useState(false);
            const [editingContractor, setEditingContractor] = useState(null);
            const [editingInvestor, setEditingInvestor] = useState(null);
            const [contractorForm, setContractorForm] = useState({ name: '', address: '', phone: '', email: '', notes: '' });
            const [investorForm, setInvestorForm] = useState({ name: '', address: '', phone: '', email: '', notes: '' });

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const dataContent = useMemo(() => {
                const content = data?.content || {};
                return {
                    projects: Array.isArray(content.projects) ? content.projects : [],
                    contractors: Array.isArray(content.contractors) ? content.contractors : [],
                    investors: Array.isArray(content.investors) ? content.investors : [],
                    filters: {
                        ...INITIAL_PROJECTS_DATA.content.filters,
                        ...(content.filters || {}),
                    },
                };
            }, [data]);

            const filteredProjects = useMemo(() => {
                const term = (dataContent.filters.search || '').toLowerCase();
                if (!term) return dataContent.projects;
                return dataContent.projects.filter((project) => (
                    [project.name, project.investor, project.contractor, project.stage, project.status]
                        .filter(Boolean)
                        .some((value) => String(value).toLowerCase().includes(term))
                ));
            }, [dataContent.filters.search, dataContent.projects]);

            const openProjectModal = (project = null) => {
                setEditingProject(project);
                setIsProjectModalOpen(true);
            };

            const closeProjectModal = () => {
                setEditingProject(null);
                setIsProjectModalOpen(false);
            };

            const handleSaveProject = (projectData) => {
                const sanitized = {
                    id: projectData.id || `project_${Date.now()}`,
                    name: projectData.name.trim(),
                    investor: (projectData.investor || '').trim(),
                    contractor: (projectData.contractor || '').trim(),
                    contact: (projectData.contact || '').trim(),
                    status: projectData.status || 'planowane',
                    stage: (projectData.stage || '').trim(),
                    owner: (projectData.owner || '').trim(),
                    startDate: projectData.startDate || '',
                    endDate: projectData.endDate || '',
                    notes: (projectData.notes || '').trim(),
                };

                const nextProjects = projectData.id
                    ? dataContent.projects.map((p) => p.id === projectData.id ? sanitized : p)
                    : [...dataContent.projects, sanitized];

                setData({
                    content: {
                        ...dataContent,
                        projects: nextProjects,
                    }
                });
                closeProjectModal();
            };

            const handleDeleteProject = (projectId) => {
                if (!confirm('Czy na pewno chcesz usunąć tę inwestycję?')) {
                    return;
                }
                setData({
                    content: {
                        ...dataContent,
                        projects: dataContent.projects.filter((p) => p.id !== projectId),
                    }
                });
            };

            const saveEntity = (type, entity, isEditing) => {
                const currentList = type === 'contractor' ? dataContent.contractors : dataContent.investors;
                const formState = type === 'contractor' ? contractorForm : investorForm;
                const sanitized = {
                    id: isEditing ? entity.id : `${type}_${Date.now()}`,
                    name: (formState.name || '').trim(),
                    address: (formState.address || '').trim(),
                    phone: (formState.phone || '').trim(),
                    email: (formState.email || '').trim(),
                    notes: (formState.notes || '').trim(),
                };
                if (!sanitized.name) {
                    alert('Nazwa jest wymagana.');
                    return;
                }
                const nextList = isEditing
                    ? currentList.map((item) => item.id === entity.id ? sanitized : item)
                    : [...currentList, sanitized];

                setData({
                    content: {
                        ...dataContent,
                        contractors: type === 'contractor' ? nextList : dataContent.contractors,
                        investors: type === 'investor' ? nextList : dataContent.investors,
                    }
                });

                if (type === 'contractor') {
                    setIsContractorModalOpen(false);
                    setEditingContractor(null);
                    setContractorForm({ name: '', address: '', phone: '', email: '', notes: '' });
                } else {
                    setIsInvestorModalOpen(false);
                    setEditingInvestor(null);
                    setInvestorForm({ name: '', address: '', phone: '', email: '', notes: '' });
                }
            };

            const deleteEntity = (type, id) => {
                if (!confirm('Usunąć wpis?')) return;
                const listKey = type === 'contractor' ? 'contractors' : 'investors';
                setData({
                    content: {
                        ...dataContent,
                        [listKey]: dataContent[listKey].filter((item) => item.id !== id),
                    }
                });
            };

            const openContractorModal = (item = null) => {
                setEditingContractor(item);
                setContractorForm({
                    name: item?.name || '',
                    address: item?.address || '',
                    phone: item?.phone || '',
                    email: item?.email || '',
                    notes: item?.notes || '',
                });
                setIsContractorModalOpen(true);
            };

            const openInvestorModal = (item = null) => {
                setEditingInvestor(item);
                setInvestorForm({
                    name: item?.name || '',
                    address: item?.address || '',
                    phone: item?.phone || '',
                    email: item?.email || '',
                    notes: item?.notes || '',
                });
                setIsInvestorModalOpen(true);
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">Budowy / Inwestycje / Wykonawcy</h1>
                            <p className="text-slate-500">Śledzenie projektów, wykonawców i statusów realizacji.</p>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input
                                    type="text"
                                    placeholder="Szukaj po nazwie, inwestorze, wykonawcy..."
                                    value={dataContent.filters.search}
                                    onChange={(event) => setData({
                                        content: { ...dataContent, filters: { search: event.target.value } }
                                    })}
                                    className="w-full sm:w-80 p-2 border border-slate-300 rounded-md text-sm"
                                />
                                <button onClick={() => openProjectModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <button onClick={() => openContractorModal()} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <SettingsIcon /> Lista Wykonawców
                                </button>
                                <button onClick={() => openInvestorModal()} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <SettingsIcon /> Lista Inwestorów
                                </button>
                            </div>
                        </div>
                    </header>

                    <Card>
                        <CardHeader>
                            <CardTitle>Lista inwestycji</CardTitle>
                            <CardDescription>Przechowuj podstawowe dane, wartości i terminy.</CardDescription>
                        </CardHeader>
                        <CardContent className="overflow-x-auto">
                            <table className="w-full text-sm text-left text-slate-600">
                                <thead className="text-xs uppercase text-slate-700 bg-slate-50">
                                    <tr>
                                        <th className="px-3 py-3">Nazwa</th>
                                        <th className="px-3 py-3">Inwestor</th>
                                        <th className="px-3 py-3">Wykonawca</th>
                                        <th className="px-3 py-3">Opiekun</th>
                                        <th className="px-3 py-3 text-center">Status</th>
                                        <th className="px-3 py-3 text-center">Terminy</th>
                                        <th className="px-3 py-3">Notatki</th>
                                        <th className="px-3 py-3 text-center">Akcje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {filteredProjects.length === 0 && (
                                        <tr>
                                            <td colSpan={8} className="px-3 py-4 text-center text-slate-500">Brak wpisów. Dodaj inwestycję.</td>
                                        </tr>
                                    )}
                                    {filteredProjects.map((project) => (
                                        <tr key={project.id} className="bg-white border-b hover:bg-slate-50">
                                            <td className="px-3 py-3 font-semibold text-slate-800">{project.name}</td>
                                            <td className="px-3 py-3">
                                                <p className="text-sm">{project.investor || '-'}</p>
                                                {project.contact && <p className="text-xs text-slate-500">{project.contact}</p>}
                                            </td>
                                            <td className="px-3 py-3">{project.contractor || '-'}</td>
                                            <td className="px-3 py-3">{project.owner || '-'}</td>
                                            <td className="px-3 py-3 text-center">
                                                <span className="px-2 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-700">{project.status || '-'}</span>
                                            </td>
                                            <td className="px-3 py-3 text-center text-xs text-slate-600">
                                                {project.startDate || project.endDate ? (
                                                    <>
                                                        <div>Start: {project.startDate || '-'}</div>
                                                        <div>Koniec: {project.endDate || '-'}</div>
                                                    </>
                                                ) : '—'}
                                            </td>
                                            <td className="px-3 py-3 text-sm text-slate-600">{project.notes || '-'}</td>
                                            <td className="px-3 py-3 text-center">
                                                <div className="flex items-center justify-center gap-2">
                                                    <button onClick={() => openProjectModal(project)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                    <button onClick={() => handleDeleteProject(project.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </CardContent>
                    </Card>

                    <Modal
                        isOpen={isProjectModalOpen}
                        onClose={closeProjectModal}
                        title={editingProject ? 'Edytuj inwestycję' : 'Dodaj inwestycję'}
                    >
                        <DocieplenieProjectForm
                            project={editingProject}
                            onSave={handleSaveProject}
                            onCancel={closeProjectModal}
                            contractors={dataContent.contractors}
                            investors={dataContent.investors}
                        />
                    </Modal>
                    <Modal
                        isOpen={isContractorModalOpen}
                        onClose={() => { setIsContractorModalOpen(false); setEditingContractor(null); setContractorForm({ name: '', address: '', phone: '', email: '', notes: '' }); }}
                        title="Lista Wykonawców"
                    >
                        <div className="space-y-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <FormGroup label="Nazwa">
                                    <Input value={contractorForm.name} onChange={(e) => setContractorForm({ ...contractorForm, name: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Adres">
                                    <Input value={contractorForm.address} onChange={(e) => setContractorForm({ ...contractorForm, address: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Telefon">
                                    <Input value={contractorForm.phone} onChange={(e) => setContractorForm({ ...contractorForm, phone: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Email">
                                    <Input value={contractorForm.email} onChange={(e) => setContractorForm({ ...contractorForm, email: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Notatki">
                                    <Input value={contractorForm.notes} onChange={(e) => setContractorForm({ ...contractorForm, notes: e.target.value })} />
                                </FormGroup>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => saveEntity('contractor', editingContractor, !!editingContractor)} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    {editingContractor ? 'Zapisz zmiany' : 'Dodaj wykonawcę'}
                                </button>
                            </div>
                            <div className="border-t pt-3">
                                {dataContent.contractors.length === 0 ? (
                                    <p className="text-sm text-slate-500">Brak wykonawców.</p>
                                ) : (
                                    <div className="space-y-2 max-h-64 overflow-y-auto pr-1">
                                        {dataContent.contractors.map((item) => (
                                            <div key={item.id} className="flex items-start justify-between gap-3 border border-slate-200 rounded-md px-3 py-2">
                                                <div className="text-sm">
                                                    <p className="font-semibold text-slate-800">{item.name}</p>
                                                    <p className="text-slate-600 text-xs">{item.address}</p>
                                                    <p className="text-slate-600 text-xs">{item.phone} {item.email && `• ${item.email}`}</p>
                                                    {item.notes && <p className="text-slate-500 text-xs">{item.notes}</p>}
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => openContractorModal(item)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                    <button onClick={() => deleteEntity('contractor', item.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </Modal>
                    <Modal
                        isOpen={isInvestorModalOpen}
                        onClose={() => { setIsInvestorModalOpen(false); setEditingInvestor(null); setInvestorForm({ name: '', address: '', phone: '', email: '', notes: '' }); }}
                        title="Lista Inwestorów"
                    >
                        <div className="space-y-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <FormGroup label="Nazwa">
                                    <Input value={investorForm.name} onChange={(e) => setInvestorForm({ ...investorForm, name: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Adres">
                                    <Input value={investorForm.address} onChange={(e) => setInvestorForm({ ...investorForm, address: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Telefon">
                                    <Input value={investorForm.phone} onChange={(e) => setInvestorForm({ ...investorForm, phone: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Email">
                                    <Input value={investorForm.email} onChange={(e) => setInvestorForm({ ...investorForm, email: e.target.value })} />
                                </FormGroup>
                                <FormGroup label="Notatki">
                                    <Input value={investorForm.notes} onChange={(e) => setInvestorForm({ ...investorForm, notes: e.target.value })} />
                                </FormGroup>
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => saveEntity('investor', editingInvestor, !!editingInvestor)} className="px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    {editingInvestor ? 'Zapisz zmiany' : 'Dodaj inwestora'}
                                </button>
                            </div>
                            <div className="border-t pt-3">
                                {dataContent.investors.length === 0 ? (
                                    <p className="text-sm text-slate-500">Brak inwestorów.</p>
                                ) : (
                                    <div className="space-y-2 max-h-64 overflow-y-auto pr-1">
                                        {dataContent.investors.map((item) => (
                                            <div key={item.id} className="flex items-start justify-between gap-3 border border-slate-200 rounded-md px-3 py-2">
                                                <div className="text-sm">
                                                    <p className="font-semibold text-slate-800">{item.name}</p>
                                                    <p className="text-slate-600 text-xs">{item.address}</p>
                                                    <p className="text-slate-600 text-xs">{item.phone} {item.email && `• ${item.email}`}</p>
                                                    {item.notes && <p className="text-slate-500 text-xs">{item.notes}</p>}
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => openInvestorModal(item)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                    <button onClick={() => deleteEntity('investor', item.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const BrukbetCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('brukbet_data', INITIAL_BRUKBET_DATA);
            const [searchTerm, setSearchTerm] = useState('');
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [isFactoryModalOpen, setIsFactoryModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);

             useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);
            
            const dataContent = useMemo(() => data.content, [data]);

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const filteredAndCalculatedProducts = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const filtered = !term
                    ? dataContent.products
                    : dataContent.products.filter(p => 
                        (p.nazwa && p.nazwa.toLowerCase().includes(term)) ||
                        (p.symbol && p.symbol.toLowerCase().includes(term)) ||
                        (p.grupa && p.grupa.toLowerCase().includes(term)) ||
                        (p.zp && p.zp.toLowerCase().includes(term))
                      );
                
                return filtered.map(p => calculateBrukbetProduct(p, dataContent.settings));
            }, [dataContent.products, dataContent.settings, searchTerm]);

            const handleFactoryChange = (e) => {
                const factoryId = e.target.value;
                const factory = dataContent.settings.factories.find(f => f.id === factoryId);
                if (factory) setData({ content: { ...dataContent, settings: { ...dataContent.settings, factory: factoryId, transportRate: factory.kosztTransportu } }});
            };
            
            const handleSettingChange = (key, value) => {
                const isPercentage = key === 'margin';
                const parsedValue = isPercentage
                    ? normalizePercentInputValue(value)
                    : parseNumericInput(value, { min: 0 });

                if (parsedValue === null) {
                    return;
                }

                setData({ content: { ...dataContent, settings: { ...dataContent.settings, [key]: parsedValue } } });
            };

            const handleDiscountChange = (group, value) => {
                const parsedValue = normalizePercentInputValue(value);
                if (parsedValue === null) {
                    return;
                }
                setData({ content: { ...dataContent, settings: { ...dataContent.settings, discounts: { ...dataContent.settings.discounts, [group]: parsedValue } } } });
            };

            const handleDefaultDiscountChange = (group, value) => {
                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            defaultDiscounts: {
                                ...(dataContent.settings.defaultDiscounts || {}),
                                [group]: value
                            }
                        }
                    }
                });
            };
            
            const handleSaveFactories = (newFactories) => {
                const currentSelectedFactoryExists = newFactories.some(f => f.id === dataContent.settings.factory);
                const newSelectedFactoryId = currentSelectedFactoryExists ? dataContent.settings.factory : (newFactories[0]?.id || null);
                const newSelectedFactory = newFactories.find(f => f.id === newSelectedFactoryId);

                setData({
                    content: {
                        ...dataContent,
                        settings: {
                            ...dataContent.settings,
                            factories: newFactories,
                            factory: newSelectedFactoryId,
                            transportRate: newSelectedFactory ? newSelectedFactory.kosztTransportu : 0,
                        }
                    }
                });
            };

            const handleSaveProduct = (productData) => {
                const newProducts = productData.id 
                    ? dataContent.products.map(p => p.id === productData.id ? { ...p, ...productData } : p)
                    : [...dataContent.products, { ...productData, id: `bruk_${Date.now()}` }];
                setData({ content: { ...dataContent, products: newProducts } });
                closeProductModal();
            };
            
            const handleDeleteProduct = (productId) => {
                if(confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                     setData({
                        content: {
                            ...dataContent,
                            products: dataContent.products.filter(p => p.id !== productId)
                        }
                    });
                }
            };
            
            const handleImportClick = () => { fileInputRef.current.click(); };
            
            const handleFileImport = async (e) => {
                const input = e.target;
                const file = input.files[0];
                if (!file) return;

                try {
                    const rows = await readExcelRows(file);

                    if (rows.length < 2) {
                        alert("Plik jest pusty lub nie zawiera nagłówków.");
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const requiredHeaders = ['Symbol', 'Nazwa', 'Cena netto'];
                    if (!requiredHeaders.every((rh) => headers.includes(rh))) {
                        alert(`Brak wymaganych kolumn w pliku: ${requiredHeaders.join(', ')}`);
                        return;
                    }

                    const colIndices = {
                        symbol: headers.indexOf('Symbol'),
                        grupa: headers.indexOf('Grupa'),
                        nazwa: headers.indexOf('Nazwa'),
                        zp: headers.indexOf('ZP'),
                        waga: headers.indexOf('Waga palety (t)'),
                        maxPalletsPerTruck: headers.indexOf('Maks. palet na auto'),
                        iloscNaPalecie: headers.indexOf('Ilość na palecie'),
                        jednostka: headers.indexOf('Jednostka'),
                        cenaNetto: headers.indexOf('Cena netto'),
                    };

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) {
                            continue;
                        }

                        const symbol = colIndices.symbol >= 0 ? row[colIndices.symbol] : null;
                        const nazwa = colIndices.nazwa >= 0 ? row[colIndices.nazwa] : null;

                        if ((!symbol || String(symbol).trim() === '') && (!nazwa || String(nazwa).trim() === '')) {
                            continue;
                        }

                        const product = {
                            id: `bruk_imported_${Date.now()}_${i}`,
                            symbol: symbol != null ? String(symbol) : '',
                            grupa: colIndices.grupa >= 0 && row[colIndices.grupa] != null ? String(row[colIndices.grupa]) : 'STANDARD',
                            nazwa: nazwa != null ? String(nazwa) : '',
                            zp: colIndices.zp >= 0 && row[colIndices.zp] != null ? String(row[colIndices.zp]) : '',
                            waga: colIndices.waga >= 0 ? parseFloat(String(row[colIndices.waga]).replace(',', '.')) || 0 : 0,
                            maxPalletsPerTruck: colIndices.maxPalletsPerTruck >= 0 ? parseInt(row[colIndices.maxPalletsPerTruck], 10) || 0 : 0,
                            iloscNaPalecie: colIndices.iloscNaPalecie >= 0 ? parseInt(row[colIndices.iloscNaPalecie], 10) || 0 : 0,
                            jednostka: colIndices.jednostka >= 0 && row[colIndices.jednostka] != null ? String(row[colIndices.jednostka]) : 'szt.',
                            cenaNetto: colIndices.cenaNetto >= 0 ? parseFloat(String(row[colIndices.cenaNetto]).replace(',', '.')) || 0 : 0,
                        };
                        newProducts.push(product);
                    }

                    if (newProducts.length === 0) {
                        alert("Nie znaleziono żadnych prawidłowych produktów do zaimportowania.");
                        return;
                    }

                    setData({ content: { ...dataContent, products: newProducts } });
                    alert(`Import zakończony! Zaimportowano ${newProducts.length} produktów.`);
                } catch (error) {
                    console.error("Błąd podczas importu pliku BRUK-BET:", error);
                    alert('Wystąpił błąd podczas importu. Sprawdź format pliku i spróbuj ponownie.');
                } finally {
                    input.value = '';
                }
            };


            const stats = { totalProducts: dataContent.products.length, prestige: dataContent.products.filter(p => p.grupa === 'PRESTIGE').length, standard: dataContent.products.filter(p => p.grupa === 'STANDARD').length };
            const groupColors = { 'PRESTIGE': 'bg-amber-100 text-amber-800', 'UNI-DECOR': 'bg-sky-100 text-sky-800', 'STANDARD': 'bg-slate-100 text-slate-800', 'WYROBY UZUPEŁNIAJĄCE': 'bg-gray-100 text-gray-800' };

            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListVersion: value,
                    }
                });
            };
            
            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">BRUK-BET</h1>
                            <p className="text-slate-500">Kostka brukowa i płyty</p>
                        </div>
                        <div className="flex flex-col items-stretch gap-3 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="border-2 border-red-600 rounded-md px-3 py-2 bg-red-50 max-w-xs w-full">
                                <label className="block text-xs font-bold uppercase text-red-700 mb-1">
                                    Wersja cennika
                                </label>
                                <input
                                    type="text"
                                    value={dataContent.priceListVersion || ''}
                                    onChange={handlePriceListVersionChange}
                                    className="w-full border border-red-600 rounded-md px-2 py-1 text-sm font-semibold text-red-700 placeholder:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-300"
                                    placeholder="np. cennik 10/2025"
                                />
                            </div>
                            <div className="flex gap-2 justify-end">
                                <input
                                    type="file"
                                    ref={fileInputRef}
                                    onChange={handleFileImport}
                                    className="hidden"
                                    accept=".xlsx, .xls"
                                />
                                <button
                                    onClick={handleImportClick}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button
                                    onClick={() => exportBrukbetToExcel(filteredAndCalculatedProducts)}
                                    className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors"
                                >
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                             <CardHeader>
                                <CardTitle>Ustawienia Główne</CardTitle>
                            </CardHeader>
                            <CardContent className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                 <div className="sm:col-span-2">
                                     <label className="text-sm font-medium text-slate-600 flex items-center justify-between mb-1">
                                         <span>Zakład produkcyjny</span>
                                         <button onClick={() => setIsFactoryModalOpen(true)} className="p-1 text-slate-500 hover:text-blue-600 rounded-full hover:bg-blue-50" title="Zarządzaj zakładami">
                                             <SettingsIcon />
                                         </button>
                                     </label>
                                     <Select value={dataContent.settings.factory} onChange={handleFactoryChange} className="w-full">
                                         {dataContent.settings.factories.map(f => <option key={f.id} value={f.id}>{f.nazwa}</option>)}
                                     </Select>
                                 </div>
                                 <div>
                                     <label className="text-sm font-medium text-slate-600">Stawka transportu</label>
                                     <p className="font-semibold pt-2 mt-1 text-lg">{formatCurrency(dataContent.settings.transportRate)}</p>
                                 </div>
                                 <FormGroup label="Marża (%)">
                                    <Input type="number" step="0.01" min="0" max="100" value={dataContent.settings.margin} onChange={e => handleSettingChange('margin', e.target.value)} />
                                 </FormGroup>
                            </CardContent>
                        </Card>
                        <Card>
                            <CardHeader><CardTitle>Rabaty</CardTitle></CardHeader>
                            <CardContent className="grid grid-cols-2 gap-4">
                                {Object.entries(dataContent.settings.discounts).map(([group, discount]) => {
                                    const defaultValue = dataContent.settings.defaultDiscounts?.[group] ?? '';
                                    return (
                                        <div key={group} className="space-y-2">
                                            <FormGroup label={`${group} (%)`}>
                                                <Input
                                                    type="number"
                                                    step="0.01"
                                                    min="0"
                                                    max="100"
                                                    value={discount}
                                                    onChange={e => handleDiscountChange(group, e.target.value)}
                                                />
                                            </FormGroup>
                                            <FormGroup label={`Rabat domyślny ${group}`} variant="default-discount">
                                                <Input
                                                    type="text"
                                                    value={defaultValue}
                                                    onChange={e => handleDefaultDiscountChange(group, e.target.value)}
                                                />
                                            </FormGroup>
                                        </div>
                                    );
                                })}
                            </CardContent>
                        </Card>
                    </div>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                           <div>
                               <CardTitle>Produkty ({filteredAndCalculatedProducts.length} / {dataContent.products.length})</CardTitle>
                           </div>
                           <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj produktów..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0"><AddIcon /> Dodaj</button>
                           </div>
                        </CardHeader>
                        <CardContent><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-500">
                            <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    {[
                                        { key: 'symbol', label: 'Symbol', className: 'w-28' },
                                        { key: 'nazwa', label: 'Nazwa', className: 'w-full' },
                                        { key: 'zp', label: 'ZP', className: 'w-20' },
                                        { key: 'grupa', label: 'Grupa', className: 'w-20' },
                                        { key: 'cenaNetto', label: (<span>Cena<br/>netto</span>), className: 'w-24' },
                                        { key: 'rabat', label: (<span>Rabat<br/>(%)</span>), className: 'w-20' },
                                        { key: 'poRabacie', label: (<span>Po<br/>rabacie</span>), className: 'w-24' },
                                        { key: 'transp', label: (<span>Transp/<br/>szt.</span>), className: 'w-24' },
                                        { key: 'sprNetto', label: (<span>Sprzedaż<br/>netto</span>), className: 'w-28' },
                                        { key: 'sprBrutto', label: (<span>Sprzedaż<br/>brutto</span>), className: 'w-28' },
                                        { key: 'iloscPal', label: (<span>Ilość<br/>paleta</span>), className: 'w-20' },
                                        { key: 'jm', label: 'JM', className: 'w-14' },
                                        { key: 'waga', label: (<span>Waga<br/>palety (t)</span>), className: 'w-24' },
                                        { key: 'maksPalet', label: (<span>Maks.<br/>palet</span>), className: 'w-20' },
                                        { key: 'akcje', label: 'Akcje', className: 'w-20' },
                                    ].map(({ key, label, className }) => (
                                        <th key={key} scope="col" className={`px-2 py-3 ${className || ''} ${key === 'nazwa' ? 'w-full' : ''}`}>{label}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>{filteredAndCalculatedProducts.map(p => (<tr key={p.id} className="bg-white border-b hover:bg-slate-50">
                                <td className="px-2 py-2 font-medium text-slate-900 align-top" style={{ wordBreak: 'break-word' }}>{p.symbol}</td>
                                <td className="px-4 py-2 align-top">{p.nazwa}</td>
                                <td className="px-2 py-2 align-top">{p.zp}</td>
                                <td className="px-2 py-2 align-top"><span className={`px-2 py-1 text-xs font-medium rounded-full ${groupColors[p.grupa] || 'bg-slate-100 text-slate-800'}`}>{p.grupa}</span></td>
                                <td className="px-2 py-2 whitespace-nowrap align-top">{formatCurrency(p.cenaNetto)}</td>
                                <td className="px-2 py-2 whitespace-nowrap align-top">{p.rabat}%</td>
                                <td className="px-2 py-2 bg-slate-50 font-semibold whitespace-nowrap align-top">{formatCurrency(p.cenaPoRabacie)}</td>
                                <td className="px-2 py-2 bg-slate-50 whitespace-nowrap align-top">{formatCurrency(p.transportPerUnit)}</td>
                                <td className="px-2 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyNetto)}</td>
                                <td className="px-2 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyBrutto)}</td>
                                <td className="px-2 py-2 align-top">{p.iloscNaPalecie}</td>
                                <td className="px-2 py-2 align-top">{p.jednostka}</td>
                                <td className="px-2 py-2 whitespace-nowrap align-top">{p.waga}</td>
                                <td className="px-2 py-2 whitespace-nowrap align-top">{p.maxPalletsPerTruck}</td>
                                <td className="px-4 py-2 whitespace-nowrap align-top">
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => openProductModal(p)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                        <button onClick={() => handleDeleteProduct(p.id)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                    </div>
                                </td>
                            </tr>))}</tbody>
                        </table></div></CardContent>
                    </Card>
                    {/* Usunięto statystyki dolne dla BRUK-BET */}
                     <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj Produkt BRUK-BET' : 'Dodaj Produkt BRUK-BET'}>
                        <BrukbetProductForm 
                            product={editingProduct} 
                            onSave={handleSaveProduct} 
                            onCancel={closeProductModal} 
                            groups={Object.keys(dataContent.settings.discounts)}
                        />
                    </Modal>
                    <BrukbetFactoryManagerModal 
                        isOpen={isFactoryModalOpen}
                        onClose={() => setIsFactoryModalOpen(false)}
                        factories={dataContent.settings.factories}
                        onSave={handleSaveFactories}
                    />
                </div>
            );
        };

        const LeierCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('leier_data', INITIAL_LEIER_DATA);
            const [openSections, setOpenSections] = useState({ materials: true, chimney: true, slab: true });
            const [isMaterialModalOpen, setIsMaterialModalOpen] = useState(false);
            const [materialModalData, setMaterialModalData] = useState({ index: null, product: null });
            const [isSlabModalOpen, setIsSlabModalOpen] = useState(false);
            const [slabModalData, setSlabModalData] = useState({ index: null, product: null });
            const materialsFileInputRef = useRef(null);

            const dataContent = data.content;
            const materials = dataContent.materials;
            const chimney = dataContent.chimney;
            const slab = dataContent.slab;
            const vatRate = 1.23;

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);

            const handlePriceListVersionChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListVersion: value,
                    }
                });
            };
            
            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };

            const toggleSection = (section) => {
                setOpenSections(prev => ({ ...prev, [section]: !prev[section] }));
            };

            const updateMaterials = (updater) => {
                const nextMaterials = typeof updater === 'function' ? updater(materials) : updater;
                setData({ content: { ...dataContent, materials: nextMaterials } });
            };

            const updateSlab = (updater) => {
                const nextSlab = typeof updater === 'function' ? updater(slab) : updater;
                setData({ content: { ...dataContent, slab: nextSlab } });
            };

            const openMaterialModal = (product = null, index = null) => {
                setMaterialModalData({ product, index });
                setIsMaterialModalOpen(true);
            };

            const closeMaterialModal = () => {
                setMaterialModalData({ index: null, product: null });
                setIsMaterialModalOpen(false);
            };

            const openSlabModal = (product = null, index = null) => {
                setSlabModalData({ product, index });
                setIsSlabModalOpen(true);
            };

            const closeSlabModal = () => {
                setSlabModalData({ index: null, product: null });
                setIsSlabModalOpen(false);
            };

            const handleMaterialsSettingChange = (name, value, isPercent = false) => {
                if (isPercent) {
                    const normalized = normalizePercentInputValue(value);
                    if (normalized === null) {
                        return;
                    }
                    updateMaterials(prev => ({
                        ...prev,
                        settings: {
                            ...prev.settings,
                            [name]: normalized
                        }
                    }));
                    return;
                }

                const parsedValue = parseNumericInput(value, { min: 0 });
                if (parsedValue === null) {
                    return;
                }

                updateMaterials(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        [name]: parsedValue
                    }
                }));
            };

            const handleMaterialsSearchChange = (event) => {
                const term = event.target.value;
                updateMaterials(prev => ({ ...prev, searchTerm: term }));
            };

            const parseNumericCell = (value) => {
                if (value == null) {
                    return 0;
                }
                const normalized = String(value).replace('%', '').replace(',', '.').trim();
                if (normalized === '') {
                    return 0;
                }
                const numeric = Number(normalized);
                return Number.isFinite(numeric) ? numeric : 0;
            };

            const handleMaterialsImport = async (event) => {
                const input = event.target;
                const file = input.files && input.files[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (rows.length < 2) {
                        alert('Plik jest pusty lub nie zawiera nagłówków.');
                        return;
                    }

                    const headers = rows[0].map(header => header == null ? '' : String(header).trim());
                    const colIndex = {
                        symbol: headers.indexOf('Symbol'),
                        name: headers.indexOf('Nazwa'),
                        priceNet: headers.indexOf('Cena netto'),
                        discount: headers.indexOf('Rabat (%)'),
                        transport: headers.indexOf('Koszt transportu/szt.'),
                        unitsPerPallet: headers.indexOf('Ilość na palecie'),
                        unit: headers.indexOf('Jednostka'),
                        palletWeight: headers.indexOf('Waga palety (t)')
                    };

                    if (colIndex.name === -1 || colIndex.priceNet === -1) {
                        alert('Brak wymaganych kolumn w pliku: Nazwa, Cena netto.');
                        return;
                    }

                    const importedProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) {
                            continue;
                        }
                        const rawName = colIndex.name >= 0 ? row[colIndex.name] : null;
                        if (!rawName || String(rawName).trim() === '') {
                            continue;
                        }

                        importedProducts.push({
                            symbol: colIndex.symbol >= 0 && row[colIndex.symbol] != null ? String(row[colIndex.symbol]).trim() : '',
                            name: String(rawName).trim(),
                            priceNet: parseNumericCell(colIndex.priceNet >= 0 ? row[colIndex.priceNet] : 0),
                            discountPercent: parseNumericCell(colIndex.discount >= 0 ? row[colIndex.discount] : 0),
                            transportPerUnit: parseNumericCell(colIndex.transport >= 0 ? row[colIndex.transport] : 0),
                            unitsPerPallet: colIndex.unitsPerPallet >= 0 && row[colIndex.unitsPerPallet] != null ? String(row[colIndex.unitsPerPallet]).trim() : '',
                            unit: colIndex.unit >= 0 && row[colIndex.unit] != null ? String(row[colIndex.unit]).trim() : '',
                            palletWeight: colIndex.palletWeight >= 0 && row[colIndex.palletWeight] != null ? String(row[colIndex.palletWeight]).trim() : ''
                        });
                    }

                    if (!importedProducts.length) {
                        alert('Nie znaleziono prawidłowych danych do importu.');
                        return;
                    }

                    updateMaterials(prev => ({ ...prev, products: importedProducts }));
                } catch (error) {
                    console.error('Błąd importu danych LEIER:', error);
                    alert('Nie udało się zaimportować pliku. Upewnij się, że format jest zgodny.');
                } finally {
                    input.value = '';
                }
            };

            const handleMaterialsExport = async () => {
                const excelRows = materials.products.map(product => ({
                    'Symbol': product.symbol || '',
                    'Nazwa': product.name,
                    'Cena netto': Number(product.priceNet || 0),
                    'Rabat (%)': Number(product.discountPercent || 0),
                    'Koszt transportu/szt.': Number(product.transportPerUnit || 0),
                    'Ilość na palecie': product.unitsPerPallet || '',
                    'Jednostka': product.unit || '',
                    'Waga palety (t)': product.palletWeight || ''
                }));
                const fileName = `LEIER_Materialy_${new Date().toISOString().split('T')[0]}.xlsx`;
                await safeExcelExport(excelRows, 'LEIER Materiały Budowlane', fileName, 'LEIER Materiały');
            };

            const materialEntries = useMemo(() => materials.products.map((product, index) => ({ product, index })), [materials.products]);
            const filteredMaterialEntries = useMemo(() => {
                const term = (materials.searchTerm || '').toLowerCase();
                if (!term) {
                    return materialEntries;
                }
                return materialEntries.filter(({ product }) => {
                    const symbol = (product.symbol || '').toLowerCase();
                    const name = (product.name || '').toLowerCase();
                    return symbol.includes(term) || name.includes(term);
                });
            }, [materialEntries, materials.searchTerm]);

            const marginValue = Number(materials.settings.margin || 0);
            const transportValue = Number(materials.settings.transportRate || 0);

            const materialRows = useMemo(() => filteredMaterialEntries.map(({ product, index }) => {
                const priceNet = Number(product.priceNet || 0);
                const discountPercent = Number(product.discountPercent || 0);
                const netAfterDiscount = priceNet * (1 - discountPercent / 100);
                const transportPerUnit = Number(product.transportPerUnit || 0) + transportValue;
                const saleNet = (netAfterDiscount + transportPerUnit) * (1 + marginValue / 100);
                const saleGross = saleNet * vatRate;
                return {
                    product,
                    index,
                    netAfterDiscount,
                    transportPerUnit,
                    saleNet,
                    saleGross
                };
            }), [filteredMaterialEntries, marginValue, transportValue]);

            const handleSaveMaterialProduct = (productData) => {
                updateMaterials(prev => {
                    const newProducts = [...prev.products];
                    const normalizedProduct = {
                        symbol: (productData.symbol || '').trim(),
                        name: productData.name.trim(),
                        priceNet: Number(productData.priceNet || 0),
                        discountPercent: Number(productData.discountPercent || 0),
                        transportPerUnit: Number(productData.transportPerUnit || 0),
                        unitsPerPallet: (productData.unitsPerPallet || '').trim(),
                        unit: (productData.unit || '').trim(),
                        palletWeight: (productData.palletWeight || '').trim()
                    };

                    if (materialModalData.index != null) {
                        newProducts[materialModalData.index] = normalizedProduct;
                    } else {
                        newProducts.push(normalizedProduct);
                    }

                    return { ...prev, products: newProducts };
                });
                closeMaterialModal();
            };

            const handleDeleteMaterialProduct = (index) => {
                if (!confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                    return;
                }
                updateMaterials(prev => ({
                    ...prev,
                    products: prev.products.filter((_, productIndex) => productIndex !== index)
                }));
                if (materialModalData.index === index) {
                    closeMaterialModal();
                }
            };

            const parseGroupPercent = (value) => {
                if (value === '' || value == null) {
                    return 0;
                }
                const normalized = String(value).replace(',', '.');
                const numeric = Number(normalized);
                return Number.isFinite(numeric) ? numeric : 0;
            };

            const handleSlabSettingChange = (name, value, isPercent = false) => {
                if (isPercent) {
                    const normalized = normalizePercentInputValue(value);
                    if (normalized === null) {
                        return;
                    }
                    updateSlab(prev => ({
                        ...prev,
                        settings: {
                            ...prev.settings,
                            [name]: normalized
                        }
                    }));
                    return;
                }

                const parsed = parseNumericInput(value, { min: 0 });
                if (parsed === null) {
                    return;
                }

                updateSlab(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        [name]: parsed
                    }
                }));
            };

            const handleSlabGroupChange = (groupKey, value) => {
                const normalized = normalizePercentInputValue(value);
                if (normalized === null) {
                    return;
                }
                updateSlab(prev => ({
                    ...prev,
                    settings: {
                        ...prev.settings,
                        groupDiscounts: {
                            ...prev.settings.groupDiscounts,
                            [groupKey]: normalized
                        }
                    }
                }));
            };

            const handleSlabQuantityChange = (index, value) => {
                updateSlab(prev => ({
                    ...prev,
                    quantities: {
                        ...prev.quantities,
                        [index]: value
                    }
                }));
            };

            const handleSaveSlabProduct = (productData) => {
                updateSlab(prev => {
                    const newProducts = [...prev.products];
                    const normalizedProduct = {
                        name: productData.name.trim(),
                        unit: (productData.unit || '').trim(),
                        catalogNet: Number(productData.catalogNet || 0),
                        catalogGross: Number(productData.catalogGross || 0),
                        discount: Number(productData.discount || 0),
                        defaultQuantity: productData.defaultQuantity === '' || productData.defaultQuantity == null ? '' : Number(productData.defaultQuantity)
                    };

                    let newQuantities = { ...prev.quantities };
                    if (slabModalData.index != null) {
                        newProducts[slabModalData.index] = normalizedProduct;
                    } else {
                        newProducts.push(normalizedProduct);
                        newQuantities[newProducts.length - 1] = '';
                    }

                    return { ...prev, products: newProducts, quantities: newQuantities };
                });
                closeSlabModal();
            };

            const handleDeleteSlabProduct = (index) => {
                if (!confirm('Czy na pewno chcesz usunąć ten produkt stropowy?')) {
                    return;
                }
                updateSlab(prev => {
                    const newProducts = prev.products.filter((_, productIndex) => productIndex !== index);
                    const newQuantities = {};
                    Object.entries(prev.quantities || {}).forEach(([key, value]) => {
                        const originalIndex = Number(key);
                        if (originalIndex === index) {
                            return;
                        }
                        const shiftedIndex = originalIndex > index ? originalIndex - 1 : originalIndex;
                        newQuantities[shiftedIndex] = value;
                    });
                    return { ...prev, products: newProducts, quantities: newQuantities };
                });
                if (slabModalData.index === index) {
                    closeSlabModal();
                }
            };

            const slabMargin = Number(slab.settings.margin || 0);
            const slabTransport = Number(slab.settings.transportCost || 0);
            const slabEntries = useMemo(() => slab.products.map((product, index) => ({ product, index })), [slab.products]);
            const slabRows = useMemo(() => slabEntries.map(({ product, index }) => {
                const baseDiscountPercent = Number(product.discount || 0) * 100;
                const groupEntry = Object.entries(slab.settings.groupDiscounts || {}).find(([_, percentValue]) => {
                    const numericPercent = parseGroupPercent(percentValue);
                    return Math.abs(numericPercent - baseDiscountPercent) < 0.5;
                });
                const effectivePercent = groupEntry ? parseGroupPercent(groupEntry[1]) : baseDiscountPercent;
                const groupLabel = groupEntry ? `${groupEntry[0]} (${effectivePercent}%)` : `Rabat ${baseDiscountPercent.toFixed(0)}%`;
                const purchaseNet = Number(product.catalogNet || 0) * (1 - effectivePercent / 100);
                const unitTransport = slabTransport;
                const quantities = slab.quantities || {};
                const quantityRaw = quantities[index];
                const quantity = quantityRaw === '' || quantityRaw == null ? 0 : Number(quantityRaw);
                const clientNet = (purchaseNet + unitTransport) * (1 + slabMargin / 100);
                const clientGross = clientNet * vatRate;
                const lineNet = clientNet * quantity;
                const lineGross = clientGross * quantity;
                const purchaseLineNet = (purchaseNet + unitTransport) * quantity;
                return {
                    product,
                    index,
                    groupLabel,
                    purchaseNet,
                    clientNet,
                    clientGross,
                    lineNet,
                    lineGross,
                    purchaseLineNet,
                    quantity
                };
            }), [slabEntries, slab.quantities, slab.settings.groupDiscounts, slabMargin, slabTransport]);

            const slabTotals = useMemo(() => {
                return slabRows.reduce((acc, row) => {
                    acc.purchaseNet += row.purchaseLineNet;
                    acc.saleNet += row.lineNet;
                    acc.saleGross += row.lineGross;
                    return acc;
                }, { purchaseNet: 0, saleNet: 0, saleGross: 0 });
            }, [slabRows]);

            slabTotals.purchaseGross = slabTotals.purchaseNet * vatRate;
            slabTotals.profitNet = slabTotals.saleNet - slabTotals.purchaseNet;
            slabTotals.profitGross = slabTotals.saleGross - slabTotals.purchaseGross;

            return (
                <div className="space-y-6">
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>LEIER - Materiały Budowlane</CardTitle>
                                <CardDescription>Systemy budowlane</CardDescription>
                            </div>
                            <div className="flex flex-col items-stretch gap-2 sm:items-end">
                                <PriceListDateField
                                    value={dataContent.priceListDate || ''}
                                    onChange={handlePriceListDateChange}
                                />
                                <div className="flex flex-wrap gap-2 justify-end">
                                    <button onClick={() => materialsFileInputRef.current?.click()} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                        <UploadIcon /> Importuj XLS
                                    </button>
                                    <button onClick={handleMaterialsExport} className="flex items-center gap-2 px-3 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                        <DownloadIcon /> Eksportuj XLS
                                    </button>
                                    <button onClick={() => openMaterialModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                        <AddIcon /> Dodaj
                                    </button>
                                    <button onClick={() => toggleSection('materials')} className="px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                        {openSections.materials ? 'Zwiń' : 'Rozwiń'}
                                    </button>
                                </div>
                            </div>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <input type="file" ref={materialsFileInputRef} onChange={handleMaterialsImport} className="hidden" accept=".xlsx,.xls" />
                            {openSections.materials && (
                                <>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <FormGroup label="Stawka transportu (zł)">
                                            <Input type="number" step="0.01" min="0" value={materials.settings.transportRate} onChange={(e) => handleMaterialsSettingChange('transportRate', e.target.value)} />
                                        </FormGroup>
                                        <FormGroup label="Marża (%)">
                                            <Input type="number" step="0.01" min="0" max="100" value={materials.settings.margin} onChange={(e) => handleMaterialsSettingChange('margin', e.target.value, true)} />
                                        </FormGroup>
                                        <div className="sm:col-span-2">
                                            <FormGroup label="Szukaj produktów">
                                                <input type="text" className="w-full p-2 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500" value={materials.searchTerm} onChange={handleMaterialsSearchChange} placeholder="Wpisz nazwę lub symbol..." />
                                            </FormGroup>
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left text-slate-500">
                                            <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                                <tr>
                                                    {['Symbol', 'Nazwa', 'Cena netto', 'Rabat (%)', 'Zakup netto', 'Transport/szt.', 'Netto sprzedaży', 'Brutto sprzedaży', 'Ilość/paleta', 'Jednostka', 'Waga palety (t)', 'Akcje'].map((header, idx) => (
                                                        <th key={header} scope="col" className={`px-4 py-3 ${idx === 1 ? 'w-full' : ''}`}>{header}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {materialRows.map((row) => (
                                                    <tr key={`${row.product.name}-${row.index}`} className="bg-white border-b hover:bg-slate-50">
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{row.product.symbol || '-'}</td>
                                                        <td className="px-4 py-2 align-top">{row.product.name}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(row.product.priceNet)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{formatPercentage(row.product.discountPercent)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(row.netAfterDiscount)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(row.transportPerUnit)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top font-semibold">{formatCurrency(row.saleNet)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top font-semibold">{formatCurrency(row.saleGross)}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{row.product.unitsPerPallet || '-'}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{row.product.unit || '-'}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">{row.product.palletWeight || '-'}</td>
                                                        <td className="px-4 py-2 whitespace-nowrap align-top">
                                                            <div className="flex items-center gap-2">
                                                                <button onClick={() => openMaterialModal(row.product, row.index)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                                <button onClick={() => handleDeleteMaterialProduct(row.index)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </>
                            )}
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>LEIER - Kalkulator Systemów Kominowych</CardTitle>
                                <CardDescription>Oryginalny kalkulator LEIER osadzony w aplikacji</CardDescription>
                            </div>
                            <button onClick={() => toggleSection('chimney')} className="px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                {openSections.chimney ? 'Zwiń' : 'Rozwiń'}
                            </button>
                        </CardHeader>
                        {openSections.chimney && (
                            <CardContent>
                                <div className="rounded-lg border border-slate-200 overflow-hidden">
                                    <iframe
                                        title="LEIER Chimney Calculator"
                                        srcDoc={LEIER_CHIMNEY_HTML}
                                        src="about:blank"
                                        className="w-full h-[920px] bg-white"
                                    />
                                </div>
                                <p className="text-xs text-slate-500 mt-3">Wbudowany kalkulator korzysta z oficjalnego arkusza LEIER i działa w trybie offline.</p>
                            </CardContent>
                        )}
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <div>
                                <CardTitle>LEIER - Strop</CardTitle>
                                <CardDescription>Kalkulator elementów stropowych</CardDescription>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => openSlabModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                    <AddIcon /> Dodaj produkt
                                </button>
                                <button onClick={() => toggleSection('slab')} className="px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                    {openSections.slab ? 'Zwiń' : 'Rozwiń'}
                                </button>
                            </div>
                        </CardHeader>
                        {openSections.slab && (
                            <CardContent className="space-y-4">
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <FormGroup label="Koszt transportu (zł/szt.)">
                                        <Input type="number" step="0.01" min="0" value={slab.settings.transportCost} onChange={(e) => handleSlabSettingChange('transportCost', e.target.value)} />
                                    </FormGroup>
                                    <FormGroup label="Marża (%)">
                                        <Input type="number" step="0.01" min="0" max="100" value={slab.settings.margin} onChange={(e) => handleSlabSettingChange('margin', e.target.value, true)} />
                                    </FormGroup>
                                    {Object.entries(slab.settings.groupDiscounts).map(([key, value]) => (
                                        <FormGroup key={key} label={`Rabat ${key} (%)`}>
                                            <Input type="number" step="0.01" min="0" max="100" value={value} onChange={(e) => handleSlabGroupChange(key, e.target.value)} />
                                        </FormGroup>
                                    ))}
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left text-slate-500">
                                        <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                            <tr>
                                                {['Nazwa', 'J.M.', 'Katalog netto', 'Grupa rabatowa', 'Zakup netto', 'Ilość', 'Netto klient', 'Brutto klient', 'Suma', 'Akcje'].map(header => (
                                                    <th key={header} scope="col" className="px-4 py-3">{header}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {slabRows.map((row) => (
                                                <tr key={`${row.product.name}-${row.index}`} className="bg-white border-b hover:bg-slate-50">
                                                    <td className="px-4 py-2 align-top">{row.product.name}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">{row.product.unit || '-'}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(row.product.catalogNet)}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">{row.groupLabel}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">{formatCurrency(row.purchaseNet)}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">
                                                        <Input
                                                            type="number"
                                                            min="0"
                                                            step="0.01"
                                                            value={slab.quantities?.[row.index] ?? ''}
                                                            onChange={(e) => handleSlabQuantityChange(row.index, e.target.value)}
                                                        />
                                                    </td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top font-semibold text-blue-700">{formatCurrency(row.clientNet)}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top font-semibold text-blue-900">{formatCurrency(row.clientGross)}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top font-semibold">{formatCurrency(row.lineNet)}</td>
                                                    <td className="px-4 py-2 whitespace-nowrap align-top">
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => openSlabModal(row.product, row.index)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                                            <button onClick={() => handleDeleteSlabProduct(row.index)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                                            <button onClick={() => handleSlabQuantityChange(row.index, '')} className="text-slate-600 hover:text-slate-800 text-xs">Wyczyść</button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase">Wartość zakupowa</div>
                                        <div className="text-sm text-slate-600">Netto: {formatCurrency(slabTotals.purchaseNet)}</div>
                                        <div className="text-sm text-slate-600">Brutto: {formatCurrency(slabTotals.purchaseGross)}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase">Wartość sprzedaży</div>
                                        <div className="text-sm text-slate-600">Netto: {formatCurrency(slabTotals.saleNet)}</div>
                                        <div className="text-sm text-slate-600">Brutto: {formatCurrency(slabTotals.saleGross)}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-500 uppercase">Zysk</div>
                                        <div className="text-sm font-semibold text-emerald-600">Netto: {formatCurrency(slabTotals.profitNet)}</div>
                                        <div className="text-sm font-semibold text-emerald-600">Brutto: {formatCurrency(slabTotals.profitGross)}</div>
                                    </div>
                                </div>
                            </CardContent>
                        )}
                    </Card>
                    <Modal
                        isOpen={isMaterialModalOpen}
                        onClose={closeMaterialModal}
                        title={materialModalData.index != null ? 'Edytuj produkt - Materiały' : 'Dodaj produkt - Materiały'}
                    >
                        <LeierMaterialForm product={materialModalData.product} onSave={handleSaveMaterialProduct} onCancel={closeMaterialModal} />
                    </Modal>
                    <Modal
                        isOpen={isSlabModalOpen}
                        onClose={closeSlabModal}
                        title={slabModalData.index != null ? 'Edytuj produkt stropowy' : 'Dodaj produkt stropowy'}
                    >
                        <LeierSlabProductForm product={slabModalData.product} onSave={handleSaveSlabProduct} onCancel={closeSlabModal} />
                    </Modal>
                </div>
            );
        };


        const UValueCalculator = ({ setSyncInfo }) => {
            const defaultMaterial = UVALUE_MATERIALS.find(material => material.id === 'eps-031') || UVALUE_MATERIALS[0];
            const [selectedMaterialId, setSelectedMaterialId] = useState(defaultMaterial.id);
            const [lambdaInput, setLambdaInput] = useState(defaultMaterial.lambda.toFixed(3));
            const [thickness, setThickness] = useState(20);
            const [visibleMaterialIds, setVisibleMaterialIds] = useState(UVALUE_MATERIALS.map(material => material.id));

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: 'offline', sync: () => {} });
                }
            }, [setSyncInfo]);

            const thicknessRange = useMemo(() => {
                const values = [];
                for (let cm = UVALUE_THICKNESS_RANGE.min; cm <= UVALUE_THICKNESS_RANGE.max; cm += UVALUE_THICKNESS_RANGE.step) {
                    values.push(cm);
                }
                return values;
            }, []);

            const parseLambdaInput = (input) => {
                if (input == null || input === '') {
                    return Number.NaN;
                }
                const normalized = Number(String(input).replace(',', '.'));
                return Number.isFinite(normalized) ? normalized : Number.NaN;
            };

            const lambda = useMemo(() => {
                const parsed = parseLambdaInput(lambdaInput);
                if (!Number.isFinite(parsed) || parsed <= 0) {
                    return defaultMaterial.lambda;
                }
                return clampValue(parsed, 0.02, 0.08);
            }, [lambdaInput, defaultMaterial.lambda]);

            const calculatePoint = useCallback((lambdaValue, thicknessCm) => {
                const thicknessMeters = thicknessCm / 100;
                if (lambdaValue <= 0 || thicknessMeters <= 0) {
                    return { thickness: thicknessCm, rValue: 0, uValue: 0 };
                }
                const rValue = thicknessMeters / lambdaValue;
                const uValue = 1 / rValue;
                return { thickness: thicknessCm, rValue, uValue };
            }, []);

            const buildDataSeries = useCallback((lambdaValue) => {
                return thicknessRange.map((cm) => calculatePoint(lambdaValue, cm));
            }, [calculatePoint, thicknessRange]);

            const selectedMaterial = UVALUE_MATERIALS.find(material => material.id === selectedMaterialId) || null;
            const primaryColor = selectedMaterial?.color || UVALUE_DEFAULT_COLOR;

            const comparisonProfiles = useMemo(() => {
                return UVALUE_MATERIALS
                    .filter(material => visibleMaterialIds.includes(material.id))
                    .map(material => ({ ...material, data: buildDataSeries(material.lambda) }));
            }, [buildDataSeries, visibleMaterialIds]);

            const currentProfile = useMemo(() => ({
                id: 'current',
                name: selectedMaterial ? selectedMaterial.name : 'Profil niestandardowy',
                lambda,
                color: primaryColor,
                data: buildDataSeries(lambda),
                isCurrent: true
            }), [buildDataSeries, lambda, primaryColor, selectedMaterial]);

            const chartProfiles = useMemo(() => {
                return [
                    ...comparisonProfiles.filter(profile => !(selectedMaterial && profile.id === selectedMaterial.id)),
                    currentProfile
                ];
            }, [comparisonProfiles, currentProfile, selectedMaterial]);

            const currentPoint = useMemo(() => calculatePoint(lambda, thickness), [calculatePoint, lambda, thickness]);

            const targetResults = useMemo(() => UVALUE_TARGETS.map((target) => {
                const requiredThickness = lambda > 0 ? (lambda / target.uLimit) * 100 : 0;
                return {
                    ...target,
                    requiredThickness,
                    roundedThickness: Math.ceil(requiredThickness),
                    meetsCurrent: thickness >= requiredThickness
                };
            }), [lambda, thickness]);

            const summaryRows = useMemo(() => {
                return UVALUE_THICKNESS_PRESETS.map((preset) => calculatePoint(lambda, preset));
            }, [calculatePoint, lambda]);

            const formatDecimal = (value, digits = 2) => {
                if (!Number.isFinite(value)) {
                    return '-';
                }
                return value.toFixed(digits).replace('.', ',');
            };

            const formatU = (value) => `${formatDecimal(value, 3)} W/(m²K)`;
            const formatR = (value) => `${formatDecimal(value, 2)} m²K/W`;
            const formatLambda = (value) => `${formatDecimal(value, 3)} W/(m·K)`;

            const handleMaterialChange = (event) => {
                const nextId = event.target.value;
                const material = UVALUE_MATERIALS.find(item => item.id === nextId);
                if (material) {
                    setSelectedMaterialId(nextId);
                    setLambdaInput(material.lambda.toFixed(3));
                    setVisibleMaterialIds((prev) => (prev.includes(nextId) ? prev : [...prev, nextId]));
                } else {
                    setSelectedMaterialId('custom');
                }
            };

            const handleLambdaInputChange = (event) => {
                setSelectedMaterialId('custom');
                setLambdaInput(event.target.value);
            };

            const handleLambdaBlur = () => {
                const parsed = parseLambdaInput(lambdaInput);
                if (Number.isFinite(parsed)) {
                    const clamped = clampValue(parsed, 0.02, 0.08);
                    setLambdaInput(clamped.toFixed(3));
                }
            };

            const handleLambdaSliderChange = (event) => {
                const nextValue = Number(event.target.value);
                if (!Number.isFinite(nextValue)) {
                    return;
                }
                setSelectedMaterialId('custom');
                setLambdaInput(nextValue.toFixed(3));
            };

            const handleThicknessChange = (event) => {
                const nextValue = Number(event.target.value);
                if (Number.isFinite(nextValue)) {
                    setThickness(Math.round(clampValue(nextValue, UVALUE_THICKNESS_RANGE.min, UVALUE_THICKNESS_RANGE.max)));
                }
            };

            const handleThicknessPreset = (preset) => {
                setThickness(Math.round(clampValue(preset, UVALUE_THICKNESS_RANGE.min, UVALUE_THICKNESS_RANGE.max)));
            };

            const toggleMaterialVisibility = (materialId) => {
                setVisibleMaterialIds((prev) => (
                    prev.includes(materialId)
                        ? prev.filter((id) => id !== materialId)
                        : [...prev, materialId]
                ));
            };

            const chartWidth = 700;
            const chartHeight = 280;
            const chartMargin = { top: 16, right: 24, bottom: 36, left: 64 };
            const innerWidth = chartWidth - chartMargin.left - chartMargin.right;
            const innerHeight = chartHeight - chartMargin.top - chartMargin.bottom;

            // Avoid Array.prototype.flatMap for broader browser support
            const allUValues = chartProfiles.reduce((values, profile) => {
                profile.data.forEach((point) => {
                    values.push(point.uValue);
                });
                return values;
            }, []);
            const rawMinU = allUValues.length ? Math.min(...allUValues) : 0;
            const rawMaxU = allUValues.length ? Math.max(...allUValues) : 1;
            const safeMinU = Math.max(0, rawMinU);
            const safeMaxU = rawMaxU <= safeMinU ? safeMinU + 0.05 : rawMaxU;

            const createTicks = (min, max, targetCount = 5) => {
                const range = max - min;
                if (range <= 0) {
                    return [min];
                }
                const roughStep = range / targetCount;
                const exponent = Math.floor(Math.log10(roughStep));
                const pow = 10 ** exponent;
                const multiples = [1, 2, 2.5, 5, 10];
                const stepMultiplier = multiples.find((m) => roughStep <= m * pow) || multiples[multiples.length - 1];
                const step = stepMultiplier * pow;
                const adjustedMin = Math.floor(min / step) * step;
                const adjustedMax = Math.ceil((max + step * 0.01) / step) * step;
                const ticks = [];
                for (let tick = adjustedMin; tick <= adjustedMax; tick += step) {
                    ticks.push(Number(tick.toFixed(6)));
                }
                return ticks.filter((tick) => tick >= min - step * 0.5 && tick <= max + step * 0.5);
            };

            const yTicks = createTicks(safeMinU, safeMaxU, 6);
            const xTicks = UVALUE_THICKNESS_PRESETS.filter((value) => value >= UVALUE_THICKNESS_RANGE.min && value <= UVALUE_THICKNESS_RANGE.max);

            const projectX = (value) => {
                if (UVALUE_THICKNESS_RANGE.max === UVALUE_THICKNESS_RANGE.min) {
                    return chartMargin.left;
                }
                const ratio = (value - UVALUE_THICKNESS_RANGE.min) / (UVALUE_THICKNESS_RANGE.max - UVALUE_THICKNESS_RANGE.min);
                return chartMargin.left + ratio * innerWidth;
            };

            const projectY = (value) => {
                if (safeMaxU === safeMinU) {
                    return chartMargin.top + innerHeight;
                }
                const ratio = (value - safeMinU) / (safeMaxU - safeMinU);
                return chartMargin.top + (1 - ratio) * innerHeight;
            };

            const highlightedChartPoint = currentProfile.data.find((point) => point.thickness === thickness);

            return (
                <div className="space-y-6">
                    {/* Usunięto statystyki górne dla U-Value */}

                    <Card>
                        <CardHeader>
                            <CardTitle>Parametry obliczeń</CardTitle>
                            <CardDescription>Ustaw lambdę, grubość i porównuj różne materiały izolacyjne.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="grid grid-cols-1 xl:grid-cols-[minmax(0,360px)_1fr] gap-6">
                                <div className="space-y-5">
                                    <div>
                                        <label className="block text-sm font-medium text-slate-600 mb-2">Materiał referencyjny</label>
                                        <select value={selectedMaterialId} onChange={handleMaterialChange} className="w-full p-3 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                            {UVALUE_MATERIALS.map((material) => (
                                                <option key={material.id} value={material.id}>{material.name} — λ = {formatDecimal(material.lambda, 3)} W/(m·K)</option>
                                            ))}
                                            <option value="custom">Inna wartość λ (własna)</option>
                                        </select>
                                        {selectedMaterial?.description && (
                                            <p className="text-xs text-slate-500 mt-2">{selectedMaterial.description}</p>
                                        )}
                                    </div>

                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between">
                                            <label className="text-sm font-medium text-slate-600">Lambda λ [W/(m·K)]</label>
                                            <span className="text-xs text-slate-500">Zakres 0,020 – 0,080</span>
                                        </div>
                                        <input
                                            type="text"
                                            value={lambdaInput}
                                            onChange={handleLambdaInputChange}
                                            onBlur={handleLambdaBlur}
                                            inputMode="decimal"
                                            className="w-full p-3 border border-slate-300 rounded-md text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                        />
                                        <input
                                            type="range"
                                            min="0.02"
                                            max="0.08"
                                            step="0.001"
                                            value={lambda}
                                            onChange={handleLambdaSliderChange}
                                            className="w-full"
                                        />
                                    </div>

                                    <div className="space-y-3">
                                        <div className="flex items-center justify-between">
                                            <label className="text-sm font-medium text-slate-600">Grubość izolacji [cm]</label>
                                            <span className="text-xs text-slate-500">{UVALUE_THICKNESS_RANGE.min} – {UVALUE_THICKNESS_RANGE.max} cm</span>
                                        </div>
                                        <input
                                            type="range"
                                            min={UVALUE_THICKNESS_RANGE.min}
                                            max={UVALUE_THICKNESS_RANGE.max}
                                            step="1"
                                            value={thickness}
                                            onChange={handleThicknessChange}
                                            className="w-full"
                                        />
                                        <div className="flex flex-wrap gap-2">
                                            {UVALUE_THICKNESS_PRESETS.map((preset) => (
                                                <button
                                                    key={preset}
                                                    type="button"
                                                    onClick={() => handleThicknessPreset(preset)}
                                                    className={`px-3 py-1.5 text-xs rounded-md border transition-colors ${preset === thickness ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-300 text-slate-600 hover:border-blue-400 hover:text-blue-600'}`}
                                                >
                                                    {preset} cm
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <p className="text-sm font-medium text-slate-600">Linie porównawcze na wykresie</p>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            {UVALUE_MATERIALS.map((material) => {
                                                const isChecked = visibleMaterialIds.includes(material.id);
                                                return (
                                                    <label key={material.id} className={`flex items-center gap-3 text-sm rounded-md border ${isChecked ? 'border-blue-400 bg-blue-50' : 'border-slate-200 bg-white'} px-3 py-2 transition-colors`}>
                                                        <input
                                                            type="checkbox"
                                                            checked={isChecked}
                                                            onChange={() => toggleMaterialVisibility(material.id)}
                                                            className="accent-blue-600"
                                                        />
                                                        <span className="flex-1">
                                                            <span className="block font-medium text-slate-700">{material.name}</span>
                                                            <span className="block text-xs text-slate-500">λ = {formatDecimal(material.lambda, 3)} W/(m·K)</span>
                                                        </span>
                                                        <span className="w-3 h-3 rounded-full" style={{ backgroundColor: material.color }} />
                                                    </label>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="grid gap-3">
                                        {targetResults.map((target) => (
                                            <div key={target.id} className={`border rounded-lg p-4 ${target.meetsCurrent ? 'border-emerald-400 bg-emerald-50' : 'border-slate-200 bg-slate-50'}`}>
                                                <div className="flex items-start justify-between gap-3">
                                                    <div>
                                                        <p className="text-xs uppercase tracking-wide text-slate-500">{target.label}</p>
                                                        <p className="text-sm text-slate-700 mt-1">Wymagana grubość: <strong>{formatDecimal(target.requiredThickness, 1)} cm</strong></p>
                                                        <p className="text-xs text-slate-500 mt-1">Zaokrąglij do {target.roundedThickness} cm dla bezpieczeństwa projektowego.</p>
                                                    </div>
                                                    <span className={`text-xs font-semibold ${target.meetsCurrent ? 'text-emerald-600' : 'text-slate-500'}`}>
                                                        {target.meetsCurrent ? 'Spełnione' : 'Do osiągnięcia'}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 rounded-lg bg-slate-100 border border-slate-200">
                                        <p className="text-sm font-medium text-slate-700">Wzory użyte do obliczeń</p>
                                        <p className="text-xs text-slate-600 mt-1">R = d/λ, gdzie d to grubość w metrach. U = 1/R. Wyniki zaokrąglone do trzech miejsc po przecinku.</p>
                                    </div>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Wykres zależności U od grubości izolacji</CardTitle>
                            <CardDescription>Porównaj spadek współczynnika U dla różnych lambd w zakresie 5–40 cm.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="w-full overflow-x-auto">
                                <svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="w-full min-w-[640px]">
                                    {/* Osie */}
                                    <line x1={chartMargin.left} y1={chartMargin.top} x2={chartMargin.left} y2={chartHeight - chartMargin.bottom} stroke="#cbd5f5" strokeWidth="1" />
                                    <line x1={chartMargin.left} y1={chartHeight - chartMargin.bottom} x2={chartWidth - chartMargin.right} y2={chartHeight - chartMargin.bottom} stroke="#cbd5f5" strokeWidth="1" />

                                    {/* Linie siatki poziomej */}
                                    {yTicks.map((tick) => {
                                        const y = projectY(tick);
                                        return (
                                            <g key={`y-tick-${tick}`}>
                                                <line x1={chartMargin.left} y1={y} x2={chartWidth - chartMargin.right} y2={y} stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 6" />
                                                <text x={chartMargin.left - 10} y={y} textAnchor="end" alignmentBaseline="middle" className="fill-slate-500 text-xs">
                                                    {formatDecimal(tick, 2)}
                                                </text>
                                            </g>
                                        );
                                    })}

                                    {/* Linie siatki pionowej */}
                                    {xTicks.map((tick) => {
                                        const x = projectX(tick);
                                        return (
                                            <g key={`x-tick-${tick}`}>
                                                <line x1={x} y1={chartMargin.top} x2={x} y2={chartHeight - chartMargin.bottom} stroke="#e2e8f0" strokeWidth="1" strokeDasharray="4 6" />
                                                <text x={x} y={chartHeight - chartMargin.bottom + 16} textAnchor="middle" className="fill-slate-500 text-xs">
                                                    {tick} cm
                                                </text>
                                            </g>
                                        );
                                    })}

                                    {/* Linie danych */}
                                    {chartProfiles.map((profile) => {
                                        const path = profile.data.map((point, index) => {
                                            const x = projectX(point.thickness);
                                            const y = projectY(point.uValue);
                                            return `${index === 0 ? 'M' : 'L'}${x} ${y}`;
                                        }).join(' ');
                                        return (
                                            <path
                                                key={profile.id}
                                                d={path}
                                                fill="none"
                                                stroke={profile.color}
                                                strokeWidth={profile.isCurrent ? 3 : 2}
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                                opacity={profile.isCurrent ? 1 : 0.65}
                                            />
                                        );
                                    })}

                                    {/* Aktualna grubość */}
                                    <line
                                        x1={projectX(thickness)}
                                        x2={projectX(thickness)}
                                        y1={chartMargin.top}
                                        y2={chartHeight - chartMargin.bottom}
                                        stroke={primaryColor}
                                        strokeWidth="1.5"
                                        strokeDasharray="6 6"
                                        opacity="0.9"
                                    />

                                    {highlightedChartPoint && (
                                        <circle
                                            cx={projectX(highlightedChartPoint.thickness)}
                                            cy={projectY(highlightedChartPoint.uValue)}
                                            r="5"
                                            fill={primaryColor}
                                            stroke="#ffffff"
                                            strokeWidth="2"
                                        />
                                    )}

                                    {/* Opisy osi */}
                                    <text x={chartMargin.left + innerWidth / 2} y={chartHeight - 4} textAnchor="middle" className="fill-slate-500 text-sm">Grubość izolacji [cm]</text>
                                    <text x="16" y={chartMargin.top - 4} className="fill-slate-500 text-sm">U [W/(m²K)]</text>
                                </svg>
                            </div>

                            <div className="flex flex-wrap gap-4 mt-4">
                                {chartProfiles.map((profile) => (
                                    <div key={`legend-${profile.id}`} className="flex items-center gap-2 text-sm text-slate-600">
                                        <span className="w-3.5 h-3.5 rounded-full" style={{ backgroundColor: profile.color, opacity: profile.isCurrent ? 1 : 0.7 }} />
                                        <span>{profile.name} — λ = {formatDecimal(profile.lambda, 3)} W/(m·K)</span>
                                    </div>
                                ))}
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Tablica wartości U i R dla wybranej lambdy</CardTitle>
                            <CardDescription>Wartości policzone dla typowych grubości izolacji. Obecna grubość jest wyróżniona.</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <div className="overflow-x-auto">
                                <table className="min-w-full text-sm text-left text-slate-600">
                                    <thead className="bg-slate-50 text-xs uppercase text-slate-500">
                                        <tr>
                                            <th className="px-4 py-3">Grubość [cm]</th>
                                            <th className="px-4 py-3">R [m²K/W]</th>
                                            <th className="px-4 py-3">U [W/(m²K)]</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {summaryRows.map((row) => {
                                            const isActive = row.thickness === thickness;
                                            return (
                                                <tr key={`row-${row.thickness}`} className={isActive ? 'bg-blue-50 font-medium text-blue-700' : 'border-b border-slate-100'}>
                                                    <td className="px-4 py-2">{row.thickness} cm</td>
                                                    <td className="px-4 py-2">{formatR(row.rValue)}</td>
                                                    <td className="px-4 py-2">{formatU(row.uValue)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            );
        };


        const WeberProductForm = ({ product, onSave, onCancel }) => {
            const initialValues = useMemo(() => ({
                id: product?.id || '',
                name: product?.name || '',
                group: product?.group || '',
                unit: product?.unit || '',
                packageUnit: product?.packageUnit || product?.unit || '',
                priceNet: product?.priceNet != null ? formatNumberForInput(product.priceNet) : '',
                priceRaw: product?.priceRaw || '',
                priceOverride: product?.priceOverride != null && product?.priceOverride !== ''
                    ? formatNumberForInput(product.priceOverride)
                    : '',
                packageSize: product?.packageSize != null && product?.packageSize !== ''
                    ? formatNumberForInput(product.packageSize)
                    : '',
            }), [product]);

            const [values, setValues] = useState(initialValues);
            const [errors, setErrors] = useState({});

            useEffect(() => {
                setValues(initialValues);
                setErrors({});
            }, [initialValues]);

            const handleChange = (field) => (event) => {
                const { value } = event.target;
                setValues((prev) => ({ ...prev, [field]: value }));
            };

            const handleSubmit = (event) => {
                event.preventDefault();

                const nextErrors = {};

                const trimmedId = values.id.trim();
                if (!trimmedId) {
                    nextErrors.id = 'Wymagany kod produktu.';
                }

                const trimmedName = values.name.trim();
                if (!trimmedName) {
                    nextErrors.name = 'Wymagana nazwa asortymentu.';
                }

                const priceNetNumeric = parseLooseNumber(values.priceNet);
                if (!Number.isFinite(priceNetNumeric) || priceNetNumeric < 0) {
                    nextErrors.priceNet = 'Podaj poprawną cenę netto.';
                }

                let priceOverrideValue = '';
                if (values.priceOverride !== '') {
                    const overrideNumeric = parseLooseNumber(values.priceOverride);
                    if (!Number.isFinite(overrideNumeric) || overrideNumeric < 0) {
                        nextErrors.priceOverride = 'Podaj poprawną wartość lub pozostaw puste.';
                    } else {
                        priceOverrideValue = roundToPrecision(overrideNumeric, 6);
                    }
                }

                let packageSizeValue = '';
                if (values.packageSize !== '') {
                    const parsedPackageSize = parseLooseNumber(values.packageSize);
                    if (!Number.isFinite(parsedPackageSize) || parsedPackageSize <= 0) {
                        nextErrors.packageSize = 'Podaj dodatnią wartość lub pozostaw puste.';
                    } else {
                        packageSizeValue = roundToPrecision(parsedPackageSize, 6);
                    }
                }

                if (Object.keys(nextErrors).length > 0) {
                    setErrors(nextErrors);
                    return;
                }

                const sanitizedProduct = {
                    id: trimmedId,
                    name: trimmedName,
                    group: values.group.trim(),
                    unit: values.unit.trim(),
                    priceNet: roundToPrecision(priceNetNumeric, 6),
                    priceRaw: values.priceRaw.trim(),
                    priceOverride: priceOverrideValue,
                    packageSize: packageSizeValue,
                    packageUnit: (values.packageUnit || values.unit || '').trim(),
                };

                onSave(sanitizedProduct);
            };

            const isEditMode = Boolean(product);

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <FormGroup label="Kod produktu" error={errors.id}>
                            <Input value={values.id} onChange={handleChange('id')} placeholder="np. WEB-001" />
                        </FormGroup>
                        <FormGroup label="Nazwa asortymentu" error={errors.name}>
                            <Input value={values.name} onChange={handleChange('name')} placeholder="Nazwa produktu" />
                        </FormGroup>
                        <FormGroup label="Cena katalogowa netto" error={errors.priceNet}>
                            <Input value={values.priceNet} onChange={handleChange('priceNet')} placeholder="np. 125.50" />
                        </FormGroup>
                        <FormGroup label="Cena nadpisana netto" error={errors.priceOverride}>
                            <Input value={values.priceOverride} onChange={handleChange('priceOverride')} placeholder="Pozostaw puste aby korzystać z katalogu" />
                        </FormGroup>
                        <FormGroup label="Jednostka bazowa">
                            <Input value={values.unit} onChange={handleChange('unit')} placeholder="np. kg" />
                        </FormGroup>
                        <FormGroup label="Opakowanie – jednostka">
                            <Input value={values.packageUnit} onChange={handleChange('packageUnit')} placeholder="np. worek" />
                        </FormGroup>
                        <FormGroup label="Opakowanie – wielkość" error={errors.packageSize}>
                            <Input value={values.packageSize} onChange={handleChange('packageSize')} placeholder="np. 25" />
                        </FormGroup>
                        <FormGroup label="Grupa (opcjonalnie)">
                            <Input value={values.group} onChange={handleChange('group')} placeholder="np. P42" />
                        </FormGroup>
                    </div>
                    <FormGroup label="Opis ceny katalogowej (tekst)">
                        <textarea
                            value={values.priceRaw}
                            onChange={handleChange('priceRaw')}
                            rows={3}
                            className="w-full rounded-md border border-slate-300 p-2 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            placeholder="np. od 59,00"
                        />
                    </FormGroup>
                    <div className="flex justify-end gap-2">
                        <button
                            type="button"
                            onClick={onCancel}
                            className="inline-flex items-center gap-2 rounded-md border border-slate-300 px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100"
                        >
                            Anuluj
                        </button>
                        <button
                            type="submit"
                            className="inline-flex items-center gap-2 rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                        >
                            {isEditMode ? 'Zapisz zmiany' : 'Dodaj produkt'}
                        </button>
                    </div>
                </form>
            );
        };

        const WeberCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('weber_data', INITIAL_WEBER_DATA);
            const fileInputRef = useRef(null);
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);

            const dataContent = useMemo(() => {
                const settings = {
                    ...INITIAL_WEBER_DATA.content.settings,
                    ...(data?.content?.settings || {}),
                };
                const filters = {
                    ...INITIAL_WEBER_DATA.content.filters,
                    ...(data?.content?.filters || {}),
                };
                const products = Array.isArray(data?.content?.products) ? data.content.products : [];
                const priceListDate = data?.content?.priceListDate || '';
                const priceListVersion = data?.content?.priceListVersion || '';
                return { settings, filters, products, priceListDate, priceListVersion };
            }, [data]);

            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [setSyncInfo, syncStatus, syncData]);

            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...data.content,
                        priceListDate: value,
                    }
                });
            };

            const filteredProducts = useMemo(() => {
                const term = dataContent.filters.searchTerm.trim().toLowerCase();
                if (!term) {
                    return dataContent.products;
                }
                return dataContent.products.filter((product) =>
                    [product.id, product.name, product.group, product.unit, product.priceRaw]
                        .filter(Boolean)
                        .some((value) => String(value).toLowerCase().includes(term))
                );
            }, [dataContent.products, dataContent.filters.searchTerm]);

            const computedProducts = useMemo(
                () => filteredProducts.map((product) => calculateWeberProduct(product, dataContent.settings)),
                [filteredProducts, dataContent.settings]
            );

            const sortedProducts = useMemo(
                () => [...computedProducts].sort((a, b) => a.name.localeCompare(b.name, 'pl')),
                [computedProducts]
            );

            const handleSettingsChange = (key, rawValue) => {
                const parser = key === 'palletPrice'
                    ? (value) => parseNumericInput(value, { min: 0 })
                    : normalizePercentInputValue;
                const parsedValue = parser(rawValue);

                if (parsedValue === null) {
                    return;
                }

                setData({
                    content: {
                        ...data.content,
                        settings: { ...dataContent.settings, [key]: parsedValue },
                    }
                });
            };

            const handleSearchChange = (value) => {
                setData({
                    content: {
                        ...data.content,
                        filters: { ...dataContent.filters, searchTerm: value },
                    }
                });
            };

            const resetSettings = () => {
                setData({
                    content: {
                        ...data.content,
                        settings: { ...INITIAL_WEBER_DATA.content.settings },
                    }
                });
            };

            const resetFilters = () => {
                setData({
                    content: {
                        ...data.content,
                        filters: { ...INITIAL_WEBER_DATA.content.filters },
                    }
                });
            };

            const handleImportClick = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const findHeaderIndex = (headers, candidates) => {
                const normalizedHeaders = headers.map((header) => (header || '').toLowerCase());
                for (const candidate of candidates) {
                    const idx = normalizedHeaders.indexOf(candidate.toLowerCase());
                    if (idx !== -1) {
                        return idx;
                    }
                }
                return -1;
            };

            const handleFileImport = async (event) => {
                const input = event.target;
                const file = input?.files?.[0];
                if (!file) {
                    return;
                }

                try {
                    const rows = await readExcelRows(file);
                    if (!rows.length) {
                        alert('Plik nie zawiera danych do importu.');
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());

                    const idxName = findHeaderIndex(headers, ['nazwa produktu', 'nazwa']);
                    if (idxName === -1) {
                        alert('Brak kolumny "Nazwa produktu".');
                        return;
                    }

                    const idxGroup = findHeaderIndex(headers, ['grupa towaro-wa', 'grupa']);
                    const idxUnit = findHeaderIndex(headers, ['jedn. sprzed.', 'jednostka', 'jednostka sprzed.', 'jedn. sprzedaz']);
                    const idxPriceNet = findHeaderIndex(headers, ['cena netto za jedn.', 'cena netto katalogowa', 'cena katalogowa']);
                    const idxPriceRaw = findHeaderIndex(headers, ['cena katalogowa (tekst)', 'cena katalogowa (raw)']);
                    const idxId = findHeaderIndex(headers, ['id produktu', 'id', 'symbol', 'kod produktu']);
                    const idxPriceOverride = findHeaderIndex(headers, ['cena nadpisana', 'cena override']);
                    const idxPackageSize = findHeaderIndex(headers, ['wielkość opakowania', 'wielkosc opakowania', 'rozmiar opakowania']);
                    const idxPackageUnit = findHeaderIndex(headers, ['jednostka opak.', 'jedn. opak.', 'jednostka opakowania']);
                    const idxPackagesCombined = findHeaderIndex(headers, ['opakowanie', 'opakowanie (opis)']);

                    const importedProducts = [];
                    for (let rowIndex = 1; rowIndex < rows.length; rowIndex += 1) {
                        const row = rows[rowIndex];
                        if (!row || row.every((cell) => cell == null || String(cell).trim() === '')) {
                            continue;
                        }

                        const rawName = row[idxName];
                        const name = rawName == null ? '' : String(rawName).trim();
                        if (!name) {
                            continue;
                        }

                        const rawId = idxId >= 0 ? row[idxId] : null;
                        const id = rawId == null || String(rawId).trim() === ''
                            ? `weber_import_${Date.now()}_${rowIndex}`
                            : String(rawId).trim();

                        const rawGroup = idxGroup >= 0 ? row[idxGroup] : null;
                        const group = rawGroup == null ? '' : String(rawGroup).trim();

                        const rawUnit = idxUnit >= 0 ? row[idxUnit] : null;
                        const unit = rawUnit == null ? '' : String(rawUnit).trim();

                        const priceRawCandidate = idxPriceRaw >= 0 ? row[idxPriceRaw] : null;
                        const basePriceSource = priceRawCandidate != null && String(priceRawCandidate).trim() !== ''
                            ? priceRawCandidate
                            : (idxPriceNet >= 0 ? row[idxPriceNet] : null);
                        const priceRawString = basePriceSource == null ? '' : String(basePriceSource).trim();
                        const priceNetValue = parseLooseNumber(idxPriceNet >= 0 ? row[idxPriceNet] : basePriceSource);
                        const priceNet = Number.isFinite(priceNetValue) && priceNetValue >= 0 ? priceNetValue : 0;

                        const priceOverrideValue = idxPriceOverride >= 0 ? parseLooseNumber(row[idxPriceOverride]) : Number.NaN;
                        const priceOverride = Number.isFinite(priceOverrideValue) && priceOverrideValue >= 0 ? roundToPrecision(priceOverrideValue, 6) : '';

                        const packageSizeValue = idxPackageSize >= 0 ? parseLooseNumber(row[idxPackageSize]) : Number.NaN;
                        let packageSize = Number.isFinite(packageSizeValue) && packageSizeValue > 0 ? roundToPrecision(packageSizeValue, 6) : '';

                        const rawPackageUnit = idxPackageUnit >= 0 ? row[idxPackageUnit] : null;
                        const packageUnitInitial = rawPackageUnit == null || String(rawPackageUnit).trim() === ''
                            ? (unit || '')
                            : String(rawPackageUnit).trim();

                        let packageUnitResolved = packageUnitInitial;
                        if ((packageSize === '' || packageUnitResolved === '') && idxPackagesCombined >= 0) {
                            const combined = row[idxPackagesCombined];
                            if (combined != null) {
                                const combinedText = String(combined).trim();
                                const match = combinedText.match(/([0-9]+[\d\.,]*)\s*(.*)/);
                                if (match) {
                                    const combinedSize = parseLooseNumber(match[1]);
                                    if (Number.isFinite(combinedSize) && combinedSize > 0) {
                                        packageSize = roundToPrecision(combinedSize, 6);
                                    }
                                    const combinedUnit = match[2].trim();
                                    if (combinedUnit) {
                                        packageUnitResolved = combinedUnit;
                                    }
                                } else if (combinedText && !packageUnitResolved) {
                                    packageUnitResolved = combinedText;
                                }
                            }
                        }

                        importedProducts.push({
                            id,
                            name,
                            group,
                            unit,
                            priceNet,
                            priceRaw: priceRawString || String(priceNetValue || ''),
                            priceOverride,
                            packageSize,
                            packageUnit: packageUnitResolved,
                        });
                    }

                    if (!importedProducts.length) {
                        alert('Nie znaleziono poprawnych pozycji do importu.');
                        return;
                    }

                    setData({
                        content: {
                            ...data.content,
                            products: importedProducts,
                        }
                    });
                    alert(`Import zakończony sukcesem – zaimportowano ${importedProducts.length} pozycji.`);
                } catch (error) {
                    console.error('Błąd podczas importu WEBER:', error);
                    alert('Wystąpił błąd podczas importu pliku WEBER. Upewnij się, że format arkusza jest zgodny z eksportem.');
                } finally {
                    if (input) {
                        input.value = '';
                    }
                }
            };

            const handleExportClick = () => {
                if (!sortedProducts.length) {
                    alert('Brak danych do eksportu.');
                    return;
                }
                exportWeberToExcel(sortedProducts, dataContent.settings);
            };

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };

            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const handleSaveProduct = (productPayload) => {
                const existingIndex = dataContent.products.findIndex((item) => item.id === productPayload.id);
                const nextProducts = existingIndex >= 0
                    ? dataContent.products.map((item) => (item.id === productPayload.id ? { ...item, ...productPayload } : item))
                    : [...dataContent.products, productPayload];
                setData({
                    content: {
                        ...data.content,
                        products: nextProducts,
                    }
                });
                closeProductModal();
            };

            const handleDeleteProduct = (productId) => {
                if (!confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                    return;
                }
                setData({
                    content: {
                        ...data.content,
                        products: dataContent.products.filter((item) => item.id !== productId),
                    }
                });
            };

            const formatPackageDisplay = (product) => {
                const unit = product.packageUnit || product.unit || '';
                const packageSizeValue = product.packageSize !== '' && product.packageSize != null
                    ? parseLooseNumber(product.packageSize)
                    : product.resolvedPackageSize;
                if (Number.isFinite(packageSizeValue) && packageSizeValue > 0) {
                    return `${formatNumberForInput(packageSizeValue)} ${unit}`.trim();
                }
                return unit || '—';
            };

            const toEditableProduct = (candidate) => {
                if (!candidate) {
                    return null;
                }

                return {
                    id: candidate.id || '',
                    name: candidate.name || '',
                    group: candidate.group || '',
                    unit: candidate.unit || '',
                    priceNet: candidate.priceNet ?? '',
                    priceRaw: candidate.priceRaw || '',
                    priceOverride: candidate.priceOverride ?? '',
                    packageSize: candidate.packageSize ?? '',
                    packageUnit: candidate.packageUnit || candidate.unit || '',
                };
            };


            return (
                <div className="space-y-6">
                    <Card>
                        <CardHeader>
                            <div className="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
                                <div>
                                    <h2 className="text-lg font-semibold text-slate-800">WEBER – parametry handlowe</h2>
                                    <p className="text-sm text-slate-500">Wprowadź globalne założenia rabatowe, marżowe oraz referencyjną cenę palety.</p>
                                </div>
                                <button
                                    type="button"
                                    onClick={resetSettings}
                                    className="self-start lg:self-auto inline-flex items-center gap-2 rounded-md border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100"
                                >
                                    Resetuj parametry
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Rabat zakupowy</label>
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="text"
                                            value={formatNumberForInput(dataContent.settings.purchaseDiscount)}
                                            onChange={(event) => handleSettingsChange('purchaseDiscount', event.target.value)}
                                            placeholder="0"
                                            className="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
                                        />
                                        <span className="text-sm text-slate-500">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Marża</label>
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="text"
                                            value={formatNumberForInput(dataContent.settings.margin)}
                                            onChange={(event) => handleSettingsChange('margin', event.target.value)}
                                            placeholder="20"
                                            className="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
                                        />
                                        <span className="text-sm text-slate-500">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Cena palety (referencja)</label>
                                    <div className="flex items-center gap-2">
                                        <input
                                            type="text"
                                            value={formatNumberForInput(dataContent.settings.palletPrice)}
                                            onChange={(event) => handleSettingsChange('palletPrice', event.target.value)}
                                            placeholder="0"
                                            className="w-full rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
                                        />
                                        <span className="text-sm text-slate-500">zł</span>
                                    </div>
                                </div>
                                <div className="md:col-span-3">
                                    <FormGroup label="Rabat zakupowy domyślny" variant="default-discount">
                                        <Input
                                            type="text"
                                            value={dataContent.settings.defaultPurchaseDiscountNote || ''}
                                            onChange={(event) => {
                                                setData({
                                                    content: {
                                                        ...data.content,
                                                        settings: {
                                                            ...dataContent.settings,
                                                            defaultPurchaseDiscountNote: event.target.value,
                                                        },
                                                    },
                                                });
                                            }}
                                        />
                                    </FormGroup>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader className="space-y-4">
                            <div>
                                <h2 className="text-lg font-semibold text-slate-800">Asortyment WEBER</h2>
                                <p className="text-sm text-slate-500">Zarządzaj produktami: wyszukuj, importuj z arkusza lub dodawaj nowe pozycje ręcznie.</p>
                            </div>
                            <div className="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
                                <div className="flex w-full items-center gap-2 lg:max-w-md">
                                    <input
                                        type="search"
                                        value={dataContent.filters.searchTerm}
                                        onChange={(event) => handleSearchChange(event.target.value)}
                                        placeholder="Szukaj po kodzie lub nazwie"
                                        className="flex-1 rounded-md border border-slate-300 px-3 py-2 text-sm text-slate-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200"
                                    />
                                    <button
                                        type="button"
                                        onClick={resetFilters}
                                        className="inline-flex items-center rounded-md border border-slate-300 px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100"
                                    >
                                        Wyczyść
                                    </button>
                                </div>
                                <div className="flex flex-col items-stretch gap-2 sm:items-end">
                                    <PriceListDateField
                                        value={dataContent.priceListDate || ''}
                                        onChange={handlePriceListDateChange}
                                        className="lg:w-64"
                                    />
                                    <div className="flex flex-wrap items-center justify-end gap-2">
                                        <input
                                            type="file"
                                            ref={fileInputRef}
                                            onChange={handleFileImport}
                                            className="hidden"
                                            accept=".xlsx,.xls"
                                        />
                                        <button
                                            type="button"
                                            onClick={handleImportClick}
                                            className="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
                                        >
                                            <UploadIcon /> Importuj XLS
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleExportClick}
                                            className="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
                                        >
                                            <DownloadIcon /> Eksportuj XLS
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => openProductModal(null)}
                                            className="inline-flex items-center gap-2 rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-700"
                                        >
                                            <AddIcon /> Dodaj produkt
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </CardHeader>
                        <CardContent className="p-0">
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-200 text-sm">
                                    <thead className="bg-slate-50">
                                        <tr className="text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
                                            <th className="px-4 py-3 whitespace-nowrap">Kod produktu</th>
                                            <th className="px-4 py-3 min-w-[220px]">Asortyment</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Opakowanie</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena katalogowa (netto)</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena zakupu (netto)</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena klient (netto)</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena klient (brutto)</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena klient (opak.) netto</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Cena klient (opak.) brutto</th>
                                            <th className="px-4 py-3 whitespace-nowrap">Akcje</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {sortedProducts.map((product) => {
                                            const packageDisplay = formatPackageDisplay(product);
                                            const baseProduct = dataContent.products.find((item) => item.id === product.id);
                                            const editableProduct = toEditableProduct(baseProduct || product);
                                            return (
                                                <tr
                                                    key={product.id}
                                                    className="hover:bg-slate-50/70 cursor-pointer"
                                                    onDoubleClick={() => openProductModal(editableProduct)}
                                                >
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-slate-700">{product.id || '—'}</td>
                                                    <td className="px-4 py-3 align-top">
                                                        <div className="font-medium text-slate-800 leading-snug">{product.name}</div>
                                                        {product.priceRaw && (
                                                            <div className="text-[11px] text-slate-500 mt-1">Katalog: {product.priceRaw}</div>
                                                        )}
                                                    </td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-slate-700">{packageDisplay}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap">{formatCurrency(product.resolvedBasePrice)}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap">{formatCurrency(product.resolvedPurchasePrice)}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-blue-700 font-semibold">{formatCurrency(product.resolvedCustomerUnitPriceNet)}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-blue-900 font-semibold">{formatCurrency(product.resolvedCustomerUnitPriceGross)}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-blue-700 font-semibold">{formatCurrency(product.resolvedCustomerPackagePriceNet)}</td>
                                                    <td className="px-4 py-3 align-top whitespace-nowrap text-blue-900 font-semibold">{formatCurrency(product.resolvedCustomerPackagePriceGross)}</td>
                                                    <td className="px-4 py-3 align-top">
                                                        <div className="flex items-center gap-2">
                                                            <button
                                                                type="button"
                                                                onClick={(event) => {
                                                                    event.stopPropagation();
                                                                    openProductModal(editableProduct);
                                                                }}
                                                                className="text-blue-600 hover:text-blue-800"
                                                            ><EditIcon /></button>
                                                            <button
                                                                type="button"
                                                                onClick={(event) => {
                                                                    event.stopPropagation();
                                                                    handleDeleteProduct(product.id);
                                                                }}
                                                                className="text-red-600 hover:text-red-800"
                                                            ><DeleteIcon /></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {!sortedProducts.length && (
                                            <tr>
                                                <td colSpan="10" className="px-4 py-6 text-center text-sm text-slate-500">
                                                    Brak wyników spełniających kryteria wyszukiwania.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            );
        };

        const PolbrukCalculator = ({ setSyncInfo }) => {
            const [data, setData, syncStatus, syncData] = usePersistentState('polbruk_data', INITIAL_POLBRUK_DATA);
            const [searchTerm, setSearchTerm] = useState('');
            const [isProductModalOpen, setIsProductModalOpen] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const fileInputRef = useRef(null);
            
            useEffect(() => {
                if (setSyncInfo) {
                    setSyncInfo({ status: syncStatus, sync: syncData });
                }
            }, [syncStatus, syncData, setSyncInfo]);
            
            const dataContent = useMemo(() => data.content, [data]);

            const handlePriceListDateChange = (event) => {
                const { value } = event.target;
                setData({
                    content: {
                        ...dataContent,
                        priceListDate: value,
                    }
                });
            };

            const openProductModal = (product = null) => {
                setEditingProduct(product);
                setIsProductModalOpen(true);
            };
            const closeProductModal = () => {
                setEditingProduct(null);
                setIsProductModalOpen(false);
            };

            const handleSettingChange = (key, value) => {
                const isPercentage = key === 'margin';
                const parsedValue = isPercentage
                    ? normalizePercentInputValue(value)
                    : parseNumericInput(value, { min: 0 });

                if (parsedValue === null) {
                    return;
                }

                setData({ content: { ...dataContent, settings: { ...dataContent.settings, [key]: parsedValue } } });
            };
            
            const calculatedProducts = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const filtered = !term
                    ? dataContent.products
                    : dataContent.products.filter(p =>
                        (p.nazwa && p.nazwa.toLowerCase().includes(term)) ||
                        (p.symbol && p.symbol.toLowerCase().includes(term)) ||
                        (p.ksztalt && p.ksztalt.toLowerCase().includes(term)) ||
                        (p.kolorystyka && p.kolorystyka.toLowerCase().includes(term))
                    );
                return filtered.map(p => calculatePolbrukProduct(p, dataContent.settings));
            }, [dataContent.products, dataContent.settings, searchTerm]);

            const handleSaveProduct = (productData) => {
                const newProducts = productData.symbol && dataContent.products.some(p => p.symbol === productData.symbol)
                    ? dataContent.products.map(p => (p.symbol === productData.symbol ? { ...p, ...productData } : p))
                    : [...dataContent.products, { ...productData, symbol: productData.symbol || `polbruk_${Date.now()}` }];
                setData({ content: { ...dataContent, products: newProducts } });
                closeProductModal();
            };

            const handleDeleteProduct = (productSymbol) => {
                if (confirm('Czy na pewno chcesz usunąć ten produkt?')) {
                    setData({
                        content: {
                            ...dataContent,
                            products: dataContent.products.filter(p => p.symbol !== productSymbol),
                        }
                    });
                }
            };

            const handleImportClick = () => { fileInputRef.current.click(); };

            const handleFileImport = async (e) => {
                const input = e.target;
                const file = input.files[0];
                if (!file) return;

                try {
                    const rows = await readExcelRows(file);

                    if (rows.length < 2) {
                        alert("Plik jest pusty lub nie zawiera nagłówków.");
                        return;
                    }

                    const headers = rows[0].map((header) => header == null ? '' : String(header).trim());
                    const requiredHeaders = ['Symbol', 'Nazwa', 'Cena detaliczna'];
                    if (!requiredHeaders.every((rh) => headers.includes(rh))) {
                        alert(`Brak wymaganych kolumn w pliku: ${requiredHeaders.join(', ')}`);
                        return;
                    }

                    const colIndices = {
                        symbol: headers.indexOf('Symbol'),
                        nazwa: headers.indexOf('Nazwa'),
                        ksztalt: headers.indexOf('Kształt'),
                        kolorystyka: headers.indexOf('Kolorystyka'),
                        cenaNetto: headers.indexOf('Cena detaliczna'),
                        rabat: headers.indexOf('Rabat (%)'),
                        iloscNaPalecie: headers.indexOf('Ilość na palecie'),
                        jednostka: headers.indexOf('Jednostka'),
                        waga: headers.indexOf('Waga palety (t)'),
                        maxPalletsPerTruck: headers.indexOf('Maks. palet na auto'),
                    };

                    const newProducts = [];
                    for (let i = 1; i < rows.length; i += 1) {
                        const row = rows[i];
                        if (!row || row.every(cell => cell === null || cell === '')) continue;

                        const nazwa = colIndices.nazwa >= 0 ? row[colIndices.nazwa] : null;
                        if (!nazwa || String(nazwa).trim() === '') continue;

                        newProducts.push({
                            symbol: colIndices.symbol >= 0 && row[colIndices.symbol] != null ? String(row[colIndices.symbol]) : `polbruk_imported_${Date.now()}_${i}`,
                            nazwa: String(nazwa),
                            ksztalt: colIndices.ksztalt >= 0 && row[colIndices.ksztalt] != null ? String(row[colIndices.ksztalt]) : '',
                            kolorystyka: colIndices.kolorystyka >= 0 && row[colIndices.kolorystyka] != null ? String(row[colIndices.kolorystyka]) : '',
                            cenaNetto: colIndices.cenaNetto >= 0 ? parseFloat(String(row[colIndices.cenaNetto]).replace(',', '.')) || 0 : 0,
                            rabat: colIndices.rabat >= 0 ? parseFloat(String(row[colIndices.rabat]).replace(',', '.')) || 0 : 0,
                            iloscNaPalecie: colIndices.iloscNaPalecie >= 0 ? parseInt(row[colIndices.iloscNaPalecie], 10) || 0 : 0,
                            jednostka: colIndices.jednostka >= 0 && row[colIndices.jednostka] != null ? String(row[colIndices.jednostka]) : 'szt',
                            waga: colIndices.waga >= 0 ? parseFloat(String(row[colIndices.waga]).replace(',', '.')) || 0 : 0,
                            maxPalletsPerTruck: colIndices.maxPalletsPerTruck >= 0 ? parseInt(row[colIndices.maxPalletsPerTruck], 10) || 22 : 22,
                        });
                    }

                    if (newProducts.length > 0) {
                        setData({ content: { ...dataContent, products: newProducts } });
                        alert(`Import zakończony! Zaimportowano ${newProducts.length} produktów.`);
                    } else {
                        alert("Nie znaleziono prawidłowych produktów do zaimportowania.");
                    }
                } catch (error) {
                    console.error("Błąd podczas importu pliku POLBRUK:", error);
                    alert('Wystąpił błąd podczas importu.');
                } finally {
                    input.value = '';
                }
            };

            const stats = {
                totalProducts: dataContent.products.length,
                avgPrice: (dataContent.products.reduce((acc, p) => acc + p.cenaNetto, 0) / (dataContent.products.length || 1)),
                avgDiscount: (dataContent.products.reduce((acc, p) => acc + (p.rabat || 0), 0) / (dataContent.products.length || 1)).toFixed(1)
            };

            return (
                <div className="space-y-6">
                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-600">POLBRUK S.A.</h1>
                            <p className="text-slate-500">Materiały budowlane</p>
                        </div>
                         <div className="flex flex-col items-stretch gap-2 sm:items-end">
                            <PriceListDateField
                                value={dataContent.priceListDate || ''}
                                onChange={handlePriceListDateChange}
                            />
                            <div className="flex gap-2 justify-end">
                                <input type="file" ref={fileInputRef} onChange={handleFileImport} className="hidden" accept=".xlsx, .xls" />
                                <button onClick={handleImportClick} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <UploadIcon /> Importuj XLS
                                </button>
                                <button onClick={() => exportPolbrukToExcel(calculatedProducts)} className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
                                    <DownloadIcon /> Eksportuj XLS
                                </button>
                            </div>
                        </div>
                    </header>
                    <Card>
                        <CardHeader><CardTitle>Ustawienia Ogólne</CardTitle></CardHeader>
                        <CardContent className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <FormGroup label="Stawka transportu (zł)"><Input type="number" step="0.01" min="0" value={dataContent.settings.transportRate} onChange={e => handleSettingChange('transportRate', e.target.value)} /></FormGroup>
                            <FormGroup label="Marża (%)"><Input type="number" step="0.01" min="0" max="100" value={dataContent.settings.margin} onChange={e => handleSettingChange('margin', e.target.value)} /></FormGroup>
                            <FormGroup label="Masa auta (t)"><Input type="number" step="0.01" min="0" value={dataContent.settings.truckWeight} onChange={e => handleSettingChange('truckWeight', e.target.value)} /></FormGroup>
                            <FormGroup label="Max palet/auto"><Input type="number" step="0.01" min="0" value={dataContent.settings.maxPalletsPerTruck} onChange={e => handleSettingChange('maxPalletsPerTruck', e.target.value)} /></FormGroup>
                        </CardContent>
                    </Card>
                     <Card>
                        <CardHeader><CardTitle>Kolorystyka Legenda</CardTitle></CardHeader>
                        <CardContent className="text-sm text-slate-600 space-y-3">
                            <div>
                                <strong className="font-semibold text-slate-800 block mb-1">SZARY</strong>
                                <p>szary</p>
                            </div>
                            <div>
                                <strong className="font-semibold text-slate-800 block mb-1">KOLOR</strong>
                                <p>brązowy, beżowy, czerwony, grafitowy, żółty, piaskowy</p>
                            </div>
                            <div>
                                <strong className="font-semibold text-slate-800 block mb-1">MONOKOLOR</strong>
                                <p>biały, stalowy, bazaltowy</p>
                            </div>
                            <div>
                                <strong className="font-semibold text-slate-800 block mb-1">MELANŻ</strong>
                                <div className="pl-4 text-slate-500">
                                    <p><span className="font-medium text-slate-600">szaro-grafitowe:</span> nerino, nerino blue, alpen, paloma</p>
                                    <p><span className="font-medium text-slate-600">beże i brązy:</span> latte, brenta, cortado, folk, galia, ivory, taupe, sahara</p>
                                    <p><span className="font-medium text-slate-600">pozostałe:</span> barwy jesieni, boho, hawaii, korten, masala, onyx</p>
                                </div>
                            </div>
                            <div>
                                <strong className="font-semibold text-slate-800 block mb-1">KOLORY PŁUKANE</strong>
                                <p>brązowy, szary, ciemnoszary, grafitowy, żółty, ardo, bianka, inez, ritmo, siena</p>
                            </div>
                        </CardContent>
                    </Card>
                    <Card>
                        <CardHeader className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                            <CardTitle>Produkty ({calculatedProducts.length} / {dataContent.products.length})</CardTitle>
                            <div className="flex gap-2 w-full sm:w-auto">
                                <input type="text" placeholder="Szukaj produktów..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full sm:w-64 p-2 border border-slate-300 rounded-md text-sm" />
                                <button onClick={() => openProductModal()} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors flex-shrink-0">
                                    <AddIcon /> Dodaj
                                </button>
                            </div>
                        </CardHeader>
                        <CardContent><div className="overflow-x-auto"><table className="w-full text-sm text-left text-slate-500">
                            <thead className="text-xs text-slate-700 uppercase bg-slate-50">
                                <tr>
                                    {[
                                        { key: 'symbol', label: 'Symbol', className: 'w-28' },
                                        { key: 'nazwa', label: 'Nazwa', className: 'w-full' },
                                        { key: 'ksztalt', label: 'Kształt', className: 'w-24' },
                                        { key: 'kolorystyka', label: 'Kolorystyka', className: 'w-28' },
                                        { key: 'cenaDetal', label: (<span>Cena<br/>detal.</span>), className: 'w-24' },
                                        { key: 'rabat', label: (<span>Rabat<br/>(%)</span>), className: 'w-20' },
                                        { key: 'poRabacie', label: (<span>Po<br/>rabacie</span>), className: 'w-24' },
                                        { key: 'transp', label: (<span>Transp/<br/>szt.</span>), className: 'w-24' },
                                        { key: 'nettoKl', label: (<span>Netto<br/>KL</span>), className: 'w-24' },
                                        { key: 'bruttoKl', label: (<span>Brutto<br/>KL</span>), className: 'w-24' },
                                        { key: 'iloscPal', label: (<span>Ilość<br/>paleta</span>), className: 'w-20' },
                                        { key: 'jm', label: 'JM', className: 'w-14' },
                                        { key: 'waga', label: (<span>Waga<br/>(t)</span>), className: 'w-24' },
                                        { key: 'maksPalet', label: (<span>Maks.<br/>palet</span>), className: 'w-20' },
                                        { key: 'akcje', label: 'Akcje', className: 'w-20' },
                                    ].map(({ key, label, className }, i) => (
                                        <th key={key} scope="col" className={`px-2 py-3 ${className || ''} ${key === 'nazwa' ? 'w-full' : ''}`}>{label}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>{calculatedProducts.map(p => (
                                <tr key={p.symbol} className="bg-white border-b hover:bg-slate-50">
                                    <td className="px-2 py-2 font-medium text-slate-900 align-top" style={{ wordBreak: 'break-word' }}>{p.symbol}</td>
                                    <td className="px-4 py-2 align-top">{p.nazwa}</td>
                                    <td className="px-2 py-2 align-top">{p.ksztalt}</td>
                                    <td className="px-2 py-2 align-top">{p.kolorystyka}</td>
                                    <td className="px-2 py-2 whitespace-nowrap align-top">{formatCurrency(p.cenaNetto)}</td>
                                    <td className="px-2 py-2 whitespace-nowrap align-top">{p.rabat}%</td>
                                    <td className="px-2 py-2 bg-slate-50 font-semibold whitespace-nowrap align-top">{formatCurrency(p.cenaPoRabacie)}</td>
                                    <td className="px-2 py-2 bg-slate-50 whitespace-nowrap align-top">{formatCurrency(p.transportPerUnit)}</td>
                                    <td className="px-2 py-2 bg-blue-50 font-bold text-blue-700 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyNetto)}</td>
                                    <td className="px-2 py-2 bg-blue-50 font-bold text-blue-900 whitespace-nowrap align-top">{formatCurrency(p.cenaSprzedazyBrutto)}</td>
                                    <td className="px-2 py-2 align-top">{p.iloscNaPalecie}</td>
                                    <td className="px-2 py-2 align-top">{p.jednostka}</td>
                                    <td className="px-2 py-2 whitespace-nowrap align-top">{p.waga}</td>
                                    <td className="px-2 py-2 whitespace-nowrap align-top">{p.maxPalletsPerTruck}</td>
                                    <td className="px-4 py-2 whitespace-nowrap align-top"><div className="flex items-center gap-2">
                                        <button onClick={() => openProductModal(p)} className="text-blue-600 hover:text-blue-800"><EditIcon /></button>
                                        <button onClick={() => handleDeleteProduct(p.symbol)} className="text-red-600 hover:text-red-800"><DeleteIcon /></button>
                                    </div></td>
                                </tr>
                            ))}</tbody>
                        </table></div></CardContent>
                    </Card>
                    {/* Usunięto statystyki dolne dla POLBRUK */}
                    <Modal isOpen={isProductModalOpen} onClose={closeProductModal} title={editingProduct ? 'Edytuj Produkt POLBRUK' : 'Dodaj Produkt POLBRUK'}>
                        <PolbrukProductForm product={editingProduct} onSave={handleSaveProduct} onCancel={closeProductModal} />
                    </Modal>
                </div>
            );
        };

        //======================================================================
        // LAYOUT COMPONENTS
        //======================================================================
        const Sidebar = ({ manufacturers, currentManufacturer, onSelectManufacturer, onMove }) => (
            <aside className="w-full lg:w-72 bg-white border-b lg:border-b-0 lg:border-r border-slate-200 p-4 lg:p-6 overflow-y-auto">
                <div className="mb-8">
                    <h1 className="text-xl font-semibold text-slate-900">Kalkulator Sprzedażowy</h1>
                    <p className="text-sm text-slate-500">Materiały budowlane</p>
                </div>
                <div className="flex flex-row lg:flex-col gap-3 overflow-x-auto lg:overflow-x-visible pb-4 lg:pb-0">
                    {manufacturers.map((manufacturer, index) => {
                        const isSelected = currentManufacturer === manufacturer.id;
                        const isFirst = index === 0;
                        const isLast = index === manufacturers.length - 1;

                        return (
                            <div
                                key={manufacturer.id}
                                onClick={() => onSelectManufacturer(manufacturer.id)}
                                className={`p-4 rounded-lg cursor-pointer transition-all duration-200 border-2 min-w-[220px] lg:min-w-full ${isSelected ? 'border-blue-500 bg-blue-50 shadow-md' : 'border-slate-200 bg-white hover:border-blue-400 hover:bg-slate-50'}`}
                            >
                                <div className="flex items-center gap-4 mb-3">
                                    <div className="text-4xl bg-slate-100 p-2 rounded-md">{manufacturer.icon}</div>
                                    <div className="flex-1">
                                        <h3 className="font-medium text-slate-800">{manufacturer.name}</h3>
                                        <p className="text-xs text-slate-500">{manufacturer.type}</p>
                                    </div>
                                    <div className="flex flex-col gap-1">
                                        <button
                                            type="button"
                                            onClick={(event) => { event.stopPropagation(); onMove(manufacturer.id, -1); }}
                                            disabled={isFirst}
                                            className={`h-7 w-7 flex items-center justify-center rounded-md border text-xs ${isFirst ? 'border-slate-200 text-slate-300 cursor-not-allowed' : 'border-slate-300 text-slate-600 hover:bg-slate-100'}`}
                                            title="Przesuń wyżej"
                                        >
                                            ↑
                                        </button>
                                        <button
                                            type="button"
                                            onClick={(event) => { event.stopPropagation(); onMove(manufacturer.id, 1); }}
                                            disabled={isLast}
                                            className={`h-7 w-7 flex items-center justify-center rounded-md border text-xs ${isLast ? 'border-slate-200 text-slate-300 cursor-not-allowed' : 'border-slate-300 text-slate-600 hover:bg-slate-100'}`}
                                            title="Przesuń niżej"
                                        >
                                            ↓
                                        </button>
                                    </div>
                                </div>
                                <div className="text-xs text-slate-500 flex justify-between items-center">
                                    <span>Produkty: <strong>{manufacturer.productCount}</strong></span>
                                    <span className={`font-medium ${manufacturer.status === 'active' ? 'text-emerald-500' : 'text-amber-500'}`}>{manufacturer.status === 'active' ? 'Aktywny' : 'W przygotowaniu'}</span>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </aside>
        );

        //======================================================================
        // ROOT APP COMPONENT
        //======================================================================
        const App = () => {
            const [currentManufacturer, setCurrentManufacturer] = useState('porotherm');
            const [syncInfo, setSyncInfo] = useState({ status: 'offline', sync: () => {} });
            const [manufacturerOrder, setManufacturerOrder] = useState(() => {
                try {
                    const stored = window.localStorage.getItem(MANUFACTURER_ORDER_KEY);
                    const parsed = stored ? JSON.parse(stored) : null;
                    if (!Array.isArray(parsed)) {
                        return MANUFACTURERS.map((item) => item.id);
                    }
                    const knownIds = new Set(MANUFACTURERS.map((item) => item.id));
                    const filtered = parsed.filter((id) => knownIds.has(id));
                    const missing = MANUFACTURERS
                        .map((item) => item.id)
                        .filter((id) => !filtered.includes(id));
                    return [...filtered, ...missing];
                } catch (error) {
                    console.warn('Nie można odczytać kolejności producentów:', error);
                    return MANUFACTURERS.map((item) => item.id);
                }
            });

            useEffect(() => {
                setManufacturerOrder((prev) => {
                    const knownIds = MANUFACTURERS.map((item) => item.id);
                    const filtered = prev.filter((id) => knownIds.includes(id));
                    const missing = knownIds.filter((id) => !filtered.includes(id));
                    const next = [...filtered, ...missing];
                    return JSON.stringify(next) === JSON.stringify(prev) ? prev : next;
                });
            }, []);

            useEffect(() => {
                try {
                    window.localStorage.setItem(
                        MANUFACTURER_ORDER_KEY,
                        JSON.stringify(manufacturerOrder)
                    );
                } catch (error) {
                    console.warn('Nie można zapisać kolejności producentów:', error);
                }
            }, [manufacturerOrder]);

            const orderedManufacturers = useMemo(() => {
                const orderMap = manufacturerOrder.reduce((acc, id, index) => {
                    acc[id] = index;
                    return acc;
                }, {});
                return [...MANUFACTURERS].sort((a, b) => {
                    const orderA = Number.isFinite(orderMap[a.id]) ? orderMap[a.id] : Infinity;
                    const orderB = Number.isFinite(orderMap[b.id]) ? orderMap[b.id] : Infinity;
                    return orderA - orderB;
                });
            }, [manufacturerOrder]);

            const moveManufacturer = (id, direction) => {
                setManufacturerOrder((prev) => {
                    const index = prev.indexOf(id);
                    if (index === -1) {
                        return prev;
                    }
                    const target = index + direction;
                    if (target < 0 || target >= prev.length) {
                        return prev;
                    }
                    const next = [...prev];
                    next.splice(index, 1);
                    next.splice(target, 0, id);
                    return next;
                });
            };

            const renderCalculator = () => {
                switch (currentManufacturer) {
                    case 'porotherm': return <PorothermCalculator setSyncInfo={setSyncInfo} />;
                    case 'solbet': return <SolbetCalculator setSyncInfo={setSyncInfo} />;
                    case 'semmelrock': return <SemmelrockCalculator setSyncInfo={setSyncInfo} />;
                    case 'brukbet': return <BrukbetCalculator setSyncInfo={setSyncInfo} />;
                    case 'polbruk': return <PolbrukCalculator setSyncInfo={setSyncInfo} />;
                    case 'weber': return <WeberCalculator setSyncInfo={setSyncInfo} />;
                    case 'leier': return <LeierCalculator setSyncInfo={setSyncInfo} />;
                    case 'uvalue': return <UValueCalculator setSyncInfo={setSyncInfo} />;
                    case 'silikaty': return <SilikatyCalculator setSyncInfo={setSyncInfo} />;
                    case 'docieplenie': return <DocieplenieCalculator setSyncInfo={setSyncInfo} />;
                    case 'knauf': return <KnaufCalculator setSyncInfo={setSyncInfo} />;
                    case 'rockwool': return <RockwoolCalculator setSyncInfo={setSyncInfo} />;
                    case 'projects': return <ProjectsCalculator setSyncInfo={setSyncInfo} />;
                    default: return <PorothermCalculator setSyncInfo={setSyncInfo} />;
                }
            };
            
            const syncEnabledManufacturers = ['porotherm', 'solbet', 'semmelrock', 'brukbet', 'polbruk', 'weber', 'leier', 'silikaty', 'docieplenie', 'knauf', 'rockwool', 'projects'];
            const isCalculatorActive = syncEnabledManufacturers.includes(currentManufacturer);

            return (
                <div className="flex flex-col lg:flex-row min-h-screen bg-slate-100">
                    <Sidebar
                        manufacturers={orderedManufacturers}
                        currentManufacturer={currentManufacturer}
                        onSelectManufacturer={setCurrentManufacturer}
                        onMove={moveManufacturer}
                    />
                    <main className="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                        {renderCalculator()}
                        {isCalculatorActive && pocketbaseEnabled && (
                            <SyncStatusIndicator status={syncInfo.status} onSync={syncInfo.sync} />
                        )}
                    </main>
                </div>
            );
        };

        //======================================================================
        // RENDER THE APP
        //======================================================================
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>

<script type="module" src="/index.tsx"></script>
</body>
</html>
